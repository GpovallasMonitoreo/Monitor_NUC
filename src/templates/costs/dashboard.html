{% extends 'base.html' %}
{% block header_title %}Executive Command Center - Argos DOOH{% endblock %}
{% block content %}
<div class="max-w-[1800px] mx-auto space-y-8">
    <!-- Header Ejecutivo -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Costo por <span class="text-primary">Ubicación</span></h1>
            <p class="text-sm text-slate-500 mt-1">Dashboard ejecutivo para toma de decisiones estratégicas</p>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="load()" class="flex items-center gap-2 px-4 py-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 shadow-sm transition">
                <i data-lucide="refresh-cw" class="w-4 h-4 text-slate-600"></i>
                <span class="text-sm font-bold text-slate-700">Actualizar</span>
            </button>
            <button onclick="openDrawer('report')" class="flex items-center gap-2 px-4 py-2.5 bg-primary text-white rounded-xl hover:bg-orange-600 shadow-lg shadow-orange-500/20 transition">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span class="text-sm font-bold">Exportar Reporte</span>
            </button>
        </div>
    </div>

    <!-- KPI Cards Ejecutivas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Inversión (CAPEX)</p>
                    <h3 id="t-inv" class="text-2xl font-bold text-slate-900 font-mono">$0.00</h3>
                </div>
                <div class="p-2.5 rounded-lg bg-primary/10">
                    <i data-lucide="trending-up" class="w-5 h-5 text-primary"></i>
                </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">Inversión total en infraestructura</p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Mantenimiento (OPEX)</p>
                    <h3 id="t-mant" class="text-2xl font-bold text-amber-600 font-mono">$0.00</h3>
                </div>
                <div class="p-2.5 rounded-lg bg-amber-100">
                    <i data-lucide="tool" class="w-5 h-5 text-amber-600"></i>
                </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">Costos operativos mensuales</p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Utilidad Neta</p>
                    <h3 id="t-net" class="text-2xl font-bold text-emerald-600 font-mono">$0.00</h3>
                </div>
                <div class="p-2.5 rounded-lg bg-emerald-100">
                    <i data-lucide="dollar-sign" class="w-5 h-5 text-emerald-600"></i>
                </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">Beneficio después de gastos</p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ROI Promedio</p>
                    <h3 id="t-roi" class="text-2xl font-bold text-secondary font-mono">0%</h3>
                </div>
                <div class="p-2.5 rounded-lg bg-secondary/10">
                    <i data-lucide="target" class="w-5 h-5 text-secondary"></i>
                </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">Retorno sobre inversión promedio</p>
        </div>
    </div>

    <!-- Tabla Ejecutiva Mejorada -->
    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold text-slate-800">Rentabilidad por Ubicación</h3>
                <p class="text-sm text-slate-500">Análisis detallado de cada activo digital</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" placeholder="Buscar ubicación..." class="pl-10 pr-4 py-2 border border-slate-200 rounded-xl text-sm w-64 focus:ring-2 focus:ring-primary focus:border-transparent" onkeyup="filterTable(this.value)">
                </div>
                <select onchange="filterByStatus(this.value)" class="border border-slate-200 rounded-xl text-sm px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">Todos los estados</option>
                    <option value="RENTABLE">Rentable</option>
                    <option value="RECUPERANDO">Recuperando</option>
                    <option value="CRITICO">Crítico</option>
                </select>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead class="bg-slate-50/80 border-b border-slate-100">
                    <tr>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Ubicación / Activo</th>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Inversión (CAPEX)</th>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Mantenimiento (OPEX)</th>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Ventas</th>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Utilidad</th>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">ROI</th>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Estado</th>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tb" class="divide-y divide-slate-100">
                    <tr><td colspan="8" class="p-12 text-center text-slate-400"><i data-lucide="loader" class="w-8 h-8 animate-spin mx-auto mb-3"></i><p>Cargando datos ejecutivos...</p></td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50/50 text-sm text-slate-500 flex justify-between items-center">
            <span id="summary-text">Mostrando 0 ubicaciones</span>
            <div class="flex items-center gap-2">
                <button onclick="changePage(-1)" class="p-2 hover:bg-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>
                <span class="text-sm font-bold">Página <span id="current-page">1</span></span>
                <button onclick="changePage(1)" class="p-2 hover:bg-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Gráficos Ejecutivos -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h3 class="text-sm font-bold text-slate-800 mb-4 uppercase tracking-wider">Distribución de Rentabilidad</h3>
            <div class="h-64 flex items-center justify-center">
                <div id="profit-chart" class="w-full h-full"></div>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h3 class="text-sm font-bold text-slate-800 mb-4 uppercase tracking-wider">Top 5 Ubicaciones</h3>
            <div id="top-locations" class="space-y-4">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h3 class="text-sm font-bold text-slate-800 mb-4 uppercase tracking-wider">Alertas Críticas</h3>
            <div id="alerts-container" class="space-y-3">
                <div class="p-3 bg-red-50 rounded-xl border border-red-100">
                    <div class="flex gap-3 items-start">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0"></i>
                        <div>
                            <p class="text-sm font-bold text-slate-700">Sin datos cargados</p>
                            <p class="text-xs text-slate-500">Ejecuta el reporte para ver alertas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drawer para Reportes -->
<div id="overlay" class="fixed inset-0 bg-slate-900/40 z-40 hidden backdrop-blur-sm transition-opacity opacity-0" onclick="closeDrawer()"></div>
<div id="drawer" class="fixed right-0 top-0 h-full w-full max-w-2xl bg-white z-50 shadow-2xl translate-x-full drawer-slide overflow-hidden flex flex-col">
    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
        <div>
            <h2 id="d-title" class="text-xl font-bold text-slate-800">Exportar Reporte Ejecutivo</h2>
            <p id="d-subtitle" class="text-sm text-slate-500">Genera un reporte detallado para presentación</p>
        </div>
        <button onclick="closeDrawer()" class="p-2 hover:bg-slate-100 rounded-full transition">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>
    <div id="d-content" class="flex-1 overflow-y-auto custom-scroll p-8 bg-slate-50/30">
        <!-- Contenido dinámico -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => { 
        lucide.createIcons(); 
        load();
    });

    let currentData = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    async function load() {
        try {
            const r = await fetch('/costs/report'); 
            const data = await r.json();
            currentData = data;
            
            updateKPI(data);
            renderTable();
            updateCharts(data);
            updateAlerts(data);
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('tb').innerHTML = `
                <tr><td colspan="8" class="p-8 text-center">
                    <i data-lucide="alert-circle" class="w-12 h-12 text-red-400 mx-auto mb-3"></i>
                    <p class="text-red-500 font-bold">Error al cargar datos</p>
                    <p class="text-sm text-slate-400">Intenta nuevamente</p>
                </td></tr>
            `;
        }
    }

    function updateKPI(data) {
        let ti = 0, tm = 0, tn = 0, troi = 0, count = 0;
        
        data.forEach(x => {
            ti += x.cost_installation || 0;
            tm += x.cost_maintenance || 0;
            tn += x.net_profit || 0;
            if (x.roi_percent && !isNaN(x.roi_percent)) {
                troi += parseFloat(x.roi_percent);
                count++;
            }
        });
        
        const avgROI = count > 0 ? (troi / count).toFixed(1) : '0.0';
        
        document.getElementById('t-inv').innerText = `$${ti.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('t-mant').innerText = `$${tm.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('t-net').innerText = `$${tn.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById('t-net').className = tn >= 0 ? 
            "text-2xl font-bold text-emerald-600 font-mono" : 
            "text-2xl font-bold text-red-500 font-mono";
        document.getElementById('t-roi').innerText = `${avgROI}%`;
    }

    function renderTable() {
        const tb = document.getElementById('tb');
        if (currentData.length === 0) {
            tb.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-400">No hay datos disponibles</td></tr>';
            return;
        }

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageData = currentData.slice(start, end);
        
        let html = '';
        
        pageData.forEach(x => {
            const isProfitable = x.net_profit >= 0;
            
            let statusClass = 'bg-red-100 text-red-700 border-red-200';
            let statusIcon = 'trending-down';
            
            if (x.status_label === 'RENTABLE') {
                statusClass = 'bg-emerald-100 text-emerald-700 border-emerald-200';
                statusIcon = 'trending-up';
            } else if (x.status_label === 'RECUPERANDO') {
                statusClass = 'bg-blue-100 text-blue-700 border-blue-200';
                statusIcon = 'activity';
            }
            
            html += `
                <tr class="hover:bg-slate-50/50 transition group">
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg ${isProfitable ? 'bg-emerald-50 text-emerald-500' : 'bg-red-50 text-red-500'} flex items-center justify-center font-bold text-xs">
                                <i data-lucide="${statusIcon}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-slate-700 group-hover:text-primary transition">${x.device_id}</p>
                                <p class="text-xs text-slate-500">${x.location || 'Sin ubicación'}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-right">
                        <p class="text-sm font-bold text-slate-900">$${x.cost_installation.toLocaleString()}</p>
                        <p class="text-xs text-slate-400">CAPEX</p>
                    </td>
                    <td class="p-4 text-right">
                        <p class="text-sm font-bold text-amber-600">$${x.cost_maintenance.toLocaleString()}</p>
                        <p class="text-xs text-slate-400">OPEX</p>
                    </td>
                    <td class="p-4 text-right">
                        <p class="text-sm font-bold text-emerald-600">$${x.total_sales.toLocaleString()}</p>
                        <p class="text-xs text-slate-400">Ingresos</p>
                    </td>
                    <td class="p-4 text-right">
                        <p class="text-sm font-bold ${isProfitable ? 'text-emerald-600' : 'text-red-500'}">
                            $${x.net_profit.toLocaleString()}
                        </p>
                        <p class="text-xs ${isProfitable ? 'text-emerald-400' : 'text-red-400'}">
                            ${isProfitable ? '✓ Rentable' : '✗ En pérdida'}
                        </p>
                    </td>
                    <td class="p-4 text-center">
                        <div class="inline-flex items-center gap-1 px-3 py-1 rounded-full ${parseFloat(x.roi_percent) >= 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'}">
                            <span class="text-sm font-bold">${x.roi_percent}%</span>
                            <i data-lucide="${parseFloat(x.roi_percent) >= 0 ? 'arrow-up-right' : 'arrow-down-right'}" class="w-3 h-3"></i>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold border ${statusClass}">
                            <i data-lucide="${statusIcon}" class="w-3 h-3"></i>
                            ${x.status_label}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="viewDetails('${x.device_id}')" class="p-2 hover:bg-slate-100 rounded-lg transition group/btn">
                            <i data-lucide="eye" class="w-4 h-4 text-slate-400 group-hover/btn:text-primary"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tb.innerHTML = html;
        lucide.createIcons();
        updatePagination();
    }

    function updatePagination() {
        const totalPages = Math.ceil(currentData.length / itemsPerPage);
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('summary-text').textContent = 
            `Mostrando ${Math.min(currentData.length, itemsPerPage)} de ${currentData.length} ubicaciones`;
            
        const prevBtn = document.querySelector('[onclick="changePage(-1)"]');
        const nextBtn = document.querySelector('[onclick="changePage(1)"]');
        
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    }

    function changePage(delta) {
        const totalPages = Math.ceil(currentData.length / itemsPerPage);
        const newPage = currentPage + delta;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderTable();
        }
    }

    function filterTable(searchTerm) {
        // Implementación básica de filtro
        const filtered = currentData.filter(item => 
            item.device_id.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (item.location && item.location.toLowerCase().includes(searchTerm.toLowerCase()))
        );
        
        // Para implementación completa, deberías guardar los datos filtrados
        // y actualizar currentData temporalmente
        console.log('Filtrando por:', searchTerm);
    }

    function filterByStatus(status) {
        console.log('Filtrando por estado:', status);
        // Implementar filtro por estado
    }

    function updateCharts(data) {
        // Ordenar por rentabilidad para el top 5
        const top5 = [...data]
            .sort((a, b) => b.net_profit - a.net_profit)
            .slice(0, 5);
        
        let topHtml = '';
        top5.forEach((item, index) => {
            topHtml += `
                <div class="flex items-center justify-between p-3 hover:bg-slate-50 rounded-xl transition">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 rounded-lg ${index < 3 ? 'bg-primary/10 text-primary' : 'bg-slate-100 text-slate-600'} flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </span>
                        <div>
                            <p class="text-sm font-bold text-slate-700">${item.device_id}</p>
                            <p class="text-xs text-slate-500">ROI: ${item.roi_percent}%</p>
                        </div>
                    </div>
                    <span class="text-sm font-bold ${item.net_profit >= 0 ? 'text-emerald-600' : 'text-red-500'}">
                        $${item.net_profit.toLocaleString()}
                    </span>
                </div>
            `;
        });
        
        document.getElementById('top-locations').innerHTML = topHtml;
    }

    function updateAlerts(data) {
        const critical = data.filter(x => 
            x.net_profit < 0 || 
            x.status_label === 'CRITICO' || 
            (parseFloat(x.roi_percent) < 0)
        );
        
        let alertsHtml = '';
        
        if (critical.length === 0) {
            alertsHtml = `
                <div class="p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                    <div class="flex gap-3 items-start">
                        <i data-lucide="check-circle" class="w-5 h-5 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                        <div>
                            <p class="text-sm font-bold text-slate-700">Sin alertas críticas</p>
                            <p class="text-xs text-slate-500">Todas las ubicaciones están estables</p>
                        </div>
                    </div>
                </div>
            `;
        } else {
            critical.slice(0, 3).forEach(item => {
                alertsHtml += `
                    <div class="p-3 bg-red-50 rounded-xl border border-red-100">
                        <div class="flex gap-3 items-start">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0"></i>
                            <div>
                                <p class="text-sm font-bold text-slate-700">${item.device_id}</p>
                                <p class="text-xs text-slate-500">
                                    ${item.net_profit < 0 ? 'Pérdida: $' + Math.abs(item.net_profit).toLocaleString() : ''}
                                    ${parseFloat(item.roi_percent) < 0 ? 'ROI negativo: ' + item.roi_percent + '%' : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (critical.length > 3) {
                alertsHtml += `
                    <div class="text-center">
                        <p class="text-xs text-slate-500">+${critical.length - 3} alertas más</p>
                    </div>
                `;
            }
        }
        
        document.getElementById('alerts-container').innerHTML = alertsHtml;
        lucide.createIcons();
    }

    function viewDetails(deviceId) {
        alert(`Viendo detalles de: ${deviceId}\n\nEn una implementación real, esto redirigiría a un dashboard detallado.`);
        // window.location.href = `/dashboard/details/${deviceId}`;
    }

    function openDrawer(type) {
        let title, subtitle, content;
        
        if (type === 'report') {
            title = 'Exportar Reporte Ejecutivo';
            subtitle = 'Genera un reporte detallado para presentación';
            content = `
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200">
                        <h4 class="text-sm font-bold text-slate-800 mb-4">Formato del Reporte</h4>
                        <div class="space-y-3">
                            <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl hover:bg-slate-50 cursor-pointer">
                                <input type="radio" name="format" value="pdf" class="text-primary" checked>
                                <div>
                                    <p class="font-bold text-slate-700">PDF Ejecutivo</p>
                                    <p class="text-xs text-slate-500">Ideal para presentaciones y reportes impresos</p>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl hover:bg-slate-50 cursor-pointer">
                                <input type="radio" name="format" value="excel" class="text-primary">
                                <div>
                                    <p class="font-bold text-slate-700">Excel Analítico</p>
                                    <p class="text-xs text-slate-500">Datos crudos para análisis avanzado</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-2xl border border-slate-200">
                        <h4 class="text-sm font-bold text-slate-800 mb-4">Filtros Adicionales</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 block mb-2">Fecha Inicio</label>
                                <input type="date" class="w-full border-slate-200 rounded-xl text-sm">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 block mb-2">Fecha Fin</label>
                                <input type="date" class="w-full border-slate-200 rounded-xl text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <button class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg shadow-orange-500/20 hover:bg-orange-600 transition">
                        <i data-lucide="download" class="w-5 h-5 inline mr-2"></i>
                        GENERAR REPORTE
                    </button>
                </div>
            `;
        }
        
        document.getElementById('d-title').innerText = title;
        document.getElementById('d-subtitle').innerText = subtitle;
        document.getElementById('d-content').innerHTML = content;
        lucide.createIcons();
        
        const drawer = document.getElementById('drawer');
        const overlay = document.getElementById('overlay');
        
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.add('opacity-100'), 10);
        drawer.classList.remove('translate-x-full');
    }

    function closeDrawer() {
        const drawer = document.getElementById('drawer');
        const overlay = document.getElementById('overlay');
        
        drawer.classList.add('translate-x-full');
        overlay.classList.remove('opacity-100');
        setTimeout(() => overlay.classList.add('hidden'), 400);
    }
</script>
{% endblock %}
