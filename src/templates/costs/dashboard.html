{% extends 'base.html' %}

{% block header_title %}Executive Command Center | Argos DOOH{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

<div id="argos-app" class="max-w-[1800px] mx-auto space-y-8 pb-12 font-['Inter']">
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[2px] mb-2">Total Inversión (CAPEX)</h3>
            <p id="t-inv" class="text-3xl font-mono font-bold text-slate-800">$0.00</p>
            <div class="mt-2 text-[10px] text-slate-400 uppercase">Incluye Obra Civil y Electrónica</div>
        </div>
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[2px] mb-2">Total Mtto. (OPEX)</h3>
            <p id="t-mant" class="text-3xl font-mono font-bold text-orange-500">$0.00</p>
            <div class="mt-2 text-[10px] text-slate-400 uppercase italic">Operación + Logística</div>
        </div>
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition border-l-4 border-l-emerald-500">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[2px] mb-2">Utilidad Neta</h3>
            <p id="t-net" class="text-3xl font-mono font-black text-slate-900">$0.00</p>
            <div id="profit-badge" class="mt-2 inline-block px-2 py-1 rounded text-[9px] font-bold">CALCULANDO...</div>
        </div>
        <div class="flex flex-col gap-2">
            <button onclick="ui.openDrawer('installation')" class="flex-1 bg-slate-900 text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-800 transition shadow-lg shadow-slate-200">
                <span class="material-icons-outlined text-sm">add_location</span> NUEVA INSTALACIÓN
            </button>
            <button onclick="ui.openDrawer('maintenance')" class="flex-1 bg-orange-500 text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-orange-600 transition shadow-lg shadow-orange-100">
                <span class="material-icons-outlined text-sm">build</span> REGISTRAR MTTO.
            </button>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div class="p-6 border-b bg-slate-50/50 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-icons-outlined text-primary text-orange-500">analytics</span> 
                    Rentabilidad por Ubicación
                </h3>
                <p class="text-[10px] text-slate-500 uppercase font-medium">Control de ciclo de vida del activo</p>
            </div>
            <button onclick="app.loadData()" class="p-2 hover:bg-slate-200 rounded-full transition text-slate-400">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm border-collapse">
                <thead class="bg-slate-100/50 text-slate-500 uppercase text-[10px] font-black tracking-widest border-b">
                    <tr>
                        <th class="p-4">ID Pantalla / Clave QTM</th>
                        <th class="p-4 text-right">Inversión</th>
                        <th class="p-4 text-right">Mantenimiento</th>
                        <th class="p-4 text-right">Total Gastos</th>
                        <th class="p-4 text-right text-emerald-600">Ventas</th>
                        <th class="p-4 text-right font-black">Ganancia</th>
                        <th class="p-4 text-center">ROI</th>
                        <th class="p-4 text-center">Estado</th>
                    </tr>
                </thead>
                <tbody id="tb" class="divide-y divide-slate-100">
                    <tr><td colspan="8" class="p-12 text-center text-slate-400 italic">Inicializando sistema Argos...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="drawer-overlay" class="fixed inset-0 bg-slate-900/40 z-[60] hidden backdrop-blur-sm transition-opacity" onclick="ui.closeDrawer()"></div>
<div id="drawer" class="fixed right-0 top-0 h-full w-full max-w-xl bg-white z-[70] shadow-2xl translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
    <div class="p-6 border-b flex justify-between items-center">
        <div>
            <h2 id="drawer-title" class="text-xl font-bold text-slate-800">Cuestionario</h2>
            <p id="drawer-subtitle" class="text-xs text-slate-500 italic uppercase tracking-wider"></p>
        </div>
        <button onclick="ui.closeDrawer()" class="p-2 hover:bg-slate-100 rounded-full"><span class="material-icons-outlined">close</span></button>
    </div>
    <div id="drawer-content" class="flex-1 overflow-y-auto p-8 bg-slate-50/30 custom-scroll">
        </div>
</div>

<script>
/**
 * ARQUITECTURA POO - ARGOS DOOH
 * Escencia técnica con visión senior.
 */

class ArgosSignageManager {
    constructor() {
        this.endpoints = {
            report: '/costs/report',
            add: '/costs/add',
            data: '/api/data'
        };
    }

    async loadData() {
        try {
            const response = await fetch(this.endpoints.report);
            const data = await response.json();
            this.renderDashboard(data);
        } catch (error) {
            console.error("Argos System Error:", error);
        }
    }

    renderDashboard(data) {
        const tb = document.getElementById('tb');
        tb.innerHTML = '';
        
        let ti=0, tm=0, tn=0;

        if(!data || data.length === 0) {
            tb.innerHTML = '<tr><td colspan="8" class="p-12 text-center text-slate-400 italic font-mono">Sin registros en base de datos.</td></tr>';
            return;
        }

        data.forEach(item => {
            ti += item.cost_installation; 
            tm += item.cost_maintenance; 
            tn += item.net_profit;

            const stClass = this.getStatusClass(item.status_label);

            tb.innerHTML += `
                <tr class="hover:bg-slate-50/80 transition-colors group cursor-pointer" onclick="ui.goToScreen('${item.device_id}')">
                    <td class="p-4">
                        <div class="font-bold text-slate-700">${item.device_id}</div>
                        <div class="text-[9px] text-slate-400 font-mono">QTM: ${item.qtm_key || 'N/A'}</div>
                    </td>
                    <td class="p-4 text-right text-slate-500 font-mono">$${item.cost_installation.toLocaleString()}</td>
                    <td class="p-4 text-right text-orange-500 font-mono">$${item.cost_maintenance.toLocaleString()}</td>
                    <td class="p-4 text-right font-bold text-red-400 font-mono">$${item.total_expenses.toLocaleString()}</td>
                    <td class="p-4 text-right font-bold text-emerald-600 font-mono">$${item.total_sales.toLocaleString()}</td>
                    <td class="p-4 text-right font-black ${item.net_profit >= 0 ? 'text-slate-800' : 'text-red-500'} font-mono">
                        $${item.net_profit.toLocaleString()}
                    </td>
                    <td class="p-4 text-center">
                        <span class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded">${item.roi_percent}%</span>
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded text-[9px] font-black uppercase tracking-tighter ${stClass}">${item.status_label}</span>
                    </td>
                </tr>
            `;
        });

        // Actualizar KPIs Globales
        this.updateGlobalKPIs(ti, tm, tn);
    }

    getStatusClass(label) {
        if(label === 'RENTABLE') return 'bg-emerald-100 text-emerald-700';
        if(label === 'RECUPERANDO') return 'bg-blue-100 text-blue-700';
        return 'bg-red-100 text-red-700';
    }

    updateGlobalKPIs(ti, tm, tn) {
        document.getElementById('t-inv').innerText = `$${ti.toLocaleString()}`;
        document.getElementById('t-mant').innerText = `$${tm.toLocaleString()}`;
        document.getElementById('t-net').innerText = `$${tn.toLocaleString()}`;
        
        const badge = document.getElementById('profit-badge');
        badge.innerText = tn >= 0 ? 'MARGEN POSITIVO' : 'DÉFICIT OPERATIVO';
        badge.className = `mt-2 inline-block px-2 py-1 rounded text-[9px] font-bold ${tn >= 0 ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}`;
    }
}

/**
 * UI MANAGER - Encargado de la interacción y cuestionarios
 */
class UIManager {
    constructor(app) {
        this.app = app;
        this.drawer = document.getElementById('drawer');
        this.overlay = document.getElementById('drawer-overlay');
    }

    openDrawer(type) {
        const content = document.getElementById('drawer-content');
        const title = document.getElementById('drawer-title');
        const subtitle = document.getElementById('drawer-subtitle');

        if(type === 'installation') {
            title.innerText = "Alta de Pantalla Digital";
            subtitle.innerText = "Configuración CAPEX y Hardware";
            content.innerHTML = this.getInstallationForm();
        } else if(type === 'maintenance') {
            title.innerText = "Control de Mantenimiento";
            subtitle.innerText = "Registro OPEX e Insumos";
            content.innerHTML = this.getMaintenanceForm();
        }

        this.overlay.classList.remove('hidden');
        this.drawer.classList.remove('translate-x-full');
        this.loadDeviceSelects();
    }

    closeDrawer() {
        this.drawer.classList.add('translate-x-full');
        this.overlay.classList.add('hidden');
    }

    getInstallationForm() {
        return `
            <form id="f-argos" class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase">Clave de Sitio en QTM</label>
                        <input type="text" id="qtm_key" class="w-full border-slate-200 rounded-xl text-sm" placeholder="Ej: QTM-CENTRO-01">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Fecha Instalación</label>
                        <input type="date" id="date" class="w-full border-slate-200 rounded-xl text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Costo Pantalla ($)</label>
                        <input type="number" id="amt" class="w-full border-slate-200 rounded-xl text-sm font-bold">
                    </div>
                </div>

                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200 space-y-3">
                    <h4 class="text-[10px] font-black text-slate-500 uppercase italic">Obra Civil y Logística</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="c_obra" placeholder="Obra Civil" class="text-xs border-slate-200 rounded-lg">
                        <input type="number" id="c_estruc" placeholder="Estructura" class="text-xs border-slate-200 rounded-lg">
                        <input type="number" id="c_elec" placeholder="Inst. Eléctrica" class="text-xs border-slate-200 rounded-lg">
                        <input type="number" id="c_cuadrilla" placeholder="Cuadrilla (6 técnicos)" class="text-xs border-slate-200 rounded-lg">
                    </div>
                </div>

                <div class="p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100 space-y-3">
                    <h4 class="text-[10px] font-black text-indigo-500 uppercase italic">Hardware ID</h4>
                    <div class="grid grid-cols-3 gap-2 text-[10px]">
                        <input type="text" id="nuc" placeholder="NUC ID" class="border-indigo-100 rounded">
                        <input type="text" id="ups" placeholder="UPS ID" class="border-indigo-100 rounded">
                        <input type="text" id="teltonika" placeholder="Teltonika" class="border-indigo-100 rounded">
                    </div>
                </div>

                <button type="button" onclick="ui.save('installation')" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg shadow-slate-200">ACTIVA ACTIVO</button>
            </form>
        `;
    }

    getMaintenanceForm() {
        return `
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase">Seleccionar Ubicación</label>
                    <select id="dev-id" class="w-full border-slate-200 rounded-xl text-sm bg-white mt-1"></select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Tipo</label>
                        <select id="sub" class="w-full border-slate-200 rounded-xl text-sm">
                            <option value="preventivo">Preventivo (Limpieza)</option>
                            <option value="correctivo">Correctivo</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Costo Total ($)</label>
                        <input type="number" id="amt" class="w-full border-slate-200 rounded-xl text-sm font-bold text-orange-500">
                    </div>
                </div>

                <div class="p-4 bg-orange-50/50 rounded-2xl border border-orange-100 grid grid-cols-2 gap-2">
                    <label class="flex items-center gap-2 text-[10px] font-bold"><input type="checkbox" id="jabon"> JABÓN / TRAPOS</label>
                    <input type="number" id="c_gas" placeholder="Gasolina/Transporte" class="text-xs border-orange-200 rounded">
                </div>

                <textarea id="desc" class="w-full border-slate-200 rounded-2xl text-sm" rows="3" placeholder="Detalle técnico de la visita..."></textarea>
                
                <button type="button" onclick="ui.save('maintenance')" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold">REGISTRAR MTTO.</button>
            </div>
        `;
    }

    async loadDeviceSelects() {
        const s = document.getElementById('dev-id');
        if(!s) return;
        const r = await fetch(this.app.endpoints.data);
        const d = await r.json();
        s.innerHTML = '<option value="">Seleccione...</option>';
        Object.values(d).forEach(x => s.innerHTML += `<option value="${x.pc_name}">${x.pc_name}</option>`);
    }

    async save(type) {
        // Lógica de recolección de datos similar a tu anterior código pero centralizada
        alert("Argos: Guardando datos de " + type);
        this.closeDrawer();
        this.app.loadData();
    }

    goToScreen(id) {
        window.location = `/costs/screen/${id}`; // Escencia: redirección ejecutiva
    }
}

// INSTANCIACIÓN DE SISTEMA
const app = new ArgosSignageManager();
const ui = new UIManager(app);

document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    app.loadData();
});
</script>

<style>
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>
{% endblock %}
