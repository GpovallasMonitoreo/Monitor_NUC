{% extends 'base.html' %}
{% block header_title %}Executive Command Center - Argos DOOH{% endblock %}
{% block content %}
<div class="max-w-[1800px] mx-auto space-y-8">
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">Costo por <span class="text-primary text-orange-500">Ubicación</span></h1>
            <p class="text-sm text-slate-500 mt-1">Dashboard ejecutivo para toma de decisiones estratégicas</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-inner">
                <button onclick="argosUI.openForm('installation')" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-white hover:shadow-sm rounded-lg transition flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-4 h-4 text-orange-500"></i> ALTA SITIO
                </button>
                <button onclick="argosUI.openForm('maintenance')" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-white hover:shadow-sm rounded-lg transition flex items-center gap-2">
                    <i data-lucide="wrench" class="w-4 h-4 text-amber-500"></i> MTTO.
                </button>
                <button onclick="argosUI.openForm('operation')" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-white hover:shadow-sm rounded-lg transition flex items-center gap-2">
                    <i data-lucide="banknote" class="w-4 h-4 text-emerald-500"></i> VENTA/GASTO
                </button>
            </div>
            
            <button onclick="load()" class="p-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 shadow-sm transition">
                <i data-lucide="refresh-cw" class="w-4 h-4 text-slate-600"></i>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Inversión (CAPEX)</p>
                    <h3 id="t-inv" class="text-2xl font-bold text-slate-900 font-mono">$0.00</h3>
                </div>
                <div class="p-2.5 rounded-lg bg-orange-100">
                    <i data-lucide="trending-up" class="w-5 h-5 text-orange-500"></i>
                </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">Inversión total en infraestructura</p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Mantenimiento (OPEX)</p>
                    <h3 id="t-mant" class="text-2xl font-bold text-amber-600 font-mono">$0.00</h3>
                </div>
                <div class="p-2.5 rounded-lg bg-amber-100">
                    <i data-lucide="tool" class="w-5 h-5 text-amber-600"></i>
                </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">Costos operativos acumulados</p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Utilidad Neta</p>
                    <h3 id="t-net" class="text-2xl font-bold text-emerald-600 font-mono">$0.00</h3>
                </div>
                <div class="p-2.5 rounded-lg bg-emerald-100">
                    <i data-lucide="dollar-sign" class="w-5 h-5 text-emerald-600"></i>
                </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">Beneficio después de gastos</p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">ROI Promedio</p>
                    <h3 id="t-roi" class="text-2xl font-bold text-blue-500 font-mono">0%</h3>
                </div>
                <div class="p-2.5 rounded-lg bg-blue-100">
                    <i data-lucide="target" class="w-5 h-5 text-blue-500"></i>
                </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">Retorno sobre inversión promedio</p>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold text-slate-800">Rentabilidad por Ubicación</h3>
                <p class="text-sm text-slate-500">Análisis detallado de cada activo digital</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" placeholder="Buscar ubicación..." class="pl-10 pr-4 py-2 border border-slate-200 rounded-xl text-sm w-64 focus:ring-2 focus:ring-orange-500 focus:border-transparent" onkeyup="filterTable(this.value)">
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full border-collapse text-sm">
                <thead class="bg-slate-50/80 border-b border-slate-100">
                    <tr>
                        <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Ubicación / Activo</th>
                        <th class="p-4 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">Inversión (CAPEX)</th>
                        <th class="p-4 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">Mtto (OPEX)</th>
                        <th class="p-4 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">Ventas</th>
                        <th class="p-4 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">Utilidad</th>
                        <th class="p-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">ROI</th>
                        <th class="p-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">Estado</th>
                        <th class="p-4 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tb" class="divide-y divide-slate-100">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="overlay" class="fixed inset-0 bg-slate-900/40 z-40 hidden backdrop-blur-sm transition-opacity opacity-0" onclick="argosUI.closeDrawer()"></div>
<div id="drawer" class="fixed right-0 top-0 h-full w-full max-w-xl bg-white z-50 shadow-2xl translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
        <div>
            <h2 id="d-title" class="text-xl font-bold text-slate-800 italic">Cuestionario Operativo</h2>
            <p id="d-subtitle" class="text-sm text-slate-500 uppercase font-bold tracking-tighter">Entrada de datos Argos</p>
        </div>
        <button onclick="argosUI.closeDrawer()" class="p-2 hover:bg-slate-100 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <div id="d-content" class="flex-1 overflow-y-auto custom-scroll p-8 bg-slate-50/10">
        </div>
</div>

<script>
    /**
     * CLASE ARGOS_UI (POO)
     * Centraliza la lógica de los cuestionarios y la interfaz
     */
    class ArgosUI {
        constructor() {
            this.drawer = document.getElementById('drawer');
            this.overlay = document.getElementById('overlay');
            this.content = document.getElementById('d-content');
            this.title = document.getElementById('d-title');
            this.subtitle = document.getElementById('d-subtitle');
        }

        openForm(type) {
            let html = '';
            switch(type) {
                case 'installation':
                    this.setMeta("Alta de Pantalla Digital", "CAPEX e Infraestructura");
                    html = this.templateInstallation();
                    break;
                case 'maintenance':
                    this.setMeta("Reporte de Mantenimiento", "OPEX e Incidencias");
                    html = this.templateMaintenance();
                    break;
                case 'operation':
                    this.setMeta("Operación y Finanzas", "Ventas y Gastos Recurrentes");
                    html = this.templateOperation();
                    break;
            }
            this.content.innerHTML = html;
            this.showDrawer();
            lucide.createIcons();
            this.loadDeviceOptions();
        }

        setMeta(t, s) { this.title.innerText = t; this.subtitle.innerText = s; }

        showDrawer() {
            this.overlay.classList.remove('hidden');
            setTimeout(() => this.overlay.classList.add('opacity-100'), 10);
            this.drawer.classList.remove('translate-x-full');
        }

        closeDrawer() {
            this.drawer.classList.add('translate-x-full');
            this.overlay.classList.remove('opacity-100');
            setTimeout(() => this.overlay.classList.add('hidden'), 300);
        }

        // --- TEMPLATES DE CUESTIONARIOS ---

        templateInstallation() {
            return `
                <form onsubmit="argosUI.handleSave(event, 'installation')" class="space-y-6 pb-10">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Clave QTM / Nombre Inventario</label>
                            <input type="text" name="qtm_key" required class="w-full border-slate-200 rounded-xl mt-1 text-sm shadow-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Instalación Pantalla</label>
                            <input type="date" name="date_inst" class="w-full border-slate-200 rounded-xl mt-1 text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Tiempo Est. (Días)</label>
                            <input type="number" name="est_days" value="15" class="w-full border-slate-200 rounded-xl mt-1 text-sm">
                        </div>
                    </div>

                    <div class="p-4 bg-orange-50 rounded-2xl border border-orange-100 space-y-4">
                        <h4 class="text-xs font-bold text-orange-600 flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4"></i> DESGLOSE CAPEX</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" name="cost_screen" placeholder="Costo Pantalla" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="cost_civil" placeholder="Obra Civil" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="cost_structure" placeholder="Estructura" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="cost_electric" placeholder="Inst. Eléctrica" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="cost_crew" placeholder="Cuadrilla (6 técnicos)" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="cost_legal" placeholder="Costos Legales" class="text-xs border-slate-200 rounded-lg">
                        </div>
                    </div>

                    <div class="p-4 bg-slate-100 rounded-2xl border border-slate-200 space-y-4">
                        <h4 class="text-xs font-bold text-slate-600 flex items-center gap-2"><i data-lucide="cpu" class="w-4 h-4"></i> HARDWARE & LICENCIAS</h4>
                        <div class="grid grid-cols-2 gap-3 text-[10px]">
                            <input type="text" name="nuc" placeholder="NUC ID" class="border-slate-200 rounded-lg">
                            <input type="text" name="ups" placeholder="UPS ID" class="border-slate-200 rounded-lg">
                            <input type="text" name="sending" placeholder="Sending Card" class="border-slate-200 rounded-lg">
                            <input type="text" name="teltonika" placeholder="Teltonika / Modem" class="border-slate-200 rounded-lg">
                            <input type="text" name="broadsign" placeholder="Broadsign Lic." class="border-slate-200 rounded-lg">
                            <input type="number" name="license_annual" placeholder="Costo Licencia Anual" class="border-slate-200 rounded-lg">
                        </div>
                    </div>

                    <button class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-black transition">GUARDAR ACTIVACIÓN</button>
                </form>
            `;
        }

        templateMaintenance() {
            return `
                <form onsubmit="argosUI.handleSave(event, 'maintenance')" class="space-y-6">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Seleccionar Ubicación</label>
                    <select id="dev-list" name="device_id" class="w-full border-slate-200 rounded-xl text-sm mb-4"></select>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100 space-y-3">
                            <p class="text-[10px] font-bold text-amber-600 uppercase">Preventivo (Limpieza)</p>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-xs"><input type="checkbox" name="soap"> Jabón y Trapos</label>
                                <input type="number" name="cost_bimestral" placeholder="Costo Bimestral" class="w-full text-xs border-slate-200 rounded-lg">
                            </div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-2xl border border-red-100 space-y-3">
                            <p class="text-[10px] font-bold text-red-600 uppercase">Correctivo</p>
                            <input type="number" name="cost_electronics" placeholder="Costo Electrónica" class="w-full text-xs border-slate-200 rounded-lg">
                            <input type="number" name="reincidencias" placeholder="# Reincidencias" class="w-full text-xs border-slate-200 rounded-lg">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Logística y Cuadrilla (4 Técnicos)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" name="gas" placeholder="Gasolina" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="truck" placeholder="Transporte Camioneta" class="text-xs border-slate-200 rounded-lg">
                        </div>
                    </div>

                    <textarea name="status_medio" placeholder="Estado actual del medio y equipos..." class="w-full border-slate-200 rounded-xl text-sm p-3" rows="3"></textarea>
                    
                    <button class="w-full bg-amber-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-amber-700 transition">REGISTRAR INTERVENCIÓN</button>
                </form>
            `;
        }

        templateOperation() {
            return `
                <form onsubmit="argosUI.handleSave(event, 'operation')" class="space-y-6">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Ubicación</label>
                    <select id="dev-list" name="device_id" class="w-full border-slate-200 rounded-xl text-sm"></select>
                    
                    <div class="p-5 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <label class="text-[10px] font-bold text-emerald-600 uppercase">Ingresos Mensuales / Pauta</label>
                        <input type="number" name="sales" placeholder="Monto de Venta ($)" class="w-full border-emerald-200 rounded-xl mt-2 font-bold text-emerald-700">
                    </div>

                    <div class="space-y-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Gastos Recurrentes (OPEX)</p>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" name="rent" placeholder="Renta Mensual" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="electricity" placeholder="Luz Mensual" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="internet" placeholder="Internet Mensual" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="land_use" placeholder="Uso de Suelo" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="sr_cost" placeholder="Costo SRD" class="text-xs border-slate-200 rounded-lg">
                            <input type="number" name="pauta_prog" placeholder="Prog. Pauta" class="text-xs border-slate-200 rounded-lg">
                        </div>
                    </div>

                    <button class="w-full bg-emerald-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-emerald-700 transition">GUARDAR DATOS FINANCIEROS</button>
                </form>
            `;
        }

        // --- LÓGICA DE NEGOCIO ---

        async loadDeviceOptions() {
            const select = document.getElementById('dev-list');
            if(!select) return;
            const r = await fetch('/api/data');
            const data = await r.json();
            select.innerHTML = '<option value="">Seleccionar Medio...</option>';
            Object.values(data).forEach(x => {
                select.innerHTML += `<option value="${x.pc_name}">${x.pc_name}</option>`;
            });
        }

        async handleSave(e, type) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            console.log(`Argos Save [${type}]:`, data);
            
            // Simulación de envío al endpoint que ya tienes
            const response = await fetch('/costs/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    device_id: data.device_id || data.qtm_key,
                    type: type,
                    amount: data.sales || data.cost_screen || data.cost_electronics || 0,
                    description: JSON.stringify(data), // Guardamos todo el objeto como descripción para no perder info
                    date: data.date_inst || new Date().toISOString().split('T')[0]
                })
            });

            if(response.ok) {
                alert("Registro exitoso en Argos DOOH");
                this.closeDrawer();
                load(); // Recarga el dashboard principal
            }
        }
    }

    // Instancia Global
    const argosUI = new ArgosUI();

    // Sobreescribimos tu función renderTable para que sea más "Argos"
    // (Mantenemos la lógica de datos pero con el diseño ejecutivo)
    // NOTA: Usa la función renderTable que ya tienes integrada en tu script original.
</script>

<style>
    .drawer-slide { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>
{% endblock %}
