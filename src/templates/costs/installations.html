{% extends 'base.html' %}
{% block header_title %}Registro de Instalaciones{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-slate-200">
    <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
        <div class="p-3 bg-indigo-50 rounded-lg text-indigo-600"><i data-lucide="monitor-speaker" class="w-6 h-6"></i></div>
        <div>
            <h2 class="text-xl font-bold text-slate-800">Alta de Pantalla</h2>
            <p class="text-sm text-slate-500">Costos iniciales de inversión.</p>
        </div>
    </div>

    <form id="form-inst" class="space-y-6">
        <div class="grid grid-cols-2 gap-6">
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Ubicación</label>
                <select id="dev-id" class="w-full p-3 border rounded-lg text-sm bg-slate-50"><option>Cargando...</option></select>
            </div>
            <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Fecha</label>
                <input type="date" id="date" class="w-full p-3 border rounded-lg text-sm">
            </div>
        </div>

        <div class="p-4 bg-slate-50 rounded-lg grid grid-cols-2 gap-4 border border-slate-200">
            <div>
                <label class="text-xs font-bold text-slate-500">Material ($)</label>
                <input type="number" id="c-mat" placeholder="0" oninput="calc()" class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-500">Mano de Obra ($)</label>
                <input type="number" id="c-mo" placeholder="0" oninput="calc()" class="w-full p-2 border rounded">
            </div>
            <div class="col-span-2 pt-2 border-t flex justify-between">
                <span class="font-bold">Total:</span>
                <span id="total-txt" class="text-lg font-black text-indigo-600">$0.00</span>
            </div>
        </div>

        <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Descripción</label>
            <textarea id="desc" class="w-full p-3 border rounded-lg" rows="2" placeholder="Detalles de la instalación..."></textarea>
        </div>

        <button type="button" onclick="save()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">Guardar Instalación</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); loadDevs(); document.getElementById('date').valueAsDate = new Date(); });
    function calc() {
        const t = (parseFloat(document.getElementById('c-mat').value)||0) + (parseFloat(document.getElementById('c-mo').value)||0);
        document.getElementById('total-txt').textContent = `$${t.toLocaleString()}`;
    }
    async function loadDevs() {
        const r = await fetch('/api/data'); const d = await r.json();
        const s = document.getElementById('dev-id'); s.innerHTML='<option value="">Seleccione...</option>';
        Object.values(d).forEach(x => s.innerHTML+=`<option value="${x.pc_name}">${x.pc_name}</option>`);
    }
    async function save() {
        const mat = document.getElementById('c-mat').value || 0;
        const mo = document.getElementById('c-mo').value || 0;
        const total = parseFloat(mat) + parseFloat(mo);
        const dev = document.getElementById('dev-id').value;
        if(!dev || total <= 0) return alert("Faltan datos");

        await fetch('/costs/add', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                device_id: dev, type: 'installation', subtype: 'inicial',
                description: `${document.getElementById('desc').value} (Mat:$${mat}, MO:$${mo})`,
                amount: total, date: document.getElementById('date').value
            })
        });
        alert("Guardado"); location.reload();
    }
</script>
{% endblock %}
