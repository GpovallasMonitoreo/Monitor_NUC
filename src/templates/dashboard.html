{% extends 'base.html' %}

{% block header_title %}Panel General{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
        <p class="text-xs font-semibold text-slate-500 uppercase">Total Equipos</p>
        <h3 class="text-2xl font-bold text-slate-800 mt-1" id="kpi-total">--</h3>
    </div>
    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
        <p class="text-xs font-semibold text-slate-500 uppercase">Offline / Críticos</p>
        <h3 class="text-2xl font-bold text-slate-800 mt-1" id="kpi-offline">--</h3>
    </div>
    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
        <p class="text-xs font-semibold text-slate-500 uppercase">Carga CPU Promedio</p>
        <h3 class="text-2xl font-bold text-slate-800 mt-1" id="kpi-cpu">--%</h3>
    </div>
    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
        <p class="text-xs font-semibold text-slate-500 uppercase">Latencia Promedio</p>
        <h3 class="text-2xl font-bold text-slate-800 mt-1" id="kpi-latency">-- ms</h3>
    </div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
        <h3 class="font-bold text-slate-700">Estado de Dispositivos</h3>
        <span class="text-xs text-slate-400" id="last-update">Sincronizando...</span>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-slate-600">
            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                <tr>
                    <th class="px-6 py-3">Estado</th>
                    <th class="px-6 py-3">Nombre PC</th>
                    <th class="px-6 py-3">IP</th>
                    <th class="px-6 py-3 text-center">CPU</th>
                    <th class="px-6 py-3 text-center">Latencia</th>
                    <th class="px-6 py-3 text-right">Última Vez</th>
                </tr>
            </thead>
            <tbody id="devices-table-body" class="divide-y divide-slate-100">
                </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function fetchData() {
        try {
            // 1. URL CORRECTA
            const response = await fetch('/api/data');
            const rawData = await response.json();
            
            // 2. CORRECCIÓN CRÍTICA: Convertir a Lista
            const devices = Object.values(rawData);
            
            updateKPIs(devices);
            renderTable(devices);
            
            document.getElementById('last-update').innerText = 'Actualizado: ' + new Date().toLocaleTimeString();
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    function updateKPIs(devices) {
        if (devices.length === 0) return;
        
        const total = devices.length;
        const offline = devices.filter(d => d.status === 'offline').length;
        
        // Mapeo seguro de variables (Backend names -> Frontend names)
        const avgCpu = devices.reduce((acc, d) => acc + (d.cpu_load_percent || 0), 0) / total;
        const avgLat = devices.reduce((acc, d) => acc + (d.latency_ms || 0), 0) / total;

        document.getElementById('kpi-total').innerText = total;
        
        const offElem = document.getElementById('kpi-offline');
        offElem.innerText = offline;
        if(offline > 0) offElem.className = "text-2xl font-bold text-red-600 mt-1 animate-pulse";
        else offElem.className = "text-2xl font-bold text-slate-800 mt-1";

        document.getElementById('kpi-cpu').innerText = avgCpu.toFixed(1) + '%';
        document.getElementById('kpi-latency').innerText = avgLat.toFixed(0) + ' ms';
    }

    function renderTable(devices) {
        const tbody = document.getElementById('devices-table-body');
        tbody.innerHTML = ''; 

        if (devices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center">Esperando conexión...</td></tr>';
            return;
        }

        devices.forEach(dev => {
            let statusBadge = `<span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold">Online</span>`;
            if (dev.status === 'offline') statusBadge = `<span class="px-2 py-1 bg-slate-200 text-slate-500 rounded-full text-xs font-bold">Offline</span>`;
            
            // Cálculo de tiempo
            const lastSeen = new Date(dev.timestamp);
            const now = new Date();
            const diff = Math.floor((now - lastSeen)/1000);
            const timeText = diff < 60 ? `${diff}s` : `${Math.floor(diff/60)}m`;

            const row = `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 font-bold">${dev.pc_name}</td>
                    <td class="px-6 py-4 font-mono text-xs">${dev.ip}</td>
                    <td class="px-6 py-4 text-center">${Math.round(dev.cpu_load_percent || 0)}%</td>
                    <td class="px-6 py-4 text-center">${dev.latency_ms || 0} ms</td>
                    <td class="px-6 py-4 text-right text-xs text-slate-400">Hace ${timeText}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
        
        if(typeof lucide !== 'undefined') lucide.createIcons();
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetchData();
        setInterval(fetchData, 3000);
    });
</script>
{% endblock %}
