{% block scripts %}
<script>
    // --- LÓGICA DEL FRONTEND (Cliente) ---
    
    async function fetchData() {
        try {
            // 1. Llamamos a la API
            const response = await fetch('/api/data');
            const rawData = await response.json();
            
            // 2. CORRECCIÓN CRÍTICA: Convertir Objeto a Array
            // El backend devuelve: { "PC1": {data}, "PC2": {data} }
            // Nosotros necesitamos: [ {data}, {data} ]
            const devicesList = Object.values(rawData);

            // 3. Mapear datos (Traducir del backend al frontend)
            const processedDevices = devicesList.map(dev => {
                // Calcular tiempo relativo
                const lastSeen = new Date(dev.timestamp);
                const now = new Date();
                const diffSeconds = Math.floor((now - lastSeen) / 1000);
                let timeText = diffSeconds + " seg";
                if (diffSeconds > 60) timeText = Math.floor(diffSeconds / 60) + " min";
                if (diffSeconds > 3600) timeText = Math.floor(diffSeconds / 3600) + " h";

                return {
                    status: dev.status || 'offline',
                    pc_name: dev.pc_name || 'Desconocido',
                    unit: "General", // Campo estático o agrégalo al agente si lo necesitas
                    ip: dev.ip || '0.0.0.0',
                    // Mapeo de métricas planas a estructura anidada que usa tu HTML
                    metrics: {
                        cpu: Math.round(dev.cpu_load_percent || 0),
                        latency: dev.latency_ms || 0
                    },
                    last_seen_human: "Hace " + timeText
                };
            });
            
            // 4. Actualizar UI
            updateKPIs(processedDevices);
            renderTable(processedDevices);
            
            // Actualizar hora del sistema
            document.getElementById('last-update').innerText = 'Actualizado: ' + new Date().toLocaleTimeString();
            
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    function updateKPIs(devices) {
        // Aseguramos que devices sea un array
        if (!Array.isArray(devices)) return;
        
        const total = devices.length;
        if (total === 0) {
            document.getElementById('kpi-total').innerText = "0";
            return;
        }

        // Contamos offline o críticos
        const offline = devices.filter(d => d.status === 'offline' || d.status === 'critical').length;
        
        // Calculamos promedios seguros
        const avgCpu = devices.reduce((acc, d) => acc + (d.metrics.cpu || 0), 0) / total;
        const avgLat = devices.reduce((acc, d) => acc + (d.metrics.latency || 0), 0) / total;

        // Actualizamos DOM
        document.getElementById('kpi-total').innerText = total;
        document.getElementById('kpi-offline').innerText = offline;
        document.getElementById('kpi-cpu').innerText = avgCpu.toFixed(1) + '%';
        document.getElementById('kpi-latency').innerText = avgLat.toFixed(0) + ' ms';
        
        // Efecto visual si hay caídos
        const offElem = document.getElementById('kpi-offline');
        if(offline > 0) {
            offElem.className = "text-2xl font-bold text-red-600 mt-1 animate-pulse";
        } else {
            offElem.className = "text-2xl font-bold text-slate-800 mt-1";
        }
    }

    function renderTable(devices) {
        const tbody = document.getElementById('devices-table-body');
        tbody.innerHTML = ''; // Limpiar tabla anterior

        if (!devices || devices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-400">Esperando conexión de agentes...</td></tr>';
            return;
        }

        devices.forEach(dev => {
            // Lógica de colores según estado
            let statusColor = 'bg-slate-100 text-slate-600';
            let statusText = 'Desconocido';
            let rowClass = '';
            
            if (dev.status === 'online') {
                statusColor = 'bg-emerald-100 text-emerald-700 border border-emerald-200';
                statusText = 'En Línea';
            } else if (dev.status === 'offline') {
                statusColor = 'bg-red-100 text-red-700 border border-red-200';
                statusText = 'Offline';
                rowClass = 'bg-red-50'; // Resaltar toda la fila
            } else if (dev.status === 'critical') {
                statusColor = 'bg-amber-100 text-amber-700 border border-amber-200';
                statusText = 'Alerta';
            }

            // Construcción de la fila HTML
            const row = `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 ${rowClass}">
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${statusColor} shadow-sm">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">${dev.pc_name}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs uppercase tracking-wide">${dev.unit}</td>
                    <td class="px-6 py-4 font-mono text-xs text-indigo-600 bg-indigo-50 rounded px-2 py-1 w-fit">${dev.ip}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center space-x-2">
                            <div class="flex-1 bg-slate-200 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-indigo-600 h-1.5 rounded-full transition-all duration-500" style="width: ${dev.metrics.cpu}%"></div>
                            </div>
                            <span class="text-xs font-bold text-slate-600 w-8">${dev.metrics.cpu}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="font-mono text-xs font-semibold ${dev.metrics.latency > 100 ? 'text-red-500' : 'text-emerald-600'}">
                            ${dev.metrics.latency} ms
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-xs font-medium text-slate-400">
                        ${dev.last_seen_human}
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
        
        // Re-inicializar iconos si usas Lucide
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // Inicialización
    document.addEventListener("DOMContentLoaded", () => {
        fetchData(); // Primera carga inmediata
        setInterval(fetchData, 3000); // Recarga automática cada 3s
    });
</script>
{% endblock %}
