<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Argos DOOH - Executive Command Center</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: { extend: { colors: { primary: "#F97316", secondary: "#3B82F6", accent: "#8B5CF6", success: "#10B981", dark: "#0F172A" }, fontFamily: { body: ["Inter", "sans-serif"] } } }
        };
    </script>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .truncate-col { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-body h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-slate-200 h-16 flex flex-shrink-0 items-center justify-between px-8 shadow-sm z-20">
        <div class="flex items-center gap-4">
            <div class="size-10 bg-slate-900 rounded-lg flex items-center justify-center text-primary shadow-lg"><i data-lucide="activity" class="w-6 h-6"></i></div>
            <div><h1 class="text-xl font-bold text-slate-800 tracking-tight">Finanzas y Rentabilidad</h1><p class="text-[10px] text-slate-400 font-medium">VISTA GENERAL</p></div>
        </div>
        <div class="flex items-center gap-3">
            <a href="/techview/proposal" class="hidden md:flex items-center gap-2 px-4 py-2 bg-slate-800 text-white text-xs font-bold rounded-lg hover:bg-slate-700 transition shadow-md"><span class="material-icons-outlined text-sm">add</span> NUEVA INSTALACIÃ“N</a>
            <a href="/" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg font-bold text-xs transition"><span class="material-icons-outlined text-sm">logout</span> Volver</a>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6 scroll-smooth custom-scroll w-full max-w-[1920px] mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="kpi-container">
            <div class="animate-pulse bg-white h-32 rounded-2xl border border-slate-100"></div>
            <div class="animate-pulse bg-white h-32 rounded-2xl border border-slate-100"></div>
            <div class="animate-pulse bg-white h-32 rounded-2xl border border-slate-100"></div>
            <div class="animate-pulse bg-white h-32 rounded-2xl border border-slate-100"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wider">Flujo de Caja</h3>
                    </div>
                    <div class="h-72 w-full"><canvas id="rentabilityChart"></canvas></div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h2 class="text-lg font-bold text-slate-800">Inventario</h2>
                        <div class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg px-3 py-1.5 w-64">
                            <span class="material-icons-outlined text-slate-400 text-lg">search</span>
                            <input type="text" id="inventory-search" placeholder="Buscar..." class="border-none bg-transparent p-0 text-sm w-full focus:ring-0">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50/80 border-b border-slate-100 text-[10px] font-black text-slate-400 uppercase tracking-wider">
                                <tr><th class="p-4 w-1/3">Sitio / ID</th><th class="p-4">Estado</th><th class="p-4 text-center">Acciones</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 text-sm" id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wider mb-4">Alertas Activas</h3>
                    <div class="space-y-3" id="alerts-container"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        class DashboardApp {
            constructor() { this.allAssets = []; }

            async init() {
                try {
                    // Cargar KPIs
                    const kpiRes = await fetch('/api/techview/dashboard');
                    const kpiData = await kpiRes.json();
                    this.renderKPIs(kpiData.kpis);
                    this.renderChart(kpiData.financials);

                    // Cargar Inventario
                    const invRes = await fetch('/api/techview/inventory');
                    this.allAssets = await invRes.json();
                    this.renderTable(this.allAssets);
                    this.renderAlerts(kpiData.kpis.active_alerts);

                    // Buscador
                    document.getElementById('inventory-search').addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        this.renderTable(this.allAssets.filter(a => a.pc_name?.toLowerCase().includes(term) || a.device_id.toLowerCase().includes(term)));
                    });
                    
                    lucide.createIcons();
                } catch (e) { console.error("Error init dashboard", e); }
            }

            renderKPIs(kpis) {
                const fmt = n => `$${(n/1000000).toFixed(2)}M`;
                document.getElementById('kpi-container').innerHTML = `
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">CAPEX Total</p><h3 class="text-2xl font-bold text-slate-900 font-mono">${fmt(kpis.capex)}</h3></div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Ventas Anuales</p><h3 class="text-2xl font-bold text-emerald-600 font-mono">${fmt(kpis.sales_annual)}</h3></div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">OPEX Mensual</p><h3 class="text-2xl font-bold text-amber-600 font-mono">$${(kpis.opex_monthly/1000).toFixed(1)}k</h3></div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Alertas</p><h3 class="text-2xl font-bold text-red-500 font-mono">${kpis.active_alerts}</h3></div>
                `;
            }

            renderTable(assets) {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = assets.map(a => `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                        <td class="p-4"><div class="truncate-col font-bold text-slate-700" title="${a.pc_name}">${a.pc_name || 'Sin Nombre'}</div><div class="text-[10px] text-slate-400 font-mono">${a.device_id}</div></td>
                        <td class="p-4"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${a.status==='online'?'bg-emerald-100 text-emerald-700':'bg-red-100 text-red-700'}">${a.status}</span></td>
                        <td class="p-4 text-center"><a href="/techview/detail?device_id=${a.device_id}" class="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-800 hover:text-white transition text-xs">Gestionar</a></td>
                    </tr>
                `).join('');
            }

            renderAlerts(count) {
                const container = document.getElementById('alerts-container');
                container.innerHTML = count > 0 
                    ? `<div class="p-3 bg-red-50 border border-red-100 rounded-lg text-red-700 text-xs font-bold flex gap-2"><span class="material-icons-outlined text-sm">warning</span> Se detectaron ${count} pantallas desconectadas.</div>`
                    : `<div class="p-3 bg-emerald-50 border border-emerald-100 rounded-lg text-emerald-700 text-xs font-bold flex gap-2"><span class="material-icons-outlined text-sm">check_circle</span> Sistema operando normalmente.</div>`;
            }

            renderChart(fin) {
                new Chart(document.getElementById('rentabilityChart'), {
                    type: 'bar',
                    data: { labels: fin.months, datasets: [{label: 'Ventas', data: fin.sales, backgroundColor: '#10B981'}, {label: 'Costos', data: fin.maintenance, backgroundColor: '#F97316'}] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }
        const app = new DashboardApp();
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
