<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Argos TechView - Dashboard Financiero</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#F97316",    // Naranja
                        secondary: "#3B82F6",  // Azul
                        accent: "#8B5CF6",     // Morado
                        success: "#10B981",    // Verde
                        dark: "#0F172A",
                    },
                    fontFamily: { body: ["Inter", "sans-serif"] },
                },
            },
        };
    </script>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .drawer-slide { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .icon-filled { font-variation-settings: 'FILL' 1; }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-body min-h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-[1600px] mx-auto px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="size-10 bg-slate-900 rounded-lg flex items-center justify-center text-primary shadow-lg">
                    <span class="material-icons-outlined">analytics</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900">Argos <span class="text-primary">TechView</span></h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Centro de Rentabilidad</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="hidden md:flex items-center bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100 mr-4">
                    <span class="relative flex h-2.5 w-2.5 mr-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
                    </span>
                    <span class="text-[10px] font-bold text-emerald-700">DB: ONLINE</span>
                </div>

                <button onclick="app.ui.openDrawer('sales')" class="hidden md:flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white text-xs font-bold rounded-lg hover:bg-emerald-700 transition shadow-md shadow-emerald-500/20">
                    <span class="material-icons-outlined text-sm">attach_money</span> REGISTRAR VENTA
                </button>
                
                <button onclick="app.ui.openDrawer('inst')" class="hidden md:flex items-center gap-2 px-4 py-2 bg-slate-800 text-white text-xs font-bold rounded-lg hover:bg-slate-700 transition shadow-md">
                    <span class="material-icons-outlined text-sm">add</span> NUEVA INSTALACIÓN
                </button>

                <div class="h-8 w-px bg-slate-200 mx-2"></div>

                <a href="/" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg font-bold text-xs transition">
                    <span class="material-icons-outlined text-sm">logout</span>
                    Volver a Monitor
                </a>
            </div>
        </div>
    </header>

    <main class="flex-1 w-full max-w-[1600px] mx-auto px-6 py-8 overflow-y-auto custom-scroll">
            
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="kpi-container">
            </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-8 space-y-6">
                
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wider">Flujo de Caja: Ventas vs Mantenimiento</h3>
                            <p class="text-xs text-slate-400">Comparativa mensual de ingresos brutos contra OPEX recurrente.</p>
                        </div>
                        <div class="flex gap-2">
                            <span class="flex items-center gap-1 text-[10px] font-bold text-slate-500"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> Ventas</span>
                            <span class="flex items-center gap-1 text-[10px] font-bold text-slate-500"><div class="w-2 h-2 rounded-full bg-orange-500"></div> Costos</span>
                        </div>
                    </div>
                    <div class="h-72 w-full">
                        <canvas id="rentabilityChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <div>
                            <h2 class="text-lg font-bold text-slate-800">Inventario de Pantallas</h2>
                            <p class="text-xs text-slate-500">Gestión de especificaciones, estado y rentabilidad individual.</p>
                        </div>
                        <button class="bg-white border border-slate-200 p-2 rounded-lg hover:bg-slate-50 text-slate-400 hover:text-slate-600 transition">
                            <span class="material-icons-outlined text-lg">filter_list</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse" id="assets-table">
                            <thead class="bg-slate-50/80 border-b border-slate-100 text-[10px] font-black text-slate-400 uppercase tracking-wider">
                                <tr>
                                    <th class="p-4">Sitio / Clave QTM</th>
                                    <th class="p-4">Especificaciones</th>
                                    <th class="p-4 text-right">Inversión (CAPEX)</th>
                                    <th class="p-4 text-right">Rentabilidad</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 text-sm" id="table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-800 mb-2 uppercase tracking-wider">Distribución CAPEX</h3>
                    <p class="text-xs text-slate-400 mb-6">Desglose de inversión inicial por categoría.</p>
                    <div class="h-48 relative flex justify-center">
                        <canvas id="capexChart"></canvas>
                    </div>
                    <div class="mt-6 space-y-3">
                        <div class="flex justify-between items-center text-xs border-b border-slate-50 pb-2">
                            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-secondary"></div> <span class="text-slate-600 font-medium">Pantallas y Electrónica</span></div>
                            <span class="font-bold text-slate-800">55%</span>
                        </div>
                        <div class="flex justify-between items-center text-xs border-b border-slate-50 pb-2">
                            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-primary"></div> <span class="text-slate-600 font-medium">Obra Civil</span></div>
                            <span class="font-bold text-slate-800">30%</span>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-accent"></div> <span class="text-slate-600 font-medium">Legal y Gestoría</span></div>
                            <span class="font-bold text-slate-800">15%</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wider">Alertas Activas</h3>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-red-100 text-red-600 animate-pulse">EN VIVO</span>
                    </div>
                    <div class="space-y-3" id="alerts-container">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <div id="overlay" class="fixed inset-0 bg-slate-900/40 z-40 hidden backdrop-blur-sm transition-opacity opacity-0" onclick="app.ui.closeDrawer()"></div>
    
    <div id="drawer" class="fixed right-0 top-0 h-full w-full max-w-2xl bg-white z-50 shadow-2xl translate-x-full drawer-slide overflow-hidden flex flex-col">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
            <div>
                <h2 id="d-title" class="text-xl font-bold text-slate-800">Título Formulario</h2>
                <p id="d-subtitle" class="text-xs text-slate-500">Descripción del proceso</p>
            </div>
            <button onclick="app.ui.closeDrawer()" class="p-2 hover:bg-slate-100 rounded-full transition text-slate-500"><span class="material-icons-outlined">close</span></button>
        </div>
        <div id="d-content" class="flex-1 overflow-y-auto custom-scroll p-8 bg-slate-50/50">
            </div>
    </div>

    <script>
        /**
         * ESTRUCTURA MAESTRA DE COSTOS (Lógica de Negocio)
         */
        const COST_STRUCTURE = {
            CAPEX: {
                infraestructura: ["Pantalla LED", "Obra Civil (Base)", "Estructura Metal", "Instalación Eléctrica", "Medidor CFE", "Instalación Datos"],
                electronica: ["NUC (Player)", "UPS", "Sending Card", "Procesador Video", "Módem Inalámbrico", "Módem SIM", "Teltonika", "Cables HDMI", "Cámara"],
                mano_obra: ["Cuadrilla (6 técnicos)", "Viáticos (15 días)", "Gasolina/Transporte Instalación"],
                legal: ["Gestoría Alcaldía", "Licencia Anuncio", "Derechos de Conexión", "Negociación"],
                admin: ["Alta en QTM", "Etiquetado Inventario", "Clave Sitio"]
            },
            OPEX: {
                suministros: ["Energía Eléctrica (CFE)", "Internet (SIM/Fibra)", "Renta de Sitio"],
                software: ["Licencia Broadsign/CMS", "Licencia TeamViewer", "Pauta Programática"]
            }
        };

        /**
         * SERVICIO DE DATOS (Simulación + API)
         */
        class SupabaseService {
            constructor() {
                // Datos "Dummy" para la demostración gráfica
                this.mockData = {
                    kpis: {
                        capex: 2630000,
                        sales_annual: 3200000,
                        opex_monthly: 124500,
                        incidents: 4
                    },
                    financials: {
                        months: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        sales: [450, 480, 520, 510, 590, 620], // Miles
                        maintenance: [120, 115, 130, 125, 140, 110] // Miles
                    }
                };
            }

            async fetchData() {
                // 1. Obtener lista de dispositivos reales desde nuestra API
                let assets = [];
                try {
                    const res = await fetch('/api/techview/inventory');
                    const devices = await res.json();
                    
                    // Enriquecemos los datos reales con datos financieros simulados para el dashboard
                    assets = devices.map(d => ({
                        id: d.device_id,
                        name: d.pc_name || 'Sin Nombre',
                        qtm: `QTM-${Math.floor(Math.random()*1000)}`, // Simulado
                        investment: Math.floor(Math.random() * (1200000 - 400000) + 400000), // Simulado
                        monthly_revenue: Math.floor(Math.random() * (80000 - 30000) + 30000), // Simulado
                        monthly_cost: Math.floor(Math.random() * (15000 - 5000) + 5000), // Simulado
                        status: d.status || 'offline',
                        specs: 'P3.9 Outdoor' // Simulado
                    }));
                } catch (e) {
                    console.error("Error fetching API:", e);
                    // Fallback a datos estáticos si falla la API
                    assets = [
                         { id: 'REF-01', name: 'Torre Reforma LED A', qtm: 'QTM-2024-001', investment: 1200000, monthly_revenue: 85000, monthly_cost: 12000, status: 'online', specs: 'P3.9 Outdoor' }
                    ];
                }

                return {
                    assets: assets,
                    kpis: this.mockData.kpis,
                    financials: this.mockData.financials
                };
            }
        }

        /**
         * GESTOR DE INTERFAZ (UI & Formularios)
         */
        class UIManager {
            constructor() {
                // HTML de los Formularios del Drawer
                this.forms = {
                    inst: {
                        title: "Alta Integral de Activo (CAPEX)",
                        subtitle: "Registro de metadata, obra civil y equipamiento inicial.",
                        html: `
                            <form id="form-capex" class="space-y-6">
                                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                    <h4 class="text-xs font-black text-slate-400 uppercase mb-3 tracking-wide">1. Identificación del Sitio</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="col-span-2">
                                            <label class="block text-[10px] font-bold text-slate-500 mb-1">Nombre Comercial</label>
                                            <input type="text" placeholder="Ej: Espectacular Periférico Norte" class="w-full border-slate-200 rounded-lg text-sm focus:ring-primary focus:border-primary">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] font-bold text-slate-500 mb-1">Clave QTM</label>
                                            <input type="text" placeholder="QTM-XXXX-XXX" class="w-full border-slate-200 rounded-lg text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] font-bold text-slate-500 mb-1">Fecha Instalación</label>
                                            <input type="date" class="w-full border-slate-200 rounded-lg text-sm">
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-black transition shadow-lg">GUARDAR ACTIVACIÓN</button>
                            </form>
                        `
                    },
                    sales: {
                        title: "Registro de Venta Publicitaria",
                        subtitle: "Ingreso de pauta para cálculo de ROI.",
                        html: `
                            <form id="form-sales" class="space-y-6">
                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Ubicación / Pantalla</label>
                                    <select class="w-full border-slate-200 rounded-xl text-sm bg-slate-50 focus:ring-emerald-500">
                                        <option>Seleccionar Ubicación...</option>
                                        <option value="REF-01">Torre Reforma LED A</option>
                                    </select>
                                </div>
                                <button type="button" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-500/20">CONFIRMAR VENTA</button>
                            </form>
                        `
                    }
                };
            }

            renderKPIs(data) {
                const container = document.getElementById('kpi-container');
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Inversión Activos (CAPEX)</p>
                        <div class="flex items-end gap-2">
                            <h3 class="text-2xl font-bold text-slate-900 font-mono">$${(data.capex/1000000).toFixed(2)}M</h3>
                            <span class="text-[10px] text-slate-400 font-medium mb-1">Acumulado</span>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Ventas Anuales</p>
                        <div class="flex items-end gap-2">
                            <h3 class="text-2xl font-bold text-emerald-600 font-mono">$${(data.sales_annual/1000000).toFixed(1)}M</h3>
                            <span class="text-xs font-bold text-emerald-500 pb-1 mb-1">▲ 15%</span>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Gasto Operativo (Mensual)</p>
                        <h3 class="text-2xl font-bold text-amber-600 font-mono">$${(data.opex_monthly/1000).toFixed(1)}k</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Estado de Red</p>
                        <div class="flex items-center gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-red-500 font-mono">0${data.incidents}</h3>
                            <span class="text-xs text-red-400 font-medium italic">Incidencias Activas</span>
                        </div>
                    </div>
                `;
            }

            renderTable(assets) {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = assets.map(asset => {
                    const statusClass = asset.status === 'online' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700';
                    const rentability = ((asset.monthly_revenue - asset.monthly_cost) / asset.monthly_revenue * 100).toFixed(1);
                    
                    return `
                    <tr class="hover:bg-slate-50/50 transition border-b border-slate-50 group">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-slate-100 text-slate-500 flex items-center justify-center font-bold text-xs group-hover:bg-primary group-hover:text-white transition">
                                    ${asset.id.split('-')[0]}
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-700">${asset.name}</p>
                                    <p class="text-[10px] font-mono text-slate-400">${asset.qtm}</p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 text-xs">
                            <div class="flex flex-col gap-1">
                                <span class="font-bold text-slate-600">${asset.specs}</span>
                                <span class="w-fit px-2 py-0.5 rounded ${statusClass} text-[10px] font-bold uppercase">${asset.status}</span>
                            </div>
                        </td>
                        <td class="p-4 text-right font-mono text-xs font-bold text-slate-600">$${asset.investment.toLocaleString()}</td>
                        <td class="p-4 text-right">
                             <div class="flex flex-col items-end">
                                <span class="font-mono font-bold text-emerald-600 text-sm">${rentability}%</span>
                                <span class="text-[10px] text-slate-400">Margen Op.</span>
                             </div>
                        </td>
                        <td class="p-4 text-center">
                            <a href="/techview/detail?device_id=${asset.id}" class="inline-flex items-center gap-1 text-xs bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg hover:bg-slate-800 hover:text-white hover:border-slate-800 transition shadow-sm">
                                Ver Detalle <span class="material-icons-outlined text-[10px]">arrow_forward</span>
                            </a>
                        </td>
                    </tr>
                    `;
                }).join('');
            }

            renderAlerts() {
                const container = document.getElementById('alerts-container');
                container.innerHTML = `
                    <div class="flex gap-3 items-start p-3 bg-red-50/50 rounded-xl border border-red-100 cursor-pointer hover:bg-red-50 transition">
                        <span class="material-icons-outlined text-red-500 text-lg">error_outline</span>
                        <div>
                            <p class="text-[11px] font-bold text-slate-700">Fallo de Envío (Sending Card)</p>
                            <p class="text-[9px] text-slate-500 uppercase">Santa Fe - Mupi B</p>
                        </div>
                    </div>
                `;
            }

            openDrawer(type) {
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('overlay');
                const config = this.forms[type];
                
                if (config) {
                    document.getElementById('d-title').innerText = config.title;
                    document.getElementById('d-subtitle').innerText = config.subtitle || '';
                    document.getElementById('d-content').innerHTML = config.html;
                    
                    overlay.classList.remove('hidden');
                    setTimeout(() => overlay.classList.add('opacity-100'), 10);
                    drawer.classList.remove('translate-x-full');
                }
            }

            closeDrawer() {
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('overlay');
                drawer.classList.add('translate-x-full');
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 400);
            }
        }

        /**
         * GESTOR DE GRÁFICAS (Chart.js)
         */
        class ChartManager {
            renderCharts(data) {
                // Gráfica de Rentabilidad
                const ctxRent = document.getElementById('rentabilityChart').getContext('2d');
                new Chart(ctxRent, {
                    type: 'bar',
                    data: {
                        labels: data.months,
                        datasets: [
                            { label: 'Ventas', data: data.sales, backgroundColor: '#10B981', borderRadius: 6, barPercentage: 0.6 },
                            { label: 'Costos', data: data.maintenance, backgroundColor: '#F97316', borderRadius: 6, barPercentage: 0.6 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                            x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                        }
                    }
                });

                // Gráfica Circular
                const ctxCapex = document.getElementById('capexChart').getContext('2d');
                new Chart(ctxCapex, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pantallas', 'Obra Civil', 'Legal'],
                        datasets: [{
                            data: [55, 30, 15],
                            backgroundColor: ['#3B82F6', '#F97316', '#8B5CF6'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '75%',
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        /**
         * APLICACIÓN PRINCIPAL
         */
        class ArgosApp {
            constructor() {
                this.db = new SupabaseService();
                this.ui = new UIManager();
                this.charts = new ChartManager();
            }

            async init() {
                const data = await this.db.fetchData();
                this.ui.renderKPIs(data.kpis);
                this.ui.renderTable(data.assets);
                this.ui.renderAlerts();
                this.charts.renderCharts(data.financials);
                lucide.createIcons();
            }
        }

        const app = new ArgosApp();
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
