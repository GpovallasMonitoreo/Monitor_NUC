<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Argos DOOH - Executive Command Center</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#F97316", // Naranja Argos
                        secondary: "#3B82F6",
                        success: "#10B981",
                        danger: "#EF4444",
                        dark: "#0F172A",
                        surface: "#FFFFFF",
                        background: "#F8FAFC"
                    },
                    fontFamily: { sans: ["Inter", "sans-serif"] }
                }
            }
        };
    </script>
    
    <style>
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="bg-background text-slate-800 font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-surface border-b border-slate-200 h-16 flex flex-shrink-0 items-center justify-between px-6 shadow-sm z-30">
        <div class="flex items-center gap-4">
            <div class="size-10 bg-dark rounded-xl flex items-center justify-center text-white shadow-lg">
                <span class="material-icons-outlined text-xl">analytics</span>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-900 leading-none">Argos DOOH</h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mt-1">Centro de Comando</p>
            </div>
        </div>

        <div class="flex-1 max-w-2xl mx-8 hidden md:block">
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="material-icons-outlined text-slate-400">search</span>
                </div>
                <input type="text" id="global-search" 
                       class="block w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-xl text-sm focus:ring-2 focus:ring-primary/50 focus:bg-white transition-all placeholder-slate-400 font-medium" 
                       placeholder="Buscar pantalla por ID, ubicación...">
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                    <span class="text-[10px] text-slate-400 font-mono border border-slate-300 rounded px-1.5 py-0.5">CTRL+K</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="app.loadData()" class="p-2 text-slate-500 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition">
                <span class="material-icons-outlined">refresh</span>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6 scroll-smooth custom-scroll w-full mx-auto relative">
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="bg-surface p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                <p class="text-slate-500 text-[11px] font-bold uppercase tracking-wider mb-1">Inversión Total (CAPEX)</p>
                <h3 class="text-2xl font-black text-slate-900 tracking-tight" id="kpi-capex">$0.00</h3>
                <div class="mt-3 h-1 w-full bg-slate-100 rounded-full"><div class="h-full bg-blue-500 w-3/4 rounded-full"></div></div>
            </div>

            <div class="bg-surface p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                <p class="text-slate-500 text-[11px] font-bold uppercase tracking-wider mb-1">Gasto Mensual (OPEX)</p>
                <h3 class="text-2xl font-black text-slate-900 tracking-tight" id="kpi-opex">$0.00</h3>
                <p class="text-xs text-slate-400 mt-1 flex items-center gap-1"><span class="material-icons-outlined text-[14px]">info</span> Recurrente</p>
            </div>

            <div class="bg-surface p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                <p class="text-slate-500 text-[11px] font-bold uppercase tracking-wider mb-1">Ingresos Mensuales</p>
                <div class="flex items-baseline gap-2">
                    <h3 class="text-2xl font-black text-slate-900 tracking-tight" id="kpi-revenue">$0.00</h3>
                    <span class="text-xs font-bold text-success bg-success/10 px-1.5 py-0.5 rounded">Proyectado</span>
                </div>
            </div>

            <div class="bg-surface p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                <p class="text-slate-500 text-[11px] font-bold uppercase tracking-wider mb-1">ROI Promedio</p>
                <div class="flex items-baseline gap-2">
                    <h3 class="text-2xl font-black text-slate-900 tracking-tight" id="kpi-roi">0.0</h3>
                    <span class="text-sm font-medium text-slate-500">meses</span>
                </div>
                <div class="mt-3 flex gap-1"><span class="h-1.5 w-1.5 rounded-full bg-success"></span><span class="text-[10px] text-slate-400 font-medium">Meta: < 24m</span></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 fade-in" style="animation-delay: 0.1s;">
            
            <div class="lg:col-span-8 flex flex-col gap-6">
                <div class="bg-surface rounded-2xl border border-slate-200 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <div class="flex items-center gap-3">
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <span class="material-icons-outlined text-slate-400">inventory_2</span> Inventario
                            </h2>
                            <span class="px-2.5 py-0.5 rounded-full bg-slate-200 text-slate-600 text-xs font-bold" id="asset-count">0</span>
                        </div>
                    </div>

                    <div class="overflow-x-auto flex-1 custom-scroll">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 border-b border-slate-200 sticky top-0 z-10">
                                <tr>
                                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-wider w-1/3">Pantalla / ID</th>
                                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">Finanzas</th>
                                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-wider">ROI</th>
                                    <th class="p-4 text-[10px] font-black text-slate-400 uppercase tracking-wider text-right">Acción</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 text-sm" id="assets-table-body">
                                <tr><td colspan="4" class="p-8 text-center text-slate-400">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 flex flex-col gap-6">
                
                <div class="bg-surface p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wider mb-4">Rentabilidad Global</h3>
                    <div class="relative h-60 w-full">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>

                <div class="bg-surface p-6 rounded-2xl border border-slate-200 shadow-sm flex-1">
                    <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wider mb-4 flex justify-between">
                        <span>Alertas</span>
                        <span class="bg-red-100 text-red-600 text-[10px] px-2 py-0.5 rounded-full" id="alert-count">0</span>
                    </h3>
                    <div class="space-y-3 overflow-y-auto max-h-[250px] custom-scroll" id="alerts-list">
                        <div class="text-center p-4 text-slate-400 text-xs italic">Sin alertas activas</div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        class Dashboard {
            constructor() {
                this.assets = [];
                this.chart = null;
            }

            async init() {
                await this.loadData();
                this.setupSearch();
                // Atajo CTRL+K
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        document.getElementById('global-search').focus();
                    }
                });
            }

            async loadData() {
                try {
                    // LLAMADA AL NUEVO ENDPOINT DEL BACKEND
                    const res = await fetch('/techview/api/dashboard');
                    const data = await res.json();
                    
                    if (data.overview_data) {
                        this.assets = data.overview_data;
                        this.renderKPIs(data.totals);
                        this.renderTable(this.assets);
                        this.renderChart(data.financials_history);
                        this.renderAlerts(this.assets);
                        document.getElementById('asset-count').innerText = data.totals.device_count || 0;
                    }
                } catch (e) {
                    console.error("Error loading dashboard:", e);
                }
            }

            renderKPIs(t) {
                const fmt = n => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);
                document.getElementById('kpi-capex').innerText = fmt(t.total_capex);
                document.getElementById('kpi-opex').innerText = fmt(t.total_monthly_opex);
                document.getElementById('kpi-revenue').innerText = fmt(t.total_monthly_revenue);
                document.getElementById('kpi-roi').innerText = (t.average_roi || 0).toFixed(1);
            }

            renderTable(data) {
                const tbody = document.getElementById('assets-table-body');
                if (!data.length) { tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-xs text-slate-400">Sin resultados.</td></tr>`; return; }

                tbody.innerHTML = data.map(item => `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-50 group">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="h-8 w-8 rounded bg-slate-200 flex items-center justify-center text-slate-500 font-bold text-xs shrink-0">LED</div>
                                <div class="min-w-0">
                                    <p class="font-bold text-slate-700 text-sm truncate max-w-[180px]">${item.pc_name || item.device_id}</p>
                                    <p class="text-[10px] text-slate-400 font-mono truncate max-w-[150px]">${item.device_id}</p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4">
                            <span class="text-xs font-bold ${item.monthly_margin > 0 ? 'text-emerald-600' : 'text-red-600'}">
                                $${item.monthly_margin?.toLocaleString()}
                            </span>
                            <span class="text-[10px] text-slate-400 block">Margen Mensual</span>
                        </td>
                        <td class="p-4">
                            <span class="text-xs font-bold text-slate-700">${item.roi_months?.toFixed(1)} m</span>
                        </td>
                        <td class="p-4 text-right">
                            <a href="/techview/management?device_id=${encodeURIComponent(item.device_id)}" 
                               class="inline-flex items-center px-3 py-1.5 bg-white border border-slate-200 hover:border-primary hover:text-primary text-slate-600 rounded-lg text-xs font-bold transition shadow-sm">
                                Gestionar
                            </a>
                        </td>
                    </tr>
                `).join('');
            }

            renderChart(hist) {
                const ctx = document.getElementById('financialChart').getContext('2d');
                if(this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: hist.months,
                        datasets: [
                            { label: 'Ventas', data: hist.sales, backgroundColor: '#10B981', borderRadius: 4 },
                            { label: 'Costos', data: hist.costs, backgroundColor: '#EF4444', borderRadius: 4 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { x: { grid: { display: false } }, y: { display: false } } }
                });
            }

            renderAlerts(data) {
                const alerts = data.filter(d => d.monthly_margin < 0 || d.status === 'offline');
                document.getElementById('alert-count').innerText = alerts.length;
                const container = document.getElementById('alerts-list');
                
                if (alerts.length === 0) {
                    container.innerHTML = '<div class="text-center p-4 text-slate-400 text-xs italic">Sistema estable.</div>';
                    return;
                }

                container.innerHTML = alerts.map(a => `
                    <div class="p-3 rounded-xl border flex gap-3 items-start ${a.monthly_margin < 0 ? 'bg-red-50 border-red-100 text-red-700' : 'bg-amber-50 border-amber-100 text-amber-700'}">
                        <span class="material-icons-outlined text-sm mt-0.5">${a.monthly_margin < 0 ? 'trending_down' : 'wifi_off'}</span>
                        <div>
                            <p class="text-xs font-bold leading-tight">${a.monthly_margin < 0 ? 'Déficit Financiero' : 'Desconectado'}</p>
                            <p class="text-[10px] opacity-80 truncate max-w-[150px]">${a.device_id}</p>
                        </div>
                    </div>
                `).join('');
            }

            setupSearch() {
                document.getElementById('global-search').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = this.assets.filter(a => 
                        a.device_id.toLowerCase().includes(term) || 
                        (a.pc_name && a.pc_name.toLowerCase().includes(term))
                    );
                    this.renderTable(filtered);
                });
            }
        }

        const app = new Dashboard();
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
