{% extends 'base.html' %}
{% block title %}Bitácora Global - Argos{% endblock %}
{% block header_title %}Bitácora de Operaciones y Mantenimiento{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div class="space-y-6 max-w-[1800px] mx-auto p-6">
    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 justify-between items-center">
        <div class="flex items-center gap-4 w-full md:w-auto"><h3 class="font-bold text-slate-800 whitespace-nowrap">Registro Histórico</h3><span class="bg-indigo-50 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full" id="log-count">Cargando...</span></div>
        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
            <select id="filter-unit" class="text-sm border-slate-300 rounded-lg focus:ring-indigo-500 bg-slate-50"><option value="all">Todas las Unidades</option><option value="ECOVALLAS">Ecovallas</option><option value="VIAVERDE">Via Verde</option><option value="BIOBOX">BioBox</option></select>
            <select id="filter-status" class="text-sm border-slate-300 rounded-lg focus:ring-indigo-500 bg-slate-50"><option value="all">Todos los Estados</option><option value="active">Activos</option><option value="inactive">Inactivos / Baja</option></select>
            <div class="relative w-full md:w-64"><i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i><input type="text" id="search-input" placeholder="Buscar ubicación, técnico..." class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm w-full focus:ring-indigo-500 outline-none"></div>
            <button onclick="exportFilteredData()" class="bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold px-4 py-2 rounded-lg transition flex items-center justify-center gap-2 shadow-sm"><i data-lucide="download" class="w-4 h-4"></i> CSV</button>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse" id="bitacora-table">
                <thead><tr class="bg-slate-900 text-white"><th class="px-6 py-4 text-xs font-bold uppercase tracking-wider">Fecha</th><th class="px-6 py-4 text-xs font-bold uppercase tracking-wider">Ubicación / NUC</th><th class="px-6 py-4 text-xs font-bold uppercase tracking-wider">Unidad</th><th class="px-6 py-4 text-xs font-bold uppercase tracking-wider">Acción</th><th class="px-6 py-4 text-xs font-bold uppercase tracking-wider w-1/3">Descripción</th><th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-center">Estado Activo</th><th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-center">Solución</th></tr></thead>
                <tbody class="divide-y divide-slate-200" id="bitacora-body"><tr><td colspan="7" class="px-6 py-10 text-center text-slate-400"><div class="flex justify-center items-center gap-2"><i data-lucide="loader-2" class="animate-spin"></i> Cargando datos reales...</div></td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); fetchLogs(); });
let allLogs = [];

async function fetchLogs() {
    try {
        const response = await fetch('/api/history/all');
        const data = await response.json();
        if (Array.isArray(data)) { allLogs = data; renderTable(allLogs); } 
        else { document.getElementById('bitacora-body').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error al cargar datos. Verifique conexión.</td></tr>'; }
    } catch (error) { console.error("Error fetch:", error); }
}

function renderTable(logs) {
    const tbody = document.getElementById('bitacora-body');
    const countBadge = document.getElementById('log-count');
    tbody.innerHTML = '';
    countBadge.textContent = `${logs.length} Registros`;
    if (logs.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400 italic">No se encontraron registros con estos filtros.</td></tr>'; return; }

    logs.forEach(log => {
        const dateObj = new Date(log.timestamp);
        const dateStr = !isNaN(dateObj) ? dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : log.timestamp;
        let unitBadge = 'bg-slate-100 text-slate-700';
        const unit = (log.unit_snapshot || 'General').toUpperCase();
        if(unit.includes('VIA')) unitBadge = 'bg-emerald-50 text-emerald-700 border border-emerald-100';
        if(unit.includes('ECO')) unitBadge = 'bg-indigo-50 text-indigo-700 border border-indigo-100';
        if(unit.includes('BIO')) unitBadge = 'bg-sky-50 text-sky-700 border border-sky-100';
        let isActive = true;
        const action = (log.action_type || '').toLowerCase();
        if(action.includes('baja') || action.includes('retiro') || (log.status_snapshot === 'inactive')) isActive = false;
        const statusHtml = isActive ? '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-bold bg-green-100 text-green-700"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> ACTIVO</span>' : '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-500"><span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span> INACTIVO</span>';
        
        tbody.innerHTML += `<tr class="hover:bg-slate-50 transition-colors group text-sm"><td class="px-6 py-4 whitespace-nowrap text-slate-500 font-mono text-xs">${dateStr}</td><td class="px-6 py-4"><div class="font-bold text-slate-800">${log.location_snapshot || 'Desconocido'}</div><div class="text-xs text-slate-400">${log.device_id || ''}</div></td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${unitBadge}">${unit}</span></td><td class="px-6 py-4"><span class="font-semibold text-slate-700 block">${log.action_type}</span><span class="text-xs text-slate-500">${log.component}</span></td><td class="px-6 py-4"><p class="text-slate-600 line-clamp-2" title="${log.description}">${log.description}</p><div class="mt-1 text-xs text-slate-400 flex gap-3"><span><i data-lucide="user" class="w-3 h-3 inline"></i> ${log.requester}</span><span><i data-lucide="wrench" class="w-3 h-3 inline"></i> ${log.executor}</span></div></td><td class="px-6 py-4 text-center">${statusHtml}</td><td class="px-6 py-4 text-center">${(log.is_resolved === true || log.is_resolved === 'true') ? '<i data-lucide="check-circle" class="w-5 h-5 text-emerald-500 mx-auto"></i>' : '<i data-lucide="clock" class="w-5 h-5 text-amber-500 mx-auto"></i>'}</td></tr>`;
    });
    lucide.createIcons();
}

function applyFilters() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const unitFilter = document.getElementById('filter-unit').value.toUpperCase();
    const statusFilter = document.getElementById('filter-status').value;
    const filtered = allLogs.filter(log => {
        const textMatch = JSON.stringify(log).toLowerCase().includes(searchTerm);
        const logUnit = (log.unit_snapshot || '').toUpperCase();
        let unitMatch = (unitFilter === 'ALL') ? true : logUnit.includes(unitFilter);
        let statusMatch = true;
        const action = (log.action_type || '').toLowerCase();
        const isInactive = action.includes('baja') || action.includes('retiro') || log.status_snapshot === 'inactive';
        if (statusFilter === 'active') statusMatch = !isInactive;
        if (statusFilter === 'inactive') statusMatch = isInactive;
        return textMatch && unitMatch && statusMatch;
    });
    renderTable(filtered);
    return filtered;
}

document.getElementById('search-input').addEventListener('input', applyFilters);
document.getElementById('filter-unit').addEventListener('change', applyFilters);
document.getElementById('filter-status').addEventListener('change', applyFilters);

function exportFilteredData() {
    const dataToExport = applyFilters();
    if (dataToExport.length === 0) return alert("No hay datos para exportar.");
    const formattedData = dataToExport.map(log => ({ Fecha: log.timestamp, Ubicacion: log.location_snapshot, Unidad: log.unit_snapshot, Tipo_Accion: log.action_type, Componente: log.component, Descripcion: log.description, Solicitante: log.requester, Ejecutor: log.executor, Resuelto: log.is_resolved, Estado: (log.action_type || '').toLowerCase().includes('baja') ? 'INACTIVO' : 'ACTIVO' }));
    const ws = XLSX.utils.json_to_sheet(formattedData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Bitacora_Filtrada");
    XLSX.writeFile(wb, `Bitacora_Argos_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
{% endblock %}
