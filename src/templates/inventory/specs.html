{% extends 'base.html' %}
{% block title %}Bitácora Global - Argos{% endblock %}
{% block header_title %}Bitácora de Operaciones y Mantenimiento{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div class="space-y-6 max-w-[1800px] mx-auto p-6">
    <div class="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
        <div class="flex items-center gap-4">
            <h3 class="font-bold text-slate-800">Registro Histórico de Cambios</h3>
            <span class="bg-indigo-50 text-indigo-700 text-xs font-bold px-2 py-1 rounded-full" id="log-count">0 Registros</span>
        </div>
        <div class="flex gap-4">
            <button onclick="exportTableToCSV()" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 flex items-center bg-indigo-50 px-3 py-2 rounded-lg transition">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i> Exportar Excel
            </button>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse" id="bitacora-table">
                <thead>
                    <tr class="bg-slate-900 text-white">
                        <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider">Fecha / Tiempo</th>
                        <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider">Ubicación / NUC</th>
                        <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider">Tipo & Componente</th>
                        <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider w-1/3">Descripción del Cambio</th>
                        <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-center">Responsables</th>
                        <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-center">Estado</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200" id="bitacora-body">
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-slate-400 italic">
                            Cargando registros del sistema...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg flex items-start">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600 mr-3 mt-0.5"></i>
        <p class="text-xs text-amber-800">
            <strong>Nota de Auditoría:</strong> Esta bitácora es inmutable. Los registros de "Cambio" o "Instalación" actualizan automáticamente la ficha técnica del activo asociado.
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    loadLogs();
});

// Función para cargar logs (Simulación - Conectar a AppSheet aquí)
function loadLogs() {
    // Ejemplo de datos que vendrían de tu API / AppSheet
    const mockLogs = [
        {
            date: new Date().toISOString(),
            loc: 'MX_CM_EV_01',
            unit: 'Ecovallas',
            type: 'Mantenimiento',
            what: 'Limpieza Fans',
            desc: 'Se realizó sopleteo de ventiladores por alerta térmica.',
            req: 'Sistema AI',
            exec: 'Juan Pérez',
            solved: true
        },
        {
            date: '2023-10-25T14:30:00',
            loc: 'MX_GDL_VV_05',
            unit: 'ViaVerde',
            type: 'Instalación',
            what: 'NUC 11 Pro',
            desc: 'Despliegue inicial en sitio nuevo. Configuración estándar.',
            req: 'Gerencia Ops',
            exec: 'Ana López',
            solved: true
        }
    ];

    const tbody = document.getElementById('bitacora-body');
    tbody.innerHTML = '';
    
    document.getElementById('log-count').textContent = `${mockLogs.length} Registros`;

    mockLogs.forEach(log => {
        const timeAgo = Math.floor((new Date() - new Date(log.date)) / (1000 * 60 * 60 * 24));
        const dateStr = new Date(log.date).toLocaleDateString();
        
        let typeColor = 'bg-slate-100 text-slate-700';
        if(log.type === 'Mantenimiento') typeColor = 'bg-blue-50 text-blue-700';
        if(log.type === 'Instalación') typeColor = 'bg-emerald-50 text-emerald-700';
        if(log.type === 'Renovación') typeColor = 'bg-purple-50 text-purple-700';

        const row = `
            <tr class="hover:bg-indigo-50 transition-colors group">
                <td class="px-6 py-4">
                    <span class="font-bold text-slate-800 block">${dateStr}</span>
                    <span class="text-[10px] text-slate-400">Hace ${timeAgo} días</span>
                </td>
                <td class="px-6 py-4">
                    <span class="font-bold text-indigo-600 block">${log.loc}</span>
                    <span class="text-[10px] text-slate-500 uppercase font-bold">${log.unit}</span>
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 rounded text-xs font-bold ${typeColor}">${log.type}</span>
                    <div class="text-xs text-slate-500 mt-1 font-medium">${log.what}</div>
                </td>
                <td class="px-6 py-4 text-sm text-slate-600 leading-relaxed">
                    ${log.desc}
                </td>
                <td class="px-6 py-4 text-center">
                    <div class="text-xs text-slate-500 text-left">
                        <div><span class="font-bold text-slate-400">Sol:</span> ${log.req}</div>
                        <div><span class="font-bold text-slate-400">Eje:</span> ${log.exec}</div>
                    </div>
                </td>
                <td class="px-6 py-4 text-center">
                    ${log.solved 
                        ? '<span class="inline-flex items-center text-emerald-600 bg-emerald-50 px-2 py-1 rounded text-xs font-bold"><i data-lucide="check" class="w-3 h-3 mr-1"></i> Resuelto</span>' 
                        : '<span class="inline-flex items-center text-amber-600 bg-amber-50 px-2 py-1 rounded text-xs font-bold">Pendiente</span>'}
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
    lucide.createIcons();
}

function exportTableToCSV() {
    const table = document.getElementById("bitacora-table");
    const wb = XLSX.utils.table_to_book(table, {sheet: "Bitacora"});
    XLSX.writeFile(wb, "Bitacora_Argos.xlsx");
}
</script>
{% endblock %}
