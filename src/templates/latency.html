{% extends 'base.html' %}
{% block header_title %}Centro de Monitoreo de Latencia y Hardware{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
    .card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 1.25rem; transition: all 0.2s; position: relative; overflow: hidden; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: #6366f1; }
    .latency-grid { display: flex; gap: 2px; margin-top: 8px; height: 10px; width: 100%; }
    .latency-block { flex: 1; background-color: #e2e8f0; border-radius: 1px; }
    .lb-low { background-color: #10b981; } .lb-med { background-color: #f59e0b; } .lb-high { background-color: #ef4444; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .status-online { background: #10b981; box-shadow: 0 0 8px #10b981; } .status-offline { background: #ef4444; box-shadow: 0 0 8px #ef4444; } .status-warning { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
    #pc-modal-overlay { z-index: 999; } 
    .modal-tab { padding: 1rem; border-bottom: 2px solid transparent; font-weight: 600; color: #64748b; cursor: pointer; }
    .modal-tab.active { color: #4f46e5; border-color: #4f46e5; background: #eff6ff; }
    .timeline-item { position: relative; padding-left: 2rem; padding-bottom: 2rem; border-left: 2px solid #e2e8f0; }
    .timeline-item:last-child { border-left: 2px solid transparent; }
    .timeline-dot { position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: white; border: 3px solid #cbd5e1; }
    
    /* Alertas */
    .alert-container { position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px; }
    .alert { padding: 12px 16px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .alert-success { background: #10b981; color: white; border-left: 4px solid #059669; }
    .alert-warning { background: #f59e0b; color: white; border-left: 4px solid #d97706; }
    .alert-error { background: #ef4444; color: white; border-left: 4px solid #dc2626; }
    .alert-info { background: #3b82f6; color: white; border-left: 4px solid #2563eb; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    
    /* Score de salud */
    .health-score-excellent { color: #10b981; }
    .health-score-good { color: #3b82f6; }
    .health-score-warning { color: #f59e0b; }
    .health-score-critical { color: #ef4444; }
</style>

<!-- Container para alertas -->
<div id="alert-container" class="alert-container"></div>

<div class="p-6 max-w-[1800px] mx-auto">
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
        <div>
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="activity" class="text-indigo-600"></i> Estado de Activos
            </h2>
            <div class="flex items-center gap-3 mt-1">
                <span id="update-status" class="text-xs text-slate-500">Conectando...</span>
                <span id="device-count" class="text-xs font-bold bg-slate-100 px-2 py-1 rounded">0 dispositivos</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <select id="unit-filter" class="p-2 text-sm border border-slate-300 rounded-lg focus:ring-indigo-500 outline-none">
                <option value="all">Todas las Unidades</option>
            </select>
            <input type="search" id="search-bar" placeholder="Buscar..." class="p-2 text-sm border border-slate-300 rounded-lg w-64 focus:ring-indigo-500 outline-none">
            <button onclick="forceRefresh()" class="p-2 text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-lg">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
    
    <div id="loading-indicator" class="flex justify-center p-10">
        <div class="text-center">
            <i data-lucide="loader-2" class="animate-spin text-indigo-600 w-8 h-8 mx-auto"></i>
            <p class="text-sm text-slate-500 mt-2">Cargando datos en tiempo real...</p>
        </div>
    </div>
    
    <div id="pc-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    
    <div class="mt-8 text-center text-xs text-slate-400">
        <p>Actualizaci√≥n autom√°tica cada 3 segundos ‚Ä¢ √öltima actualizaci√≥n: <span id="last-update-time">--:--:--</span></p>
    </div>
</div>

<!-- Modal -->
<div id="pc-modal-overlay" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden items-center justify-center p-4">
    <div id="pc-modal-container" class="bg-white w-full max-w-6xl h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
        <div class="flex justify-between items-start p-6 border-b border-slate-100 bg-white sticky top-0 z-10">
            <div>
                <h2 id="modal-pc-name" class="text-2xl font-bold text-slate-800"></h2>
                <div id="modal-status-line" class="mt-1 flex items-center gap-2 text-sm"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportToPDF()" class="text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-lg text-sm font-bold border border-indigo-200 transition flex items-center gap-2">
                    <i data-lucide="file-down" class="w-4 h-4"></i> Ficha
                </button>
                <button onclick="closeModal()" class="text-slate-400 hover:text-rose-500 hover:bg-rose-50 p-2 rounded-lg transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
        
        <div class="border-b border-slate-200 bg-white px-6">
            <nav class="flex space-x-1" id="modal-tabs">
                <button data-tab="general" class="modal-tab active">General</button>
                <button data-tab="hardware" class="modal-tab">Hardware</button>
                <button data-tab="predictive" class="modal-tab">Diagn√≥stico IA</button>
                <button data-tab="specs" class="modal-tab">Ficha & Bit√°cora</button>
            </nav>
        </div>
        
        <div class="p-8 overflow-y-auto bg-slate-50 flex-1">
            <!-- Contenido de las pesta√±as (igual que antes) -->
            <div id="tab-general" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">IDENTIDAD</h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-500">Unidad</span>
                                <span id="gen-unit" class="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">IP</span>
                                <span id="gen-ip" class="font-mono text-slate-700"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">√öltima actualizaci√≥n</span>
                                <span id="gen-seen" class="text-slate-700 font-medium"></span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">CARGA</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span>CPU</span>
                                    <span id="gen-cpu-val" class="font-bold"></span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5">
                                    <div id="gen-cpu-bar" class="bg-indigo-500 h-1.5 rounded-full" style="width:0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span>RAM</span>
                                    <span id="gen-ram-val" class="font-bold"></span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5">
                                    <div id="gen-ram-bar" class="bg-purple-500 h-1.5 rounded-full" style="width:0%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span>DISCO</span>
                                    <span id="gen-disk-val" class="font-bold"></span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5">
                                    <div id="gen-disk-bar" class="bg-amber-500 h-1.5 rounded-full" style="width:0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center justify-center">
                        <div id="health-icon-container" class="mb-1"></div>
                        <span id="health-score-val" class="text-4xl font-black health-score-excellent">--%</span>
                        <span class="text-[10px] font-bold text-slate-400 uppercase">SCORE ARGOS</span>
                        <div id="health-indicators" class="mt-2 text-xs text-center text-slate-500"></div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-[320px]">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">TELEMETR√çA DE RED (√öltimas 12 mediciones)</h4>
                    <canvas id="latency-chart"></canvas>
                </div>
            </div>
            
            <!-- Otras pesta√±as (hardware, predictive, specs) se mantienen igual -->
            <div id="tab-hardware" class="tab-content hidden">
                <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-lg mb-6">
                    <p class="text-xs text-indigo-800 font-medium">
                        <i data-lucide="info" class="w-4 h-4 inline mr-1"></i> Lectura directa de sensores.
                    </p>
                </div>
                <div id="hardware-full-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>
            
            <div id="tab-predictive" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-slate-800">Argos AI</h3>
                    <button onclick="runManualAnalysis()" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition">
                        <i data-lucide="play" class="w-4 h-4"></i> Ejecutar An√°lisis
                    </button>
                </div>
                <div id="ai-loading" class="hidden p-8 text-center text-indigo-600">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                    <p>Procesando...</p>
                </div>
                <div id="ai-results" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-full">
                        <h4 class="font-bold text-slate-700 mb-4 flex items-center">
                            <i data-lucide="search" class="w-4 h-4 mr-2 text-indigo-500"></i>Hallazgos
                        </h4>
                        <div id="ai-anomalies-list" class="space-y-3 text-sm"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-full">
                        <h4 class="font-bold text-slate-700 mb-4 flex items-center">
                            <i data-lucide="check-circle-2" class="w-4 h-4 mr-2 text-emerald-500"></i>Recomendaciones
                        </h4>
                        <div id="ai-recommendations-list" class="space-y-3 text-sm"></div>
                    </div>
                </div>
            </div>
            
            <div id="tab-specs" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-8 space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg text-slate-800">Bit√°cora</h3>
                            <button onclick="toggleForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nueva Entrada
                            </button>
                        </div>
                        <div id="log-form-container" class="hidden bg-slate-50 p-6 rounded-xl border border-indigo-100">
                            <form id="new-log-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2 bg-white p-3 rounded border border-slate-200 grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-[10px] uppercase font-bold text-slate-400">Ubicaci√≥n</label>
                                        <div id="form-loc" class="font-bold text-sm"></div>
                                    </div>
                                    <div>
                                        <label class="text-[10px] uppercase font-bold text-slate-400">Unidad</label>
                                        <div id="form-unit" class="font-bold text-sm"></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500">Solicita</label>
                                    <input type="text" id="log-req" class="w-full mt-1 p-2 border rounded text-sm bg-white">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500">Ejecuta</label>
                                    <input type="text" id="log-exec" class="w-full mt-1 p-2 border rounded text-sm bg-white">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500">Tipo</label>
                                    <select id="log-action" class="w-full mt-1 p-2 border rounded text-sm bg-white">
                                        <option value="Mantenimiento">Mantenimiento</option>
                                        <option value="Incidente">Incidente</option>
                                        <option value="Renovaci√≥n">Renovaci√≥n</option>
                                        <option value="Baja">Baja</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500">Componente</label>
                                    <input type="text" id="log-what" class="w-full mt-1 p-2 border rounded text-sm bg-white" placeholder="Ej: Disco">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="text-xs font-bold text-slate-500">Descripci√≥n</label>
                                    <textarea id="log-desc" rows="2" class="w-full mt-1 p-2 border rounded text-sm bg-white"></textarea>
                                </div>
                                <div class="md:col-span-2 flex items-center gap-2">
                                    <input type="checkbox" id="log-solved" class="rounded text-indigo-600" checked>
                                    <label for="log-solved" class="text-sm font-bold text-emerald-700">¬øResuelto?</label>
                                </div>
                                <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                                    <button type="button" onclick="toggleForm()" class="px-4 py-2 text-sm text-slate-500">Cancelar</button>
                                    <button type="button" onclick="saveLog()" class="px-6 py-2 text-sm bg-slate-900 text-white font-bold rounded hover:bg-slate-700">Guardar</button>
                                </div>
                            </form>
                        </div>
                        <div id="history-timeline" class="space-y-0"></div>
                    </div>
                    <div class="lg:col-span-4">
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm sticky top-0">
                            <h3 class="font-bold text-slate-800 mb-4 pb-2 border-b">Ficha T√©cnica</h3>
                            <div class="space-y-4 text-sm" id="specs-summary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = '/api/realtime'; // Cambiado a endpoint de tiempo real
    const REFRESH_INTERVAL = 3000; // 3 segundos
    
    let pcDataStore = {};
    let previousPcDataStore = {};
    let currentPc = null;
    let charts = { latency: null };
    let updateInterval;
    let alertCooldown = {}; // Para evitar alertas repetitivas

    lucide.createIcons();

    // Sistema de alertas
    function showAlert(message, type = 'info', duration = 5000) {
        const alertContainer = document.getElementById('alert-container');
        if (!alertContainer) return;
        
        const alertId = 'alert-' + Date.now();
        const alert = document.createElement('div');
        alert.id = alertId;
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `
            <i data-lucide="${getAlertIcon(type)}" class="w-5 h-5 flex-shrink-0"></i>
            <div class="flex-1 text-sm">${message}</div>
            <button onclick="document.getElementById('${alertId}').remove()" class="text-white/80 hover:text-white">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        `;
        
        alertContainer.appendChild(alert);
        lucide.createIcons();
        
        // Auto-remover despu√©s de la duraci√≥n
        setTimeout(() => {
            const alertEl = document.getElementById(alertId);
            if (alertEl) {
                alertEl.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => alertEl.remove(), 300);
            }
        }, duration);
        
        return alertId;
    }

    function getAlertIcon(type) {
        const icons = {
            'success': 'check-circle',
            'warning': 'alert-triangle',
            'error': 'alert-circle',
            'info': 'info'
        };
        return icons[type] || 'info';
    }

    // Verificar cambios significativos
    function checkForSignificantChanges(oldDevice, newDevice) {
        if (!oldDevice || !newDevice) return null;
        
        const changes = [];
        const deviceName = newDevice.pc_name;
        
        // Verificar latencia
        const oldLatency = oldDevice.latency_ms || oldDevice.latency || 0;
        const newLatency = newDevice.latency_ms || newDevice.latency || 0;
        
        // Cooldown key para evitar alertas repetitivas
        const cooldownKey = `${deviceName}-latency`;
        
        if (oldLatency > 0 && newLatency > 0) {
            const changePercent = ((newLatency - oldLatency) / oldLatency) * 100;
            
            // Latencia mejor√≥ significativamente
            if (newLatency < oldLatency * 0.7 && oldLatency > 50) {
                if (!alertCooldown[cooldownKey] || Date.now() - alertCooldown[cooldownKey] > 60000) {
                    changes.push({
                        type: 'success',
                        message: `‚úÖ ${deviceName}: Latencia mejor√≥ ${oldLatency}ms ‚Üí ${newLatency}ms (-${Math.abs(Math.round(changePercent))}%)`
                    });
                    alertCooldown[cooldownKey] = Date.now();
                }
            }
            
            // Latencia empeor√≥ significativamente
            if (newLatency > oldLatency * 1.5 && newLatency > 80) {
                if (!alertCooldown[cooldownKey] || Date.now() - alertCooldown[cooldownKey] > 60000) {
                    changes.push({
                        type: 'warning',
                        message: `‚ö†Ô∏è ${deviceName}: Latencia aument√≥ ${oldLatency}ms ‚Üí ${newLatency}ms (+${Math.round(changePercent)}%)`
                    });
                    alertCooldown[cooldownKey] = Date.now();
                }
            }
            
            // Latencia cr√≠tica
            if (newLatency > 200 && oldLatency <= 200) {
                changes.push({
                    type: 'error',
                    message: `üî¥ ${deviceName}: Latencia CR√çTICA ${newLatency}ms`
                });
            }
        }
        
        // Verificar estado (online/offline)
        if (oldDevice.status !== newDevice.status) {
            if (newDevice.status === 'offline') {
                changes.push({
                    type: 'error',
                    message: `üî¥ ${deviceName} se desconect√≥`
                });
            } else if (newDevice.status === 'online' && oldDevice.status === 'offline') {
                changes.push({
                    type: 'success',
                    message: `üü¢ ${deviceName} se reconect√≥`
                });
            }
        }
        
        // Verificar CPU alta
        const oldCpu = oldDevice.cpu_load_percent || 0;
        const newCpu = newDevice.cpu_load_percent || 0;
        
        if (newCpu > 90 && oldCpu <= 90) {
            changes.push({
                type: 'warning',
                message: `‚ö†Ô∏è ${deviceName}: CPU alta ${newCpu}%`
            });
        }
        
        return changes;
    }

    async function updateData() {
        try {
            const updateStatus = document.getElementById('update-status');
            updateStatus.textContent = 'Actualizando...';
            updateStatus.className = 'text-xs text-amber-500';
            
            const timestamp = new Date();
            document.getElementById('last-update-time').textContent = 
                timestamp.toLocaleTimeString();
            
            const res = await fetch(API_URL + '?t=' + Date.now()); // Cache busting
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const rawData = await res.json();
            
            // Guardar datos anteriores para comparar
            previousPcDataStore = { ...pcDataStore };
            
            // Procesar nuevos datos
            const devices = Object.values(rawData);
            let hasChanges = false;
            
            devices.forEach(dev => {
                const deviceId = dev.pc_name;
                const oldDevice = previousPcDataStore[deviceId];
                
                // Verificar si hay cambios
                if (!oldDevice || JSON.stringify(dev) !== JSON.stringify(oldDevice)) {
                    pcDataStore[deviceId] = dev;
                    hasChanges = true;
                    
                    // Verificar cambios significativos para alertas
                    if (oldDevice) {
                        const changes = checkForSignificantChanges(oldDevice, dev);
                        if (changes && changes.length > 0) {
                            changes.forEach(change => {
                                showAlert(change.message, change.type);
                            });
                        }
                    }
                }
            });
            
            // Actualizar UI solo si hay cambios
            if (hasChanges) {
                renderGrid();
                
                // Actualizar contador de dispositivos
                const onlineCount = devices.filter(d => d.status === 'online').length;
                const totalCount = devices.length;
                document.getElementById('device-count').textContent = 
                    `${onlineCount}/${totalCount} dispositivos`;
                
                // Si hay un dispositivo abierto en modal, actualizarlo
                if (currentPc && pcDataStore[currentPc]) {
                    refreshModalData(false);
                }
            }
            
            updateStatus.textContent = 'Conectado';
            updateStatus.className = 'text-xs text-emerald-500';
            document.getElementById('loading-indicator').style.display = 'none';
            
        } catch (e) {
            console.error('Error en updateData:', e);
            document.getElementById('update-status').textContent = 'Error de conexi√≥n';
            document.getElementById('update-status').className = 'text-xs text-rose-500';
            
            // Mostrar alerta de error solo cada 30 segundos
            if (!alertCooldown['connection-error'] || Date.now() - alertCooldown['connection-error'] > 30000) {
                showAlert('Error conectando al servidor', 'error');
                alertCooldown['connection-error'] = Date.now();
            }
        }
    }

    function renderGrid() {
        const container = document.getElementById('pc-cards-container');
        const search = document.getElementById('search-bar').value.toLowerCase();
        const unitFilter = document.getElementById('unit-filter').value;
        
        let html = '';
        let deviceCount = 0;
        
        Object.values(pcDataStore).forEach(pc => {
            if (unitFilter !== 'all' && pc.unit !== unitFilter) return;
            if (!pc.pc_name.toLowerCase().includes(search) && !(pc.public_ip||'').includes(search)) return;
            
            deviceCount++;
            
            let statusClass = 'status-offline';
            let statusText = 'Offline';
            
            if (pc.status === 'online') {
                if (pc.cpu_load_percent > 90 || (pc.latency_ms > 200)) {
                    statusClass = 'status-warning';
                    statusText = 'Cr√≠tico';
                } else if (pc.cpu_load_percent > 80 || (pc.latency_ms > 100)) {
                    statusClass = 'status-warning';
                    statusText = 'Alerta';
                } else {
                    statusClass = 'status-online';
                    statusText = 'Online';
                }
            }
            
            // Generar gr√°fico de latencia
            let latencyBarHtml = '<div class="latency-grid">';
            const history = pc.latency_history || Array(12).fill(0);
            
            // Asegurar que siempre tengamos 12 valores
            const displayHistory = [...history];
            while (displayHistory.length < 12) displayHistory.push(0);
            if (displayHistory.length > 12) displayHistory.splice(0, displayHistory.length - 12);
            
            displayHistory.forEach((val, index) => {
                let colorClass = 'bg-slate-100';
                if (val > 0) {
                    if (val > 100) colorClass = 'lb-high';
                    else if (val > 50) colorClass = 'lb-med';
                    else colorClass = 'lb-low';
                }
                latencyBarHtml += `<div class="latency-block ${colorClass}" title="${index+1}: ${val}ms"></div>`;
            });
            latencyBarHtml += '</div>';
            
            // Calcular salud
            const healthScore = pc.health_score || calculateHealthScore(pc);
            const healthClass = getHealthScoreClass(healthScore);
            
            html += `
                <div class="card cursor-pointer group hover:border-indigo-400" onclick="openModal('${pc.pc_name}')" data-pc="${pc.pc_name}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="truncate pr-2">
                            <h3 class="font-bold text-slate-800 text-sm truncate group-hover:text-indigo-600">${pc.pc_name}</h3>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">${pc.unit}</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="status-dot ${statusClass} flex-shrink-0 mb-1" title="${statusText}"></div>
                            <span class="text-[10px] font-bold ${healthClass}">${healthScore}%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-end mt-1">
                        <span class="text-2xl font-black text-slate-700">
                            ${pc.latency_ms || 0}<span class="text-xs text-slate-400 font-bold ml-1">ms</span>
                        </span>
                        <div class="text-right">
                            <span class="text-xs font-bold text-slate-500 block">CPU: ${Math.round(pc.cpu_load_percent||0)}%</span>
                            <span class="text-xs font-bold text-slate-400">RAM: ${Math.round(pc.ram_percent||0)}%</span>
                        </div>
                    </div>
                    ${latencyBarHtml}
                    <div class="mt-2 text-[10px] text-slate-400 flex justify-between">
                        <span>${pc.public_ip || 'Sin IP'}</span>
                        <span>${formatTimeAgo(pc.last_seen)}</span>
                    </div>
                </div>
            `;
        });
        
        if (deviceCount === 0) {
            html = `
                <div class="col-span-full text-center py-12">
                    <i data-lucide="search-x" class="w-12 h-12 text-slate-300 mx-auto mb-4"></i>
                    <p class="text-slate-500">No se encontraron dispositivos</p>
                    <p class="text-sm text-slate-400 mt-1">Intenta con otros t√©rminos de b√∫squeda</p>
                </div>
            `;
        }
        
        container.innerHTML = html;
        lucide.createIcons();
    }

    function calculateHealthScore(pc) {
        let score = 100;
        
        if (pc.status === 'offline') return 0;
        
        // Penalizaciones
        if (pc.cpu_load_percent > 90) score -= 30;
        else if (pc.cpu_load_percent > 80) score -= 20;
        else if (pc.cpu_load_percent > 70) score -= 10;
        
        if (pc.ram_percent > 90) score -= 20;
        else if (pc.ram_percent > 80) score -= 10;
        
        const latency = pc.latency_ms || pc.latency || 0;
        if (latency > 200) score -= 30;
        else if (latency > 100) score -= 20;
        else if (latency > 50) score -= 10;
        
        if (pc.packet_loss > 5) score -= 30;
        else if (pc.packet_loss > 0) score -= 15;
        
        return Math.max(0, Math.min(100, Math.round(score)));
    }

    function getHealthScoreClass(score) {
        if (score >= 90) return 'text-emerald-600';
        if (score >= 70) return 'text-blue-600';
        if (score >= 50) return 'text-amber-600';
        return 'text-rose-600';
    }

    function formatTimeAgo(timestamp) {
        if (!timestamp) return 'Nunca';
        
        try {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Ahora';
            if (diffMins < 60) return `Hace ${diffMins}m`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `Hace ${diffHours}h`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `Hace ${diffDays}d`;
        } catch {
            return 'Desconocido';
        }
    }

    window.openModal = (pcName) => {
        currentPc = pcName;
        const modal = document.getElementById('pc-modal-container');
        const overlay = document.getElementById('pc-modal-overlay');
        
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
        
        setTimeout(() => {
            modal.classList.remove('opacity-0', 'scale-95');
            modal.classList.add('opacity-100', 'scale-100');
        }, 10);
        
        switchTab('general');
        refreshModalData(true);
    };

    window.closeModal = () => {
        const modal = document.getElementById('pc-modal-container');
        const overlay = document.getElementById('pc-modal-overlay');
        
        modal.classList.replace('opacity-100', 'opacity-0');
        modal.classList.replace('scale-100', 'scale-95');
        
        setTimeout(() => {
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            currentPc = null;
        }, 300);
    };

    function refreshModalData(fullUpdate) {
        if (!currentPc || !pcDataStore[currentPc]) return;
        
        const pc = pcDataStore[currentPc];
        
        // Actualizar informaci√≥n b√°sica
        document.getElementById('modal-pc-name').textContent = pc.pc_name;
        
        const statusLine = document.getElementById('modal-status-line');
        const statusClass = pc.status === 'online' ? 
            (pc.cpu_load_percent > 90 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700') : 
            'bg-red-100 text-red-700';
        
        statusLine.innerHTML = `
            <span class="px-2 py-0.5 rounded text-xs font-bold ${statusClass}">
                ${pc.status ? pc.status.toUpperCase() : 'ONLINE'}
            </span>
            <span class="text-slate-400">|</span>
            <span class="font-mono text-slate-500">${pc.public_ip || '-'}</span>
            <span class="text-slate-400">|</span>
            <span class="text-slate-500 text-xs">${formatTimeAgo(pc.last_seen)}</span>
        `;
        
        // Actualizar pesta√±a General
        document.getElementById('gen-unit').textContent = pc.unit || 'General';
        document.getElementById('gen-ip').textContent = pc.public_ip || '-';
        document.getElementById('gen-seen').textContent = new Date(pc.last_seen || Date.now()).toLocaleString();
        
        document.getElementById('gen-cpu-val').textContent = Math.round(pc.cpu_load_percent||0)+'%';
        document.getElementById('gen-cpu-bar').style.width = (pc.cpu_load_percent||0)+'%';
        
        document.getElementById('gen-ram-val').textContent = Math.round(pc.ram_percent||0)+'%';
        document.getElementById('gen-ram-bar').style.width = (pc.ram_percent||0)+'%';
        
        document.getElementById('gen-disk-val').textContent = Math.round(pc.disk_percent||0)+'%';
        document.getElementById('gen-disk-bar').style.width = (pc.disk_percent||0)+'%';
        
        // Actualizar score de salud
        const healthScore = pc.health_score || calculateHealthScore(pc);
        const healthClass = getHealthScoreClass(healthScore);
        document.getElementById('health-score-val').textContent = healthScore + '%';
        document.getElementById('health-score-val').className = `text-4xl font-black ${healthClass}`;
        
        // Actualizar icono de salud
        let healthIcon = 'check-circle';
        if (healthScore < 50) healthIcon = 'alert-octagon';
        else if (healthScore < 70) healthIcon = 'alert-triangle';
        else if (healthScore < 90) healthIcon = 'activity';
        
        document.getElementById('health-icon-container').innerHTML = 
            `<i data-lucide="${healthIcon}" class="w-8 h-8 ${healthClass}"></i>`;
        
        // Indicadores de salud
        const indicators = [];
        if (pc.cpu_load_percent > 80) indicators.push('CPU alta');
        if (pc.ram_percent > 80) indicators.push('RAM alta');
        if ((pc.latency_ms || 0) > 100) indicators.push('Latencia alta');
        if (pc.packet_loss > 0) indicators.push('P√©rdida de paquetes');
        
        document.getElementById('health-indicators').textContent = 
            indicators.length > 0 ? indicators.join(' ‚Ä¢ ') : 'Todos los sistemas OK';
        
        if (fullUpdate) {
            // Actualizar gr√°fico de latencia
            updateLatencyChart(pc.latency_history || Array(12).fill(0));
            
            // Actualizar hardware
            updateHardwareGrid(pc);
            
            // Actualizar historial
            updateHistoryTab(pc);
        }
        
        lucide.createIcons();
    }

    function updateLatencyChart(data) {
        const ctx = document.getElementById('latency-chart');
        if (!ctx) return;
        
        const chartData = Array.isArray(data) ? data : Array(12).fill(0);
        
        if (charts.latency) {
            charts.latency.data.datasets[0].data = chartData;
            charts.latency.update();
        } else {
            charts.latency = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array(chartData.length).fill(''),
                    datasets: [{
                        data: chartData,
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 1,
                        fill: true,
                        backgroundColor: 'rgba(99,102,241,0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: false },
                    scales: {
                        x: { display: false },
                        y: {
                            display: true,
                            grid: { borderDash: [4, 4] },
                            min: 0,
                            suggestedMax: Math.max(...chartData) * 1.5 || 100,
                            ticks: {
                                callback: function(value) {
                                    return value + 'ms';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
    }

    function updateHardwareGrid(pc) {
        const grid = document.getElementById('hardware-full-grid');
        grid.innerHTML = '';
        
        if (pc.extended_sensors && Object.keys(pc.extended_sensors).length > 0) {
            for (const [cat, sensors] of Object.entries(pc.extended_sensors)) {
                sensors.forEach(s => {
                    grid.innerHTML += `
                        <div class="bg-white p-3 rounded border border-slate-100 shadow-sm text-xs">
                            <span class="block text-slate-400 uppercase font-bold text-[10px]">${cat}</span>
                            <span class="block text-slate-600 truncate">${s.nombre||s.tipo||'Sensor'}</span>
                            <span class="block text-lg font-mono font-bold text-slate-800">${s.valor} ${s.unidad||''}</span>
                        </div>
                    `;
                });
            }
        } else {
            grid.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <i data-lucide="cpu" class="w-8 h-8 text-slate-300 mx-auto mb-2"></i>
                    <p class="text-slate-400">Sin datos de sensores</p>
                    <p class="text-xs text-slate-300 mt-1">Los sensores se mostrar√°n cuando est√©n disponibles</p>
                </div>
            `;
        }
        
        lucide.createIcons();
    }

    // Funciones de pesta√±as (mantener igual)
    window.switchTab = (id) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + id).classList.remove('hidden');
        document.querySelector(`[data-tab="${id}"]`).classList.add('active');
    };

    function updateFilters(devices) {
        const select = document.getElementById('unit-filter');
        if (select.options.length > 1) return;
        
        const units = [...new Set(devices.map(d => d.unit || 'General'))];
        units.sort();
        
        units.forEach(u => {
            select.appendChild(new Option(u, u));
        });
    }

    window.forceRefresh = () => {
        clearInterval(updateInterval);
        updateData();
        updateInterval = setInterval(updateData, REFRESH_INTERVAL);
        showAlert('Actualizaci√≥n forzada realizada', 'info', 3000);
    };

    // Event Listeners
    document.getElementById('modal-tabs').onclick = (e) => {
        if (e.target.closest('.modal-tab')) {
            switchTab(e.target.closest('.modal-tab').dataset.tab);
        }
    };
    
    document.getElementById('search-bar').oninput = renderGrid;
    document.getElementById('unit-filter').onchange = renderGrid;

    // Inicializaci√≥n
    updateData();
    updateInterval = setInterval(updateData, REFRESH_INTERVAL);
    
    // Actualizar filtros despu√©s de cargar datos
    setTimeout(() => {
        updateFilters(Object.values(pcDataStore));
    }, 1000);
});
</script>
{% endblock %}
