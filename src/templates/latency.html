{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // CONFIGURACIÓN CHART
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        
        let latencyChart = null;

        async function fetchLatencyData() {
            try {
                // 1. URL CORRECTA
                const response = await fetch('/api/data');
                const rawData = await response.json();
                
                // 2. CONVERTIR Y ORDENAR
                const devices = Object.values(rawData).sort((a,b) => (b.latency_ms || 0) - (a.latency_ms || 0)); // Ordenar por mayor latencia

                updateTable(devices);
                updateChart(devices);

            } catch (error) { console.error(error); }
        }

        function updateTable(devices) {
            const tbody = document.querySelector('tbody'); 
            // Si tu latency.html tiene una tabla, asegúrate de que tenga <tbody> o ajusta este selector
            if(!tbody) return;

            tbody.innerHTML = '';
            devices.forEach(dev => {
                const lat = dev.latency_ms || 0;
                let color = lat < 50 ? 'text-emerald-600' : (lat < 100 ? 'text-amber-500' : 'text-red-600');
                
                const row = `
                    <tr class="border-b border-slate-50 hover:bg-slate-50">
                        <td class="px-6 py-4 font-bold text-slate-700">${dev.pc_name}</td>
                        <td class="px-6 py-4 font-mono text-xs">${dev.ip}</td>
                        <td class="px-6 py-4 font-bold ${color}">${lat} ms</td>
                        <td class="px-6 py-4 text-xs text-slate-400">${new Date(dev.timestamp).toLocaleTimeString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateChart(devices) {
            // Tomamos el Top 10 para el gráfico
            const topDevices = devices.slice(0, 10);
            const labels = topDevices.map(d => d.pc_name);
            const data = topDevices.map(d => d.latency_ms || 0);

            const ctx = document.getElementById('latencyChart'); // Asegúrate que tu HTML tenga un <canvas id="latencyChart">
            if(!ctx) return; 

            if (latencyChart) {
                latencyChart.data.labels = labels;
                latencyChart.data.datasets[0].data = data;
                latencyChart.update();
            } else {
                latencyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Latencia (ms)',
                            data: data,
                            backgroundColor: '#6366f1',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }

        setInterval(fetchLatencyData, 2000);
        fetchLatencyData();
    });
</script>
{% endblock %}
