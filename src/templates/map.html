{% extends 'base.html' %}

{% block header_title %}Mapa de Infraestructura y Riesgos Corporativos{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    /* --- ESTRUCTURA EJECUTIVA --- */
    #app-container { position: relative; height: calc(100vh - 5rem); width: 100%; overflow: hidden; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; }
    #map { height: 100%; width: 100%; z-index: 1; background: #e2e8f0; }
    
    #sidebar { position: absolute; top: 0; bottom: 0; right: 0; width: 350px; background: #ffffff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 2000; display: flex; flex-direction: column; transition: transform 0.3s ease; border-left: 1px solid #e2e8f0; }
    #sidebar.collapsed { transform: translateX(100%); }
    
    #sidebar-toggle { position: absolute; top: 20px; right: 365px; z-index: 2001; background: #334155; color: white; border: none; width: 40px; height: 40px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: right 0.3s ease; }
    #sidebar.collapsed + #sidebar-toggle { right: 20px; }

    /* KPI DASHBOARD */
    .kpi-dashboard { position: absolute; top: 15px; left: 15px; z-index: 1000; display: flex; gap: 10px; }
    .kpi-card { background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; min-width: 120px; }
    .kpi-value { font-size: 1.25rem; font-weight: 800; display: block; }

    /* NUC MARKERS */
    .nuc-marker { display: flex; justify-content: center; align-items: center; background: white; border-radius: 6px; border: 2px solid #64748b; width: 28px; height: 28px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .nuc-online { border-color: #10b981; color: #10b981; background: #f0fdf4; }
    .nuc-offline { border-color: #ef4444; color: #ef4444; background: #fef2f2; }
    .nuc-warning { border-color: #f59e0b; color: #f59e0b; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { transform: scale(1); } }

    /* CONTROLES SIDEBAR */
    .sidebar-header { padding: 18px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .control-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
    .card-header { padding: 12px 15px; background: #f8fafc; font-weight: 700; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: space-between; }
    .layer-toggle { padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; font-size: 0.75rem; }
    
    .switch { position: relative; width: 30px; height: 16px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background: #cbd5e1; transition: .2s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background: #4f46e5; }
    input:checked + .slider:before { transform: translateX(14px); }

    .nuc-popup-stats { background: #f8fafc; padding: 5px; border-radius: 4px; margin-top: 5px; font-size: 10px; border: 1px solid #eee; }
</style>

<div id="app-container">
    <div class="kpi-dashboard">
        <div class="kpi-card"><span class="text-[10px] font-bold text-slate-400 uppercase">Activos</span><span class="kpi-value text-emerald-600" id="kpi-online">0</span></div>
        <div class="kpi-card"><span class="text-[10px] font-bold text-slate-400 uppercase">Alertas</span><span class="kpi-value text-rose-600" id="kpi-issues">0</span></div>
        <div class="kpi-card"><span class="text-[10px] font-bold text-slate-400 uppercase">Zonas de Riesgo</span><span class="kpi-value text-amber-500" id="kpi-zones">0</span></div>
    </div>

    <div id="map"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <div><h2 class="text-sm font-bold text-slate-800 uppercase">Panel Ejecutivo</h2><small class="text-slate-400">Infraestructura CDMX</small></div>
            <i class="fa-solid fa-server text-indigo-500"></i>
        </div>
        <div class="sidebar-content">
            <div class="control-card">
                <div class="card-header"><span>TELEMETRÍA CRÍTICA</span></div>
                <div class="layer-toggle"><span><i class="fa-solid fa-th mr-2 text-indigo-500"></i> Red (Grilla Cuadriculada)</span><label class="switch"><input type="checkbox" checked onchange="toggleSimultaneousLayer('netGrid', this.checked)"><span class="slider"></span></label></div>
                <div class="layer-toggle"><span><i class="fa-solid fa-bolt mr-2 text-yellow-500"></i> Mapa Eléctrico</span><label class="switch"><input type="checkbox" onchange="toggleSimultaneousLayer('elecHeat', this.checked)"><span class="slider"></span></label></div>
                <div class="layer-toggle"><span><i class="fa-solid fa-users mr-2 text-orange-500"></i> Afluencia (Gente)</span><label class="switch"><input type="checkbox" onchange="toggleSimultaneousLayer('afluHeat', this.checked)"><span class="slider"></span></label></div>
            </div>

            <div class="control-card">
                <div class="card-header" onclick="toggleCard(this)"><span><i class="fa-solid fa-clock mr-2"></i> Filtro Hora (Personas)</span><i class="fa-solid fa-chevron-down text-slate-400"></i></div>
                <div class="card-body hidden p-3">
                    <select id="time-selector" class="w-full p-2 border rounded text-xs" onchange="updateAfluenciaByTime(this.value)">
                        <option value="9" selected>09:00 AM - Pico</option>
                        <option value="18">06:00 PM - Salida</option>
                    </select>
                </div>
            </div>

            <div class="control-card">
                <div class="card-header"><span>ESTADO DE RIESGO</span></div>
                <div class="layer-row layer-toggle"><span>Afectación de Zona (Auto)</span><label class="switch"><input type="checkbox" checked onchange="toggleSimultaneousLayer('autoRisk', this.checked)"><span class="slider"></span></label></div>
            </div>

            <div id="dynamic-panels"></div>
        </div>
    </div>
    <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="{{ url_for('static', filename='js/datos_speedtest.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let map = null;
    const nucTelemetry = {}; // Acumulador de bajones/caídas
    const markerRegistry = {};
    const afluenciaHeatLayers = {};

    const panes = {
        heat: 'heatPane',
        grid: 'gridPane',
        risk: 'riskPane',
        nuc: 'nucPane'
    };

    const layers = {
        netGrid: L.layerGroup(),
        elecHeat: L.layerGroup(),
        afluHeat: L.layerGroup(),
        autoRisk: L.layerGroup(),
        metro: L.layerGroup(),
        'BioBox': L.layerGroup(), 'ViaVerde': L.layerGroup(), 'Ecovallas': L.layerGroup(), 'General': L.layerGroup()
    };

    function init() {
        map = L.map('map', { zoomControl: false }).setView([19.4326, -99.1332], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

        // JERARQUÍA DE SUPERPOSICIÓN EXACTA
        map.createPane(panes.heat).style.zIndex = 400;  // Calor fondo
        map.createPane(panes.grid).style.zIndex = 450;  // Grilla red
        map.createPane(panes.risk).style.zIndex = 500;  // Zonas de afectación
        map.createPane(panes.nuc).style.zIndex = 700;   // NUCs (Siempre arriba)

        initNetworkGrid();
        initHeatmaps();
        fetchLiveNucs();
        setInterval(fetchLiveNucs, 5000);
        
        // Capas iniciales
        layers.netGrid.addTo(map);
        layers.autoRisk.addTo(map);
        ['BioBox', 'ViaVerde', 'Ecovallas', 'General'].forEach(l => layers[l].addTo(map));
    }

    // GRILLA DE RED (SPEEDTEST ORIGINAL)
    function initNetworkGrid() {
        if (typeof SPEEDTEST_DATA === 'undefined') return;
        const style = (c) => ({ color: c, weight: 1, fillOpacity: 0.3, fillColor: c, pane: panes.grid });
        
        SPEEDTEST_DATA.features.forEach(f => {
            const speed = f.properties.download;
            let color = speed > 50 ? '#10b981' : (speed > 15 ? '#f59e0b' : '#ef4444');
            L.geoJson(f, { style: style(color) }).addTo(layers.netGrid);
        });
    }

    // MAPAS DE CALOR (PERSONAS Y ELÉCTRICO)
    function initHeatmaps() {
        // Eléctrico
        const elecData = [[19.43, -99.13, 0.8], [19.40, -99.18, 0.9]];
        L.heatLayer(elecData, { radius: 45, blur: 25, pane: panes.heat, gradient: {0.5: 'yellow', 1: 'orange'} }).addTo(layers.elecHeat);
        
        // Personas (Afluencia) - Precarga horarios
        [9, 18].forEach(h => {
            const data = [[19.432, -99.133, h === 9 ? 0.9 : 0.6]];
            afluenciaHeatLayers[h] = L.heatLayer(data, { radius: 30, blur: 20, pane: panes.heat });
        });
    }

    async function fetchLiveNucs() {
        try {
            const res = await fetch('/api/data');
            const rawData = await res.json();
            const devices = Object.values(rawData);

            devices.forEach(dev => {
                if (!dev.lat || !dev.lng) return;

                // Contadores automáticos persistentes en la sesión
                if (!nucTelemetry[dev.pc_name]) nucTelemetry[dev.pc_name] = { bajones: 0, apagados: 0, lastStatus: dev.status };
                
                const lat = dev.latency_ms || dev.latency || 0;
                if (lat > 120) nucTelemetry[dev.pc_name].bajones++;
                if (nucTelemetry[dev.pc_name].lastStatus === 'online' && dev.status === 'offline') nucTelemetry[dev.pc_name].apagados++;
                nucTelemetry[dev.pc_name].lastStatus = dev.status;

                const stats = nucTelemetry[dev.pc_name];
                const statusClass = dev.status === 'offline' ? 'nuc-offline' : (lat > 100 ? 'nuc-warning' : 'nuc-online');
                
                const popupHtml = `<b>${dev.pc_name}</b><div class="nuc-popup-stats">Bajones: ${stats.bajones} | Caídas: ${stats.apagados}<br>Latencia: ${lat}ms</div>`;

                if (markerRegistry[dev.pc_name]) {
                    const m = markerRegistry[dev.pc_name];
                    m.setLatLng([dev.lat, dev.lng]);
                    m.setIcon(L.divIcon({ className: '', html: `<div class="nuc-marker ${statusClass}"><i class="fa-solid fa-desktop"></i></div>`, iconSize: [28,28] }));
                    m.getPopup().setContent(popupHtml);
                } else {
                    const m = L.marker([dev.lat, dev.lng], {
                        icon: L.divIcon({ className: '', html: `<div class="nuc-marker ${statusClass}"><i class="fa-solid fa-desktop"></i></div>`, iconSize: [28,28] }),
                        pane: panes.nuc
                    }).bindPopup(popupHtml).addTo(layers[dev.unit || 'General']);
                    markerRegistry[dev.pc_name] = m;
                }
            });
            updateKPIs(devices);
            updateAutoZones(devices);
            updateSidebarList(devices);
        } catch (e) { console.error(e); }
    }

    function updateAutoZones(devices) {
        layers.autoRisk.clearLayers();
        const problematic = devices.filter(d => d.status === 'offline' || (d.latency_ms||0) > 100);
        const clusters = [];

        problematic.forEach(p => {
            let zone = clusters.find(c => Math.abs(c.lat - p.lat) < 0.009 && Math.abs(c.lng - p.lng) < 0.009);
            if(zone) zone.count++; else clusters.push({ lat: p.lat, lng: p.lng, count: 1 });
        });

        document.getElementById('kpi-zones').innerText = clusters.length;

        clusters.forEach(z => {
            L.circle([z.lat, z.lng], { radius: 800, color: '#ef4444', weight: 1, fillOpacity: 0.2, pane: panes.risk })
             .addTo(layers.autoRisk).bindTooltip(`Falla Grupal: ${z.count} activos`);
        });
    }

    // UI FUNCTIONS
    window.toggleSimultaneousLayer = (id, show) => { if(show) map.addLayer(layers[id]); else map.removeLayer(layers[id]); };
    window.updateAfluenciaByTime = (h) => { layers.afluHeat.clearLayers(); if(afluenciaHeatLayers[h]) layers.afluHeat.addLayer(afluenciaHeatLayers[h]); };
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('collapsed');
    window.toggleCard = (h) => { h.nextElementSibling.classList.toggle('hidden'); h.querySelector('i').classList.toggle('fa-rotate-180'); };
    
    function updateKPIs(d) {
        document.getElementById('kpi-online').innerText = d.filter(x => x.status === 'online').length;
        document.getElementById('kpi-issues').innerText = d.filter(x => x.status === 'offline').length;
    }

    function updateSidebarList(devices) {
        const cont = document.getElementById('dynamic-panels');
        const groups = {};
        devices.forEach(d => { const u = d.unit || 'General'; if(!groups[u]) groups[u]=[]; groups[u].push(d); });
        cont.innerHTML = '';
        Object.entries(groups).forEach(([u, devs]) => {
            cont.innerHTML += `<div class="control-card"><div class="card-header" onclick="toggleCard(this)">${u} (${devs.length}) <i class="fa-solid fa-chevron-down"></i></div><div class="card-body hidden">
                ${devs.map(d => `<div class="p-2 border-b text-[10px] flex items-center gap-2 cursor-pointer hover:bg-slate-50" onclick="zoomTo('${d.pc_name}')"><div class="w-2 h-2 rounded-full ${d.status==='offline'?'bg-rose-500':'bg-emerald-500'}"></div>${d.pc_name}</div>`).join('')}
            </div></div>`;
        });
    }

    window.zoomTo = (name) => { const m = markerRegistry[name]; if(m) { map.flyTo(m.getLatLng(), 17); m.openPopup(); } };

    init();
});
</script>
{% endblock %}
