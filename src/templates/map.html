{% extends 'base.html' %}
{% block header_title %}Mapa de Riesgos e Infraestructura{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
    #app-container { position: relative; height: calc(100vh - 5rem); width: 100%; overflow: hidden; background: #f1f5f9; border-radius: 8px; }
    #map { height: 100%; width: 100%; z-index: 1; }
    
    /* Sidebar */
    #sidebar { position: absolute; top: 0; bottom: 0; right: 0; width: 320px; background: white; z-index: 2000; box-shadow: -2px 0 15px rgba(0,0,0,0.1); transform: translateX(0); transition: transform 0.3s ease; display: flex; flex-direction: column; }
    #sidebar.collapsed { transform: translateX(100%); }
    .sidebar-header { padding: 15px; background: #1e293b; color: white; display: flex; justify-content: space-between; align-items: center; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }
    
    /* Cards Controls */
    .control-card { background: white; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card-header { padding: 10px 15px; background: #f8fafc; font-weight: 600; font-size: 0.85rem; color: #334155; cursor: pointer; display: flex; justify-content: space-between; }
    .card-body { padding: 5px 0; }
    .hidden { display: none; }

    /* Toggles */
    .layer-item { padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
    .color-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    
    /* Toggle Switch */
    .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #2563eb; }
    input:checked + .slider:before { transform: translateX(14px); }

    /* Modal Incidentes */
    #incident-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; width: 400px; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

    /* Marcadores */
    .nuc-marker { display: flex; justify-content: center; align-items: center; background: white; border-radius: 4px; border: 2px solid #64748b; width: 24px; height: 24px; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .nuc-online { border-color: #16a34a; color: #16a34a; }
    .nuc-offline { border-color: #94a3b8; color: #94a3b8; background: #f1f5f9; }
    .nuc-critical { border-color: #dc2626; color: #dc2626; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
</style>

<div id="app-container">
    <div id="map"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <span>Control de Capas</span>
            <button onclick="toggleSidebar()" class="text-white hover:text-gray-300"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="sidebar-content">
            
            <div class="control-card">
                <div class="card-header">
                    <span><i class="fa-solid fa-eye text-indigo-600 mr-2"></i> Modo de Vista</span>
                </div>
                <div class="card-body">
                    <div class="layer-item bg-slate-50">
                        <span><i class="fa-regular fa-square mr-2"></i> Vista Limpia (Mapa Base)</span>
                        <label class="switch"><input type="radio" name="view-mode" onchange="setMode('none')"><span class="slider"></span></label>
                    </div>
                    <div class="layer-item">
                        <span><span class="color-dot bg-blue-600"></span> Monitor de Red</span>
                        <label class="switch"><input type="radio" name="view-mode" checked onchange="setMode('network')"><span class="slider"></span></label>
                    </div>
                    <div class="layer-item">
                        <span><span class="color-dot bg-red-500"></span> Zonas de Riesgo (Incidentes)</span>
                        <label class="switch"><input type="radio" name="view-mode" onchange="setMode('risk')"><span class="slider"></span></label>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <div class="card-header" onclick="this.nextElementSibling.classList.toggle('hidden')">
                    <span><i class="fa-solid fa-building text-slate-500 mr-2"></i> Infraestructura</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="card-body hidden">
                    <div class="layer-item">
                        <span>Sitios de Interés (POI)</span>
                        <label class="switch"><input type="checkbox" checked onchange="toggleLayer('poi', this.checked)"><span class="slider"></span></label>
                    </div>
                </div>
            </div>

            <div class="p-3 bg-blue-50 rounded border border-blue-100 text-xs text-blue-800">
                <i class="fa-solid fa-info-circle mr-1"></i> Haz clic en un equipo en el mapa para reportar una falla.
            </div>
        </div>
    </div>
</div>

<div id="incident-modal">
    <div class="modal-content">
        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-triangle-exclamation text-amber-500"></i> Reportar Incidente
        </h3>
        <p class="text-sm text-slate-500 mb-4">Equipo: <strong id="modal-dev-name">--</strong></p>
        
        <form id="incident-form" class="space-y-4">
            <input type="hidden" id="modal-dev-id">
            
            <div>
                <label class="block text-xs font-bold text-slate-600 mb-1">Tipo de Falla</label>
                <select id="inc-type" class="w-full p-2 border rounded text-sm">
                    <option value="desconexion">Desconexión de Red</option>
                    <option value="energia">Falla Eléctrica / Voltaje</option>
                    <option value="fibra">Corte de Fibra Óptica</option>
                    <option value="vandalismo">Vandalismo / Robo</option>
                    <option value="hardware">Falla de Hardware (NUC)</option>
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-slate-600 mb-1">Detalles</label>
                <textarea id="inc-desc" rows="3" class="w-full p-2 border rounded text-sm" placeholder="Ej: Se detectó corte en la zona..."></textarea>
            </div>

            <div class="flex justify-end gap-2 pt-2">
                <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded">Cancelar</button>
                <button type="button" onclick="submitIncident()" class="px-4 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700 font-bold">Registrar Falla</button>
            </div>
        </form>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map, layers = {};
    let liveDevices = [];

    document.addEventListener('DOMContentLoaded', () => {
        // 1. INICIALIZAR MAPA
        map = L.map('map', {zoomControl: false}).setView([19.4326, -99.1332], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Argos Risk Map'
        }).addTo(map);
        L.control.zoom({position: 'topleft'}).addTo(map);

        // 2. CREAR CAPAS
        layers.network = L.layerGroup(); // Equipos normales
        layers.risk = L.layerGroup();    // Zonas de colores (Semáforo)
        layers.poi = L.layerGroup();     // Puntos de interés
        
        // Cargar por defecto
        layers.network.addTo(map);
        layers.poi.addTo(map);

        // 3. CARGAR DATOS
        fetchLiveNucs(); // Cargar equipos
        fetchRiskData(); // Cargar zonas de riesgo (backend)

        // Actualizar cada 10s
        setInterval(fetchLiveNucs, 10000);
    });

    // --- LÓGICA DE CAPAS ---
    function setMode(mode) {
        // Limpiar todo primero
        map.removeLayer(layers.network);
        map.removeLayer(layers.risk);

        if (mode === 'none') {
            // No hacemos nada, queda limpio
        } else if (mode === 'network') {
            map.addLayer(layers.network);
        } else if (mode === 'risk') {
            map.addLayer(layers.risk);
            fetchRiskData(); // Refrescar riesgos al activar
        }
    }

    function toggleLayer(name, checked) {
        if(checked) map.addLayer(layers[name]);
        else map.removeLayer(layers[name]);
    }

    // --- DATOS EN VIVO (EQUIPOS) ---
    async function fetchLiveNucs() {
        try {
            const res = await fetch('/api/data');
            const data = await res.json();
            liveDevices = Object.values(data);
            
            layers.network.clearLayers();

            liveDevices.forEach(d => {
                if(!d.lat || !d.lng) return; // Saltar sin GPS

                let colorClass = 'nuc-online';
                if(d.status === 'offline') colorClass = 'nuc-offline';
                if(d.status === 'critical') colorClass = 'nuc-critical';

                const icon = L.divIcon({
                    className: '',
                    html: `<div class="nuc-marker ${colorClass}"><i class="fa-solid fa-desktop"></i></div>`,
                    iconSize: [24, 24]
                });

                const marker = L.marker([d.lat, d.lng], {icon: icon})
                    .bindPopup(`
                        <div class="text-sm">
                            <strong class="block text-slate-800 mb-1">${d.pc_name}</strong>
                            <span class="text-xs text-slate-500">${d.ip_address || ''}</span>
                            <hr class="my-2">
                            <button onclick="openIncidentModal('${d.pc_name}')" class="w-full bg-red-50 text-red-600 border border-red-200 px-3 py-1 rounded text-xs font-bold hover:bg-red-100 transition">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i> Reportar Falla
                            </button>
                        </div>
                    `);
                
                layers.network.addLayer(marker);
            });
        } catch(e) { console.error("Error data", e); }
    }

    // --- CAPA DE RIESGOS (ZONAS DE COLOR) ---
    async function fetchRiskData() {
        try {
            const res = await fetch('/api/incidents/risk-map');
            const risks = await res.json();
            
            layers.risk.clearLayers();

            // Cruzar datos de riesgo con ubicación de dispositivos
            risks.forEach(r => {
                const device = liveDevices.find(d => d.pc_name === r.device_id);
                if(device && device.lat) {
                    
                    let color = '#22c55e'; // Verde (Estable)
                    let radius = 200;
                    
                    if(r.risk_level === 'unstable') { color = '#eab308'; radius = 400; } // Amarillo
                    if(r.risk_level === 'critical') { color = '#ef4444'; radius = 600; } // Rojo

                    // Dibujar Zona
                    L.circle([device.lat, device.lng], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.4,
                        radius: radius
                    }).bindPopup(`
                        <b>Zona: ${r.device_id}</b><br>
                        Nivel: ${r.risk_level.toUpperCase()}<br>
                        Incidentes: ${r.total_incidents}<br>
                        Tipos: ${r.recent_issues.join(', ')}
                    `).addTo(layers.risk);
                }
            });
        } catch(e) { console.error("Error risk", e); }
    }

    // --- GESTIÓN DE INCIDENTES (MODAL) ---
    function openIncidentModal(pcName) {
        document.getElementById('modal-dev-name').innerText = pcName;
        document.getElementById('modal-dev-id').value = pcName;
        document.getElementById('incident-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('incident-modal').style.display = 'none';
        document.getElementById('incident-form').reset();
    }

    async function submitIncident() {
        const id = document.getElementById('modal-dev-id').value;
        const type = document.getElementById('inc-type').value;
        const desc = document.getElementById('inc-desc').value;

        try {
            const res = await fetch('/api/incidents/report', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ device_id: id, type: type, description: desc })
            });
            if(res.ok) {
                alert("Falla registrada. La zona se actualizará en el mapa de riesgos.");
                closeModal();
                if(document.querySelector('input[name="view-mode"]:checked').value === 'risk') {
                    fetchRiskData(); // Actualizar mapa si estamos viendolo
                }
            }
        } catch(e) { alert("Error de conexión"); }
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
</script>
{% endblock %}
