{% extends 'base.html' %}

{% block header_title %}Mapa de Infraestructura y Riesgos{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    #app-container { position: relative; height: calc(100vh - 5rem); width: 100%; overflow: hidden; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; }
    #map { height: 100%; width: 100%; z-index: 1; background: #e2e8f0; }
    
    /* Sidebar */
    #sidebar { position: absolute; top: 0; bottom: 0; right: 0; width: 350px; background: #ffffff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 2000; display: flex; flex-direction: column; transition: transform 0.3s ease; transform: translateX(0); border-left: 1px solid #e2e8f0; }
    #sidebar.collapsed { transform: translateX(100%); }
    #sidebar-toggle { position: absolute; top: 20px; right: 365px; z-index: 2001; background: #334155; color: white; border: none; width: 40px; height: 40px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: right 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    #sidebar-toggle:hover { background: #1e293b; }
    #sidebar.collapsed + #sidebar-toggle { right: 20px; }

    /* Cards */
    .sidebar-header { padding: 18px 20px; background: #f8fafc; color: #1e293b; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; background: #ffffff; }
    .control-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 12px; overflow: hidden; }
    .card-header { padding: 10px 15px; background: #f8fafc; color: #334155; font-weight: 600; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; cursor: pointer; }
    .card-body.hidden { display: none; }
    
    /* Markers */
    .nuc-marker { display: flex; justify-content: center; align-items: center; background: white; border-radius: 4px; border: 2px solid #64748b; width: 24px; height: 24px; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s; }
    .nuc-online { border-color: #16a34a; color: #16a34a; background: #f0fdf4; }
    .nuc-offline { border-color: #94a3b8; color: #94a3b8; background: #f8fafc; }
    .nuc-critical { border-color: #dc2626; color: #dc2626; background: #fef2f2; animation: soft-pulse 2s infinite; z-index: 1000 !important; }
    
    @keyframes soft-pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

    .kpi-dashboard { position: absolute; top: 15px; left: 15px; z-index: 1000; display: flex; gap: 10px; }
    .kpi-card { background: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; min-width: 110px; }
    .kpi-title { font-size: 0.65rem; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .kpi-value { font-size: 1.1rem; font-weight: 700; color: #0f172a; display: block; margin-top: 2px; }
</style>

<div id="app-container">
    <div class="kpi-dashboard">
        <div class="kpi-card">
            <span class="kpi-title">Equipos Activos</span>
            <span class="kpi-value text-emerald-600" id="kpi-online">0</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Alertas</span>
            <span class="kpi-value text-red-600" id="kpi-issues">0</span>
        </div>
    </div>

    <div id="map"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <div><h2>Panel Ejecutivo</h2><small>Infraestructura</small></div>
            <i class="fa-solid fa-map text-slate-400"></i>
        </div>
        <div class="sidebar-content">
            <div class="control-card">
                <div class="card-header" onclick="toggleCard(this)">
                    <span><i class="fa-solid fa-layer-group text-blue-600 mr-2"></i> Unidades de Negocio</span>
                    <i class="fa-solid fa-chevron-down text-slate-400"></i>
                </div>
                <div class="card-body p-2" id="dynamic-panels">
                    </div>
            </div>
        </div>
    </div>
    <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='js/datos_speedtest.js') }}"></script> 

<script>
document.addEventListener('DOMContentLoaded', () => {
    let map = null;
    const layers = { 'BioBox': L.layerGroup(), 'ViaVerde': L.layerGroup(), 'Ecovallas': L.layerGroup(), 'General': L.layerGroup() };
    const markers = {};

    function init() {
        map = L.map('map', { zoomControl: false }).setView([19.4326, -99.1332], 12);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Argos Analytics', maxZoom: 19
        }).addTo(map);

        map.createPane('nucPane').style.zIndex = 700;

        // AÃ±adir capas al mapa
        Object.values(layers).forEach(layer => layer.addTo(map));

        fetchLiveNucs();
        setInterval(fetchLiveNucs, 3000);
    }

    async function fetchLiveNucs() {
        try {
            // URL CORRECTA
            const response = await fetch('/api/data');
            const rawData = await response.json();
            const devices = Object.values(rawData);
            
            updateMap(devices);
            updateKPIs(devices);
            updateSidebarList(devices);
            
        } catch (e) { console.error("Error API:", e); }
    }

    function updateMap(devices) {
        devices.forEach(dev => {
            // Validar Coordenadas (Si no vienen, no se pinta)
            if (!dev.lat || !dev.lng) return;

            const unit = dev.unit || 'General';
            const layer = layers[unit] || layers['General'];
            
            // Icono
            let statusClass = 'nuc-online';
            let iconName = 'desktop';
            if (dev.status === 'offline') { statusClass = 'nuc-offline'; iconName = 'power-off'; }
            if (dev.cpu_load_percent > 90) { statusClass = 'nuc-critical'; iconName = 'triangle-exclamation'; }

            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="nuc-marker ${statusClass}"><i class="fa-solid fa-${iconName}"></i></div>`,
                iconSize: [24, 24], iconAnchor: [12, 12]
            });

            if (markers[dev.pc_name]) {
                markers[dev.pc_name].setLatLng([dev.lat, dev.lng]).setIcon(icon);
            } else {
                markers[dev.pc_name] = L.marker([dev.lat, dev.lng], { icon: icon, pane: 'nucPane' })
                    .bindPopup(`<b>${dev.pc_name}</b><br>${unit}<br>CPU: ${Math.round(dev.cpu_load_percent||0)}%`)
                    .addTo(layer);
            }
        });
    }

    function updateSidebarList(devices) {
        const container = document.getElementById('dynamic-panels');
        let html = '';
        devices.forEach(d => {
            const color = d.status === 'online' ? 'bg-emerald-500' : 'bg-red-500';
            html += `
                <div class="flex items-center justify-between p-2 border-b border-slate-50 hover:bg-slate-50 cursor-pointer" onclick="zoomTo('${d.pc_name}')">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full ${color}"></div>
                        <span class="text-sm font-medium text-slate-700">${d.pc_name}</span>
                    </div>
                    <span class="text-xs text-slate-400">${d.unit || '-'}</span>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    window.zoomTo = (name) => {
        const m = markers[name];
        if (m) { map.flyTo(m.getLatLng(), 16); m.openPopup(); }
    };

    function updateKPIs(devices) {
        const online = devices.filter(d => d.status === 'online').length;
        const issues = devices.filter(d => d.status === 'critical' || d.status === 'offline').length;
        document.getElementById('kpi-online').innerText = online;
        document.getElementById('kpi-issues').innerText = issues;
    }

    // UI Helpers
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('collapsed');
    window.toggleCard = (h) => { h.nextElementSibling.classList.toggle('hidden'); };

    init();
});
</script>
{% endblock %}
