<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Riesgos Corporativos | Perímetro 250m</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        #map { height: 100vh; width: 100%; z-index: 1; }
        .sidebar { 
            position: absolute; top: 10px; right: 10px; width: 360px; 
            max-height: 95vh; background: white; z-index: 1000; 
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); 
            display: flex; flex-direction: column; overflow: hidden;
        }
        .site-list::-webkit-scrollbar { width: 5px; }
        .site-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50">

<div id="map"></div>

<div class="sidebar">
    <div class="p-5 bg-slate-900 text-white">
        <h2 class="text-xl font-bold flex items-center gap-2">
            <i class="fa-solid fa-expand text-blue-400"></i> Gestión de Riesgos
        </h2>
        <p class="text-[10px] opacity-60 mt-1 uppercase tracking-widest">Cobertura: Cuadro de 250 Metros</p>
    </div>

    <div class="grid grid-cols-3 gap-2 p-4 bg-slate-50 border-b">
        <div class="text-center p-2 bg-white rounded-lg shadow-sm border-b-4 border-rose-500">
            <div id="count-red" class="text-xl font-black text-slate-800">0</div>
            <div class="text-[9px] font-bold text-rose-500 uppercase">Críticos</div>
        </div>
        <div class="text-center p-2 bg-white rounded-lg shadow-sm border-b-4 border-amber-500">
            <div id="count-yellow" class="text-xl font-black text-slate-800">0</div>
            <div class="text-[9px] font-bold text-amber-500 uppercase">Atención</div>
        </div>
        <div class="text-center p-2 bg-white rounded-lg shadow-sm border-b-4 border-emerald-500">
            <div id="count-green" class="text-xl font-black text-slate-800">0</div>
            <div class="text-[9px] font-bold text-emerald-500 uppercase">Estables</div>
        </div>
    </div>

    <div class="px-4 py-3 border-b">
        <div class="relative">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
            <input type="text" id="site-search" placeholder="Filtrar por sitio..." 
                   class="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                   onkeyup="filtrarSitios()">
        </div>
    </div>

    <div id="site-list" class="flex-1 overflow-y-auto site-list"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- DATA DE INTELIGENCIA (Con desglose de categorías) ---
const riskIntelligence = {
    "MX_CM_VV_COL_669": { 
        "sat": 91.0, "color": "#ef4444", "total": 41, "top": "Pauta Digital", "lat": 19.4270, "lng": -99.1670,
        "categories": { "Conectividad y red": 18, "Hardware": 12, "Software": 8, "Otros": 3 }
    },
    "MX_CM_EV_MGP_15_3378 INSURGENTES SUR 171": { 
        "sat": 61.0, "color": "#f59e0b", "total": 26, "top": "Vandalismo", "lat": 19.4350, "lng": -99.1410,
        "categories": { "Conectividad y red": 10, "Hardware": 8, "Software": 5, "Otros": 3 }
    },
    "MX_CM_VV_COL_551": { 
        "sat": 65.0, "color": "#f59e0b", "total": 25, "top": "Vandalismo", "lat": 19.4180, "lng": -99.1620,
        "categories": { "Conectividad y red": 12, "Hardware": 6, "Software": 4, "Otros": 3 }
    },
    "MX_CM_VV_COL_735": { 
        "sat": 52.0, "color": "#f59e0b", "total": 22, "top": "Configuración", "lat": 19.4120, "lng": -99.1640,
        "categories": { "Conectividad y red": 8, "Hardware": 7, "Software": 5, "Otros": 2 }
    },
    "MX_CM_VV_COL_542": { 
        "sat": 60.0, "color": "#f59e0b", "total": 21, "top": "Falla CFE", "lat": 19.4060, "lng": -99.1750,
        "categories": { "Conectividad y red": 15, "Hardware": 3, "Software": 2, "Otros": 1 }
    }
};

// Completar base de datos para la lista de 335 sitios
for(let i=1; i<=330; i++) {
    const name = "SITIO_LOG_" + (1000 + i);
    if(!riskIntelligence[name]) {
        const totalRand = Math.floor(Math.random() * 5);
        riskIntelligence[name] = { 
            "sat": Math.floor(Math.random() * 30), "color": "#10b981", 
            "total": totalRand, "top": "Operación Normal",
            "lat": 19.43 + (Math.random() * 0.1 - 0.05), "lng": -99.13 + (Math.random() * 0.1 - 0.05),
            "categories": { 
                "Conectividad y red": Math.floor(totalRand * 0.5), 
                "Hardware": Math.floor(totalRand * 0.3), 
                "Software": totalRand - (Math.floor(totalRand * 0.5) + Math.floor(totalRand * 0.3)), 
                "Otros": 0 
            }
        };
    }
}

let map, markers = {};

function init() {
    map = L.map('map', { zoomControl: false }).setView([19.43, -99.13], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    const listCont = document.getElementById('site-list');
    let kpis = { red: 0, yellow: 0, green: 0 };

    Object.entries(riskIntelligence).forEach(([name, data]) => {
        const offset = 0.001125; 
        const bounds = [[data.lat - offset, data.lng - offset], [data.lat + offset, data.lng + offset]];

        const square = L.rectangle(bounds, {
            color: data.color, weight: 1.5, fillColor: data.color, fillOpacity: 0.4
        }).addTo(map);

        // --- CONSTRUCCIÓN DEL DESGLOSE POR CATEGORÍA PARA EL POPUP ---
        let categoryBreakdown = `<div class="mt-2 border-t pt-2 text-[10px] text-slate-500 uppercase font-bold text-center">Desglose por Categoría</div>`;
        Object.entries(data.categories).forEach(([cat, count]) => {
            if(count > 0) {
                categoryBreakdown += `<div class="flex justify-between text-[11px] py-0.5"><span>${cat}:</span> <b>${count}</b></div>`;
            }
        });

        const popup = `
            <div class="p-1" style="min-width:200px; font-family:sans-serif;">
                <b class="text-sm block border-b pb-1 mb-2">${name}</b>
                <div class="text-[11px] space-y-1">
                    <div class="flex justify-between"><span>Saturación:</span> <b style="color:${data.color}">${data.sat}%</b></div>
                    <div class="flex justify-between"><span>Incidencias Totales:</span> <b>${data.total}</b></div>
                    <div class="mt-2 text-slate-400 italic">Causa Principal: ${data.top}</div>
                </div>
                ${categoryBreakdown}
            </div>`;
        
        square.bindPopup(popup);
        markers[name] = square;

        if(data.sat > 70) kpis.red++; else if(data.sat > 35) kpis.yellow++; else kpis.green++;

        listCont.innerHTML += `
            <div class="site-item p-4 border-b hover:bg-slate-50 cursor-pointer flex justify-between items-center transition-all" 
                 onclick="enfocarSitio('${name}', ${data.lat}, ${data.lng})">
                <div class="text-[11px] font-bold text-slate-800">${name}</div>
                <div class="text-xs font-black" style="color:${data.color}">${data.sat}%</div>
            </div>`;
    });

    document.getElementById('count-red').innerText = kpis.red;
    document.getElementById('count-yellow').innerText = kpis.yellow;
    document.getElementById('count-green').innerText = kpis.green;
}

function enfocarSitio(name, lat, lng) {
    map.flyTo([lat, lng], 17);
    markers[name].openPopup();
}

function filtrarSitios() {
    const q = document.getElementById('site-search').value.toLowerCase();
    const items = document.querySelectorAll('.site-item');
    items.forEach(item => {
        item.style.display = item.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
    });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
