{% extends 'base.html' %}

{% block header_title %}Mapa de Infraestructura y Riesgos{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    /* --- TUS ESTILOS ORIGINALES MANTENIDOS --- */
    #app-container { position: relative; height: calc(100vh - 5rem); width: 100%; overflow: hidden; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; }
    #map { height: 100%; width: 100%; z-index: 1; background: #e2e8f0; }
    #sidebar { position: absolute; top: 0; bottom: 0; right: 0; width: 350px; background: #ffffff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 2000; display: flex; flex-direction: column; transition: transform 0.3s ease; transform: translateX(0); border-left: 1px solid #e2e8f0; }
    #sidebar.collapsed { transform: translateX(100%); }
    #sidebar-toggle { position: absolute; top: 20px; right: 365px; z-index: 2001; background: #334155; color: white; border: none; width: 40px; height: 40px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: right 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    #sidebar-toggle:hover { background: #1e293b; }
    #sidebar.collapsed + #sidebar-toggle { right: 20px; }
    .sidebar-header { padding: 18px 20px; background: #f8fafc; color: #1e293b; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
    .sidebar-header h2 { margin: 0; font-size: 1rem; font-weight: 700; color: #0f172a; }
    .sidebar-header small { color: #64748b; font-weight: 500; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; background: #ffffff; }
    .control-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 12px; overflow: hidden; }
    .card-header { padding: 10px 15px; background: #f8fafc; color: #334155; font-weight: 600; font-size: 0.85rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; cursor: pointer; }
    .card-header:hover { background: #f1f5f9; color: #0f172a; }
    .card-body { padding: 0; }
    .card-body.hidden { display: none; }
    .layer-toggle { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
    .layer-info { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #475569; }
    .color-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; }
    input:checked + .slider { background-color: #2563eb; }
    input:checked + .slider:before { transform: translateX(14px); }
    .kpi-dashboard { position: absolute; top: 15px; left: 15px; z-index: 1000; display: flex; gap: 10px; }
    .kpi-card { background: white; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; min-width: 110px; }
    .kpi-title { font-size: 0.65rem; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .kpi-value { font-size: 1.1rem; font-weight: 700; color: #0f172a; display: block; margin-top: 2px; }
    .nuc-marker { display: flex; justify-content: center; align-items: center; background: white; border-radius: 4px; border: 2px solid #64748b; width: 24px; height: 24px; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s; }
    .nuc-online { border-color: #16a34a; color: #16a34a; background: #f0fdf4; }
    .nuc-offline { border-color: #94a3b8; color: #94a3b8; background: #f8fafc; }
    .nuc-critical { border-color: #dc2626; color: #dc2626; background: #fef2f2; animation: soft-pulse 2s infinite; z-index: 1000 !important; }
    @keyframes soft-pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
    .marker-list { max-height: 200px; overflow-y: auto; }
    .marker-row { padding: 8px 15px; display: flex; align-items: center; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; cursor: pointer; color: #334155; }
    .marker-row:hover { background: #f1f5f9; color: #0f172a; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 10px; }
    .dot-green { background: #16a34a; }
    .dot-red { background: #dc2626; }
    .dot-orange { background: #f59e0b; }
    .custom-fa-icon { display: flex !important; justify-content: center; align-items: center; background: white; border-radius: 50%; border: 1px solid #94a3b8; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }

    /* --- NUEVOS ESTILOS PARA MODAL Y RIESGOS --- */
    #incident-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
    .modal-box { background: white; padding: 25px; border-radius: 12px; width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
</style>

<div id="app-container">
    <div class="kpi-dashboard">
        <div class="kpi-card">
            <span class="kpi-title">Equipos Activos</span>
            <span class="kpi-value text-emerald-600" id="kpi-online">0</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Alertas</span>
            <span class="kpi-value text-red-600" id="kpi-issues">0</span>
        </div>
        <div class="kpi-card">
            <span class="kpi-title">Velocidad Promedio</span>
            <span class="kpi-value text-blue-600" id="avg-speed">--</span>
        </div>
    </div>

    <div id="map"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <div><h2>Panel Ejecutivo</h2><small>Infraestructura CDMX</small></div>
            <i class="fa-solid fa-map text-slate-400"></i>
        </div>

        <div class="sidebar-content">
            
            <div class="control-card" style="border-left: 3px solid #6366f1;">
                <div class="card-header">
                    <span><i class="fa-solid fa-eye text-indigo-600 mr-2"></i> Modo de Vista</span>
                </div>
                <div class="card-body">
                    <div class="layer-toggle">
                        <div class="layer-info"><i class="fa-solid fa-chart-line mr-2"></i> Análisis Estático (Original)</div>
                        <label class="switch"><input type="radio" name="view-mode" value="analysis" checked onchange="setMapMode('analysis')"><span class="slider"></span></label>
                    </div>
                    <div class="layer-toggle">
                        <div class="layer-info"><i class="fa-solid fa-triangle-exclamation mr-2"></i> Mapa de Riesgos (Semáforo)</div>
                        <label class="switch"><input type="radio" name="view-mode" value="risk" onchange="setMapMode('risk')"><span class="slider"></span></label>
                    </div>
                    <div class="layer-toggle bg-slate-50">
                        <div class="layer-info text-slate-500"><i class="fa-regular fa-square mr-2"></i> Mapa Limpio (Ninguna)</div>
                        <label class="switch"><input type="radio" name="view-mode" value="clean" onchange="setMapMode('clean')"><span class="slider"></span></label>
                    </div>
                </div>
            </div>

            <div id="analysis-controls">
                <div class="control-card" style="border-left: 3px solid #2563eb;">
                    <div class="card-header"><span><i class="fa-solid fa-layer-group text-blue-600 mr-2"></i> Capas de Análisis</span></div>
                    <div class="card-body">
                        <div class="layer-toggle">
                            <div class="layer-info"><span class="color-dot" style="background:#2563eb;"></span> Red Internet</div>
                            <label class="switch"><input type="radio" name="exclusive-mode" checked onchange="activateExclusiveMode('red')"><span class="slider"></span></label>
                        </div>
                        <div class="layer-toggle">
                            <div class="layer-info"><span class="color-dot" style="background:#ef4444;"></span> Calor: Afluencia</div>
                            <label class="switch"><input type="radio" name="exclusive-mode" onchange="activateExclusiveMode('afluencia')"><span class="slider"></span></label>
                        </div>
                        <div class="layer-toggle">
                            <div class="layer-info"><span class="color-dot" style="background:#0f172a;"></span> Calor: Fallas</div>
                            <label class="switch"><input type="radio" name="exclusive-mode" onchange="activateExclusiveMode('fallas')"><span class="slider"></span></label>
                        </div>
                    </div>
                </div>

                <div class="control-card">
                    <div class="card-header" onclick="toggleCard(this)"><span><i class="fa-solid fa-clock mr-2"></i> Filtro de Hora</span><i class="fa-solid fa-chevron-down text-slate-400"></i></div>
                    <div class="card-body hidden">
                        <div style="padding: 15px;">
                            <select id="heatmap-time-selector" class="w-full p-2 border rounded text-sm" onchange="updateAfluenciaHeatmap(this.value)">
                                <option value="off">Desactivado</option><option value="9" selected>09:00 AM</option><option value="18">06:00 PM</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <div class="card-header" onclick="toggleCard(this)"><span><i class="fa-solid fa-building mr-2"></i> Puntos de Referencia</span><i class="fa-solid fa-chevron-down text-slate-400"></i></div>
                <div class="card-body hidden">
                    <div class="layer-toggle"><div class="layer-info"><span class="color-dot" style="background:#800080;"></span> Sitios de Interés</div><label class="switch"><input type="checkbox" checked onchange="toggleLayer('poi', this.checked)"><span class="slider"></span></label></div>
                    <div class="layer-toggle"><div class="layer-info"><span class="color-dot" style="background:#0000ff;"></span> Metro CDMX</div><label class="switch"><input type="checkbox" checked onchange="toggleLayer('metro', this.checked)"><span class="slider"></span></label></div>
                </div>
            </div>

            <div id="dynamic-panels"></div>
        </div>
    </div>
    <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
</div>

<div id="incident-modal">
    <div class="modal-box">
        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-amber-500"></i> Registrar Incidente</h3>
        <p class="text-sm text-slate-500 mb-4">Equipo: <strong id="modal-dev-name" class="text-slate-800"></strong></p>
        <p class="text-xs bg-blue-50 text-blue-700 p-2 rounded mb-4">ℹ️ Las desconexiones se cuentan automáticamente. Use esto para reportar causas externas.</p>
        
        <input type="hidden" id="modal-dev-id">
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-bold text-slate-600 mb-1">Causa Externa</label>
                <select id="inc-type" class="w-full p-2 border rounded text-sm bg-white">
                    <option value="energia">Falla Eléctrica / CFE</option>
                    <option value="fibra">Corte de Fibra Óptica</option>
                    <option value="vandalismo">Vandalismo / Robo</option>
                    <option value="hardware">Falla Física (Pantalla/PC)</option>
                    <option value="otro">Otro</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-600 mb-1">Detalles</label>
                <textarea id="inc-desc" rows="3" class="w-full p-2 border rounded text-sm" placeholder="Detalles..."></textarea>
            </div>
        </div>
        <div class="flex justify-end gap-2 mt-6">
            <button onclick="closeModal()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded font-medium">Cancelar</button>
            <button onclick="submitIncident()" class="px-4 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700 font-bold">Registrar</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="{{ url_for('static', filename='js/datos_speedtest.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DATOS ESTÁTICOS ORIGINALES ---
    const DATA_INTERMITENCIAS = [[19.357, -99.299, 1.0], [19.388, -99.193, 0.9], [19.288, -99.167, 0.8], [19.278, -99.102, 0.75]];
    const DATA_POI = [[19.4326, -99.1332, "Zócalo", "landmark", "purple"], [19.4385, -99.1764, "Revolución", "monument", "purple"]];
    const PUNTOS_BASE_AFLUENCIA = [[19.4326, -99.1332, 0.9], [19.4353, -99.1411, 0.85]];

    let map = null;
    let afluenciaHeatmapLayers = {};
    let currentMode = 'analysis'; // analysis, risk, clean

    const layers = {
        high: L.layerGroup(), mid: L.layerGroup(), low: L.layerGroup(),
        metro: L.layerGroup(), poi: L.layerGroup(),
        afluencia: L.layerGroup(), fallas_electricas: L.layerGroup(),
        'BioBox': L.layerGroup(), 'ViaVerde': L.layerGroup(), 'Ecovallas': L.layerGroup(), 'General': L.layerGroup(),
        risk: L.layerGroup() // NUEVA CAPA DE RIESGOS
    };

    const markerRegistry = {}; 

    function init() {
        map = L.map('map', { renderer: L.canvas(), zoomControl: false }).setView([19.4326, -99.1332], 12);
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Argos', maxZoom: 19 }).addTo(map);

        map.createPane('redPane').style.zIndex = 400;
        map.createPane('heatmapPane').style.zIndex = 450;
        map.createPane('riskPane').style.zIndex = 500; // Panel para círculos de riesgo
        map.createPane('markerPane').style.zIndex = 600;
        map.createPane('nucPane').style.zIndex = 700; 

        // Inicializar datos originales
        initRedData(); initAfluenciaData(); initFallasElectricas(); initInfraestructura();

        // Cargar vista por defecto
        setMapMode('analysis');

        fetchLiveNucs();
        setInterval(fetchLiveNucs, 5000); 
    }

    // --- NUEVA LÓGICA DE MODOS DE VISTA ---
    window.setMapMode = (mode) => {
        currentMode = mode;
        const analysisControls = document.getElementById('analysis-controls');

        // 1. Limpiar todo
        Object.values(layers).forEach(l => map.removeLayer(l));

        if (mode === 'clean') {
            analysisControls.style.opacity = '0.5';
            analysisControls.style.pointerEvents = 'none';
            // No añadimos nada
        } 
        else if (mode === 'analysis') {
            analysisControls.style.opacity = '1';
            analysisControls.style.pointerEvents = 'auto';
            // Restaurar configuración original
            map.addLayer(layers.metro);
            map.addLayer(layers.poi);
            // Restaurar heatmap seleccionado
            const selected = document.querySelector('input[name="exclusive-mode"]:checked');
            if(selected) activateExclusiveMode(selected.parentElement.parentElement.innerText.includes('Red') ? 'red' : 'afluencia');
            // Restaurar unidades
            ['BioBox', 'ViaVerde', 'Ecovallas', 'General'].forEach(k => layers[k].addTo(map));
        } 
        else if (mode === 'risk') {
            analysisControls.style.opacity = '0.5';
            analysisControls.style.pointerEvents = 'none';
            // Cargar capa de riesgos
            fetchRiskMap();
            map.addLayer(layers.risk);
            // También mostramos los equipos para referencia
            ['BioBox', 'ViaVerde', 'Ecovallas', 'General'].forEach(k => layers[k].addTo(map));
        }
    };

    // --- NUEVO: API DE MAPA DE RIESGOS ---
    async function fetchRiskMap() {
        try {
            const res = await fetch('/api/incidents/risk-map');
            const data = await res.json();
            layers.risk.clearLayers();

            data.forEach(d => {
                let color = '#22c55e'; // Verde
                let radius = 150;
                
                if (d.risk_level === 'unstable') { color = '#eab308'; radius = 300; } // Amarillo
                if (d.risk_level === 'critical') { color = '#ef4444'; radius = 500; } // Rojo

                L.circle([d.lat, d.lng], {
                    color: color, fillColor: color, fillOpacity: 0.3, radius: radius, weight: 1, pane: 'riskPane'
                }).bindPopup(`
                    <div style="text-align:center;">
                        <strong>${d.device_id}</strong><br>
                        <span style="color:${color}; font-weight:bold;">${d.risk_level.toUpperCase()}</span><br>
                        <small>Auto Desc.: ${d.auto_disconnects} | Reportes: ${d.manual_reports}</small>
                    </div>
                `).addTo(layers.risk);
            });
        } catch(e) { console.error("Error risk map", e); }
    }

    // --- NUEVO: REPORTE DE INCIDENTES ---
    window.openIncidentModal = (name) => {
        document.getElementById('modal-dev-name').innerText = name;
        document.getElementById('modal-dev-id').value = name;
        document.getElementById('incident-modal').style.display = 'flex';
    };
    window.closeModal = () => document.getElementById('incident-modal').style.display = 'none';
    
    window.submitIncident = async () => {
        const id = document.getElementById('modal-dev-id').value;
        const type = document.getElementById('inc-type').value;
        const desc = document.getElementById('inc-desc').value;
        
        try {
            const res = await fetch('/api/incidents/report', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ device_id: id, type: type, description: desc })
            });
            if(res.ok) {
                alert("Reporte registrado. Se sumará al historial de la zona.");
                closeModal();
                if(currentMode === 'risk') fetchRiskMap(); // Actualizar si estamos viendo riesgos
            }
        } catch(e) { alert("Error"); }
    };

    // --- FUNCIONES ORIGINALES (Restauradas intactas) ---
    async function fetchLiveNucs() {
        try {
            const response = await fetch('/api/data');
            const rawData = await response.json();
            const devices = Object.values(rawData);
            
            ['BioBox', 'ViaVerde', 'Ecovallas', 'General'].forEach(k => layers[k].clearLayers());

            devices.forEach(dev => {
                if (!dev.lat || !dev.lng) return;
                let statusClass = dev.status === 'offline' ? 'nuc-offline' : (dev.cpu_load_percent > 90 ? 'nuc-critical' : 'nuc-online');
                let iconName = dev.status === 'offline' ? 'power-off' : 'desktop';

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="nuc-marker ${statusClass}"><i class="fa-solid fa-${iconName}"></i></div>`,
                    iconSize: [24, 24]
                });

                // POPUP ACTUALIZADO CON BOTÓN DE REPORTE
                const popupContent = `
                    <div style="min-width:180px; font-family: sans-serif;">
                        <strong>${dev.pc_name}</strong><br>
                        <span style="color:#666; font-size:11px;">${dev.unit || 'General'}</span>
                        <hr style="margin:5px 0;">
                        <div style="font-size:12px;">
                            Estado: <b>${dev.status || 'ONLINE'}</b><br>
                            Caídas Auto: <b>${dev.disconnect_count || 0}</b>
                        </div>
                        <button onclick="openIncidentModal('${dev.pc_name}')" style="width:100%; margin-top:8px; background:#fee2e2; color:#b91c1c; border:none; padding:5px; border-radius:4px; font-size:11px; cursor:pointer; font-weight:bold;">
                            <i class="fa-solid fa-bullhorn"></i> Reportar Causa
                        </button>
                    </div>`;

                const marker = L.marker([dev.lat, dev.lng], { icon: icon, pane: 'nucPane' }).bindPopup(popupContent);
                const unit = dev.unit || 'General';
                if (layers[unit]) { layers[unit].addLayer(marker); markerRegistry[dev.pc_name] = marker; }
                else { layers['General'].addLayer(marker); markerRegistry[dev.pc_name] = marker; }
            });
            
            updateSidebars(devices);
            updateKPIs(devices);
        } catch (e) { console.error("Error API", e); }
    }

    function updateSidebars(devices) {
        const container = document.getElementById('dynamic-panels');
        const groups = {};
        devices.forEach(d => { const u = d.unit || 'General'; if (!groups[u]) groups[u] = []; groups[u].push(d); });
        container.innerHTML = '';
        Object.entries(groups).forEach(([u, devs]) => {
            if (devs.length > 0) {
                container.innerHTML += `
                    <div class="control-card">
                        <div class="card-header" onclick="toggleCard(this)"><span>${u} <small>(${devs.length})</small></span><i class="fa-solid fa-chevron-down text-slate-400"></i></div>
                        <div class="card-body hidden"><div class="marker-list">${devs.map(d => `<div class="marker-row" onclick="zoomToMarker('${d.pc_name}')"><div class="status-dot ${d.status==='offline'?'dot-red':'dot-green'}"></div><label style="flex:1">${d.pc_name}</label></div>`).join('')}</div></div>
                    </div>`;
            }
        });
    }

    function initRedData() {
        if (typeof SPEEDTEST_DATA === 'undefined') return;
        const feats = { high: [], mid: [], low: [] };
        SPEEDTEST_DATA.features.forEach(f => {
            const d = f.properties.download;
            if(d > 50) feats.high.push(f); else if(d > 10) feats.mid.push(f); else feats.low.push(f);
        });
        const style = c => ({ weight: 1, color: c, fillOpacity: 0.4, fillColor: c });
        layers.high.addLayer(L.geoJson(feats.high, { pane: 'redPane', style: style('#16a34a') }));
        layers.mid.addLayer(L.geoJson(feats.mid, { pane: 'redPane', style: style('#eab308') }));
        layers.low.addLayer(L.geoJson(feats.low, { pane: 'redPane', style: style('#ef4444') }));
    }

    function initAfluenciaData() {
        const horarios = [9, 18];
        horarios.forEach(h => {
            const heat = [];
            PUNTOS_BASE_AFLUENCIA.forEach(p => { for(let i=0;i<20;i++) heat.push([p[0]+(Math.random()-.5)*.02, p[1]+(Math.random()-.5)*.02, 0.7]); });
            afluenciaHeatmapLayers[h] = L.heatLayer(heat, { radius: 35, blur: 25, pane: 'heatmapPane' });
        });
    }

    function initFallasElectricas() {
        const heat = [];
        DATA_INTERMITENCIAS.forEach(p => { for(let i=0;i<30;i++) heat.push([p[0]+(Math.random()-.5)*.04, p[1]+(Math.random()-.5)*.04, 0.6]); });
        L.heatLayer(heat, { radius: 40, blur: 30, gradient: {0.5:'red'}, pane: 'heatmapPane' }).addTo(layers.fallas_electricas);
    }

    function initInfraestructura() {
        DATA_POI.forEach(p => {
            const icon = L.divIcon({ html: `<i class="fa-solid fa-${p[3]}" style="color:${p[4]}; font-size:14px;"></i>`, className: 'custom-fa-icon', iconSize: [26, 26] });
            L.marker([p[0], p[1]], {icon: icon, pane: 'markerPane'}).bindPopup(`<b>${p[2]}</b>`).addTo(layers.poi);
        });
        const lines = [{c:'#f06292', p:[[19.42,-99.12],[19.43,-99.14]]}];
        lines.forEach(l => L.polyline(l.p, {color: l.c, weight: 4, pane:'markerPane'}).addTo(layers.metro));
    }

    window.activateExclusiveMode = (mode) => {
        ['high', 'mid', 'low', 'afluencia', 'fallas_electricas'].forEach(k => { if (layers[k]) map.removeLayer(layers[k]); });
        if (mode === 'red') { map.addLayer(layers.high); map.addLayer(layers.mid); map.addLayer(layers.low); }
        else if (mode === 'afluencia') { map.addLayer(layers.afluencia); updateAfluenciaHeatmap(document.getElementById('heatmap-time-selector').value); }
        else if (mode === 'fallas') { map.addLayer(layers.fallas_electricas); }
    };

    window.updateAfluenciaHeatmap = (h) => {
        layers.afluencia.clearLayers();
        if (h !== 'off' && afluenciaHeatmapLayers[h]) layers.afluencia.addLayer(afluenciaHeatmapLayers[h]);
    };

    window.toggleLayer = (lid, ch) => { if (ch) map.addLayer(layers[lid]); else map.removeLayer(layers[lid]); };
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('collapsed');
    window.toggleCard = (h) => { h.nextElementSibling.classList.toggle('hidden'); h.querySelector('i.fa-chevron-down').classList.toggle('fa-rotate-180'); };
    window.zoomToMarker = (name) => { const m = markerRegistry[name]; if (m) { map.flyTo(m.getLatLng(), 16); m.openPopup(); } };
    function updateKPIs(d) { 
        document.getElementById('kpi-online').innerText = d.length - d.filter(x=>x.status==='offline').length; 
        document.getElementById('kpi-issues').innerText = d.filter(x=>x.status==='offline').length; 
    }

    init();
});
</script>
{% endblock %}
