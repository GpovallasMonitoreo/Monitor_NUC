{% extends 'base.html' %}

{% block header_title %}Mapa de Infraestructura y Riesgos Corporativos{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
    /* --- ESTILOS NUCLEO --- */
    #app-container { position: relative; height: calc(100vh - 5rem); width: 100%; overflow: hidden; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; }
    #map { height: 100%; width: 100%; z-index: 1; background: #e2e8f0; }
    #sidebar { position: absolute; top: 0; bottom: 0; right: 0; width: 350px; background: #ffffff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 2000; display: flex; flex-direction: column; transition: transform 0.3s ease; border-left: 1px solid #e2e8f0; }
    #sidebar.collapsed { transform: translateX(100%); }
    #sidebar-toggle { position: absolute; top: 20px; right: 365px; z-index: 2001; background: #334155; color: white; border: none; width: 40px; height: 40px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    
    /* KPI CARDS */
    .kpi-dashboard { position: absolute; top: 15px; left: 15px; z-index: 1000; display: flex; gap: 10px; }
    .kpi-card { background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; min-width: 120px; }
    .kpi-value { font-size: 1.25rem; font-weight: 800; display: block; }
    
    /* MARKERS NUC */
    .nuc-marker { display: flex; justify-content: center; align-items: center; background: white; border-radius: 6px; border: 2px solid #64748b; width: 28px; height: 28px; }
    .nuc-online { border-color: #10b981; color: #10b981; background: #f0fdf4; }
    .nuc-offline { border-color: #ef4444; color: #ef4444; background: #fef2f2; }

    /* LEGENDA RED */
    .red-legend { position: absolute; bottom: 30px; left: 15px; z-index: 1000; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; font-size: 0.75rem; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .legend-color { width: 15px; height: 15px; border-radius: 3px; }

    /* UTILITIES */
    .hidden { display: none !important; }
    .control-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
    .card-header { padding: 12px 15px; background: #f8fafc; font-weight: 700; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: space-between; }
    .layer-toggle { padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; font-size: 0.75rem; }
    .switch { position: relative; width: 30px; height: 16px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; inset: 0; background: #cbd5e1; transition: .2s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background: #4f46e5; }
    input:checked + .slider:before { transform: translateX(14px); }
</style>

<div id="app-container">
    <div class="kpi-dashboard">
        <div class="kpi-card">
            <span style="font-size: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase;">En Línea</span>
            <span class="kpi-value text-emerald-600" id="kpi-online">0</span>
        </div>
        <div class="kpi-card">
            <span style="font-size: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase;">Alertas</span>
            <span class="kpi-value text-rose-600" id="kpi-issues">0</span>
        </div>
        <div class="kpi-card">
            <span style="font-size: 10px; font-weight: bold; color: #94a3b8; text-transform: uppercase;">Velocidad Promedio</span>
            <span class="kpi-value text-blue-600" id="avg-speed">--</span>
        </div>
    </div>

    <div class="red-legend" id="red-legend">
        <div style="font-weight: bold; margin-bottom: 8px; font-size: 0.8rem;">Calidad de Red (Mbps)</div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #16a34a;"></div>
            <span>Alta (>50 Mbps)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #eab308;"></div>
            <span>Media (10-50 Mbps)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ef4444;"></div>
            <span>Baja (<10 Mbps)</span>
        </div>
    </div>

    <div id="map"></div>

    <div id="sidebar">
        <div class="sidebar-header" style="padding: 18px 20px; border-bottom: 1px solid #e2e8f0;">
            <h2 class="text-sm font-bold text-slate-800 uppercase">Control de Infraestructura</h2>
        </div>
        <div class="sidebar-content" style="padding: 15px; overflow-y: auto;">
            <div class="control-card">
                <div class="card-header"><span>CAPAS DE RED</span></div>
                <div class="layer-toggle">
                    <span>Ver Cuadros de Red</span>
                    <label class="switch">
                        <input type="checkbox" checked onchange="toggleLayer('redZones', this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div id="dynamic-panels"></div>
        </div>
    </div>
    <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = null;
const markerRegistry = {};
const layers = {
    redZones: L.layerGroup(),
    nucs: L.layerGroup()
};

// --- DATOS DE ZONAS (CUADROS) ---
const ZONAS_CDMX = [
    { name: "Centro Histórico", bounds: [[19.428, -99.145], [19.445, -99.125]], speed: 45, color: "#eab308" },
    { name: "Polanco", bounds: [[19.430, -99.210], [19.445, -99.195]], speed: 85, color: "#16a34a" },
    { name: "Santa Fe", bounds: [[19.350, -99.280], [19.370, -99.260]], speed: 30, color: "#eab308" },
    { name: "Tlalpan", bounds: [[19.280, -99.170], [19.300, -99.150]], speed: 8, color: "#ef4444" },
    { name: "Iztapalapa", bounds: [[19.350, -99.100], [19.370, -99.080]], speed: 5, color: "#ef4444" }
];

function init() {
    map = L.map('map', { zoomControl: false }).setView([19.4326, -99.1332], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    layers.redZones.addTo(map);
    layers.nucs.addTo(map);

    createRedZones();
    fetchLiveNucs();
    setInterval(fetchLiveNucs, 5000);
}

// --- FUNCIÓN PARA CREAR LOS CUADROS DE RED ---
function createRedZones() {
    layers.redZones.clearLayers();
    
    ZONAS_CDMX.forEach(zone => {
        // Se dibuja el RECTÁNGULO (cuadro) eliminando cualquier forma circular
        const rectangle = L.rectangle(zone.bounds, {
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: 0.3,
            weight: 2
        }).addTo(layers.redZones);

        rectangle.bindPopup(`
            <div style="text-align:center">
                <strong style="color:${zone.color}">${zone.name}</strong><br>
                Velocidad: <b>${zone.speed} Mbps</b>
            </div>
        `);

        // Etiqueta de texto centrada en el cuadro
        const center = rectangle.getBounds().getCenter();
        L.marker(center, {
            icon: L.divIcon({
                className: 'speed-label',
                html: `<div style="color:white; background:${zone.color}; padding:2px 5px; border-radius:3px; font-size:9px; font-weight:bold; border:1px solid white">${zone.speed} Mb</div>`,
                iconSize: [40, 20]
            }),
            interactive: false
        }).addTo(layers.redZones);
    });
}

async function fetchLiveNucs() {
    try {
        const res = await fetch('/api/data');
        const data = await res.json();
        const devices = Object.values(data);

        devices.forEach(dev => {
            if (!dev.lat || !dev.lng) return;
            const statusClass = dev.status === 'offline' ? 'nuc-offline' : 'nuc-online';
            
            if (markerRegistry[dev.pc_name]) {
                markerRegistry[dev.pc_name].setLatLng([dev.lat, dev.lng]);
            } else {
                const marker = L.marker([dev.lat, dev.lng], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="nuc-marker ${statusClass}"><i class="fa-solid fa-desktop"></i></div>`,
                        iconSize: [28, 28]
                    })
                }).bindPopup(`<b>${dev.pc_name}</b>`).addTo(layers.nucs);
                markerRegistry[dev.pc_name] = marker;
            }
        });

        document.getElementById('kpi-online').innerText = devices.filter(x => x.status !== 'offline').length;
        document.getElementById('kpi-issues').innerText = devices.filter(x => x.status === 'offline').length;
    } catch (e) { console.error("Error NUCs", e); }
}

window.toggleLayer = (id, show) => show ? map.addLayer(layers[id]) : map.removeLayer(layers[id]);
window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('collapsed');

document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}
