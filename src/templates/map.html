{% extends 'base.html' %}

{% block header_title %}Mapa de Red{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<div id="map" style="height: 80vh; width: 100%; border-radius: 12px; z-index: 1;"></div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. INICIALIZAR MAPA
    const map = L.map('map').setView([19.4326, -99.1332], 12); // CDMX
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: 'Argos'
    }).addTo(map);

    const markers = {};
    
    // Base de datos de coordenadas simuladas (por si el agente no manda GPS)
    const FIXED_COORDS = {
        'LUNAMARIOPMX5264': [19.4326, -99.1332],
        'MX_NUC_001': [19.4270, -99.1677]
    };

    function getLocation(dev) {
        // Prioridad: 1. GPS del agente, 2. Base de datos fija, 3. Aleatorio
        if (dev.lat && dev.lng) return [dev.lat, dev.lng];
        if (FIXED_COORDS[dev.pc_name]) return FIXED_COORDS[dev.pc_name];
        
        // Generar aleatorio y guardar para que no brinque
        if (!FIXED_COORDS[dev.pc_name]) {
            FIXED_COORDS[dev.pc_name] = [
                19.4326 + (Math.random() - 0.5) * 0.1,
                -99.1332 + (Math.random() - 0.5) * 0.1
            ];
        }
        return FIXED_COORDS[dev.pc_name];
    }

    async function updateMap() {
        try {
            const res = await fetch('/api/data');
            const rawData = await res.json();
            const devices = Object.values(rawData);

            devices.forEach(dev => {
                const loc = getLocation(dev);
                const color = dev.status === 'offline' ? '#94a3b8' : '#10b981';
                
                // Icono CSS personalizado
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background:${color}; width:14px; height:14px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [14, 14]
                });

                if (markers[dev.pc_name]) {
                    markers[dev.pc_name].setLatLng(loc).setIcon(icon);
                } else {
                    markers[dev.pc_name] = L.marker(loc, {icon: icon})
                        .bindPopup(`<b>${dev.pc_name}</b><br>${dev.status}`)
                        .addTo(map);
                }
            });
        } catch(e) { console.error(e); }
    }

    setInterval(updateMap, 3000);
    updateMap();
});
</script>
{% endblock %}
