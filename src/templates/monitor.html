{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. URL CORRECTA
        const API_URL = '/api/data'; 
        let pcDataStore = {};
        let latencyHistory = {};
        let currentPc = null;
        let charts = { latency: null };

        if (typeof lucide !== 'undefined') lucide.createIcons();

        // --- Sincronización ---
        async function updateData() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("Error API");
                const rawData = await res.json();
                
                // 2. CONVERTIR DICCIONARIO A LISTA
                const devices = Object.values(rawData);
                
                devices.forEach(dev => {
                    // 3. NORMALIZAR VARIABLES (Backend -> Frontend)
                    // El backend manda cpu_load_percent, el frontend usa cpu_percent
                    dev.cpu_percent = dev.cpu_load_percent || 0;
                    dev.latency = dev.latency_ms || 0;
                    if (!dev.unit) dev.unit = "General";

                    pcDataStore[dev.pc_name] = dev;
                    
                    if (!latencyHistory[dev.pc_name]) latencyHistory[dev.pc_name] = [];
                    latencyHistory[dev.pc_name].push({ x: new Date(), y: dev.latency });
                    if (latencyHistory[dev.pc_name].length > 20) latencyHistory[dev.pc_name].shift();
                });

                renderGrid();
                updateUnitFilter(devices);
                if (currentPc && pcDataStore[currentPc]) refreshModalData();
                document.getElementById('loading-indicator').style.display = 'none';
            } catch (e) { console.error(e); }
        }

        function renderGrid() {
            const container = document.getElementById('pc-cards-container');
            const search = document.getElementById('search-bar').value.toLowerCase();
            const unitFilter = document.getElementById('unit-filter').value;
            container.innerHTML = '';
            
            Object.values(pcDataStore).forEach(pc => {
                if (unitFilter !== 'all' && pc.unit !== unitFilter) return;
                // Búsqueda segura (valida que existan los campos)
                const searchStr = (pc.pc_name + (pc.ip || '')).toLowerCase();
                if (!searchStr.includes(search)) return;

                let latencyColor = pc.latency > 100 ? "text-red-600" : (pc.latency > 50 ? "text-amber-500" : "text-slate-900");
                
                // Obtener temperatura segura
                let temp = 40;
                if(pc.extended_sensors && pc.extended_sensors['Intel CPU']) {
                    const t = pc.extended_sensors['Intel CPU'].find(s => s.tipo === 'Temperature');
                    if(t) temp = t.valor;
                }

                const card = document.createElement('div');
                card.className = 'card cursor-pointer group hover:border-indigo-300';
                card.onclick = () => openModal(pc.pc_name);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-slate-800 leading-tight group-hover:text-indigo-600 transition">${pc.pc_name}</h3>
                            <span class="text-[10px] font-black text-indigo-500 uppercase tracking-widest bg-indigo-50 px-2 py-0.5 rounded">${pc.unit}</span>
                        </div>
                        <div class="status-dot ${pc.status === 'online' ? 'status-online' : 'status-offline'}"></div>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span class="text-4xl font-black ${latencyColor}">${pc.latency}</span>
                        <span class="text-sm font-bold text-slate-400">ms</span>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-100 grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <span class="block text-[9px] font-bold text-slate-400 uppercase">CPU</span>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-1 mb-1">
                                <div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${pc.cpu_percent}%"></div>
                            </div>
                            <span class="text-sm font-bold text-slate-700">${Math.round(pc.cpu_percent)}%</span>
                        </div>
                        <div class="text-center">
                            <span class="block text-[9px] font-bold text-slate-400 uppercase">Temp</span>
                            <span class="text-sm font-bold ${temp > 70 ? 'text-red-500' : 'text-slate-700'}">${Math.round(temp)}°C</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openModal(pcName) {
            currentPc = pcName;
            document.getElementById('modal-pc-name').textContent = pcName;
            document.getElementById('pc-modal-overlay').classList.replace('hidden', 'flex');
            switchTab('general');
            refreshModalData();
        }

        function refreshModalData() {
            if(!currentPc || !pcDataStore[currentPc]) return;
            const pc = pcDataStore[currentPc];
            
            let temp = 0;
            if(pc.extended_sensors && pc.extended_sensors['Intel CPU']) {
               const t = pc.extended_sensors['Intel CPU'].find(s => s.tipo === 'Temperature');
               if(t) temp = t.valor;
            }

            document.getElementById('modal-status-line').innerHTML = `
                <span class="font-bold ${pc.status === 'online' ? 'text-emerald-500' : 'text-red-500'}">● ${pc.status.toUpperCase()}</span>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500 font-mono">IP: ${pc.ip || '0.0.0.0'}</span>
            `;

            document.getElementById('info-panel').innerHTML = `
                <div class="flex justify-between py-2 border-b border-slate-50"><span>Unidad:</span> <b class="text-indigo-600">${pc.unit}</b></div>
                <div class="flex justify-between py-2 border-b border-slate-50"><span>Latencia:</span> <b>${pc.latency} ms</b></div>
                <div class="flex justify-between py-2 border-b border-slate-50"><span>CPU:</span> <b>${pc.cpu_percent.toFixed(1)}%</b></div>
                <div class="flex justify-between py-2 border-b border-slate-50"><span>RAM:</span> <b>${pc.ram_percent.toFixed(1)}%</b></div>
                <div class="flex justify-between py-2"><span>Temp:</span> <b>${temp.toFixed(1)}°C</b></div>
            `;

            updateLatencyChart();
            updateHardwareGrid(pc);
            updateSpecsTab(pc);
        }

        function updateSpecsTab(pc) {
            const specsHtml = `
                <div><p class="text-slate-500 text-xs uppercase font-bold mb-1">Nombre Equipo</p><p class="font-semibold text-slate-800">${pc.pc_name}</p></div>
                <div><p class="text-slate-500 text-xs uppercase font-bold mb-1">IP Pública</p><p class="font-semibold text-slate-800">${pc.public_ip || 'N/A'}</p></div>
                <div><p class="text-slate-500 text-xs uppercase font-bold mb-1">IP Local</p><p class="font-semibold text-slate-800">${pc.ip}</p></div>
                <div><p class="text-slate-500 text-xs uppercase font-bold mb-1">Última Conexión</p><p class="font-mono text-slate-600 text-xs bg-slate-100 p-1 rounded inline-block">${new Date(pc.timestamp).toLocaleString()}</p></div>
            `;
            document.getElementById('specs-current').innerHTML = specsHtml;
            document.getElementById('specs-history').innerHTML = `<div class="p-4 text-sm text-slate-500">Historial no disponible en versión demo.</div>`;
        }

        function updateLatencyChart() {
            const ctx = document.getElementById('latency-chart').getContext('2d');
            const dataPoints = latencyHistory[currentPc] || [];
            
            if (charts.latency) charts.latency.destroy();
            
            charts.latency = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Latencia (ms)',
                        data: dataPoints,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true, tension: 0.4, pointRadius: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { legend: {display: false} },
                    scales: { 
                        x: { type: 'time', time: { unit: 'second' }, grid: { display: false } }, 
                        y: { beginAtZero: true, suggestedMax: 100 } 
                    }
                }
            });
        }

        function updateHardwareGrid(pc) {
            document.getElementById('hardware-grid').innerHTML = `
                <div class="p-4 bg-white border border-slate-200 rounded-lg shadow-sm">
                    <span class="block text-[10px] font-bold text-slate-400 uppercase">Estado</span>
                    <span class="text-md font-bold ${pc.status==='online'?'text-emerald-600':'text-red-600'}">${pc.status.toUpperCase()}</span>
                </div>
                <div class="p-4 bg-white border border-slate-200 rounded-lg shadow-sm">
                    <span class="block text-[10px] font-bold text-slate-400 uppercase">Carga CPU</span>
                    <span class="text-md font-bold text-slate-700">${pc.cpu_percent}%</span>
                </div>
                <div class="p-4 bg-white border border-slate-200 rounded-lg shadow-sm">
                    <span class="block text-[10px] font-bold text-slate-400 uppercase">Disco Libre</span>
                    <span class="text-md font-bold text-emerald-600">${pc.disk_free_gb || 0} GB</span>
                </div>
            `;
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.querySelector(`[data-tab="${id}"]`).classList.add('active');
        }

        function updateUnitFilter(devices) {
            const select = document.getElementById('unit-filter');
            if (select.options.length > 1) return;
            const units = [...new Set(devices.map(d => d.unit))];
            units.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.textContent = u;
                select.appendChild(opt);
            });
        }

        document.getElementById('modal-tabs').onclick = (e) => { if(e.target.classList.contains('modal-tab')) switchTab(e.target.dataset.tab); };
        document.getElementById('modal-close-button').onclick = () => { document.getElementById('pc-modal-overlay').classList.replace('flex', 'hidden'); currentPc = null; };
        document.getElementById('search-bar').oninput = renderGrid;
        document.getElementById('unit-filter').onchange = renderGrid;

        setInterval(updateData, 2000);
        updateData();
    });
</script>
{% endblock %}
