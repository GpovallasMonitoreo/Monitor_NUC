{% extends 'base.html' %}

{% block header_title %}Centro de Comando y An√°lisis{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<div class="max-w-8xl mx-auto space-y-6">

    <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-6 text-white shadow-xl border border-slate-700">
        <div class="flex items-start justify-between">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="brain-circuit" class="w-6 h-6 text-indigo-400"></i>
                    <h2 class="text-lg font-bold">An√°lisis Inteligente de Red</h2>
                </div>
                <p id="ai-summary" class="text-slate-300 text-sm leading-relaxed max-w-4xl">
                    Inicializando motor de an√°lisis heur√≠stico...
                </p>
                <div id="ai-recommendation" class="mt-4 p-3 bg-white/10 rounded-lg border border-white/10 text-xs font-mono text-indigo-200 hidden">
                    </div>
            </div>
            <button onclick="downloadReport()" class="group flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg transition-all shadow-lg hover:shadow-indigo-500/25">
                <i data-lucide="file-down" class="w-4 h-4"></i>
                <span class="text-sm font-medium">Informe Ejecutivo</span>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:border-indigo-300 transition-colors">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Flota Total</p>
            <h3 class="text-2xl font-black text-slate-800 mt-1" id="kpi-total">--</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:border-red-300 transition-colors">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Atenci√≥n Requerida</p>
            <h3 class="text-2xl font-black text-slate-800 mt-1" id="kpi-offline">--</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Salud CPU</p>
            <div class="flex items-baseline gap-2">
                <h3 class="text-2xl font-black text-slate-800 mt-1" id="kpi-cpu">--%</h3>
                <span id="cpu-trend" class="text-xs font-medium">--</span>
            </div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Latencia Red</p>
            <h3 class="text-2xl font-black text-slate-800 mt-1" id="kpi-latency">-- ms</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-amber-400">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Foco de Atenci√≥n</p>
            <h3 class="text-lg font-bold text-slate-800 mt-1 truncate" id="kpi-focus">Analizando...</h3>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[500px]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <h3 class="font-bold text-slate-700">Inventario en Tiempo Real</h3>
                    <div class="flex bg-slate-200 rounded-lg p-1">
                        <button onclick="filterTable('all')" class="filter-btn px-3 py-1 text-xs font-medium rounded-md bg-white shadow-sm text-slate-700" id="btn-all">Todos</button>
                        <button onclick="filterTable('ECOVALLAS')" class="filter-btn px-3 py-1 text-xs font-medium rounded-md text-slate-500 hover:text-slate-700" id="btn-ev">Ecovallas</button>
                        <button onclick="filterTable('VIAVERDE')" class="filter-btn px-3 py-1 text-xs font-medium rounded-md text-slate-500 hover:text-slate-700" id="btn-vv">ViaVerde</button>
                        <button onclick="filterTable('BIOBOX')" class="filter-btn px-3 py-1 text-xs font-medium rounded-md text-slate-500 hover:text-slate-700" id="btn-bb">BioBox</button>
                    </div>
                </div>
                <span class="text-xs text-slate-400 font-mono" id="last-update">Sync...</span>
            </div>
            
            <div class="overflow-auto flex-1">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b sticky top-0 backdrop-blur-sm z-10">
                        <tr>
                            <th class="px-6 py-3">Unidad</th>
                            <th class="px-6 py-3">Dispositivo</th>
                            <th class="px-6 py-3 text-center">Estado</th>
                            <th class="px-6 py-3 text-center">Rendimiento</th>
                            <th class="px-6 py-3 text-right">Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="devices-table-body" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 h-[240px]">
                <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Salud por Unidad</h4>
                <div class="relative h-[180px] w-full">
                    <canvas id="healthChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 h-[240px]">
                <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Distribuci√≥n de Alertas</h4>
                <div class="relative h-[180px] w-full flex justify-center">
                    <canvas id="alertsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables Globales
    let globalDevices = [];
    let currentFilter = 'all';
    let charts = {};
    let aiInsights = { summary: '', recommendation: '' };

    // --- 1. L√ìGICA DE CLASIFICACI√ìN (Detectar Unidad) ---
    function detectUnit(pcName) {
        if (!pcName) return 'GENERAL';
        const name = pcName.toUpperCase();
        
        // Reglas de negocio para detectar unidad
        if (name.includes('MX_EV') || name.includes('ECO') || name.includes('VALLA')) return 'ECOVALLAS';
        if (name.includes('MX_VV') || name.includes('VIA') || name.includes('VERDE')) return 'VIAVERDE';
        if (name.includes('MX_BB') || name.includes('BIO') || name.includes('BOX')) return 'BIOBOX';
        if (name.includes('MX_CM') || name.includes('MGP')) return 'MGP'; // Extra por si acaso
        
        return 'OTROS';
    }

    function getUnitColor(unit) {
        switch(unit) {
            case 'ECOVALLAS': return 'bg-blue-100 text-blue-700 border-blue-200';
            case 'VIAVERDE': return 'bg-green-100 text-green-700 border-green-200';
            case 'BIOBOX': return 'bg-amber-100 text-amber-700 border-amber-200';
            default: return 'bg-slate-100 text-slate-600 border-slate-200';
        }
    }

    // --- 2. CORE: FETCH DATA ---
    async function fetchData() {
        try {
            const response = await fetch('/api/data');
            const rawData = await response.json();
            
            // Procesar y enriquecer datos
            globalDevices = Object.values(rawData).map(d => ({
                ...d,
                unit: detectUnit(d.pc_name),
                health_score: calculateHealthScore(d)
            }));

            // Ejecutar pipelines
            updateAIAnalysis(globalDevices);
            updateKPIs(globalDevices);
            updateCharts(globalDevices);
            renderTable();
            
            const now = new Date();
            document.getElementById('last-update').innerText = `Sync: ${now.toLocaleTimeString()}`;

        } catch (error) {
            console.error('Argos Error:', error);
        }
    }

    function calculateHealthScore(device) {
        // Algoritmo simple de salud (0-100)
        let score = 100;
        if (device.status === 'offline') return 0;
        if (device.cpu_load_percent > 80) score -= 30;
        if (device.latency_ms > 200) score -= 20;
        if (device.disk_percent > 90) score -= 20;
        return Math.max(0, score);
    }

    // --- 3. MOTOR DE INTELIGENCIA (ARGOS AI) ---
    function updateAIAnalysis(devices) {
        const total = devices.length;
        if (total === 0) return;

        const offline = devices.filter(d => d.status === 'offline');
        const critical = devices.filter(d => d.health_score > 0 && d.health_score < 50);
        const highLatency = devices.filter(d => d.latency_ms > 150);

        // An√°lisis por Unidad
        const units = ['ECOVALLAS', 'VIAVERDE', 'BIOBOX'];
        let worstUnit = { name: '', offlinePct: 0 };

        units.forEach(u => {
            const unitDevs = devices.filter(d => d.unit === u);
            if (unitDevs.length > 0) {
                const off = unitDevs.filter(d => d.status === 'offline').length;
                const pct = (off / unitDevs.length) * 100;
                if (pct > worstUnit.offlinePct) worstUnit = { name: u, offlinePct: pct };
            }
        });

        // Generaci√≥n de Texto Natural
        let summary = '';
        let recommendation = '';

        if (offline.length === 0 && critical.length === 0) {
            summary = `üü¢ **Sistema Estable.** La flota de ${total} equipos opera con normalidad. Los tiempos de latencia son √≥ptimos y no hay alertas cr√≠ticas.`;
            recommendation = "Mantenimiento preventivo rutinario recomendado.";
        } else {
            if (offline.length > (total * 0.1)) {
                summary = `üî¥ **Alerta Cr√≠tica de Conectividad.** Se detecta una ca√≠da del ${((offline.length/total)*100).toFixed(1)}% de la red. `;
                if (worstUnit.name) summary += `El impacto se concentra mayormente en **${worstUnit.name}**.`;
                recommendation = "Revisar concentradores de red principales y suministro el√©ctrico en zonas afectadas.";
            } else if (critical.length > 0) {
                summary = `üü° **Degradaci√≥n de Rendimiento.** ${critical.length} equipos presentan alta carga de CPU o temperatura, aunque siguen online. Riesgo de fallo inminente.`;
                recommendation = "Revisar procesos en segundo plano (Agent Update) o ventilaci√≥n f√≠sica en equipos listados.";
            } else {
                summary = `üü† **Incidencias Aisladas.** Se reportan ${offline.length} equipos offline. El resto de la operaci√≥n es nominal.`;
                recommendation = "Generar tickets de soporte individual para los equipos desconectados.";
            }
        }

        // Render AI
        const aiContainer = document.getElementById('ai-summary');
        // Convertir markdown b√°sico a HTML simple
        aiContainer.innerHTML = summary.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-white">$1</span>');
        
        const recContainer = document.getElementById('ai-recommendation');
        recContainer.innerHTML = `<span class="text-indigo-400 font-bold">RECOMENDACI√ìN ARGOS:</span> ${recommendation}`;
        recContainer.classList.remove('hidden');

        // Guardar para reporte
        aiInsights = { summary: summary.replace(/\*\*/g, ''), recommendation };
        
        // Actualizar KPI de Foco
        const focusElem = document.getElementById('kpi-focus');
        if (worstUnit.offlinePct > 0) {
            focusElem.innerText = `${worstUnit.name} (${worstUnit.offlinePct.toFixed(0)}% Off)`;
            focusElem.className = "text-lg font-bold text-red-600 mt-1 truncate";
        } else {
            focusElem.innerText = "Ninguno";
            focusElem.className = "text-lg font-bold text-emerald-600 mt-1 truncate";
        }
    }

    // --- 4. ACTUALIZACI√ìN VISUAL ---
    function updateKPIs(devices) {
        const total = devices.length;
        const offline = devices.filter(d => d.status === 'offline' || d.status === 'critical').length;
        const avgCpu = devices.reduce((acc, d) => acc + (d.cpu_load_percent || 0), 0) / (total || 1);
        const avgLat = devices.reduce((acc, d) => acc + (d.latency_ms || 0), 0) / (total || 1);

        animateValue("kpi-total", parseInt(document.getElementById("kpi-total").innerText) || 0, total, 1000);
        document.getElementById('kpi-offline').innerText = offline;
        document.getElementById('kpi-offline').className = offline > 0 ? "text-2xl font-black text-red-500 mt-1" : "text-2xl font-black text-slate-800 mt-1";
        
        document.getElementById('kpi-cpu').innerText = avgCpu.toFixed(1) + '%';
        const cpuTrend = document.getElementById('cpu-trend');
        cpuTrend.innerText = avgCpu > 50 ? '‚ñ≤ Alta' : '‚ñº Estable';
        cpuTrend.className = avgCpu > 50 ? 'text-xs font-medium text-amber-500' : 'text-xs font-medium text-emerald-500';

        document.getElementById('kpi-latency').innerText = avgLat.toFixed(0) + ' ms';
    }

    function renderTable() {
        const tbody = document.getElementById('devices-table-body');
        tbody.innerHTML = '';

        // Filtrado
        const filtered = currentFilter === 'all' 
            ? globalDevices 
            : globalDevices.filter(d => d.unit === currentFilter);

        filtered.forEach(dev => {
            const unitBadge = `<span class="px-2 py-0.5 border rounded text-[10px] font-bold ${getUnitColor(dev.unit)}">${dev.unit}</span>`;
            
            let statusDot = dev.status === 'offline' 
                ? '<span class="flex h-3 w-3 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>' 
                : '<span class="h-2.5 w-2.5 rounded-full bg-emerald-500 block shadow-sm shadow-emerald-200"></span>';

            const row = `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 group">
                    <td class="px-6 py-4">${unitBadge}</td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-700 group-hover:text-indigo-600 transition-colors">${dev.pc_name}</div>
                        <div class="text-xs text-slate-400 font-mono">${dev.ip || '0.0.0.0'}</div>
                    </td>
                    <td class="px-6 py-4 flex justify-center pt-6">${statusDot}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2 text-xs">
                            <span class="w-8 text-right text-slate-500">CPU</span>
                            <div class="w-full bg-slate-200 rounded-full h-1.5">
                                <div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${dev.cpu_load_percent}%"></div>
                            </div>
                            <span class="w-8">${Math.round(dev.cpu_load_percent)}%</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs mt-1">
                            <span class="w-8 text-right text-slate-500">RAM</span>
                            <div class="w-full bg-slate-200 rounded-full h-1.5">
                                <div class="bg-purple-500 h-1.5 rounded-full" style="width: ${dev.ram_percent}%"></div>
                            </div>
                            <span class="w-8">${Math.round(dev.ram_percent)}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                         <span class="text-xs font-mono text-slate-500 bg-slate-100 px-2 py-1 rounded">${dev.latency_ms} ms</span>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function filterTable(filter) {
        currentFilter = filter;
        // Actualizar botones
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'shadow-sm', 'text-slate-700');
            btn.classList.add('text-slate-500');
        });
        
        let btnId = 'btn-all';
        if(filter === 'ECOVALLAS') btnId = 'btn-ev';
        if(filter === 'VIAVERDE') btnId = 'btn-vv';
        if(filter === 'BIOBOX') btnId = 'btn-bb';
        
        const activeBtn = document.getElementById(btnId);
        activeBtn.classList.add('bg-white', 'shadow-sm', 'text-slate-700');
        activeBtn.classList.remove('text-slate-500');

        renderTable();
    }

    // --- 5. GR√ÅFICAS (Chart.js) ---
    function updateCharts(devices) {
        // Datos para gr√°fico de barras (Salud por Unidad)
        const units = ['ECOVALLAS', 'VIAVERDE', 'BIOBOX'];
        const onlineData = units.map(u => devices.filter(d => d.unit === u && d.status !== 'offline').length);
        const offlineData = units.map(u => devices.filter(d => d.unit === u && d.status === 'offline').length);

        if (charts.health) charts.health.destroy();
        const ctx1 = document.getElementById('healthChart').getContext('2d');
        charts.health = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: units,
                datasets: [
                    { label: 'Online', data: onlineData, backgroundColor: '#10b981', borderRadius: 4 },
                    { label: 'Offline', data: offlineData, backgroundColor: '#ef4444', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { x: { stacked: true }, y: { stacked: true, display: false } }
            }
        });

        // Datos para gr√°fico circular (Alertas)
        const critical = devices.filter(d => d.health_score < 50 && d.status !== 'offline').length;
        const offline = devices.filter(d => d.status === 'offline').length;
        const stable = devices.length - critical - offline;

        if (charts.alerts) charts.alerts.destroy();
        const ctx2 = document.getElementById('alertsChart').getContext('2d');
        charts.alerts = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Estable', 'Cr√≠tico (CPU/Temp)', 'Offline'],
                datasets: [{
                    data: [stable, critical, offline],
                    backgroundColor: ['#e2e8f0', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } } }
            }
        });
    }

    // --- 6. GENERADOR DE PDF PROFESIONAL (jsPDF) ---
    async function downloadReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const now = new Date();

        // 1. Membrete / Header Profesional
        doc.setFillColor(30, 41, 59); // Slate 900
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text("ARGOS", 15, 20);
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("SISTEMA DE MONITOREO UNIFICADO", 15, 26);
        
        doc.text(`Fecha: ${now.toLocaleDateString()}`, 160, 20);
        doc.text(`Hora: ${now.toLocaleTimeString()}`, 160, 26);

        // 2. Resumen Ejecutivo (IA)
        doc.setTextColor(40, 40, 40);
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("1. Resumen Ejecutivo (IA)", 15, 55);

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        const splitSummary = doc.splitTextToSize(aiInsights.summary, 180);
        doc.text(splitSummary, 15, 65);
        
        doc.setFont("helvetica", "italic");
        doc.setTextColor(79, 70, 229); // Indigo
        const splitRec = doc.splitTextToSize(`Recomendaci√≥n: ${aiInsights.recommendation}`, 180);
        doc.text(splitRec, 15, 65 + (splitSummary.length * 5) + 5);

        // 3. Tabla de Datos Cr√≠ticos
        doc.setTextColor(40, 40, 40);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        let startY = 65 + (splitSummary.length * 5) + (splitRec.length * 5) + 20;
        doc.text("2. Detalle de Equipos Cr√≠ticos/Offline", 15, startY);

        // Filtrar solo equipos con problemas para el reporte (para no hacerlo de 50 hojas)
        const reportData = globalDevices
            .filter(d => d.status === 'offline' || d.health_score < 60)
            .map(d => [d.unit, d.pc_name, d.status.toUpperCase(), `${Math.round(d.cpu_load_percent)}%`, `${d.latency_ms}ms`]);

        if (reportData.length === 0) {
             doc.setFontSize(10);
             doc.setFont("helvetica", "normal");
             doc.text("No hay incidentes reportados. Todos los sistemas operan nominalmente.", 15, startY + 10);
        } else {
            doc.autoTable({
                startY: startY + 5,
                head: [['Unidad', 'Dispositivo', 'Estado', 'CPU', 'Latencia']],
                body: reportData,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }, // Indigo header
                styles: { fontSize: 8 },
            });
        }

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text('Generado por Argos AI System - Uso Confidencial', 105, 290, { align: 'center' });
        }

        doc.save(`Argos_Reporte_${now.toISOString().slice(0,10)}.pdf`);
    }

    // Utilidad animaci√≥n n√∫meros
    function animateValue(id, start, end, duration) {
        if (start === end) return;
        let range = end - start;
        let current = start;
        let increment = end > start ? 1 : -1;
        let stepTime = Math.abs(Math.floor(duration / range));
        let obj = document.getElementById(id);
        let timer = setInterval(function() {
            current += increment;
            obj.innerHTML = current;
            if (current == end) clearInterval(timer);
        }, Math.max(stepTime, 10)); // Min 10ms
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetchData();
        setInterval(fetchData, 5000); // 5 segundos
        
        // Iconos
        if(typeof lucide !== 'undefined') lucide.createIcons();
    });
</script>
{% endblock %}
