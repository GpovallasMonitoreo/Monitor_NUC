<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechView - Gestión</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Space Grotesk', sans-serif; }
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; }
        .nav-tab.active { color: #00e070; border-bottom: 2px solid #00e070; background-color: rgba(0, 224, 112, 0.05); }
        .cost-input { width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #00e070; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; z-index: 2000; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <header class="flex items-center justify-between border-b border-gray-200 px-6 py-3 bg-white sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="size-10 bg-green-500/10 rounded-lg flex items-center justify-center text-green-600">
                <span class="material-icons-outlined">analytics</span>
            </div>
            <div>
                <h2 class="text-lg font-bold leading-none">TechView</h2>
                <p class="text-xs text-gray-500 mt-1 font-mono truncate max-w-[200px]" id="device-display">{{ device_id }}</p>
            </div>
        </div>
        
        <nav class="hidden md:flex bg-gray-100 p-1 rounded-lg">
            <button onclick="switchTab('resumen')" class="nav-tab active px-4 py-1.5 rounded-md text-sm font-medium">Resumen</button>
            <button onclick="switchTab('capex')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium">CAPEX</button>
            <button onclick="switchTab('opex')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium">OPEX</button>
            <button onclick="switchTab('manto')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium">Mantenimiento</button>
            <button onclick="switchTab('specs')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium">Ficha NUC & Bitácora</button>
        </nav>

        <div class="flex items-center gap-3">
            <div id="unsaved-badge" class="hidden px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-full animate-pulse">Sin guardar</div>
            <button onclick="saveAll()" class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm shadow-lg">
                <span class="material-icons-outlined">save</span> Guardar
            </button>
            <button onclick="window.location.href='/techview/overview'" class="p-2 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg"><span class="material-icons-outlined">logout</span></button>
        </div>
    </header>

    <main class="flex-1 w-full max-w-[1600px] mx-auto px-4 py-6">
        
        <div id="tab-resumen" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">CAPEX Total</p>
                    <p class="text-2xl font-black text-gray-900" id="dash-capex">$0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-orange-100 bg-orange-50/20 shadow-sm">
                    <p class="text-xs text-orange-600 font-bold uppercase mb-1">Gasto Op. Histórico</p>
                    <p class="text-2xl font-black text-orange-700" id="dash-accum-opex">$0</p>
                    <p class="text-[10px] text-gray-400 mt-1">Incluye mantenimientos de bitácora</p>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-purple-100 bg-purple-50/20 shadow-sm">
                    <p class="text-xs text-purple-600 font-bold uppercase mb-1">Costo Total Proyecto</p>
                    <p class="text-2xl font-black text-purple-700" id="dash-total-project">$0</p>
                    <p class="text-[10px] text-gray-400 mt-1">CAPEX + OPEX Histórico</p>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                    <p class="text-xs text-gray-500 font-bold uppercase mb-1">ROI Actual</p>
                    <p class="text-2xl font-black text-gray-900" id="dash-roi">0m</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm h-80">
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-4">Proyección Flujo de Caja</h4>
                <canvas id="monthlyCostChart"></canvas>
            </div>
        </div>

        <div id="tab-capex" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4">Inversión Inicial</h3>
                <div class="grid grid-cols-3 gap-6">
                    <div><label class="text-xs font-bold text-gray-500">Pantalla</label><input type="number" class="cost-input" id="capex_screen"></div>
                    <div><label class="text-xs font-bold text-gray-500">Estructura</label><input type="number" class="cost-input" id="capex_structure"></div>
                    <div><label class="text-xs font-bold text-gray-500">NUC</label><input type="number" class="cost-input" id="capex_nuc"></div>
                    </div>
            </div>
        </div>

        <div id="tab-opex" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4">Gastos Mensuales</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="text-xs font-bold text-gray-500">Renta</label><input type="number" class="cost-input" id="opex_rent"></div>
                    <div><label class="text-xs font-bold text-gray-500">Luz</label><input type="number" class="cost-input" id="opex_light"></div>
                    <div><label class="text-xs font-bold text-green-600">Ventas Mensuales</label><input type="number" class="cost-input bg-green-50 border-green-200" id="revenue_monthly"></div>
                </div>
            </div>
        </div>

        <div id="tab-manto" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4">Costos Base Mantenimiento</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="text-xs font-bold text-blue-600">Preventivo (Bimestral)</label><input type="number" class="cost-input" id="maint_prev_bimonthly"></div>
                    <div><label class="text-xs font-bold text-red-600">Correctivo (Mano de Obra)</label><input type="number" class="cost-input" id="maint_corr_labor"></div>
                </div>
            </div>
        </div>

        <div id="tab-specs" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">Historial de Mantenimiento</h3>
                        <button onclick="toggleForm()" class="bg-gray-900 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2">
                            <i data-lucide="plus"></i> Nueva Entrada
                        </button>
                    </div>
                    
                    <div id="log-form-container" class="hidden bg-white p-6 rounded-2xl border border-indigo-100 shadow-inner mb-6">
                        <form id="new-log-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2 bg-indigo-50 p-3 rounded-xl flex justify-between text-xs font-bold">
                                <div>UBICACIÓN: <span id="form-loc">{{ device_id }}</span></div>
                            </div>
                            <div><label class="text-[10px] font-bold text-gray-400">SOLICITA</label><input type="text" id="log-req" class="w-full mt-1 p-2 border rounded-lg text-sm bg-gray-50"></div>
                            <div><label class="text-[10px] font-bold text-gray-400">EJECUTA</label><input type="text" id="log-exec" class="w-full mt-1 p-2 border rounded-lg text-sm bg-gray-50"></div>
                            <div><label class="text-[10px] font-bold text-gray-400">TIPO</label><select id="log-action" class="w-full mt-1 p-2 border rounded-lg text-sm bg-gray-50"><option value="Preventivo">Preventivo</option><option value="Correctivo">Correctivo</option><option value="Cambio HW">Cambio HW</option></select></div>
                            
                            <div>
                                <label class="text-[10px] font-bold text-green-600">COSTO ($)</label>
                                <input type="number" id="log-cost" class="w-full mt-1 p-2 border border-green-200 rounded-lg text-sm bg-green-50 font-bold" placeholder="0.00 (Opcional)">
                                <p class="text-[9px] text-gray-400 mt-1">*Si es 0, usa costo base</p>
                            </div>

                            <div class="md:col-span-2"><label class="text-[10px] font-bold text-gray-400">DESCRIPCIÓN</label><textarea id="log-desc" rows="2" class="w-full mt-1 p-2 border rounded-lg text-sm bg-gray-50"></textarea></div>
                            <div class="md:col-span-2 flex justify-end gap-2">
                                <button type="button" onclick="toggleForm()" class="px-4 py-2 text-xs text-gray-400 font-bold">Cancelar</button>
                                <button type="button" onclick="saveLog()" class="px-6 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-md">Guardar</button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="history-timeline" class="space-y-2 text-sm text-gray-500">Cargando historial...</div>
                </div>
                
                <div class="lg:col-span-4">
                    <div class="bg-white p-6 rounded-2xl border border-gray-200 sticky top-0">
                        <h3 class="font-black text-gray-800 mb-4 pb-2 border-b text-sm">ESPECIFICACIONES NUC</h3>
                        <div id="specs-summary" class="space-y-2 text-xs"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="loading-overlay" class="loading-overlay hidden"><div class="bg-white p-6 rounded-xl flex flex-col items-center"><div class="spinner mb-4"></div><p class="font-bold">Procesando...</p></div></div>
    <div id="toast-container"></div>

    <script>
        const deviceId = "{{ device_id }}";
        let pendingChanges = new Set();
        let chartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadDeviceData();
            setupInputs();
            updateHistoryTab(); // Cargar historial inicial
        });

        function setupInputs() {
            document.querySelectorAll('input:not([id^="log-"]), select:not([id^="log-"])').forEach(input => {
                input.addEventListener('input', (e) => {
                    pendingChanges.add(e.target.id);
                    document.getElementById('unsaved-badge').classList.remove('hidden');
                });
            });
        }

        async function loadDeviceData() {
            showLoading();
            try {
                const res = await fetch(`/techview/api/device/${encodeURIComponent(deviceId)}`);
                const data = await res.json();
                
                if (data.financials) {
                    Object.keys(data.financials).forEach(k => {
                        const el = document.getElementById(k);
                        if (el) el.value = data.financials[k];
                    });
                }

                if (data.advanced_kpis) {
                    setTxt('dash-accum-opex', formatCurrency(data.advanced_kpis.accumulated_opex));
                    setTxt('dash-total-project', formatCurrency(data.advanced_kpis.total_current_cost));
                }
                
                if (data.totals) {
                    setTxt('dash-capex', formatCurrency(data.totals.capex));
                    setTxt('dash-roi', `${data.totals.roi_months} meses`);
                }

                // Sensores
                if(data.device && data.device.sensors) updateSpecsSummary(data.device.sensors);

                initChart(data.financials);

            } catch (e) { console.error(e); } 
            finally { hideLoading(); }
        }

        function updateSpecsSummary(sensors) {
            const container = document.getElementById('specs-summary');
            container.innerHTML = '';
            for(const [cat, items] of Object.entries(sensors)) {
                items.forEach(s => {
                    if(['intel','ssd','memory','processor','disk'].some(k => (s.nombre||'').toLowerCase().includes(k))) {
                        container.innerHTML += `<div class="flex justify-between border-b border-gray-50 py-1"><span class="text-gray-500">${s.nombre}</span><span class="font-bold">${s.valor}</span></div>`;
                    }
                });
            }
        }

        // --- LÓGICA DE BITÁCORA ---
        window.toggleForm = () => document.getElementById('log-form-container').classList.toggle('hidden');

        window.saveLog = async () => {
            const log = {
                device_id: deviceId,
                req: document.getElementById('log-req').value,
                exec: document.getElementById('log-exec').value,
                action: document.getElementById('log-action').value,
                cost: parseFloat(document.getElementById('log-cost').value) || 0, // Costo manual
                desc: document.getElementById('log-desc').value
            };
            
            try {
                const res = await fetch('/techview/api/history/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(log) });
                if(res.ok) {
                    showToast('Agregado a bitácora', 'success');
                    toggleForm();
                    document.getElementById('new-log-form').reset();
                    updateHistoryTab();
                    loadDeviceData(); // Recargar para ver impacto financiero
                }
            } catch(e) { showToast('Error al guardar', 'error'); }
        };

        async function updateHistoryTab() {
            const container = document.getElementById('history-timeline');
            try {
                // Fetch logs específicos de este device
                const res = await fetch('/techview/api/history/all'); // Idealmente filtrar en backend, por ahora filtraremos aquí
                const allLogs = await res.json();
                const logs = allLogs.filter(l => l.device_id === deviceId);
                
                if(logs.length === 0) { container.innerHTML = 'Sin registros.'; return; }
                
                container.innerHTML = logs.map(l => `
                    <div class="bg-white p-3 rounded border border-gray-100 flex justify-between">
                        <div>
                            <span class="font-bold text-xs uppercase text-indigo-600">${l.action}</span>
                            <p class="text-gray-800">${l.description || 'Sin descripción'}</p>
                            <p class="text-[10px] text-gray-400">${new Date(l.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-gray-900">$${(l.total_cost||0).toLocaleString()}</p>
                        </div>
                    </div>
                `).join('');
            } catch(e) { container.innerHTML = 'Error cargando historial.'; }
        }

        // --- GUARDADO GENERAL ---
        async function saveAll() {
            showLoading();
            const payload = { device_id: deviceId };
            document.querySelectorAll('input:not([id^="log-"])').forEach(i => {
                if(i.value !== '') payload[i.id] = parseFloat(i.value) || i.value;
            });
            
            try {
                await fetch('/techview/api/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                showToast('Guardado', 'success');
                pendingChanges.clear();
                document.getElementById('unsaved-badge').classList.add('hidden');
                loadDeviceData();
            } catch(e) { showToast('Error', 'error'); }
            finally { hideLoading(); }
        }

        // Utils
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
        function formatCurrency(val) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0); }
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function showToast(msg, type) {
            const t = document.createElement('div'); t.className = `toast ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`; t.innerText = msg;
            document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000);
        }
        function initChart(fin) {
            const ctx = document.getElementById('monthlyCostChart');
            if(!ctx) return;
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['M1','M2','M3','M4','Actual'],
                    datasets: [{ data: [30,32,31,33,30], borderColor: '#f97316', fill: true, backgroundColor: 'rgba(249,115,22,0.1)' }]
                },
                options: { plugins: {legend: false}, scales: { x: {display:false}, y: {display:false} } }
            });
        }
    </script>
</body>
</html>
