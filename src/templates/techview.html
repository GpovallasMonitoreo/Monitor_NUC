<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argos DOOH - TechView</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Google Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        :root {
            --color-primary: #3B82F6;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-danger: #EF4444;
            --color-dark: #1F2937;
            --color-surface: #374151;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #374151;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 10px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }
        
        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10B981;
        }
        
        .status-offline {
            background-color: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }
        
        .status-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="window.history.back()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <div>
                    <h1 class="text-xl font-bold">TechView</h1>
                    <p class="text-sm text-gray-400" id="device-display">Cargando dispositivo...</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="refreshData()" class="p-2 hover:bg-gray-700 rounded-lg transition" title="Actualizar">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
                <button onclick="exportToPDF()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium flex items-center space-x-2">
                    <span class="material-symbols-outlined text-sm">download</span>
                    <span>Exportar PDF</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-6">
        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="animate-pulse flex flex-col items-center">
                <div class="h-12 w-12 bg-gray-700 rounded-full mb-4"></div>
                <div class="h-4 bg-gray-700 rounded w-48 mb-2"></div>
                <div class="h-3 bg-gray-700 rounded w-32"></div>
            </div>
        </div>

        <!-- Content -->
        <div id="content" class="hidden">
            <!-- Tabs Navigation -->
            <div class="border-b border-gray-700 mb-6">
                <nav class="flex space-x-1" id="tabs-nav">
                    <button class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent hover:text-blue-400 transition" data-tab="overview">
                        Resumen
                    </button>
                    <button class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent hover:text-blue-400 transition" data-tab="financials">
                        Finanzas
                    </button>
                    <button class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent hover:text-blue-400 transition" data-tab="maintenance">
                        Mantenimiento
                    </button>
                    <button class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent hover:text-blue-400 transition" data-tab="logs">
                        Ficha NUC & Bitácora
                    </button>
                    <button class="tab-button px-4 py-2 font-medium text-sm border-b-2 border-transparent hover:text-blue-400 transition" data-tab="advanced">
                        KPIs Avanzados
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="fade-in">
                <!-- Overview Tab -->
                <div id="tab-overview" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <!-- Status Card -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-300">Estado</h3>
                                <span id="status-badge" class="status-badge">Cargando...</span>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-400">Última Conexión</span>
                                    <span id="last-seen" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-400">Desconexiones</span>
                                    <span id="disconnect-count" class="font-medium">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Financial Health Card -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-semibold text-gray-300 mb-4">Salud Financiera</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="text-gray-400">Rating</span>
                                        <span id="financial-rating" class="font-medium">--/5</span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div id="financial-bar" class="h-2 rounded-full bg-green-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-400" id="financial-status">Cargando...</div>
                            </div>
                        </div>

                        <!-- Monthly Margin Card -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-semibold text-gray-300 mb-4">Margen Mensual</h3>
                            <div class="text-3xl font-bold mb-2" id="monthly-margin">$0</div>
                            <div class="text-sm text-gray-400 flex justify-between">
                                <span>Ingresos: <span id="monthly-revenue" class="text-green-400">$0</span></span>
                                <span>Costos: <span id="monthly-opex" class="text-red-400">$0</span></span>
                            </div>
                        </div>

                        <!-- ROI Card -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-semibold text-gray-300 mb-4">Retorno de Inversión</h3>
                            <div class="text-3xl font-bold mb-2" id="roi-months">0.0</div>
                            <div class="text-sm text-gray-400">meses para recuperar CAPEX</div>
                            <div class="mt-4">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-400">CAPEX Total</span>
                                    <span id="total-capex" class="font-medium">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-semibold text-gray-300 mb-4">Distribución de Costos</h3>
                            <div class="h-64">
                                <canvas id="cost-distribution-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-semibold text-gray-300 mb-4">Proyección Financiera</h3>
                            <div class="h-64">
                                <canvas id="financial-projection-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financials Tab -->
                <div id="tab-financials" class="tab-content hidden">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold mb-4">Gestión Financiera del Dispositivo</h2>
                        <p class="text-gray-400 mb-6">Edita los valores y guarda los cambios. Los cálculos se actualizan automáticamente.</p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- CAPEX Form -->
                            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                                <h3 class="font-semibold text-lg mb-4 pb-3 border-b border-gray-700">CAPEX (Inversión Inicial)</h3>
                                <div class="space-y-4" id="capex-form">
                                    <!-- Los campos CAPEX se generan dinámicamente -->
                                </div>
                            </div>

                            <!-- OPEX Form -->
                            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                                <h3 class="font-semibold text-lg mb-4 pb-3 border-b border-gray-700">OPEX (Costos Operativos Mensuales)</h3>
                                <div class="space-y-4" id="opex-form">
                                    <!-- Los campos OPEX se generan dinámicamente -->
                                </div>
                            </div>

                            <!-- Mantenimiento Form -->
                            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 lg:col-span-2">
                                <h3 class="font-semibold text-lg mb-4 pb-3 border-b border-gray-700">Mantenimiento</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="maintenance-form">
                                    <!-- Los campos de mantenimiento se generan dinámicamente -->
                                </div>
                            </div>

                            <!-- Lifecycle Form -->
                            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 lg:col-span-2">
                                <h3 class="font-semibold text-lg mb-4 pb-3 border-b border-gray-700">Ciclo de Vida</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="lifecycle-form">
                                    <!-- Los campos de ciclo de vida se generan dinámicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="mt-8 flex justify-end space-x-3">
                            <button onclick="resetForm()" class="px-6 py-3 border border-gray-600 hover:bg-gray-700 rounded-lg font-medium transition">
                                Restablecer
                            </button>
                            <button onclick="saveFinancials()" id="save-button" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium flex items-center space-x-2">
                                <span class="material-symbols-outlined">save</span>
                                <span>Guardar Cambios</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Maintenance Tab -->
                <div id="tab-maintenance" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Statistics -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 lg:col-span-2">
                            <h3 class="font-semibold text-lg mb-6">Estadísticas de Mantenimiento</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center p-4 bg-gray-900 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-400" id="maint-total">0</div>
                                    <div class="text-sm text-gray-400 mt-1">Total Visitas</div>
                                </div>
                                <div class="text-center p-4 bg-gray-900 rounded-lg">
                                    <div class="text-2xl font-bold text-green-400" id="maint-preventive">0</div>
                                    <div class="text-sm text-gray-400 mt-1">Preventivas</div>
                                </div>
                                <div class="text-center p-4 bg-gray-900 rounded-lg">
                                    <div class="text-2xl font-bold text-yellow-400" id="maint-corrective">0</div>
                                    <div class="text-sm text-gray-400 mt-1">Correctivas</div>
                                </div>
                                <div class="text-center p-4 bg-gray-900 rounded-lg">
                                    <div class="text-2xl font-bold text-red-400" id="maint-total-cost">$0</div>
                                    <div class="text-sm text-gray-400 mt-1">Costo Total</div>
                                </div>
                            </div>
                            
                            <div class="mt-8">
                                <h4 class="font-semibold mb-4">Costo Promedio por Visita</h4>
                                <div class="flex items-center space-x-4">
                                    <div class="flex-1">
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-400">Preventivo</span>
                                            <span id="avg-preventive-cost" class="font-medium">$0</span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div id="preventive-cost-bar" class="h-2 rounded-full bg-green-500" style="width: 50%"></div>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-400">Correctivo</span>
                                            <span id="avg-corrective-cost" class="font-medium">$0</span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div id="corrective-cost-bar" class="h-2 rounded-full bg-yellow-500" style="width: 50%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Health Score -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-semibold text-lg mb-6">Score de Mantenimiento</h3>
                            <div class="flex flex-col items-center justify-center">
                                <div class="relative w-48 h-48">
                                    <canvas id="health-score-chart"></canvas>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <div class="text-4xl font-bold" id="health-score-value">0</div>
                                        <div class="text-sm text-gray-400">de 100</div>
                                    </div>
                                </div>
                                <div class="mt-4 text-center">
                                    <div class="text-lg font-semibold" id="health-status">Excelente</div>
                                    <div class="text-sm text-gray-400" id="health-message">Mantenimiento óptimo</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="tab-logs" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <!-- Log Form & History -->
                        <div class="lg:col-span-8 space-y-6">
                            <!-- Add New Log Form -->
                            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-lg">Nuevo Registro de Mantenimiento</h3>
                                    <span class="text-sm text-gray-400">Los costos se actualizarán automáticamente</span>
                                </div>
                                
                                <form id="new-log-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2 bg-blue-900/20 p-4 rounded-lg border border-blue-800/30 mb-2">
                                        <div class="flex justify-between text-sm">
                                            <div class="font-medium">DISPOSITIVO: <span id="form-device-name" class="text-blue-300">Cargando...</span></div>
                                            <div class="font-medium">ID: <span id="form-device-id" class="text-blue-300">Cargando...</span></div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Solicitado por</label>
                                        <input type="text" id="log-req" class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nombre del solicitante" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Ejecutado por</label>
                                        <input type="text" id="log-exec" class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nombre del técnico" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Tipo de Mantenimiento</label>
                                        <select id="log-action" class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="Preventivo">Preventivo</option>
                                            <option value="Correctivo">Correctivo</option>
                                            <option value="Cambio HW">Cambio de Hardware</option>
                                            <option value="Actualización">Actualización</option>
                                            <option value="Inspección">Inspección</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Componente/Área</label>
                                        <input type="text" id="log-what" class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: Pantalla LED, Sistema eléctrico" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Costo ($)</label>
                                        <input type="number" id="log-cost" class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00" step="0.01" min="0">
                                        <p class="text-xs text-gray-500 mt-1">*Se sumará automáticamente a las finanzas</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Tamaño del Equipo</label>
                                        <input type="number" id="log-crew" class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Número de técnicos" min="1" max="10">
                                    </div>
                                    
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Descripción Detallada</label>
                                        <textarea id="log-desc" rows="3" class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Describe el trabajo realizado, problemas encontrados y soluciones aplicadas..." required></textarea>
                                    </div>
                                    
                                    <div class="md:col-span-2 flex justify-end space-x-3 pt-4 border-t border-gray-700">
                                        <button type="button" onclick="clearLogForm()" class="px-6 py-2.5 border border-gray-600 hover:bg-gray-700 rounded-lg font-medium transition">
                                            Limpiar
                                        </button>
                                        <button type="button" onclick="saveLog()" class="px-6 py-2.5 bg-green-600 hover:bg-green-700 rounded-lg font-medium flex items-center space-x-2">
                                            <span class="material-symbols-outlined">check</span>
                                            <span>Guardar en Bitácora</span>
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Maintenance History -->
                            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="font-bold text-lg">Historial de Mantenimiento</h3>
                                    <button onclick="refreshLogs()" class="p-2 hover:bg-gray-700 rounded-lg transition">
                                        <span class="material-symbols-outlined">refresh</span>
                                    </button>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-xs text-gray-400 uppercase bg-gray-900/50">
                                            <tr>
                                                <th class="px-4 py-3">Fecha</th>
                                                <th class="px-4 py-3">Tipo</th>
                                                <th class="px-4 py-3">Componente</th>
                                                <th class="px-4 py-3">Técnico</th>
                                                <th class="px-4 py-3">Costo</th>
                                                <th class="px-4 py-3">Descripción</th>
                                            </tr>
                                        </thead>
                                        <tbody id="logs-table-body" class="divide-y divide-gray-700">
                                            <tr>
                                                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                                    <span class="material-symbols-outlined text-4xl mb-2">history</span>
                                                    <p>No hay registros de mantenimiento</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Device Specs -->
                        <div class="lg:col-span-4">
                            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 sticky top-6">
                                <h3 class="font-bold text-lg mb-6 pb-3 border-b border-gray-700 flex items-center gap-2">
                                    <span class="material-symbols-outlined">developer_board</span>
                                    ESPECIFICACIONES TÉCNICAS
                                </h3>
                                <div id="specs-summary" class="space-y-4">
                                    <div class="animate-pulse space-y-3">
                                        <div class="h-4 bg-gray-700 rounded"></div>
                                        <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                                        <div class="h-4 bg-gray-700 rounded w-1/2"></div>
                                    </div>
                                </div>
                                
                                <div class="mt-8 pt-6 border-t border-gray-700">
                                    <h4 class="font-semibold mb-3">Últimos Mantenimientos</h4>
                                    <div id="recent-maintenance" class="space-y-3">
                                        <div class="text-sm text-gray-400 italic">Cargando...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div id="tab-advanced" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- KPIs Card -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-semibold text-lg mb-6">KPIs Avanzados</h3>
                            <div class="space-y-6">
                                <div>
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-gray-400">TCO a 5 años</span>
                                        <span id="tco-5year" class="font-medium">$0</span>
                                    </div>
                                    <div class="text-xs text-gray-500">Costo Total de Propiedad proyectado</div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-gray-400">Punto de Equilibrio</span>
                                        <span id="break-even" class="font-medium">0 meses</span>
                                    </div>
                                    <div class="text-xs text-gray-500">Tiempo para recuperar la inversión</div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-gray-400">Tasa de Reincidencia</span>
                                        <span id="reincidence-rate" class="font-medium">0%</span>
                                    </div>
                                    <div class="text-xs text-gray-500">Proporción de mantenimientos correctivos</div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-gray-400">Margen Operativo</span>
                                        <span id="operating-margin" class="font-medium">0%</span>
                                    </div>
                                    <div class="text-xs text-gray-500">(Ingresos - Costos) / Ingresos</div>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations Card -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                            <h3 class="font-semibold text-lg mb-6">Recomendaciones</h3>
                            <div id="recommendations-list" class="space-y-4">
                                <div class="flex items-start space-x-3 p-4 bg-gray-900/50 rounded-lg">
                                    <span class="material-symbols-outlined text-green-400 mt-0.5">info</span>
                                    <div>
                                        <div class="font-medium">Análisis en progreso</div>
                                        <div class="text-sm text-gray-400">Cargando recomendaciones...</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Life Projection Card -->
                        <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 lg:col-span-2">
                            <h3 class="font-semibold text-lg mb-6">Proyección de Vida Útil</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="text-center p-4 bg-gray-900 rounded-lg">
                                    <div class="text-2xl font-bold text-blue-400" id="life-months">0</div>
                                    <div class="text-sm text-gray-400 mt-1">Meses Restantes</div>
                                </div>
                                <div class="text-center p-4 bg-gray-900 rounded-lg">
                                    <div class="text-2xl font-bold text-green-400" id="life-years">0</div>
                                    <div class="text-sm text-gray-400 mt-1">Años Estimados</div>
                                </div>
                                <div class="text-center p-4 bg-gray-900 rounded-lg">
                                    <div class="text-2xl font-bold text-yellow-400" id="renewal-date">--</div>
                                    <div class="text-sm text-gray-400 mt-1">Próxima Renovación</div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <div class="flex justify-between text-sm mb-2">
                                    <span class="text-gray-400">Instalación</span>
                                    <span id="install-date" class="font-medium">--</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="life-progress" class="h-2 rounded-full bg-green-500" style="width: 50%"></div>
                                </div>
                                <div class="flex justify-between text-sm mt-2">
                                    <span class="text-gray-400">0%</span>
                                    <span class="text-gray-400">100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Global variables
        let currentDeviceId = '';
        let deviceData = null;
        let financialData = null;
        let maintenanceLogs = [];
        let charts = {};
        let formInitialData = {};
        let isSaving = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Get device ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentDeviceId = urlParams.get('device_id') || '';
            
            if (!currentDeviceId) {
                showNotification('No se especificó un dispositivo', 'error');
                return;
            }

            // Update device display
            document.getElementById('device-display').textContent = decodeURIComponent(currentDeviceId);
            
            // Setup tabs
            setupTabs();
            
            // Load data
            loadDeviceData();
            
            // Setup auto-refresh
            setInterval(loadDeviceData, 30000); // Refresh every 30 seconds
        });

        // Tab management
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    // Update active button
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-blue-500', 'text-blue-400');
                        btn.classList.add('border-transparent');
                    });
                    button.classList.add('border-blue-500', 'text-blue-400');
                    button.classList.remove('border-transparent');
                    
                    // Show selected tab
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                        if (content.id === `tab-${tabId}`) {
                            content.classList.remove('hidden');
                        }
                    });
                    
                    // Load tab-specific data
                    switch(tabId) {
                        case 'financials':
                            loadFinancialForm();
                            break;
                        case 'logs':
                            loadLogs();
                            break;
                        case 'advanced':
                            loadAdvancedKPIs();
                            break;
                    }
                });
            });
            
            // Set first tab as active
            tabButtons[0].click();
        }

        // Load device data
        async function loadDeviceData() {
            try {
                const response = await fetch(`/techview/api/device/${encodeURIComponent(currentDeviceId)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                deviceData = data;
                financialData = data.financials || {};
                maintenanceLogs = data.maintenance_logs || [];
                
                // Hide loading, show content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
                // Update all views
                updateOverview();
                updateMaintenanceStats();
                updateDeviceSpecs();
                
            } catch (error) {
                console.error('Error loading device data:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-5xl text-red-400 mb-4">error</span>
                        <h3 class="text-xl font-bold mb-2">Error al cargar datos</h3>
                        <p class="text-gray-400">${error.message}</p>
                        <button onclick="loadDeviceData()" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Update overview tab
        function updateOverview() {
            if (!deviceData) return;
            
            const { device, totals, advanced_kpis } = deviceData;
            
            // Status
            const status = device.status || 'unknown';
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = status.toUpperCase();
            statusBadge.className = `status-badge status-${status}`;
            
            // Basic info
            document.getElementById('last-seen').textContent = 
                device.last_seen ? new Date(device.last_seen).toLocaleString() : '--';
            document.getElementById('disconnect-count').textContent = 
                device.disconnect_count || 0;
            
            // Financial overview
            document.getElementById('monthly-margin').textContent = 
                formatCurrency(totals.margin_monthly || 0);
            document.getElementById('monthly-revenue').textContent = 
                formatCurrency(totals.revenue_monthly || 0);
            document.getElementById('monthly-opex').textContent = 
                formatCurrency(totals.opex_monthly || 0);
            document.getElementById('roi-months').textContent = 
                (totals.roi_months || 0).toFixed(1);
            document.getElementById('total-capex').textContent = 
                formatCurrency(totals.capex || 0);
            
            // Financial health
            const rating = deviceData.summary?.overall_rating || 0;
            const ratingPercent = (rating / 5) * 100;
            document.getElementById('financial-rating').textContent = 
                `${rating}/5`;
            document.getElementById('financial-bar').style.width = `${ratingPercent}%`;
            document.getElementById('financial-status').textContent = 
                deviceData.summary?.financial_health || 'Desconocido';
            
            // Update charts
            updateCharts();
        }

        // Load financial form
        function loadFinancialForm() {
            if (!financialData) return;
            
            // CAPEX fields
            const capexFields = [
                { id: 'capex_screen', label: 'Pantalla LED', prefix: 'CAPEX' },
                { id: 'capex_structure', label: 'Estructura', prefix: 'CAPEX' },
                { id: 'capex_electrical', label: 'Instalación Eléctrica', prefix: 'CAPEX' },
                { id: 'capex_civil', label: 'Obra Civil', prefix: 'CAPEX' },
                { id: 'capex_nuc', label: 'NUC/Computadora', prefix: 'CAPEX' },
                { id: 'capex_ups', label: 'UPS', prefix: 'CAPEX' },
                { id: 'capex_modem_wifi', label: 'Modem WiFi', prefix: 'CAPEX' },
                { id: 'capex_modem_sim', label: 'Modem SIM', prefix: 'CAPEX' },
                { id: 'capex_crew', label: 'Mano de Obra', prefix: 'CAPEX' },
                { id: 'capex_transportation', label: 'Transporte', prefix: 'CAPEX' }
            ];
            
            // OPEX fields
            const opexFields = [
                { id: 'opex_light', label: 'Energía Eléctrica', prefix: 'OPEX' },
                { id: 'opex_internet', label: 'Internet', prefix: 'OPEX' },
                { id: 'opex_rent', label: 'Renta', prefix: 'OPEX' },
                { id: 'opex_soil_use', label: 'Uso de Suelo', prefix: 'OPEX' },
                { id: 'opex_taxes', label: 'Impuestos', prefix: 'OPEX' },
                { id: 'opex_insurance', label: 'Seguro', prefix: 'OPEX' },
                { id: 'opex_license_annual', label: 'Licencia Anual', prefix: 'OPEX' },
                { id: 'opex_content_scheduling', label: 'Programación Contenido', prefix: 'OPEX' },
                { id: 'opex_srd', label: 'SRD', prefix: 'OPEX' }
            ];
            
            // Maintenance fields
            const maintFields = [
                { id: 'maint_visit_count', label: 'Visitas Preventivas', type: 'integer' },
                { id: 'maint_corr_visit_count', label: 'Visitas Correctivas', type: 'integer' },
                { id: 'maint_crew_size', label: 'Tamaño Equipo', type: 'integer' },
                { id: 'maint_prev_bimonthly', label: 'Costo Preventivo Bimestral', type: 'currency' },
                { id: 'maint_corr_labor', label: 'Costo Correctivo (Mano de Obra)', type: 'currency' },
                { id: 'maint_corr_parts', label: 'Costo Correctivo (Partes)', type: 'currency' },
                { id: 'maint_corr_gas', label: 'Costo Correctivo (Gasolina)', type: 'currency' },
                { id: 'maint_cleaning_supplies', label: 'Suministros Limpieza', type: 'currency' },
                { id: 'maint_gas', label: 'Gasolina Mantenimiento', type: 'currency' }
            ];
            
            // Lifecycle fields
            const lifeFields = [
                { id: 'life_installation_date', label: 'Fecha de Instalación', type: 'date' },
                { id: 'life_retirement_date', label: 'Fecha de Retiro', type: 'date' },
                { id: 'life_retirement', label: 'Costo de Retiro', type: 'currency' },
                { id: 'life_renewal_date', label: 'Fecha de Renovación', type: 'date' },
                { id: 'life_renewal', label: 'Costo de Renovación', type: 'currency' },
                { id: 'life_special', label: 'Notas Especiales', type: 'text' }
            ];
            
            // Generate forms
            generateForm('capex-form', capexFields);
            generateForm('opex-form', opexFields);
            generateForm('maintenance-form', maintFields);
            generateForm('lifecycle-form', lifeFields);
            
            // Revenue field
            const revenueHtml = `
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Ingresos Mensuales</label>
                    <input type="number" 
                           id="revenue_monthly" 
                           class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           value="${financialData.revenue_monthly || 0}"
                           step="0.01"
                           min="0">
                    <p class="text-xs text-gray-500 mt-1">Ingresos mensuales proyectados por publicidad</p>
                </div>
            `;
            document.getElementById('opex-form').insertAdjacentHTML('beforeend', revenueHtml);
            
            // Store initial values
            storeInitialValues();
        }
        
        function generateForm(containerId, fields) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            fields.forEach(field => {
                const value = financialData[field.id] || '';
                let inputHtml = '';
                
                switch(field.type) {
                    case 'integer':
                        inputHtml = `
                            <input type="number" 
                                   id="${field.id}" 
                                   class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   value="${value}"
                                   min="0"
                                   step="1">
                        `;
                        break;
                        
                    case 'date':
                        const dateValue = value ? new Date(value).toISOString().split('T')[0] : '';
                        inputHtml = `
                            <input type="date" 
                                   id="${field.id}" 
                                   class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   value="${dateValue}">
                        `;
                        break;
                        
                    case 'text':
                        inputHtml = `
                            <textarea id="${field.id}" 
                                      rows="2"
                                      class="w-full px-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">${value}</textarea>
                        `;
                        break;
                        
                    default: // currency
                        inputHtml = `
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">$</span>
                                <input type="number" 
                                       id="${field.id}" 
                                       class="w-full pl-8 pr-4 py-2.5 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       value="${value}"
                                       step="0.01"
                                       min="0">
                            </div>
                        `;
                }
                
                const fieldHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            ${field.label}
                            ${field.prefix ? `<span class="text-xs text-gray-500">(${field.prefix})</span>` : ''}
                        </label>
                        ${inputHtml}
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', fieldHtml);
            });
        }
        
        function storeInitialValues() {
            formInitialData = {};
            const inputs = document.querySelectorAll('#tab-financials input, #tab-financials textarea, #tab-financials select');
            inputs.forEach(input => {
                formInitialData[input.id] = input.value;
            });
        }
        
        // Save financial data
        async function saveFinancials() {
            if (isSaving) return;
            
            try {
                isSaving = true;
                const saveButton = document.getElementById('save-button');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<span class="material-symbols-outlined animate-spin">autorenew</span><span>Guardando...</span>';
                saveButton.disabled = true;
                
                // Collect form data
                const formData = {
                    device_id: currentDeviceId
                };
                
                // Get all form fields
                const inputs = document.querySelectorAll('#tab-financials input, #tab-financials textarea, #tab-financials select');
                inputs.forEach(input => {
                    let value = input.value;
                    
                    // Convert empty strings to null for dates
                    if (input.type === 'date' && value === '') {
                        value = null;
                    }
                    // Convert to number for numeric fields
                    else if (input.type === 'number' && value !== '') {
                        value = parseFloat(value);
                    }
                    
                    formData[input.id] = value;
                });
                
                // Send to API
                const response = await fetch('/techview/api/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Datos financieros guardados correctamente', 'success');
                    storeInitialValues(); // Update initial values
                    
                    // Reload device data to update calculations
                    setTimeout(() => {
                        loadDeviceData();
                        // Refresh financial form to show updated values
                        if (document.getElementById('tab-financials').classList.contains('hidden') === false) {
                            loadFinancialForm();
                        }
                    }, 500);
                    
                } else {
                    throw new Error(result.message || 'Error al guardar');
                }
                
            } catch (error) {
                console.error('Error saving financials:', error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                isSaving = false;
                const saveButton = document.getElementById('save-button');
                saveButton.innerHTML = '<span class="material-symbols-outlined">save</span><span>Guardar Cambios</span>';
                saveButton.disabled = false;
            }
        }
        
        // Reset form
        function resetForm() {
            if (!confirm('¿Restablecer todos los valores a su estado original?')) {
                return;
            }
            
            Object.entries(formInitialData).forEach(([id, value]) => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = value;
                }
            });
            
            showNotification('Formulario restablecido', 'info');
        }
        
        // Update maintenance statistics
        function updateMaintenanceStats() {
            if (!deviceData?.maintenance_stats) return;
            
            const stats = deviceData.maintenance_stats;
            
            document.getElementById('maint-total').textContent = stats.total_logs || 0;
            document.getElementById('maint-preventive').textContent = stats.preventive_count || 0;
            document.getElementById('maint-corrective').textContent = stats.corrective_count || 0;
            document.getElementById('maint-total-cost').textContent = formatCurrency(stats.total_cost || 0);
            
            // Average costs
            const avgPreventive = stats.preventive_count > 0 ? (stats.total_cost / stats.preventive_count) : 0;
            const avgCorrective = stats.corrective_count > 0 ? (stats.total_cost / stats.corrective_count) : 0;
            
            document.getElementById('avg-preventive-cost').textContent = formatCurrency(avgPreventive);
            document.getElementById('avg-corrective-cost').textContent = formatCurrency(avgCorrective);
            
            // Update health score
            const healthScore = deviceData.advanced_kpis?.technical_score || 0;
            document.getElementById('health-score-value').textContent = healthScore;
            document.getElementById('health-status').textContent = 
                deviceData.advanced_kpis?.health_status?.status || 'Desconocido';
            document.getElementById('health-status').className = 
                `text-lg font-semibold ${getHealthColor(healthScore)}`;
            
            // Health message
            let healthMessage = '';
            if (healthScore >= 85) healthMessage = 'Mantenimiento excelente';
            else if (healthScore >= 70) healthMessage = 'Mantenimiento adecuado';
            else if (healthScore >= 50) healthMessage = 'Requiere atención';
            else healthMessage = 'Necesita intervención urgente';
            document.getElementById('health-message').textContent = healthMessage;
            
            // Update health chart
            updateHealthChart(healthScore);
        }
        
        function getHealthColor(score) {
            if (score >= 85) return 'text-green-400';
            if (score >= 70) return 'text-yellow-400';
            if (score >= 50) return 'text-orange-400';
            return 'text-red-400';
        }
        
        // Update device specs
        function updateDeviceSpecs() {
            if (!deviceData?.device) return;
            
            const device = deviceData.device;
            const specsContainer = document.getElementById('specs-summary');
            
            let specsHtml = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 text-sm">Estado</span>
                        <span class="font-medium ${device.status === 'online' ? 'text-green-400' : 'text-red-400'}">
                            ${device.status?.toUpperCase() || 'DESCONOCIDO'}
                        </span>
                    </div>
            `;
            
            if (device.location) {
                specsHtml += `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 text-sm">Ubicación</span>
                        <span class="font-medium">${device.location}</span>
                    </div>
                `;
            }
            
            if (device.public_ip) {
                specsHtml += `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 text-sm">IP Pública</span>
                        <span class="font-mono font-medium">${device.public_ip}</span>
                    </div>
                `;
            }
            
            if (device.created_at) {
                specsHtml += `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 text-sm">Fecha Creación</span>
                        <span class="font-medium">${new Date(device.created_at).toLocaleDateString()}</span>
                    </div>
                `;
            }
            
            if (device.last_seen) {
                specsHtml += `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 text-sm">Última Conexión</span>
                        <span class="font-medium">${new Date(device.last_seen).toLocaleTimeString()}</span>
                    </div>
                `;
            }
            
            specsHtml += '</div>';
            specsContainer.innerHTML = specsHtml;
            
            // Update form device info
            document.getElementById('form-device-name').textContent = device.pc_name || device.device_id;
            document.getElementById('form-device-id').textContent = device.device_id;
        }
        
        // Load logs
        async function loadLogs() {
            try {
                const response = await fetch(`/techview/api/maintenance/logs/${encodeURIComponent(currentDeviceId)}`);
                const data = await response.json();
                
                maintenanceLogs = data.logs || [];
                updateLogsTable();
                updateRecentMaintenance();
                
            } catch (error) {
                console.error('Error loading logs:', error);
                showNotification('Error cargando historial', 'error');
            }
        }
        
        // Update logs table
        function updateLogsTable() {
            const tbody = document.getElementById('logs-table-body');
            
            if (!maintenanceLogs.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <span class="material-symbols-outlined text-4xl mb-2">history</span>
                            <p>No hay registros de mantenimiento</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            maintenanceLogs.forEach(log => {
                const date = log.timestamp ? new Date(log.timestamp).toLocaleDateString() : '--';
                const cost = log.cost ? formatCurrency(log.cost) : '$0';
                
                html += `
                    <tr class="hover:bg-gray-900/50">
                        <td class="px-4 py-3">${date}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs ${
                                log.action === 'Preventivo' ? 'bg-green-900/30 text-green-400' :
                                log.action === 'Correctivo' ? 'bg-yellow-900/30 text-yellow-400' :
                                'bg-blue-900/30 text-blue-400'
                            }">
                                ${log.action}
                            </span>
                        </td>
                        <td class="px-4 py-3 font-medium">${log.what || '--'}</td>
                        <td class="px-4 py-3">${log.executed_by || '--'}</td>
                        <td class="px-4 py-3 font-medium">${cost}</td>
                        <td class="px-4 py-3">
                            <div class="max-w-xs truncate" title="${log.description}">
                                ${log.description || '--'}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Update recent maintenance
        function updateRecentMaintenance() {
            const container = document.getElementById('recent-maintenance');
            
            if (!maintenanceLogs.length) {
                container.innerHTML = '<div class="text-sm text-gray-400 italic">Sin mantenimientos registrados</div>';
                return;
            }
            
            const recent = maintenanceLogs.slice(0, 3);
            let html = '';
            
            recent.forEach(log => {
                const date = log.timestamp ? new Date(log.timestamp).toLocaleDateString() : '--';
                const icon = log.action === 'Preventivo' ? 'preventive_maintenance' : 
                            log.action === 'Correctivo' ? 'construction' : 'build';
                
                html += `
                    <div class="flex items-start space-x-3 p-3 bg-gray-900/30 rounded-lg">
                        <span class="material-symbols-outlined text-blue-400 mt-0.5">${icon}</span>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <div class="font-medium text-sm">${log.what || 'Mantenimiento'}</div>
                                <div class="text-xs text-gray-500">${date}</div>
                            </div>
                            <div class="text-xs text-gray-400 mt-1 truncate">${log.description || ''}</div>
                            <div class="text-xs text-blue-400 mt-1">${log.executed_by || '--'}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Save new log
        async function saveLog() {
            try {
                // Validate form
                const req = document.getElementById('log-req').value.trim();
                const exec = document.getElementById('log-exec').value.trim();
                const what = document.getElementById('log-what').value.trim();
                const desc = document.getElementById('log-desc').value.trim();
                
                if (!req || !exec || !what || !desc) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }
                
                const logData = {
                    device_id: currentDeviceId,
                    pc_name: deviceData?.device?.pc_name || currentDeviceId,
                    req: req,
                    exec: exec,
                    action: document.getElementById('log-action').value,
                    what: what,
                    desc: desc,
                    cost: parseFloat(document.getElementById('log-cost').value) || 0
                };
                
                // Add crew size if specified
                const crew = document.getElementById('log-crew').value;
                if (crew) {
                    logData.executed_by = `${exec} (Equipo: ${crew} técnicos)`;
                }
                
                // Show saving state
                const saveButton = document.querySelector('#new-log-form button[onclick="saveLog()"]');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<span class="material-symbols-outlined animate-spin">autorenew</span><span>Guardando...</span>';
                saveButton.disabled = true;
                
                // Send to API
                const response = await fetch('/techview/api/maintenance/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(logData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Log guardado y finanzas actualizadas automáticamente', 'success');
                    clearLogForm();
                    
                    // Refresh data
                    setTimeout(() => {
                        loadDeviceData();
                        loadLogs();
                    }, 500);
                    
                } else {
                    throw new Error(result.message || 'Error al guardar');
                }
                
            } catch (error) {
                console.error('Error saving log:', error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                // Restore button
                const saveButton = document.querySelector('#new-log-form button[onclick="saveLog()"]');
                if (saveButton) {
                    saveButton.innerHTML = '<span class="material-symbols-outlined">check</span><span>Guardar en Bitácora</span>';
                    saveButton.disabled = false;
                }
            }
        }
        
        // Clear log form
        function clearLogForm() {
            document.getElementById('new-log-form').reset();
            document.getElementById('log-cost').value = '';
            document.getElementById('log-crew').value = '';
        }
        
        // Load advanced KPIs
        function loadAdvancedKPIs() {
            if (!deviceData?.advanced_kpis) return;
            
            const kpis = deviceData.advanced_kpis;
            
            document.getElementById('tco-5year').textContent = formatCurrency(kpis.tco_5year || 0);
            document.getElementById('break-even').textContent = `${kpis.break_even_months || 0} meses`;
            document.getElementById('reincidence-rate').textContent = `${kpis.reincidence_rate || 0}%`;
            document.getElementById('operating-margin').textContent = `${kpis.operating_margin || 0}%`;
            
            // Life projection
            const life = kpis.life_projection || {};
            document.getElementById('life-months').textContent = life.months_remaining || 0;
            document.getElementById('life-years').textContent = (life.estimated_life_years || 0).toFixed(1);
            document.getElementById('install-date').textContent = 
                deviceData.financials?.life_installation_date ? 
                new Date(deviceData.financials.life_installation_date).toLocaleDateString() : '--';
            document.getElementById('renewal-date').textContent = 
                deviceData.financials?.life_renewal_date ? 
                new Date(deviceData.financials.life_renewal_date).toLocaleDateString() : '--';
            
            // Life progress
            const totalMonths = life.estimated_life_months || 96;
            const remaining = life.months_remaining || 0;
            const usedPercent = totalMonths > 0 ? ((totalMonths - remaining) / totalMonths) * 100 : 0;
            document.getElementById('life-progress').style.width = `${Math.min(usedPercent, 100)}%`;
            
            // Recommendations
            updateRecommendations(kpis.recommendations || []);
        }
        
        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations-list');
            
            if (!recommendations.length) {
                container.innerHTML = `
                    <div class="flex items-start space-x-3 p-4 bg-gray-900/50 rounded-lg">
                        <span class="material-symbols-outlined text-green-400 mt-0.5">check_circle</span>
                        <div>
                            <div class="font-medium">Sin recomendaciones específicas</div>
                            <div class="text-sm text-gray-400">El dispositivo está funcionando óptimamente</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            recommendations.forEach(rec => {
                const icon = rec.type === 'critical' ? 'error' :
                            rec.type === 'warning' ? 'warning' : 'info';
                const color = rec.type === 'critical' ? 'text-red-400' :
                            rec.type === 'warning' ? 'text-yellow-400' : 'text-green-400';
                const bgColor = rec.type === 'critical' ? 'bg-red-900/20' :
                              rec.type === 'warning' ? 'bg-yellow-900/20' : 'bg-green-900/20';
                
                html += `
                    <div class="flex items-start space-x-3 p-4 ${bgColor} rounded-lg">
                        <span class="material-symbols-outlined ${color} mt-0.5">${icon}</span>
                        <div class="flex-1">
                            <div class="font-medium">${rec.title}</div>
                            <div class="text-sm text-gray-300 mt-1">${rec.description}</div>
                            <div class="text-xs text-gray-400 mt-2 font-medium">${rec.action}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Update charts
        function updateCharts() {
            // Cost distribution chart
            const costCtx = document.getElementById('cost-distribution-chart');
            if (costCtx) {
                if (charts.costDistribution) {
                    charts.costDistribution.destroy();
                }
                
                const costData = {
                    labels: ['CAPEX', 'OPEX Mensual', 'Mantenimiento'],
                    datasets: [{
                        data: [
                            deviceData.totals?.capex || 0,
                            deviceData.totals?.opex_monthly || 0,
                            deviceData.totals?.total_maintenance_cost || 0
                        ],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(16, 185, 129, 0.8)'
                        ]
                    }]
                };
                
                charts.costDistribution = new Chart(costCtx, {
                    type: 'doughnut',
                    data: costData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#9CA3AF',
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Financial projection chart
            const projectionCtx = document.getElementById('financial-projection-chart');
            if (projectionCtx && deviceData.projections) {
                if (charts.financialProjection) {
                    charts.financialProjection.destroy();
                }
                
                const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
                const revenue = months.map(() => (deviceData.totals?.revenue_monthly || 0) * (0.9 + Math.random() * 0.2));
                const margin = months.map(() => (deviceData.totals?.margin_monthly || 0) * (0.9 + Math.random() * 0.2));
                
                charts.financialProjection = new Chart(projectionCtx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: revenue,
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Margen',
                                data: margin,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#9CA3AF'
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(75, 85, 99, 0.2)'
                                },
                                ticks: {
                                    color: '#9CA3AF'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(75, 85, 99, 0.2)'
                                },
                                ticks: {
                                    color: '#9CA3AF',
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function updateHealthChart(score) {
            const ctx = document.getElementById('health-score-chart');
            if (!ctx) return;
            
            if (charts.healthScore) {
                charts.healthScore.destroy();
            }
            
            const data = {
                datasets: [{
                    data: [score, 100 - score],
                    backgroundColor: [
                        getHealthColor(score).replace('text-', '').replace('-400', '-500'),
                        'rgba(75, 85, 99, 0.3)'
                    ],
                    borderWidth: 0,
                    circumference: 270,
                    rotation: 225
                }]
            };
            
            charts.healthScore = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                }
            });
        }
        
        // Export to PDF
        async function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title
                doc.setFontSize(20);
                doc.text(`Ficha Técnica - ${deviceData.device.pc_name || currentDeviceId}`, 20, 20);
                
                doc.setFontSize(10);
                doc.text(`Generado: ${new Date().toLocaleString()}`, 20, 30);
                
                // Device Info
                doc.setFontSize(12);
                doc.text('Información del Dispositivo', 20, 45);
                
                let yPos = 55;
                const deviceInfo = [
                    ['ID:', deviceData.device.device_id],
                    ['Estado:', deviceData.device.status?.toUpperCase()],
                    ['Ubicación:', deviceData.device.location || '--'],
                    ['IP Pública:', deviceData.device.public_ip || '--'],
                    ['Última Conexión:', deviceData.device.last_seen ? new Date(deviceData.device.last_seen).toLocaleString() : '--']
                ];
                
                deviceInfo.forEach(([label, value]) => {
                    doc.setFontSize(10);
                    doc.text(`${label} ${value}`, 20, yPos);
                    yPos += 7;
                });
                
                // Financial Summary
                yPos += 5;
                doc.setFontSize(12);
                doc.text('Resumen Financiero', 20, yPos);
                yPos += 10;
                
                const financialInfo = [
                    ['CAPEX Total:', formatCurrency(deviceData.totals?.capex || 0)],
                    ['OPEX Mensual:', formatCurrency(deviceData.totals?.opex_monthly || 0)],
                    ['Ingresos Mensuales:', formatCurrency(deviceData.totals?.revenue_monthly || 0)],
                    ['Margen Mensual:', formatCurrency(deviceData.totals?.margin_monthly || 0)],
                    ['ROI:', `${(deviceData.totals?.roi_months || 0).toFixed(1)} meses`]
                ];
                
                financialInfo.forEach(([label, value]) => {
                    doc.setFontSize(10);
                    doc.text(`${label} ${value}`, 20, yPos);
                    yPos += 7;
                });
                
                // Maintenance Summary
                if (maintenanceLogs.length > 0) {
                    yPos += 5;
                    doc.setFontSize(12);
                    doc.text('Resumen de Mantenimiento', 20, yPos);
                    yPos += 10;
                    
                    const maintInfo = [
                        ['Total Visitas:', deviceData.maintenance_stats?.total_logs || 0],
                        ['Preventivas:', deviceData.maintenance_stats?.preventive_count || 0],
                        ['Correctivas:', deviceData.maintenance_stats?.corrective_count || 0],
                        ['Costo Total:', formatCurrency(deviceData.maintenance_stats?.total_cost || 0)]
                    ];
                    
                    maintInfo.forEach(([label, value]) => {
                        doc.setFontSize(10);
                        doc.text(`${label} ${value}`, 20, yPos);
                        yPos += 7;
                    });
                }
                
                // Recent Logs Table
                if (maintenanceLogs.length > 0) {
                    yPos += 10;
                    doc.setFontSize(12);
                    doc.text('Últimos Mantenimientos', 20, yPos);
                    yPos += 10;
                    
                    const tableData = maintenanceLogs.slice(0, 5).map(log => [
                        new Date(log.timestamp).toLocaleDateString(),
                        log.action,
                        log.what || '--',
                        log.executed_by || '--',
                        formatCurrency(log.cost || 0)
                    ]);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Fecha', 'Tipo', 'Componente', 'Técnico', 'Costo']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [59, 130, 246] },
                        margin: { left: 20 }
                    });
                }
                
                // Save PDF
                doc.save(`Ficha_${deviceData.device.pc_name || currentDeviceId}_${new Date().getTime()}.pdf`);
                
                showNotification('PDF generado exitosamente', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showNotification('Error generando PDF', 'error');
            }
        }
        
        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const id = Date.now();
            
            const colors = {
                success: 'bg-green-500 border-green-600',
                error: 'bg-red-500 border-red-600',
                warning: 'bg-yellow-500 border-yellow-600',
                info: 'bg-blue-500 border-blue-600'
            };
            
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            
            const notification = document.createElement('div');
            notification.id = `notification-${id}`;
            notification.className = `${colors[type]} text-white px-4 py-3 rounded-lg border shadow-lg flex items-center space-x-3 max-w-md fade-in`;
            notification.innerHTML = `
                <span class="material-symbols-outlined">${icons[type]}</span>
                <span class="flex-1">${message}</span>
                <button onclick="document.getElementById('notification-${id}').remove()" class="hover:opacity-80">
                    <span class="material-symbols-outlined">close</span>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const elem = document.getElementById(`notification-${id}`);
                if (elem) {
                    elem.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => elem.remove(), 300);
                }
            }, 5000);
        }
        
        function refreshData() {
            showNotification('Actualizando datos...', 'info');
            loadDeviceData();
        }
        
        function refreshLogs() {
            showNotification('Actualizando historial...', 'info');
            loadLogs();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (!document.getElementById('tab-financials').classList.contains('hidden')) {
                    saveFinancials();
                }
            }
            
            // F5 to refresh
            if (e.key === 'F5') {
                e.preventDefault();
                refreshData();
            }
            
            // Escape to go back
            if (e.key === 'Escape') {
                window.history.back();
            }
        });
    </script>
</body>
</html>
