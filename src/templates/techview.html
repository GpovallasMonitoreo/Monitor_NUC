<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Argos TechView - Detalle</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <style>.tab-content{display:none}.tab-content.active{display:block}.nav-tab.active{border-bottom:2px solid #F97316;color:#F97316;font-weight:700}</style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div>
            <h2 class="text-lg font-bold text-slate-900">Gestión: <span class="text-primary">{{ device_id }}</span></h2>
        </div>
        <div class="flex gap-3">
            <button onclick="saveAll()" class="bg-primary hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-xs flex gap-2"><span class="material-icons-outlined text-sm">save</span> GUARDAR TODO</button>
            <a href="/techview" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold text-xs">CERRAR</a>
        </div>
    </header>

    <div class="bg-white border-b border-slate-100 px-6">
        <div class="flex gap-6 overflow-x-auto">
            <button onclick="switchTab('resumen')" class="nav-tab active py-4 text-sm">Resumen</button>
            <button onclick="switchTab('capex')" class="nav-tab py-4 text-sm">1. CAPEX</button>
            <button onclick="switchTab('opex')" class="nav-tab py-4 text-sm">2. OPEX</button>
            <button onclick="switchTab('manto')" class="nav-tab py-4 text-sm">3. Mantenimiento</button>
        </div>
    </div>

    <main class="p-6 max-w-7xl mx-auto w-full">
        <div id="tab-resumen" class="tab-content active space-y-6">
            <div class="grid grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">CAPEX Total</p><h3 class="text-3xl font-black text-slate-800" id="kpi-capex">$0</h3></div>
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">OPEX Mensual</p><h3 class="text-3xl font-black text-orange-600" id="kpi-opex">$0</h3></div>
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">Venta Mensual</p><h3 class="text-3xl font-black text-emerald-600" id="kpi-sales">$0</h3></div>
            </div>
        </div>

        <div id="tab-capex" class="tab-content space-y-6">
            <form class="grid grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4">Infraestructura</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Pantalla LED <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Infraestructura" data-con="Pantalla"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Obra Civil <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Infraestructura" data-con="Obra Civil"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Instalación Eléctrica <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Infraestructura" data-con="Instalacion Electrica"></label>
                </div>
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4">Electrónica & Legal</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">NUC / Player <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Electronica" data-con="NUC"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Gestoría Legal <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Legal" data-con="Permisos"></label>
                </div>
            </form>
        </div>

        <div id="tab-opex" class="tab-content space-y-6">
            <form class="grid grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4">Suministros (Mensual)</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Luz CFE <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="OPEX" data-cat="Suministros" data-con="Luz" data-rec="monthly"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Internet <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="OPEX" data-cat="Suministros" data-con="Internet" data-rec="monthly"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Renta Sitio <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="OPEX" data-cat="Suministros" data-con="Renta" data-rec="monthly"></label>
                </div>
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-emerald-600">Ingresos</h4>
                    <label class="block mb-2 text-xs font-bold text-emerald-700">Venta Mensual <input type="number" class="w-full border-emerald-200 rounded text-sm mt-1 cost-input font-bold" data-type="REVENUE" data-cat="Ventas" data-con="Publicidad" data-rec="monthly"></label>
                </div>
            </form>
        </div>
        
        <div id="tab-manto" class="tab-content">
            <div class="bg-white p-6 rounded-xl border shadow-sm">
                <h4 class="font-bold border-b pb-2 mb-4">Costos Preventivos</h4>
                <label class="block mb-2 text-xs font-bold text-slate-500">Visita Bimestral <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="MAINTENANCE" data-cat="Preventivo" data-con="Visita" data-rec="bimonthly"></label>
            </div>
        </div>
    </main>

    <script>
        const deviceId = "{{ device_id }}";
        
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadData() {
            try {
                const res = await fetch(`/api/techview/device/${deviceId}`);
                const data = await res.json();
                
                // Llenar inputs si existen datos
                if(data.breakdown) {
                    data.breakdown.forEach(item => {
                        const input = document.querySelector(`.cost-input[data-type="${item.cost_type}"][data-con="${item.concept}"]`);
                        if(input) input.value = item.amount;
                    });
                }
                
                // Actualizar KPIs
                document.getElementById('kpi-capex').innerText = `$${data.totals.capex.toLocaleString()}`;
                document.getElementById('kpi-opex').innerText = `$${data.totals.opex.toLocaleString()}`;
                document.getElementById('kpi-sales').innerText = `$${data.totals.revenue.toLocaleString()}`;
            } catch(e) { console.error(e); }
        }

        async function saveAll() {
            const inputs = document.querySelectorAll('.cost-input');
            const promises = Array.from(inputs).map(input => {
                const val = parseFloat(input.value);
                if(val > 0) {
                    return fetch('/api/techview/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            device_id: deviceId,
                            cost_type: input.dataset.type,
                            category: input.dataset.cat,
                            concept: input.dataset.con,
                            recurrence: input.dataset.rec || 'one_time',
                            amount: val
                        })
                    });
                }
            });
            await Promise.all(promises);
            alert('Datos guardados en Supabase.');
            loadData(); // Recargar para actualizar KPIs
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
