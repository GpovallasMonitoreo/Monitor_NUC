<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Argos DOOH - Gesti√≥n de Pantalla</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Incluir Supabase -->
    <script src="/assets/js/supabase-client.js"></script>
    <script src="/assets/js/maintenance-calculator.js"></script>
    <script src="/assets/js/report-generator.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f97415",
                        "primary-dark": "#c2570e",
                        "background-light": "#f8f7f5",
                        "background-dark": "#23170f",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-card { transition: all 0.3s ease; }
        .section-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#181411] dark:text-white min-h-screen font-display antialiased">
    <!-- Main Wrapper -->
    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar Espec√≠fica -->
        <aside class="flex w-64 flex-col border-r border-[#e5e7eb] dark:border-[#3a2d25] bg-white dark:bg-[#2a1d15] flex-shrink-0">
            <div class="flex h-16 items-center px-6 border-b border-[#e5e7eb] dark:border-[#3a2d25]">
                <div class="flex items-center gap-2">
                    <div class="size-8 flex items-center justify-center bg-primary rounded-lg text-white">
                        <span class="material-symbols-outlined">tv</span>
                    </div>
                    <div class="flex flex-col">
                        <h2 class="text-[#181411] dark:text-white text-base font-bold leading-none">Gesti√≥n de Pantalla</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-medium mt-1" id="screen-id-display">ARG-001</p>
                    </div>
                </div>
            </div>
            
            <!-- Screen Info -->
            <div class="p-4 border-b border-[#e5e7eb] dark:border-[#3a2d25]">
                <h3 id="screen-name-display" class="font-bold text-[#181411] dark:text-white text-sm mb-2">Cargando...</h3>
                <div class="flex items-center gap-2">
                    <span id="screen-status" class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">
                        <span class="size-2 rounded-full bg-emerald-500"></span>
                        En L√≠nea
                    </span>
                    <span id="screen-uptime" class="text-xs text-slate-500">99.8%</span>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto px-3 py-6 space-y-1">
                <a href="dashboard_finanzas.html" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200 transition-colors group">
                    <span class="material-symbols-outlined">arrow_back</span>
                    <span class="text-sm font-medium">Volver al Dashboard</span>
                </a>
                
                <a href="#" class="tab-nav flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary dark:text-primary transition-colors group" data-tab="dashboard">
                    <span class="material-symbols-outlined">dashboard</span>
                    <span class="text-sm font-semibold">Dashboard</span>
                </a>
                <a href="#" class="tab-nav flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200 transition-colors group" data-tab="instalacion">
                    <span class="material-symbols-outlined">build</span>
                    <span class="text-sm font-medium">Instalaci√≥n</span>
                </a>
                <a href="#" class="tab-nav flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200 transition-colors group" data-tab="gastos">
                    <span class="material-symbols-outlined">receipt</span>
                    <span class="text-sm font-medium">Gastos Mensuales</span>
                </a>
                <a href="#" class="tab-nav flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200 transition-colors group" data-tab="mantenimientos">
                    <span class="material-symbols-outlined">engineering</span>
                    <span class="text-sm font-medium">Mantenimientos</span>
                </a>
                <a href="#" class="tab-nav flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200 transition-colors group" data-tab="refacciones">
                    <span class="material-symbols-outlined">precision_manufacturing</span>
                    <span class="text-sm font-medium">Refacciones Usadas</span>
                </a>
                <a href="#" class="tab-nav flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200 transition-colors group" data-tab="reubicaciones">
                    <span class="material-symbols-outlined">location_on</span>
                    <span class="text-sm font-medium">Reubicaciones</span>
                </a>
                <a href="#" class="tab-nav flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200 transition-colors group" data-tab="retiros">
                    <span class="material-symbols-outlined">move_up</span>
                    <span class="text-sm font-medium">Retiros</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-background-light dark:bg-background-dark">
            <!-- Top Header -->
            <header class="flex h-16 items-center justify-between gap-4 border-b border-[#e5e7eb] dark:border-[#3a2d25] bg-white/80 dark:bg-[#2a1d15]/80 px-8 backdrop-blur-md">
                <div>
                    <h1 id="screen-title" class="text-xl font-bold text-[#181411] dark:text-white">Gesti√≥n de Pantalla</h1>
                    <p id="screen-location" class="text-sm text-slate-500 dark:text-slate-400 mt-1">Cargando ubicaci√≥n...</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Quick Actions -->
                    <button onclick="generateScreenReport()" class="px-4 py-2 bg-primary text-white font-bold rounded-lg hover:bg-primary-dark transition flex items-center gap-2">
                        <span class="material-symbols-outlined">summarize</span>
                        Reporte Directivo PDF
                    </button>
                    <button onclick="refreshScreenData()" class="p-2 text-slate-500 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition">
                        <span class="material-symbols-outlined">refresh</span>
                    </button>
                </div>
            </header>

            <!-- Tab Content -->
            <div class="flex-1 overflow-y-auto p-8">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="max-w-[1400px] mx-auto">
                        <!-- Screen Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="section-card bg-white dark:bg-[#2a1d15] rounded-xl p-6 border border-[#e5e7eb] dark:border-[#3a2d25]">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">ROI Actual</p>
                                        <p class="text-2xl font-bold text-[#181411] dark:text-white mt-1" id="roi-value">0 meses</p>
                                    </div>
                                    <div class="p-3 bg-emerald-100 dark:bg-emerald-500/20 rounded-lg">
                                        <span class="material-symbols-outlined text-emerald-600 dark:text-emerald-400">trending_up</span>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-500">Meta: 24 meses</div>
                                <div class="h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden mt-2">
                                    <div class="h-full bg-emerald-500 rounded-full" id="roi-progress"></div>
                                </div>
                            </div>

                            <div class="section-card bg-white dark:bg-[#2a1d15] rounded-xl p-6 border border-[#e5e7eb] dark:border-[#3a2d25]">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Ingresos Mensuales</p>
                                        <p class="text-2xl font-bold text-[#181411] dark:text-white mt-1" id="monthly-revenue">$0</p>
                                    </div>
                                    <div class="p-3 bg-blue-100 dark:bg-blue-500/20 rounded-lg">
                                        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">payments</span>
                                    </div>
                                </div>
                                <div class="text-xs text-emerald-500 flex items-center" id="revenue-trend">
                                    <span class="material-symbols-outlined text-sm mr-1">arrow_upward</span>
                                    Cargando...
                                </div>
                            </div>

                            <div class="section-card bg-white dark:bg-[#2a1d15] rounded-xl p-6 border border-[#e5e7eb] dark:border-[#3a2d25]">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Gastos Mensuales</p>
                                        <p class="text-2xl font-bold text-[#181411] dark:text-white mt-1" id="monthly-expenses">$0</p>
                                    </div>
                                    <div class="p-3 bg-red-100 dark:bg-red-500/20 rounded-lg">
                                        <span class="material-symbols-outlined text-red-600 dark:text-red-400">credit_card</span>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-500" id="expenses-breakdown">Cargando...</div>
                            </div>

                            <div class="section-card bg-white dark:bg-[#2a1d15] rounded-xl p-6 border border-[#e5e7eb] dark:border-[#3a2d25]">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Ganancia Neta</p>
                                        <p class="text-2xl font-bold text-[#181411] dark:text-white mt-1" id="net-profit">$0</p>
                                    </div>
                                    <div class="p-3 bg-purple-100 dark:bg-purple-500/20 rounded-lg">
                                        <span class="material-symbols-outlined text-purple-600 dark:text-purple-400">show_chart</span>
                                    </div>
                                </div>
                                <div class="text-xs text-emerald-500" id="profit-margin">0% de margen</div>
                            </div>
                        </div>

                        <!-- Performance Chart -->
                        <div class="bg-white dark:bg-[#2a1d15] rounded-xl shadow-sm border border-[#e5e7eb] dark:border-[#3a2d25] p-6 mb-8">
                            <h3 class="text-lg font-bold text-[#181411] dark:text-white mb-6">Rendimiento Financiero</h3>
                            <div class="h-80">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>

                        <!-- Quick Overview -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white dark:bg-[#2a1d15] rounded-xl shadow-sm border border-[#e5e7eb] dark:border-[#3a2d25] p-6">
                                <h3 class="text-lg font-bold text-[#181411] dark:text-white mb-6">Informaci√≥n T√©cnica y Financiera</h3>
                                <div class="space-y-4" id="technical-info">
                                    <div class="text-center py-8 text-slate-400">
                                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
                                        <p class="mt-4">Cargando informaci√≥n...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-[#2a1d15] rounded-xl shadow-sm border border-[#e5e7eb] dark:border-[#3a2d25] p-6">
                                <h3 class="text-lg font-bold text-[#181411] dark:text-white mb-6">Alertas y Mantenimientos</h3>
                                <div class="space-y-3" id="screen-alerts">
                                    <div class="text-center py-8 text-slate-400">
                                        <span class="material-symbols-outlined text-2xl">notifications_none</span>
                                        <p class="mt-2">Cargando alertas...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mantenimientos Tab (con c√°lculos reales) -->
                <div id="mantenimientos" class="tab-content">
                    <div class="max-w-[1400px] mx-auto">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Formulario de Mantenimiento -->
                            <div>
                                <div class="bg-white dark:bg-[#2a1d15] rounded-xl shadow-sm border border-[#e5e7eb] dark:border-[#3a2d25] p-6">
                                    <h3 class="text-xl font-bold text-[#181411] dark:text-white mb-6">Registrar Mantenimiento</h3>
                                    
                                    <div class="space-y-4" id="maintenance-form">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tipo de Mantenimiento</label>
                                            <div class="flex gap-4">
                                                <label class="flex items-center">
                                                    <input type="radio" name="maintenance-type" value="preventivo" class="mr-2" checked 
                                                           onchange="updateMaintenanceCalculation()">
                                                    <span class="text-sm">Preventivo</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" name="maintenance-type" value="correctivo" class="mr-2"
                                                           onchange="updateMaintenanceCalculation()">
                                                    <span class="text-sm">Correctivo</span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Fecha</label>
                                                <input type="date" id="maintenance-date" class="w-full px-4 py-2 border border-[#e5e7eb] dark:border-[#3a2d25] rounded-lg bg-white dark:bg-[#2a1d15]" 
                                                       value="<?php echo date('Y-m-d'); ?>">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Horas</label>
                                                <input type="number" id="maintenance-hours" class="w-full px-4 py-2 border border-[#e5e7eb] dark:border-[#3a2d25] rounded-lg bg-white dark:bg-[#2a1d15]" 
                                                       min="0" step="0.5" value="0" onchange="updateMaintenanceCalculation()">
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Tipo de T√©cnico</label>
                                            <select id="technician-type" class="w-full px-4 py-2 border border-[#e5e7eb] dark:border-[#3a2d25] rounded-lg bg-white dark:bg-[#2a1d15]"
                                                    onchange="updateMaintenanceCalculation()">
                                                <option value="tecnico_regular">T√©cnico Regular ($120/hora)</option>
                                                <option value="tecnico_especializado">T√©cnico Especializado ($180/hora)</option>
                                                <option value="ingeniero">Ingeniero ($250/hora)</option>
                                                <option value="contratista">Contratista Externo ($150/hora)</option>
                                            </select>
                                        </div>

                                        <!-- Materiales -->
                                        <div>
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Materiales Utilizados</label>
                                                <button type="button" onclick="addMaterialRow()" class="text-sm text-primary font-medium hover:underline">
                                                    + Agregar Material
                                                </button>
                                            </div>
                                            <div class="space-y-2" id="materials-container">
                                                <!-- Los materiales se agregar√°n din√°micamente -->
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Descripci√≥n</label>
                                            <textarea id="maintenance-description" class="w-full px-4 py-2 border border-[#e5e7eb] dark:border-[#3a2d25] rounded-lg bg-white dark:bg-[#2a1d15] h-32" 
                                                      placeholder="Describa el trabajo realizado..."></textarea>
                                        </div>

                                        <!-- Costo Total -->
                                        <div class="pt-4 border-t border-[#e5e7eb] dark:border-[#3a2d25]">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-lg font-bold text-[#181411] dark:text-white">Costo Total del Mantenimiento:</span>
                                                <span class="text-2xl font-bold text-primary" id="maintenance-total-cost">$0.00</span>
                                            </div>
                                            <div class="text-sm text-slate-500" id="cost-breakdown">
                                                Mano de obra: $0.00 | Materiales: $0.00 | Adicional: $0.00
                                            </div>
                                        </div>

                                        <!-- Bot√≥n de Guardar -->
                                        <div class="pt-4">
                                            <button onclick="saveMaintenance()" class="w-full px-4 py-3 bg-primary text-white font-bold rounded-lg hover:bg-primary-dark transition">
                                                Guardar Mantenimiento en Base de Datos
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Historial de Mantenimientos (desde Supabase) -->
                            <div>
                                <div class="bg-white dark:bg-[#2a1d15] rounded-xl shadow-sm border border-[#e5e7eb] dark:border-[#3a2d25] p-6 h-full">
                                    <h3 class="text-xl font-bold text-[#181411] dark:text-white mb-6">Historial de Mantenimientos</h3>
                                    <div class="space-y-4 overflow-y-auto max-h-[600px]" id="maintenance-history">
                                        <div class="text-center py-8 text-slate-400">
                                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
                                            <p class="mt-4">Cargando historial...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Las otras pesta√±as (Instalaci√≥n, Gastos, etc.) mantienen la misma estructura -->
                <!-- ... resto del c√≥digo de las otras pesta√±as ... -->
                
            </div>
        </main>
    </div>

    <!-- Modal para Reporte Directivo PDF -->
    <div id="reportModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-[#2a1d15] rounded-xl shadow-lg w-full max-w-4xl mx-4">
            <div class="px-6 py-4 border-b border-[#e5e7eb] dark:border-[#3a2d25] flex justify-between items-center">
                <h3 class="text-lg font-bold text-[#181411] dark:text-white">Generar Reporte Directivo PDF</h3>
                <button onclick="closeReportModal()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-6" id="report-options">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
                        <p class="mt-4">Preparando generador de reportes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentScreen = null;
        let currentTab = 'dashboard';
        let maintenanceCalculator = null;
        let reportGenerator = null;
        let materialCounter = 0;

        // Cargar datos de la pantalla
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const deviceId = urlParams.get('device_id') || 'ARG-001';
            
            // Inicializar calculadora y generador
            if (window.MaintenanceCalculator) {
                maintenanceCalculator = new MaintenanceCalculator();
            }
            
            if (window.ReportGenerator) {
                reportGenerator = new ReportGenerator();
            }
            
            // Cargar datos
            await loadScreenData(deviceId);
            setupTabNavigation();
            initializeCharts();
            loadMaintenanceHistory();
            
            // Inicializar c√°lculo de mantenimiento
            updateMaintenanceCalculation();
        });

        async function loadScreenData(deviceId) {
            try {
                console.log('üîÑ Cargando datos de pantalla:', deviceId);
                
                if (!window.supabaseClient) {
                    throw new Error('Supabase no est√° inicializado');
                }

                // Obtener datos de la pantalla desde Supabase
                const { data: screen, error } = await window.supabaseClient
                    .from('pantallas')
                    .select('*')
                    .eq('id', deviceId)
                    .single();

                if (error) throw error;
                
                currentScreen = screen;

                // Actualizar UI
                updateScreenInfo();
                updateDashboard();
                updateMaintenanceForm();

            } catch (error) {
                console.error('‚ùå Error cargando pantalla:', error);
                // Cargar datos de ejemplo si hay error
                loadFallbackData(deviceId);
                showNotification('Error cargando datos. Usando datos de ejemplo.', 'error');
            }
        }

        function loadFallbackData(deviceId) {
            // Datos de ejemplo si Supabase falla
            currentScreen = {
                id: deviceId,
                nombre: `Pantalla ${deviceId}`,
                ubicacion: 'Centro Comercial Galer√≠as',
                estado: 'online',
                uptime: '99.8%',
                fecha_instalacion: '2024-01-15',
                ingresos_mensuales: 8500,
                gastos_mensuales: 3200,
                roi: 14.5,
                capex_data: JSON.stringify({
                    pantalla: 15000,
                    obra_civil: 5000,
                    estructura: 8000,
                    electrica: 3000,
                    novastar: 2500,
                    ups: 800,
                    nuc: 1200,
                    total: 28700
                }),
                opex_data: JSON.stringify({
                    renta: 2000,
                    cfe: 450,
                    internet: 120,
                    licencias: 150,
                    otros: 480,
                    total: 3200
                })
            };

            updateScreenInfo();
            updateDashboard();
        }

        function updateScreenInfo() {
            if (!currentScreen) return;

            document.getElementById('screen-id-display').textContent = currentScreen.id;
            document.getElementById('screen-name-display').textContent = currentScreen.nombre;
            document.getElementById('screen-title').textContent = currentScreen.nombre;
            document.getElementById('screen-location').textContent = currentScreen.ubicacion;
            
            // Actualizar estado
            const statusElement = document.getElementById('screen-status');
            const statusText = currentScreen.estado === 'online' ? 'En L√≠nea' : 
                              currentScreen.estado === 'maintenance' ? 'Mantenimiento' : 'Desconectada';
            const statusColor = currentScreen.estado === 'online' ? 'emerald' : 
                               currentScreen.estado === 'maintenance' ? 'amber' : 'red';
            
            statusElement.textContent = statusText;
            statusElement.className = `inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold bg-${statusColor}-100 text-${statusColor}-700 dark:bg-${statusColor}-900/30 dark:text-${statusColor}-400`;
            
            document.getElementById('screen-uptime').textContent = currentScreen.uptime || '0%';
        }

        function updateDashboard() {
            if (!currentScreen) return;

            const revenue = currentScreen.ingresos_mensuales || 0;
            const expenses = currentScreen.gastos_mensuales || 0;
            const profit = revenue - expenses;
            const profitMargin = revenue > 0 ? (profit / revenue) * 100 : 0;
            const roi = currentScreen.roi || 0;

            // Actualizar valores
            document.getElementById('roi-value').textContent = `${roi.toFixed(1)} meses`;
            document.getElementById('monthly-revenue').textContent = `$${revenue.toLocaleString()}`;
            document.getElementById('monthly-expenses').textContent = `$${expenses.toLocaleString()}`;
            document.getElementById('net-profit').textContent = `$${profit.toLocaleString()}`;
            document.getElementById('profit-margin').textContent = `${profitMargin.toFixed(1)}% de margen`;

            // Actualizar barra de progreso de ROI
            const roiProgress = Math.min((roi / 24) * 100, 100);
            document.getElementById('roi-progress').style.width = `${roiProgress}%`;

            // Actualizar tendencia de ingresos
            const revenueTrend = document.getElementById('revenue-trend');
            if (profit > 0) {
                revenueTrend.innerHTML = '<span class="material-symbols-outlined text-sm mr-1">arrow_upward</span> Rentable';
                revenueTrend.className = 'text-xs text-emerald-500 flex items-center';
            } else {
                revenueTrend.innerHTML = '<span class="material-symbols-outlined text-sm mr-1">arrow_downward</span> En d√©ficit';
                revenueTrend.className = 'text-xs text-red-500 flex items-center';
            }

            // Actualizar desglose de gastos
            const expensesBreakdown = document.getElementById('expenses-breakdown');
            try {
                const opexData = currentScreen.opex_data ? JSON.parse(currentScreen.opex_data) : {};
                expensesBreakdown.textContent = `OPEX: $${expenses.toLocaleString()}`;
            } catch (error) {
                expensesBreakdown.textContent = `OPEX mensual: $${expenses.toLocaleString()}`;
            }

            // Actualizar informaci√≥n t√©cnica
            updateTechnicalInfo();
        }

        function updateTechnicalInfo() {
            const container = document.getElementById('technical-info');
            if (!currentScreen) return;

            const installDate = currentScreen.fecha_instalacion || '2024-01-15';
            const daysOnline = Math.floor((new Date() - new Date(installDate)) / (1000 * 60 * 60 * 24));
            
            try {
                const capexData = currentScreen.capex_data ? JSON.parse(currentScreen.capex_data) : {};
                const totalCapex = capexData.total || Object.values(capexData).reduce((sum, val) => sum + (Number(val) || 0), 0);
                
                container.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-500">Instalaci√≥n</span>
                            <span class="font-medium">${installDate}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-500">D√≠as en Operaci√≥n</span>
                            <span class="font-medium">${daysOnline} d√≠as</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-500">CAPEX Total</span>
                            <span class="font-bold text-primary">$${totalCapex.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-500">Uptime</span>
                            <span class="font-medium text-emerald-600">${currentScreen.uptime || '0%'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-slate-500">ROI Actual</span>
                            <span class="font-bold ${(currentScreen.roi || 0) < 18 ? 'text-emerald-600' : (currentScreen.roi || 0) < 24 ? 'text-blue-600' : 'text-red-600'}">
                                ${(currentScreen.roi || 0).toFixed(1)} meses
                            </span>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <span class="material-symbols-outlined text-2xl">error</span>
                        <p class="mt-2">Error cargando informaci√≥n t√©cnica</p>
                    </div>
                `;
            }
        }

        async function loadMaintenanceHistory() {
            try {
                if (!window.supabaseClient || !currentScreen) return;

                const { data: maintenances, error } = await window.supabaseClient
                    .from('mantenimientos')
                    .select('*')
                    .eq('pantalla_id', currentScreen.id)
                    .order('fecha', { ascending: false });

                if (error) throw error;

                updateMaintenanceHistoryUI(maintenances || []);

            } catch (error) {
                console.error('Error cargando historial:', error);
                updateMaintenanceHistoryUI([]);
            }
        }

        function updateMaintenanceHistoryUI(maintenances) {
            const container = document.getElementById('maintenance-history');
            
            if (!maintenances || maintenances.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <span class="material-symbols-outlined text-2xl">history</span>
                        <p class="mt-2">No hay mantenimientos registrados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = maintenances.map(maintenance => {
                const typeClass = maintenance.tipo === 'preventivo' 
                    ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-400' 
                    : 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400';
                
                const typeText = maintenance.tipo === 'preventivo' ? 'Preventivo' : 'Correctivo';
                
                return `
                    <div class="p-4 border border-[#e5e7eb] dark:border-[#3a2d25] rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium ${typeClass} border">
                                    ${typeText}
                                </span>
                                <span class="text-sm text-slate-500 ml-2">${maintenance.fecha}</span>
                            </div>
                            <span class="font-bold text-primary">$${(maintenance.costo_total || 0).toLocaleString()}</span>
                        </div>
                        <p class="text-sm text-slate-700 dark:text-slate-300 mb-2">${maintenance.descripcion || 'Sin descripci√≥n'}</p>
                        <div class="flex justify-between text-xs text-slate-500">
                            <span>${maintenance.horas || 0} horas ‚Ä¢ ${maintenance.tipo_tecnico || 'T√©cnico'}</span>
                            <button onclick="deleteMaintenance('${maintenance.id}')" class="text-red-500 hover:text-red-700">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setupTabNavigation() {
            document.querySelectorAll('.tab-nav').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tab = this.getAttribute('data-tab');
                    showTab(tab);
                });
            });
        }

        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Actualizar enlaces activos
            document.querySelectorAll('.tab-nav').forEach(link => {
                link.classList.remove('bg-primary/10', 'text-primary');
                link.classList.add('text-slate-600', 'dark:text-slate-400');
            });

            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            
            // Activar enlace correspondiente
            const activeLink = document.querySelector(`.tab-nav[data-tab="${tabName}"]`);
            if (activeLink) {
                activeLink.classList.remove('text-slate-600', 'dark:text-slate-400');
                activeLink.classList.add('bg-primary/10', 'text-primary');
            }

            currentTab = tabName;
        }

        function initializeCharts() {
            if (!currentScreen) return;

            const ctx = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: [6500, 7200, 8000, 8500, 9000, 9500],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Gastos',
                            data: [4200, 4500, 4800, 5200, 5500, 5800],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funciones para mantenimientos con c√°lculos reales
        function updateMaintenanceForm() {
            if (!currentScreen) return;
            
            // Prellenar el ID de pantalla si es necesario
            document.getElementById('maintenance-form').dataset.pantallaId = currentScreen.id;
        }

        function addMaterialRow() {
            materialCounter++;
            const container = document.getElementById('materials-container');
            const newRow = document.createElement('div');
            newRow.className = 'material-row flex items-center gap-2';
            newRow.innerHTML = `
                <select class="flex-1 px-3 py-2 border border-[#e5e7eb] dark:border-[#3a2d25] rounded-lg bg-white dark:bg-[#2a1d15] material-type" 
                        onchange="updateMaintenanceCalculation()">
                    <option value="">Seleccionar material...</option>
                    <option value="dioxido_titanio">Di√≥xido de Titanio ($45/kg)</option>
                    <option value="modulo_led">M√≥dulo LED ($250/unidad)</option>
                    <option value="fuente_poder">Fuente de Poder ($180/unidad)</option>
                    <option value="cable_fat">Cable FAT ($45/metro)</option>
                    <option value="novastar_mctrl300">Novastar MCTRL300 ($350/unidad)</option>
                    <option value="ventilador">Ventilador ($85/unidad)</option>
                    <option value="tarjeta_control">Tarjeta de Control ($120/unidad)</option>
                </select>
                <input type="number" class="w-20 px-3 py-2 border border-[#e5e7eb] dark:border-[#3a2d25] rounded-lg bg-white dark:bg-[#2a1d15] material-quantity" 
                       placeholder="Cant" min="1" value="1" step="1" onchange="updateMaintenanceCalculation()">
                <button type="button" onclick="this.parentElement.remove(); updateMaintenanceCalculation();" class="text-red-500 hover:text-red-700">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            `;
            container.appendChild(newRow);
            updateMaintenanceCalculation();
        }

        function updateMaintenanceCalculation() {
            if (!maintenanceCalculator) return;

            const hours = parseFloat(document.getElementById('maintenance-hours').value) || 0;
            const technicianType = document.getElementById('technician-type').value;
            
            // Obtener materiales
            const materials = [];
            document.querySelectorAll('.material-row').forEach(row => {
                const type = row.querySelector('.material-type').value;
                const quantity = parseFloat(row.querySelector('.material-quantity').value) || 1;
                if (type) {
                    materials.push({ type: type, quantity: quantity });
                }
            });

            // Obtener servicios adicionales
            const additionalServices = [];
            const travelDistance = 0; // Podr√≠as agregar un campo para esto

            // Calcular costo
            const calculation = maintenanceCalculator.calculateMaintenanceCost({
                hours: hours,
                technicianType: technicianType,
                materials: materials,
                additionalServices: additionalServices,
                travelDistance: travelDistance
            });

            // Actualizar UI
            document.getElementById('maintenance-total-cost').textContent = 
                `$${calculation.totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
            document.getElementById('cost-breakdown').textContent = 
                `Mano de obra: $${calculation.laborCost.toLocaleString('en-US', { minimumFractionDigits: 2 })} | ` +
                `Materiales: $${calculation.materialsCost.toLocaleString('en-US', { minimumFractionDigits: 2 })} | ` +
                `Adicional: $${calculation.additionalCosts.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
        }

        async function saveMaintenance() {
            if (!maintenanceCalculator || !currentScreen) {
                showNotification('Error: Sistema de c√°lculo no disponible', 'error');
                return;
            }

            try {
                const hours = parseFloat(document.getElementById('maintenance-hours').value) || 0;
                if (hours <= 0) {
                    showNotification('Ingrese horas v√°lidas', 'error');
                    return;
                }

                const maintenanceType = document.querySelector('input[name="maintenance-type"]:checked').value;
                const technicianType = document.getElementById('technician-type').value;
                const date = document.getElementById('maintenance-date').value;
                const description = document.getElementById('maintenance-description').value;

                // Obtener materiales
                const materials = [];
                document.querySelectorAll('.material-row').forEach(row => {
                    const type = row.querySelector('.material-type').value;
                    const quantity = parseFloat(row.querySelector('.material-quantity').value) || 1;
                    if (type) {
                        materials.push({ type: type, quantity: quantity });
                    }
                });

                const maintenanceData = {
                    pantalla_id: currentScreen.id,
                    fecha: date,
                    tipo: maintenanceType,
                    horas: hours,
                    tipo_tecnico: technicianType,
                    descripcion: description,
                    materiales: materials,
                    servicios_adicionales: [],
                    distancia_traslado: 0
                };

                // Guardar en Supabase
                const result = await maintenanceCalculator.saveMaintenanceToDB(maintenanceData);
                
                showNotification('‚úÖ Mantenimiento guardado exitosamente', 'success');
                
                // Actualizar historial
                await loadMaintenanceHistory();
                
                // Actualizar datos de pantalla
                await loadScreenData(currentScreen.id);
                
                // Limpiar formulario
                document.getElementById('maintenance-hours').value = 0;
                document.getElementById('maintenance-description').value = '';
                document.getElementById('materials-container').innerHTML = '';
                materialCounter = 0;
                updateMaintenanceCalculation();

            } catch (error) {
                console.error('Error guardando mantenimiento:', error);
                showNotification('Error al guardar mantenimiento: ' + error.message, 'error');
            }
        }

        async function deleteMaintenance(maintenanceId) {
            if (!confirm('¬øEst√°s seguro de eliminar este mantenimiento?')) return;

            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase no est√° inicializado');
                }

                const { error } = await window.supabaseClient
                    .from('mantenimientos')
                    .delete()
                    .eq('id', maintenanceId);

                if (error) throw error;

                showNotification('Mantenimiento eliminado', 'success');
                await loadMaintenanceHistory();
                await loadScreenData(currentScreen.id);

            } catch (error) {
                console.error('Error eliminando mantenimiento:', error);
                showNotification('Error al eliminar mantenimiento', 'error');
            }
        }

        // Funciones para reportes PDF reales
        async function generateScreenReport() {
            if (!reportGenerator || !currentScreen) {
                showNotification('Error: Generador de reportes no disponible', 'error');
                return;
            }

            try {
                showNotification('üìä Generando reporte directivo...', 'info');
                
                const reportData = await reportGenerator.generateScreenReport(currentScreen.id, {
                    analysisType: 'estrategico',
                    detailLevel: 'directivo',
                    includeCharts: true,
                    includeRecommendations: true
                });

                // Mostrar modal con opciones de reporte
                showReportModal(reportData);

            } catch (error) {
                console.error('Error generando reporte:', error);
                showNotification('Error al generar reporte: ' + error.message, 'error');
            }
        }

        function showReportModal(reportData) {
            const container = document.getElementById('report-options');
            
            container.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold text-[#181411] dark:text-white mb-2">Tipo de An√°lisis</h4>
                        <select id="report-analysis-type" class="w-full px-4 py-2 border border-[#e5e7eb] dark:border-[#3a2d25] rounded-lg bg-white dark:bg-[#2a1d15]">
                            <option value="estrategico">An√°lisis Estrat√©gico</option>
                            <option value="financiero">An√°lisis Financiero Avanzado</option>
                            <option value="operativo">An√°lisis Operativo</option>
                            <option value="rentabilidad">An√°lisis de Rentabilidad</option>
                            <option value="inversion">An√°lisis de Inversi√≥n</option>
                        </select>
                    </div>

                    <div>
                        <h4 class="font-bold text-[#181411] dark:text-white mb-2">Nivel de Detalle</h4>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="report-detail" value="ejecutivo" class="mr-2" checked>
                                <span class="text-sm">Ejecutivo (Resumido)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="report-detail" value="directivo" class="mr-2">
                                <span class="text-sm">Directivo (Detallado)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="report-detail" value="tecnico" class="mr-2">
                                <span class="text-sm">T√©cnico (Completo)</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-[#181411] dark:text-white mb-2">Secciones a Incluir</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span class="text-sm">Resumen Ejecutivo</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span class="text-sm">An√°lisis Financiero</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span class="text-sm">ROI y Rentabilidad</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span class="text-sm">Historial de Mantenimientos</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span class="text-sm">Recomendaciones Estrat√©gicas</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span class="text-sm">Proyecciones Futuras</span>
                            </label>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-[#e5e7eb] dark:border-[#3a2d25]">
                        <div class="mb-4 p-4 bg-slate-50 dark:bg-slate-800/30 rounded-lg">
                            <h5 class="font-bold text-[#181411] dark:text-white mb-2">Resumen del Reporte:</h5>
                            <p class="text-sm text-slate-600 dark:text-slate-400">
                                Pantalla: <strong>${reportData.screen.nombre}</strong><br>
                                ROI: <strong>${reportData.stats.roiMonths} meses</strong><br>
                                Margen: <strong>${reportData.stats.profitMargin}%</strong><br>
                                Costo Mantenimientos: <strong>$${reportData.stats.totalMaintenanceCost.toLocaleString()}</strong>
                            </p>
                        </div>
                        
                        <button onclick="generatePDFReport()" class="w-full px-6 py-3 bg-primary text-white font-bold rounded-lg hover:bg-primary-dark transition flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">picture_as_pdf</span>
                            Generar Reporte Directivo PDF
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('reportModal').classList.remove('hidden');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        async function generatePDFReport() {
            try {
                showNotification('üìÑ Generando PDF... Esto puede tomar unos segundos.', 'info');
                
                // Aqu√≠ implementar√≠as la generaci√≥n real del PDF
                // Por ahora, simular la generaci√≥n
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Crear enlace de descarga simulado
                const link = document.createElement('a');
                link.href = '#';
                link.download = `reporte-${currentScreen.id}-${new Date().toISOString().split('T')[0]}.pdf`;
                link.click();
                
                showNotification('‚úÖ Reporte PDF generado exitosamente', 'success');
                closeReportModal();
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                showNotification('Error al generar PDF: ' + error.message, 'error');
            }
        }

        async function refreshScreenData() {
            if (!currentScreen) return;
            
            await loadScreenData(currentScreen.id);
            showNotification('Datos de pantalla actualizados', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const typeClasses = {
                'success': 'bg-emerald-500 text-white',
                'error': 'bg-red-500 text-white',
                'info': 'bg-blue-500 text-white',
                'warning': 'bg-amber-500 text-white'
            };

            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${typeClasses[type]} animate-fade-in`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined">
                        ${type === 'success' ? 'check_circle' : 
                          type === 'error' ? 'error' : 
                          type === 'warning' ? 'warning' : 'info'}
                    </span>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('reportModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeReportModal();
            }
        });

        // A√±adir estilo para animaci√≥n
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in {
                animation: fade-in 0.3s ease-out;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
