<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechView - Gestión Financiera Completa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <style>
        /* Estilos personalizados omitidos para brevedad, son los mismos de antes */
        .tab-content { display: none; opacity: 0; transition: all 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; }
        .nav-tab.active { border-bottom: 3px solid #f97316; color: #f97316; font-weight: 600; }
        .cost-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.3); border-top: 3px solid #f97316; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 8px; color: white; z-index: 1000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <span class="material-icons-outlined text-orange-500 text-3xl">analytics</span>
                <div>
                    <h1 class="text-xl font-bold">TechView - Gestión</h1>
                    <code class="text-xs bg-gray-100 px-2 py-1 rounded">{{ device_id }}</code>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="saveAll()" id="save-btn" class="px-4 py-2 bg-orange-500 text-white rounded-lg flex items-center gap-2 hover:bg-orange-600 transition">
                    <span class="material-icons-outlined">save</span> Guardar
                    <span id="save-badge" class="bg-white text-orange-600 px-2 rounded-full text-xs hidden">0</span>
                </button>
            </div>
        </div>
    </header>

    <div class="bg-white border-b">
        <div class="container mx-auto px-4 flex overflow-x-auto">
            <button onclick="switchTab('resumen')" class="nav-tab active px-4 py-3">Resumen</button>
            <button onclick="switchTab('capex')" class="nav-tab px-4 py-3">CAPEX</button>
            <button onclick="switchTab('opex')" class="nav-tab px-4 py-3">OPEX</button>
            <button onclick="switchTab('manto')" class="nav-tab px-4 py-3">Mantenimiento</button>
        </div>
    </div>

    <main class="container mx-auto px-4 py-6">
        
        <div id="tab-resumen" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <p class="text-sm text-gray-500">CAPEX Total</p>
                    <p class="text-2xl font-bold" id="kpi-capex">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <p class="text-sm text-gray-500">OPEX Mensual</p>
                    <p class="text-2xl font-bold" id="kpi-opex">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <p class="text-sm text-gray-500">ROI Estimado</p>
                    <p class="text-2xl font-bold text-blue-600" id="kpi-roi">0 meses</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <p class="text-sm text-gray-500">Score Técnico</p>
                    <p class="text-2xl font-bold text-emerald-600" id="tech-score-text">0/100</p>
                </div>
            </div>
        </div>

        <div id="tab-capex" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                <h3 class="font-bold text-lg mb-4">Infraestructura y Equipamiento</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Pantalla LED</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_screen" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Estructura</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_structure" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Obra Civil</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_civil" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Instalación Eléctrica</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_electrical" placeholder="0.00">
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-opex" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                <h3 class="font-bold text-lg mb-4">Gastos Mensuales</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Renta</label>
                        <input type="number" step="0.01" class="cost-input" id="opex_rent" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Electricidad</label>
                        <input type="number" step="0.01" class="cost-input" id="opex_light" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Internet</label>
                        <input type="number" step="0.01" class="cost-input" id="opex_internet" placeholder="0.00">
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-manto" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                <h3 class="font-bold text-lg mb-4">Configuración de Mantenimiento</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Costo Bimestral</label>
                        <input type="number" step="0.01" class="cost-input" id="maint_prev_bimonthly" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Tamaño de Cuadrilla (Personas)</label>
                        <input type="number" step="1" class="cost-input" id="maint_crew_size" placeholder="3">
                        <p class="text-xs text-gray-500">Número entero</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Visitas Realizadas</label>
                        <input type="number" step="1" class="cost-input" id="maint_visit_count" placeholder="0">
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl flex flex-col items-center">
            <div class="loading-spinner mb-3"></div>
            <p>Procesando...</p>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script>
        const deviceId = "{{ device_id }}";
        let pendingChanges = new Set();
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            loadDeviceData();
            setupInputs();
        });
        
        function setupInputs() {
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    pendingChanges.add(e.target.id);
                    updateBadge();
                });
            });
        }
        
        function updateBadge() {
            const badge = document.getElementById('save-badge');
            if (pendingChanges.size > 0) {
                badge.textContent = pendingChanges.size;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        async function loadDeviceData() {
            showLoading();
            try {
                const res = await fetch(`/techview/api/device/${encodeURIComponent(deviceId)}`);
                const data = await res.json();
                
                if (data.financials) {
                    Object.keys(data.financials).forEach(key => {
                        const input = document.getElementById(key);
                        if (input) input.value = data.financials[key];
                    });
                }
                
                if (data.totals) {
                    document.getElementById('kpi-capex').textContent = `$${data.totals.capex}`;
                    document.getElementById('kpi-opex').textContent = `$${data.totals.opex_monthly}`;
                    document.getElementById('kpi-roi').textContent = `${data.totals.roi_months} meses`;
                }
            } catch (e) {
                showToast('Error cargando datos', 'error');
            } finally {
                hideLoading();
            }
        }

        // ==========================================
        // FUNCIÓN CORREGIDA SAVE ALL
        // ==========================================
        async function saveAll() {
            if (pendingChanges.size === 0) {
                showToast('No hay cambios para guardar', 'info');
                return;
            }
            
            showLoading();
            
            try {
                const payload = {
                    device_id: deviceId,
                    cost_type: 'techview',
                    category: 'comprehensive'
                };
                
                // Campos que deben ser ENTEROS
                const integerFields = ['maint_crew_size', 'maint_visit_count', 'maint_corr_visit_count'];
                
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    if (input.value && input.value !== '') {
                        // CORRECCIÓN AQUÍ: Convertir a entero si es necesario
                        if (integerFields.includes(input.id)) {
                            payload[input.id] = parseInt(input.value, 10);
                        } else {
                            payload[input.id] = parseFloat(input.value);
                        }
                    }
                });
                
                console.log('Enviando payload:', payload);

                const res = await fetch('/techview/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const result = await res.json();
                
                if (res.ok) {
                    showToast('Guardado correctamente', 'success');
                    pendingChanges.clear();
                    updateBadge();
                    loadDeviceData(); // Recargar para ver cálculos actualizados
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
                
            } catch (e) {
                console.error(e);
                showToast('Error al guardar: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Utilidades UI
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        
        function showToast(msg, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
