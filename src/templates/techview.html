<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Argos TechView - Gestión</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    <style>
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        .nav-tab.active { border-bottom: 2px solid #F97316; color: #F97316; font-weight: 700; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h2 class="text-lg font-bold text-slate-900">Gestión: <span class="text-primary">{{ device_id }}</span></h2>
        </div>
        <div class="flex gap-3">
            <a href="/techview/analysis?device_id={{ device_id }}" target="_blank" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-xs flex gap-2 items-center">
                <span class="material-icons-outlined text-sm">analytics</span> Reporte Visual (Premium)
            </a>
            <button onclick="saveAll()" class="bg-primary hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-xs flex gap-2 items-center shadow-md">
                <span class="material-icons-outlined text-sm">save</span> Guardar
            </button>
            <a href="/techview" class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-xs">Cerrar</a>
        </div>
    </header>

    <div class="bg-white border-b border-slate-100 px-6 overflow-x-auto">
        <div class="flex gap-6 min-w-max">
            <button onclick="switchTab('resumen')" class="nav-tab active py-3 text-sm">Resumen & Gráficas</button>
            <button onclick="switchTab('capex')" class="nav-tab py-3 text-sm">1. CAPEX</button>
            <button onclick="switchTab('electro')" class="nav-tab py-3 text-sm">2. Electrónica</button>
            <button onclick="switchTab('opex')" class="nav-tab py-3 text-sm">3. OPEX</button>
            <button onclick="switchTab('manto')" class="nav-tab py-3 text-sm">4. Mantenimiento</button>
        </div>
    </div>

    <main class="p-6 max-w-[1920px] mx-auto w-full">

        <div id="tab-resumen" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">CAPEX Total</p><h3 class="text-3xl font-black text-slate-900" id="kpi-capex">$0</h3></div>
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">OPEX Mensual</p><h3 class="text-3xl font-black text-orange-600" id="kpi-opex">$0</h3></div>
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">Ventas Mensual</p><h3 class="text-3xl font-black text-emerald-600" id="kpi-sales">$0</h3></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl border shadow-sm">
                    <h3 class="font-bold text-sm text-slate-800 mb-4">Proyección Financiera</h3>
                    <div class="h-64 w-full"><canvas id="barChart"></canvas></div>
                </div>
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-4 rounded-xl border shadow-sm h-40 flex flex-col">
                        <h3 class="font-bold text-xs mb-2">Distribución CAPEX</h3>
                        <div class="flex-1 relative"><canvas id="pieCapex"></canvas></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border shadow-sm h-40 flex flex-col">
                        <h3 class="font-bold text-xs mb-2">Distribución OPEX</h3>
                        <div class="flex-1 relative"><canvas id="pieOpex"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-capex" class="tab-content space-y-6">
            <form class="grid grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-primary">Infraestructura</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Pantalla LED <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Infraestructura" data-con="Pantalla"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Obra Civil <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Infraestructura" data-con="Obra Civil"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Estructura <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Infraestructura" data-con="Estructura"></label>
                </div>
            </form>
        </div>

        <div id="tab-electro" class="tab-content space-y-6">
            <form class="grid grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm col-span-3">
                    <h4 class="font-bold border-b pb-2 mb-4 text-primary">Componentes</h4>
                    <div class="grid grid-cols-3 gap-4">
                        <label class="block text-xs font-bold text-slate-500">NUC <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Electronica" data-con="NUC"></label>
                        <label class="block text-xs font-bold text-slate-500">UPS <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Electronica" data-con="UPS"></label>
                        <label class="block text-xs font-bold text-slate-500">Sending <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="CAPEX" data-cat="Electronica" data-con="Sending Card"></label>
                    </div>
                </div>
            </form>
        </div>

        <div id="tab-opex" class="tab-content space-y-6">
            <form class="grid grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-orange-600">Mensuales</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Luz <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="OPEX" data-cat="Suministros" data-con="Luz" data-rec="monthly"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Internet <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="OPEX" data-cat="Suministros" data-con="Internet" data-rec="monthly"></label>
                </div>
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-emerald-600">Ingresos</h4>
                    <label class="block mb-2 text-xs font-bold text-emerald-700">Ventas <input type="number" class="w-full border-emerald-200 bg-emerald-50 rounded text-sm mt-1 cost-input font-bold" data-type="REVENUE" data-cat="Ventas" data-con="Publicidad" data-rec="monthly"></label>
                </div>
            </form>
        </div>

        <div id="tab-manto" class="tab-content">
            <div class="bg-white p-6 rounded-xl border shadow-sm">
                <h4 class="font-bold border-b pb-2 mb-4">Costos</h4>
                <label class="block mb-2 text-xs font-bold text-slate-500">Preventivo (Bimestral) <input type="number" class="w-full border-slate-200 rounded text-sm mt-1 cost-input" data-type="MAINTENANCE" data-cat="Preventivo" data-con="Visita" data-rec="bimonthly"></label>
            </div>
        </div>

    </main>

    <script>
        const deviceId = "{{ device_id }}";
        let charts = {};

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadData() {
            try {
                const res = await fetch(`/api/techview/device/${encodeURIComponent(deviceId)}`);
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();

                let capexInfra = 0, capexElec = 0, capexTotal = 0;
                let opexSum = 0, opexSoft = 0, opexTotal = 0;

                if(data.breakdown) {
                    data.breakdown.forEach(item => {
                        const sel = `.cost-input[data-type="${item.cost_type}"][data-con="${item.concept}"]`;
                        const input = document.querySelector(sel);
                        if(input) input.value = item.amount;

                        // Sumas para Pasteles
                        if(item.cost_type === 'CAPEX') {
                            capexTotal += item.amount;
                            if(item.category === 'Infraestructura') capexInfra += item.amount;
                            else capexElec += item.amount;
                        }
                        if(item.cost_type === 'OPEX') {
                            opexTotal += item.amount;
                            if(item.category === 'Suministros') opexSum += item.amount;
                            else opexSoft += item.amount;
                        }
                    });
                }

                // KPIs
                const fmt = n => `$${n.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                document.getElementById('kpi-capex').innerText = fmt(data.totals.capex);
                document.getElementById('kpi-opex').innerText = fmt(data.totals.opex);
                document.getElementById('kpi-sales').innerText = fmt(data.totals.revenue);

                // Render Charts
                renderCharts({
                    revenue: data.totals.revenue,
                    opex: data.totals.opex,
                    capexData: [capexInfra, capexElec, capexTotal - (capexInfra+capexElec)],
                    opexData: [opexSum, opexSoft, opexTotal - (opexSum+opexSoft)]
                });

            } catch(e) { console.error(e); }
        }

        function renderCharts(d) {
            if(charts.bar) charts.bar.destroy();
            if(charts.pie1) charts.pie1.destroy();
            if(charts.pie2) charts.pie2.destroy();

            // 1. Bar Chart
            charts.bar = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: ['Mensual'],
                    datasets: [
                        { label: 'Ingresos', data: [d.revenue], backgroundColor: '#10B981' },
                        { label: 'Gastos', data: [d.opex], backgroundColor: '#F97316' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });

            // 2. Pie CAPEX
            charts.pie1 = new Chart(document.getElementById('pieCapex'), {
                type: 'doughnut',
                data: {
                    labels: ['Infra', 'Elec', 'Otros'],
                    datasets: [{ data: d.capexData, backgroundColor: ['#3B82F6', '#6366F1', '#CBD5E1'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 3. Pie OPEX
            charts.pie2 = new Chart(document.getElementById('pieOpex'), {
                type: 'doughnut',
                data: {
                    labels: ['Suministros', 'Soft', 'Otros'],
                    datasets: [{ data: d.opexData, backgroundColor: ['#F59E0B', '#EF4444', '#CBD5E1'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        async function saveAll() {
            const inputs = document.querySelectorAll('.cost-input');
            const promises = Array.from(inputs).map(input => {
                const val = parseFloat(input.value);
                if (val > 0) {
                    return fetch('/api/techview/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            device_id: deviceId,
                            cost_type: input.dataset.type,
                            category: input.dataset.cat,
                            concept: input.dataset.con,
                            recurrence: input.dataset.rec || 'one_time',
                            amount: val
                        })
                    });
                }
            });
            await Promise.all(promises);
            alert("Datos guardados en Supabase.");
            loadData();
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
