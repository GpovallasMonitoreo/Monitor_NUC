<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechView - Análisis Financiero DOOH</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#00e070",
                        "primary-dark": "#00c462",
                        "background-light": "#f8fcfa",
                        "surface-light": "#ffffff",
                        "text-main": "#0c1d14",
                        "text-muted": "#45a173",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Space Grotesk', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .icon-filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        
        /* Tabs Logic */
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; }
        .nav-tab.active { color: #00e070; border-bottom: 2px solid #00e070; background-color: rgba(0, 224, 112, 0.05); }
        
        .cost-input { width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; background-color: #fff; }
        .cost-input:focus { outline: none; border-color: #00e070; box-shadow: 0 0 0 3px rgba(0, 224, 112, 0.1); }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #00e070; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; z-index: 2000; box-shadow: 0 10px 25px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="bg-background-light text-text-main font-display min-h-screen flex flex-col">

    <header class="flex items-center justify-between border-b border-[#e6f4ed] px-6 py-3 bg-surface-light sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="size-10 bg-primary/10 rounded-lg flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined icon-filled">analytics</span>
                </div>
                <div>
                    <h2 class="text-lg font-bold leading-none">TechView</h2>
                    <p class="text-xs text-text-muted mt-1 font-mono truncate max-w-[200px]" id="device-display">{{ device_id }}</p>
                </div>
            </div>
            
            <nav class="hidden md:flex bg-gray-100/50 p-1 rounded-lg">
                <button onclick="switchTab('resumen')" class="nav-tab active px-4 py-1.5 rounded-md text-sm font-medium transition-all">Análisis Ejecutivo</button>
                <button onclick="switchTab('capex')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main">Inversión (CAPEX)</button>
                <button onclick="switchTab('opex')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main">Costos (OPEX)</button>
                <button onclick="switchTab('manto')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main">Mantenimiento</button>
                <button onclick="switchTab('ciclo')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main">Ciclo de Vida</button>
            </nav>
        </div>

        <div class="flex items-center gap-3">
            <div id="unsaved-badge" class="hidden px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-full border border-yellow-200 animate-pulse">
                Cambios sin guardar
            </div>
            
            <button onclick="saveAll()" class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-bold text-sm transition-colors shadow-lg shadow-primary/20 active:scale-95">
                <span class="material-symbols-outlined text-lg">save</span>
                <span class="hidden sm:inline">Guardar</span>
            </button>
            
            <button onclick="checkExit()" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 rounded-lg font-bold text-sm transition-colors" title="Salir (Esc)">
                <span class="material-symbols-outlined text-lg">logout</span>
            </button>
        </div>
    </header>

    <main class="flex-1 w-full max-w-[1600px] mx-auto px-4 md:px-8 py-6">
        
        <div id="tab-resumen" class="tab-content active">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6">
                <div>
                    <div class="flex items-center gap-2 text-sm text-text-muted mb-1">
                        <span>Estado Financiero</span>
                        <span class="material-symbols-outlined text-xs">chevron_right</span>
                        <span class="text-primary font-bold" id="financial-status-text">Analizando...</span>
                    </div>
                    <h1 class="text-3xl font-black tracking-tight text-text-main">Resumen de Ubicación</h1>
                </div>
                <div class="bg-surface-light border border-[#e6f4ed] rounded-xl p-3 flex items-center gap-4 shadow-sm">
                    <div class="size-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                        <span class="material-symbols-outlined">smart_toy</span>
                    </div>
                    <div>
                        <p class="text-xs text-text-muted font-bold uppercase">Recomendación del Sistema</p>
                        <p class="text-sm font-bold text-text-main" id="ai-recommendation">Cargando análisis...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <div class="lg:col-span-4 flex flex-col gap-6">
                    <div class="bg-surface-light rounded-2xl border border-[#cdeadb] shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">verified</span>
                            Salud del Activo
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-text-muted">Score Técnico</span>
                                    <span class="font-bold" id="tech-score-val">0/100</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div id="tech-score-bar" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                    <span class="text-xs text-text-muted block">ROI Actual</span>
                                    <span class="text-lg font-black text-text-main" id="dash-roi">0m</span>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                    <span class="text-xs text-text-muted block">Tasa Reincidencia</span>
                                    <span class="text-lg font-black text-text-main" id="dash-reincidence">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-surface-light rounded-2xl border border-[#cdeadb] shadow-sm p-6 flex-1">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg flex items-center gap-2">
                                <span class="material-symbols-outlined text-orange-500">payments</span>
                                Flujo Operativo
                            </h3>
                            <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold">MENSUAL</span>
                        </div>
                        <p class="text-sm text-text-muted mb-4">Suma de OPEX recurrente + Mantenimiento prorrateado.</p>
                        
                        <div class="flex items-baseline gap-2 mb-4">
                            <span class="text-4xl font-black text-text-main" id="dash-monthly-cost">$0</span>
                            <span class="text-sm text-text-muted">/ mes</span>
                        </div>

                        <div class="h-32 w-full">
                            <canvas id="monthlyCostChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 flex flex-col gap-6">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-surface-light p-5 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-5xl text-primary">monetization_on</span>
                            </div>
                            <p class="text-text-muted text-xs font-bold uppercase mb-1">Ingreso Mensual</p>
                            <p class="text-2xl font-black text-text-main" id="dash-revenue">$0</p>
                        </div>
                        <div class="bg-surface-light p-5 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-5xl text-blue-500">business</span>
                            </div>
                            <p class="text-text-muted text-xs font-bold uppercase mb-1">Inversión Inicial (CAPEX)</p>
                            <p class="text-2xl font-black text-text-main" id="dash-capex">$0</p>
                        </div>
                        <div class="bg-surface-light p-5 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
                            <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                <span class="material-symbols-outlined text-5xl text-purple-500">query_stats</span>
                            </div>
                            <p class="text-text-muted text-xs font-bold uppercase mb-1">Margen Neto Mensual</p>
                            <p class="text-2xl font-black text-text-main" id="dash-margin">$0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                        <div class="bg-surface-light p-6 rounded-2xl border border-[#cdeadb] shadow-sm">
                            <h4 class="text-xs uppercase tracking-wider text-text-muted font-bold mb-4 border-b pb-2">Especificaciones Activo</h4>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Modelo Pantalla</span>
                                    <span class="font-bold text-text-main">LED P3.9 Outdoor</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Controlador</span>
                                    <span class="font-bold text-text-main">Intel NUC / Novastar</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Conectividad</span>
                                    <span class="font-bold text-text-main">Teltonika LTE + Fibra</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-surface-light p-6 rounded-2xl border border-[#cdeadb] shadow-sm relative overflow-hidden">
                            <h4 class="text-xs uppercase tracking-wider text-text-muted font-bold mb-4 border-b pb-2">Impacto Ecológico</h4>
                            <div class="flex items-center gap-6">
                                <div class="relative size-24 shrink-0">
                                    <svg class="size-full -rotate-90" viewBox="0 0 36 36">
                                        <path class="text-gray-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3"></path>
                                        <path class="text-primary" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-dasharray="66, 100" stroke-width="3"></path>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-primary">66% Ahorro</div>
                                </div>
                                <div>
                                    <p class="text-2xl font-black text-text-main" id="eco-co2">0.00</p>
                                    <p class="text-xs text-text-muted uppercase">Toneladas CO₂ evitadas</p>
                                    <p class="text-xs text-gray-400 mt-1">Eq. a <span id="eco-trees">0</span> árboles</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-capex" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-xl mb-6 text-gray-800">1. Inversión Inicial (CAPEX)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-blue-600 border-b pb-2">Infraestructura</h4>
                        <div><label class="text-xs font-bold text-gray-500">Pantalla LED</label><input type="number" class="cost-input" id="capex_screen"></div>
                        <div><label class="text-xs font-bold text-gray-500">Obra Civil</label><input type="number" class="cost-input" id="capex_civil"></div>
                        <div><label class="text-xs font-bold text-gray-500">Estructura</label><input type="number" class="cost-input" id="capex_structure"></div>
                        <div><label class="text-xs font-bold text-gray-500">Inst. Eléctrica</label><input type="number" class="cost-input" id="capex_electrical"></div>
                        <div><label class="text-xs font-bold text-gray-500">Medidor CFE</label><input type="number" class="cost-input" id="capex_meter"></div>
                        <div><label class="text-xs font-bold text-gray-500">Inst. Datos</label><input type="number" class="cost-input" id="capex_data_install"></div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-purple-600 border-b pb-2">Electrónica</h4>
                        <div><label class="text-xs font-bold text-gray-500">NUC</label><input type="number" class="cost-input" id="capex_nuc"></div>
                        <div><label class="text-xs font-bold text-gray-500">UPS</label><input type="number" class="cost-input" id="capex_ups"></div>
                        <div><label class="text-xs font-bold text-gray-500">Sending Card</label><input type="number" class="cost-input" id="capex_sending"></div>
                        <div><label class="text-xs font-bold text-gray-500">Procesador</label><input type="number" class="cost-input" id="capex_processor"></div>
                        <div><label class="text-xs font-bold text-gray-500">Módem WiFi</label><input type="number" class="cost-input" id="capex_modem_wifi"></div>
                        <div><label class="text-xs font-bold text-gray-500">Módem SIM</label><input type="number" class="cost-input" id="capex_modem_sim"></div>
                        <div><label class="text-xs font-bold text-gray-500">Teltonika</label><input type="number" class="cost-input" id="capex_teltonika"></div>
                        <div><label class="text-xs font-bold text-gray-500">HDMI / Cables</label><input type="number" class="cost-input" id="capex_hdmi"></div>
                        <div><label class="text-xs font-bold text-gray-500">Cámara</label><input type="number" class="cost-input" id="capex_camera"></div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-amber-600 border-b pb-2">Mano de Obra y Legal</h4>
                        <div><label class="text-xs font-bold text-gray-500">Cuadrilla Instalación</label><input type="number" class="cost-input" id="capex_crew"></div>
                        <div><label class="text-xs font-bold text-gray-500">Logística/Transporte</label><input type="number" class="cost-input" id="capex_logistics"></div>
                        <div><label class="text-xs font-bold text-gray-500">Transporte Camioneta</label><input type="number" class="cost-input" id="capex_transportation"></div>
                        <div><label class="text-xs font-bold text-gray-500">Negociaciones/Legal</label><input type="number" class="cost-input" id="capex_legal"></div>
                        <div><label class="text-xs font-bold text-gray-500">Negociaciones Extra</label><input type="number" class="cost-input" id="capex_negotiations"></div>
                        <div><label class="text-xs font-bold text-gray-500">Admin QTM</label><input type="number" class="cost-input" id="capex_admin_qtm"></div>
                        <div><label class="text-xs font-bold text-gray-500">Admin Inventario</label><input type="number" class="cost-input" id="capex_inventory"></div>
                        <div><label class="text-xs font-bold text-gray-500">Primera Instalación</label><input type="number" class="cost-input" id="capex_first_install"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-opex" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-xl mb-6 text-gray-800">2. Gastos Operativos (OPEX Mensual)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-green-600 border-b pb-2">Suministros y Rentas</h4>
                        <div><label class="text-xs font-bold text-gray-500">Pago Luz</label><input type="number" class="cost-input" id="opex_light"></div>
                        <div><label class="text-xs font-bold text-gray-500">Internet (Total)</label><input type="number" class="cost-input" id="opex_internet"></div>
                        <div><label class="text-xs font-bold text-gray-500">Internet SIM</label><input type="number" class="cost-input" id="opex_internet_sim"></div>
                        <div><label class="text-xs font-bold text-gray-500">Internet Cable</label><input type="number" class="cost-input" id="opex_internet_cable"></div>
                        <div><label class="text-xs font-bold text-gray-500">Renta Espacio</label><input type="number" class="cost-input" id="opex_rent"></div>
                        <div><label class="text-xs font-bold text-gray-500">Uso de Suelo</label><input type="number" class="cost-input" id="opex_soil_use"></div>
                        <div><label class="text-xs font-bold text-gray-500">Impuestos</label><input type="number" class="cost-input" id="opex_taxes"></div>
                        <div><label class="text-xs font-bold text-gray-500">Seguros</label><input type="number" class="cost-input" id="opex_insurance"></div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-indigo-600 border-b pb-2">Software y Licencias</h4>
                        <div><label class="text-xs font-bold text-gray-500">Licencia Anual (Broadsign/TV)</label><input type="number" class="cost-input" id="opex_license_annual"><p class="text-[10px] text-gray-400">Se prorratea /12 auto.</p></div>
                        <div><label class="text-xs font-bold text-gray-500">Programación Pauta</label><input type="number" class="cost-input" id="opex_content_scheduling"></div>
                        <div><label class="text-xs font-bold text-gray-500">Costo SRD</label><input type="number" class="cost-input" id="opex_srd"></div>
                        
                        <h4 class="font-bold text-sm text-green-700 border-b pb-2 mt-6">Ingresos (Ventas)</h4>
                        <div><label class="text-xs font-bold text-gray-500">Venta Publicidad Mensual</label><input type="number" class="cost-input bg-green-50 border-green-200" id="revenue_monthly"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-manto" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-xl mb-6 text-gray-800">3. Mantenimiento</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-blue-600 border-b pb-2">Preventivo (Programado)</h4>
                        <div><label class="text-xs font-bold text-gray-500">Costo Bimestral</label><input type="number" class="cost-input" id="maint_prev_bimonthly"></div>
                        <div><label class="text-xs font-bold text-gray-500">Insumos Limpieza</label><input type="number" class="cost-input" id="maint_cleaning_supplies"></div>
                        <div><label class="text-xs font-bold text-gray-500">Gasolina/Transporte</label><input type="number" class="cost-input" id="maint_gas"></div>
                        <div class="bg-gray-50 p-2 rounded border border-gray-200">
                            <label class="text-xs font-bold text-gray-700">Tamaño Cuadrilla (Entero)</label>
                            <input type="number" step="1" class="cost-input" id="maint_crew_size" placeholder="Ej: 3">
                        </div>
                        <div class="bg-gray-50 p-2 rounded border border-gray-200">
                            <label class="text-xs font-bold text-gray-700">Conteo Visitas (Entero)</label>
                            <input type="number" step="1" class="cost-input" id="maint_visit_count">
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-red-600 border-b pb-2">Correctivo (No Planeado)</h4>
                        <div><label class="text-xs font-bold text-gray-500">Costo Cuadrilla Extra</label><input type="number" class="cost-input" id="maint_corr_labor"></div>
                        <div><label class="text-xs font-bold text-gray-500">Refacciones</label><input type="number" class="cost-input" id="maint_corr_parts"></div>
                        <div><label class="text-xs font-bold text-gray-500">Gasolina Extra</label><input type="number" class="cost-input" id="maint_corr_gas"></div>
                        <div class="bg-red-50 p-2 rounded border border-red-100">
                            <label class="text-xs font-bold text-red-700">Conteo Incidencias (Entero)</label>
                            <input type="number" step="1" class="cost-input" id="maint_corr_visit_count">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-ciclo" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 max-w-3xl mx-auto">
                <h3 class="font-bold text-xl mb-6 text-gray-800">4. Ciclo de Vida y Contingencias</h3>
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">Fecha Instalación</label><input type="date" class="cost-input" id="life_installation_date"></div>
                        <div><label class="text-xs font-bold text-gray-500">Implementaciones Especiales</label><input type="text" class="cost-input" id="life_special" placeholder="Ej: Sensores"></div>
                    </div>
                    <div class="border-t pt-4">
                        <h4 class="font-bold text-sm text-gray-700 mb-2">Retiro / Reubicación</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500">Fecha Retiro</label><input type="date" class="cost-input" id="life_retirement_date"></div>
                            <div><label class="text-xs font-bold text-gray-500">Costo Maniobra</label><input type="number" class="cost-input" id="life_retirement"></div>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <h4 class="font-bold text-sm text-gray-700 mb-2">Renovación Tecnológica</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500">Fecha Renovación</label><input type="date" class="cost-input" id="life_renewal_date"></div>
                            <div><label class="text-xs font-bold text-gray-500">Costo Renovación</label><input type="number" class="cost-input" id="life_renewal"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="bg-white p-6 rounded-xl flex flex-col items-center shadow-2xl">
            <div class="spinner mb-4"></div>
            <p class="font-bold text-gray-700">Procesando...</p>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        const deviceId = "{{ device_id }}";
        let pendingChanges = new Set();
        let chartInstance = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            loadDeviceData();
            setupInputListeners();
            
            // Cerrar con tecla ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') checkExit();
                if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveAll(); }
            });
        });

        // Configuración de inputs
        function setupInputListeners() {
            document.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', (e) => {
                    pendingChanges.add(e.target.id);
                    document.getElementById('unsaved-badge').classList.remove('hidden');
                });
            });
        }

        // Lógica de Salida (Botón Cerrar / ESC)
        function checkExit() {
            if (pendingChanges.size > 0) {
                if(confirm("Tienes cambios sin guardar. ¿Estás seguro de que quieres salir?")) {
                    goBack();
                }
            } else {
                goBack();
            }
        }

        function goBack() {
            // Intentar cerrar ventana o volver al dashboard general
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/techview/overview'; // Fallback seguro
            }
        }

        // --- FUNCIÓN HELPER PARA EVITAR EL ERROR "CANNOT SET PROPERTIES OF NULL" ---
        const safeSet = (id, val) => {
            const el = document.getElementById(id);
            if (el) {
                el.innerText = val;
            } else {
                // Opcional: console.warn(`Elemento no encontrado: ${id}`);
            }
        };

        // Carga de datos (Robustecida)
        async function loadDeviceData() {
            showLoading();
            try {
                const res = await fetch(`/techview/api/device/${encodeURIComponent(deviceId)}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // Llenar todos los inputs automáticamente
                if (data.financials) {
                    Object.keys(data.financials).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = data.financials[key];
                    });
                }

                // Llenar Dashboard (Análisis Ejecutivo) CON VERIFICACIÓN DE EXISTENCIA
                if (data.totals) {
                    safeSet('kpi-capex', formatCurrency(data.totals.capex));
                    safeSet('dash-capex', formatCurrency(data.totals.capex));
                    safeSet('kpi-opex', formatCurrency(data.totals.opex_monthly));
                    safeSet('kpi-revenue', formatCurrency(data.totals.revenue_monthly));
                    safeSet('dash-revenue', formatCurrency(data.totals.revenue_monthly));
                    safeSet('kpi-margin', formatCurrency(data.totals.margin_monthly));
                    safeSet('dash-margin', formatCurrency(data.totals.margin_monthly));
                    safeSet('dash-roi', `${data.totals.roi_months} meses`);
                    safeSet('dash-monthly-cost', formatCurrency(data.totals.opex_monthly));
                }

                if (data.advanced_kpis) {
                    safeSet('tech-score-val', `${data.advanced_kpis.technical_score}/100`);
                    
                    const elBar = document.getElementById('tech-score-bar');
                    if(elBar) elBar.style.width = `${data.advanced_kpis.technical_score}%`;
                    
                    safeSet('dash-reincidence', `${data.advanced_kpis.reincidence_rate}%`);
                    
                    // Telemetría / Recomendación
                    generateTelemetry(data.totals, data.advanced_kpis);
                }

                if (data.eco) {
                    safeSet('eco-co2', data.eco.co2_tons);
                    safeSet('eco-trees', data.eco.trees);
                }

                // Renderizar Gráfica
                initMonthlyChart(data.financials);

            } catch (e) {
                console.error(e);
                showToast('Error cargando datos: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Telemetría Simple
        function generateTelemetry(totals, advanced) {
            const margin = totals?.margin_monthly || 0;
            const roi = totals?.roi_months || 99;
            const score = advanced?.technical_score || 0;
            let status = "Estable";
            let rec = "Mantener operación actual.";
            let color = "text-text-muted";

            if (margin < 0) {
                status = "Déficit";
                rec = "URGENTE: Revisar costos operativos, el sitio pierde dinero.";
                color = "text-red-500";
            } else if (roi > 36) {
                status = "ROI Lento";
                rec = "Considerar estrategias para aumentar ingresos, retorno lento.";
                color = "text-orange-500";
            } else if (score < 60) {
                status = "Riesgo Técnico";
                rec = "Planear mantenimiento correctivo o renovación tecnológica.";
                color = "text-orange-500";
            } else if (margin > 1000 && roi < 24) {
                status = "Alta Rentabilidad";
                rec = "Sitio Estrella. Modelo replicable para expansión.";
                color = "text-primary";
            }

            const elStatus = document.getElementById('financial-status-text');
            if (elStatus) {
                elStatus.innerText = status;
                elStatus.className = `font-bold ${color}`;
            }
            
            const elRec = document.getElementById('ai-recommendation');
            if (elRec) elRec.innerText = rec;
        }

        // Gráfica de Costo Mensual
        function initMonthlyChart(financials) {
            const ctx = document.getElementById('monthlyCostChart');
            if (!ctx) return;

            // Calcular costo mensual base (aprox)
            let opex = 0;
            if (financials) {
                // Sumar campos OPEX manual para gráfica rápida
                const keys = Object.keys(financials);
                keys.forEach(k => {
                    if (k.startsWith('opex_') && !k.includes('annual')) opex += parseFloat(financials[k] || 0);
                    if (k === 'opex_license_annual') opex += parseFloat(financials[k] || 0) / 12;
                });
            }
            
            // Generar datos simulados con ligera variación para proyección visual
            const dataPoints = Array.from({length: 6}, (_, i) => opex * (1 + (Math.random() * 0.05 - 0.025)));

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mes 1', 'Mes 2', 'Mes 3', 'Mes 4', 'Mes 5', 'Actual'],
                    datasets: [{
                        label: 'Costo Operativo',
                        data: dataPoints,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: 0 }
                    }
                }
            });
        }

        // Guardado con conversión de tipos
        async function saveAll() {
            if (pendingChanges.size === 0) {
                showToast('No hay cambios pendientes', 'info');
                return;
            }
            showLoading();
            try {
                const payload = { device_id: deviceId, cost_type: 'techview', category: 'comprehensive' };
                // Campos ENTEROS específicos
                const integerFields = ['maint_crew_size', 'maint_visit_count', 'maint_corr_visit_count'];

                document.querySelectorAll('input').forEach(input => {
                    if (input.value !== '') {
                        if (input.type === 'number') {
                            // CORRECCIÓN CLAVE: parseInt vs parseFloat
                            payload[input.id] = integerFields.includes(input.id) ? parseInt(input.value, 10) : parseFloat(input.value);
                        } else {
                            payload[input.id] = input.value;
                        }
                    }
                });

                const res = await fetch('/techview/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const json = await res.json();
                if (res.ok) {
                    showToast('Guardado exitosamente', 'success');
                    pendingChanges.clear();
                    document.getElementById('unsaved-badge').classList.add('hidden');
                    loadDeviceData();
                } else {
                    throw new Error(json.error);
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Utilidades UI
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
        function formatCurrency(val) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
        }
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function showToast(msg, type) {
            const el = document.getElementById('toast-container');
            const t = document.createElement('div');
            const colors = { error: 'bg-red-500', success: 'bg-green-500', info: 'bg-blue-500' };
            t.className = `toast ${colors[type] || colors.info}`;
            t.innerText = msg;
            el.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
