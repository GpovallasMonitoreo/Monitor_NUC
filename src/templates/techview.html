<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechView - Gesti√≥n Financiera</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        /* Estilos personalizados */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .nav-tab.active { 
            border-bottom: 3px solid #f97316; 
            color: #f97316; 
            font-weight: 600;
        }
        .cost-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .cost-input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        .cost-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .debug-panel {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div>
                    <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="material-icons-outlined text-orange-500">analytics</span>
                        TechView - Gesti√≥n Financiera
                    </h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-sm text-gray-600">Dispositivo:</span>
                        <code id="device-id-display" class="text-sm bg-gray-100 px-2 py-1 rounded">{{ device_id }}</code>
                        <span id="device-status" class="text-xs px-2 py-1 rounded-full bg-gray-100"></span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.open('/techview/diagnostic', '_blank')" 
                            class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center gap-1">
                        <span class="material-icons-outlined text-sm">bug_report</span>
                        Diagn√≥stico
                    </button>
                    <button onclick="testConnection()" 
                            class="px-3 py-2 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg flex items-center gap-1">
                        <span class="material-icons-outlined text-sm">wifi</span>
                        Test Conexi√≥n
                    </button>
                    <button onclick="saveAll()" id="save-btn" 
                            class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg flex items-center gap-2 transition-colors">
                        <span class="material-icons-outlined text-sm">save</span>
                        <span>Guardar Todo</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <div class="bg-white border-b shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto">
                <button onclick="switchTab('resumen')" class="nav-tab active px-4 py-3 whitespace-nowrap flex items-center gap-2">
                    <span class="material-icons-outlined text-sm">dashboard</span>
                    Resumen
                </button>
                <button onclick="switchTab('infra')" class="nav-tab px-4 py-3 whitespace-nowrap flex items-center gap-2">
                    <span class="material-icons-outlined text-sm">construction</span>
                    Infraestructura
                </button>
                <button onclick="switchTab('electronica')" class="nav-tab px-4 py-3 whitespace-nowrap flex items-center gap-2">
                    <span class="material-icons-outlined text-sm">memory</span>
                    Electr√≥nica
                </button>
                <button onclick="switchTab('opex')" class="nav-tab px-4 py-3 whitespace-nowrap flex items-center gap-2">
                    <span class="material-icons-outlined text-sm">receipt</span>
                    OPEX
                </button>
                <button onclick="switchTab('manto')" class="nav-tab px-4 py-3 whitespace-nowrap flex items-center gap-2">
                    <span class="material-icons-outlined text-sm">handyman</span>
                    Mantenimiento
                </button>
                <button onclick="switchTab('debug')" class="nav-tab px-4 py-3 whitespace-nowrap flex items-center gap-2">
                    <span class="material-icons-outlined text-sm">code</span>
                    Debug
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Tab: Resumen -->
        <div id="tab-resumen" class="tab-content active">
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-medium text-gray-500">CAPEX TOTAL</p>
                        <span class="material-icons-outlined text-gray-400 text-lg">business</span>
                    </div>
                    <p class="text-3xl font-bold text-gray-800" id="kpi-capex">$0</p>
                    <p class="text-xs text-gray-400 mt-2">Inversi√≥n inicial en infraestructura</p>
                </div>
                
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-medium text-gray-500">OPEX MENSUAL</p>
                        <span class="material-icons-outlined text-orange-400 text-lg">trending_up</span>
                    </div>
                    <p class="text-3xl font-bold text-orange-500" id="kpi-opex">$0</p>
                    <p class="text-xs text-gray-400 mt-2">Gastos operativos mensuales</p>
                </div>
                
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-medium text-gray-500">VENTAS MENSUALES</p>
                        <span class="material-icons-outlined text-emerald-400 text-lg">attach_money</span>
                    </div>
                    <p class="text-3xl font-bold text-emerald-500" id="kpi-sales">$0</p>
                    <p class="text-xs text-gray-400 mt-2">Ingresos mensuales estimados</p>
                </div>
            </div>

            <!-- Gr√°ficas y m√©tricas -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="material-icons-outlined text-blue-500">bar_chart</span>
                        Rendimiento Financiero
                    </h3>
                    <div class="h-64">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <h4 class="font-bold text-gray-700 mb-3">üìà ROI y Margen</h4>
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-500">Margen Mensual</p>
                                <p class="text-2xl font-bold text-blue-600" id="kpi-margin">$0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">ROI (Meses)</p>
                                <p class="text-2xl font-bold text-purple-600" id="kpi-roi">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <h4 class="font-bold text-gray-700 mb-3">üå± Impacto Ecol√≥gico</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Ahorro Energ√©tico</span>
                                <span class="font-medium text-emerald-600" id="eco-kwh">0 kWh</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Reducci√≥n CO‚ÇÇ</span>
                                <span class="font-medium text-emerald-600" id="eco-co2">0 ton</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Equivalente √Årboles</span>
                                <span class="font-medium text-emerald-600" id="eco-trees">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del dispositivo -->
            <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <span class="material-icons-outlined text-gray-500">info</span>
                    Informaci√≥n del Dispositivo
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">Estado</p>
                        <p class="font-medium" id="device-info-status">Cargando...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Ubicaci√≥n</p>
                        <p class="font-medium" id="device-info-location">Cargando...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">√öltima actualizaci√≥n</p>
                        <p class="font-medium" id="device-info-updated">Cargando...</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Tickets activos</p>
                        <p class="font-medium" id="device-info-tickets">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Infraestructura -->
        <div id="tab-infra" class="tab-content">
            <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm mb-4">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-3 flex items-center gap-2">
                    <span class="material-icons-outlined text-orange-500">apartment</span>
                    Estructura F√≠sica
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pantalla LED ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_screen" placeholder="0.00">
                        <p class="text-xs text-gray-500 mt-1">Costo de la pantalla LED principal</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Obra Civil ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_civil" placeholder="0.00">
                        <p class="text-xs text-gray-500 mt-1">Preparaci√≥n del terreno y cimentaci√≥n</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estructura Met√°lica ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_structure" placeholder="0.00">
                        <p class="text-xs text-gray-500 mt-1">Estructura de soporte y montaje</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instalaci√≥n El√©ctrica ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_electrical" placeholder="0.00">
                        <p class="text-xs text-gray-500 mt-1">Cableado, protecciones y conexiones</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Electr√≥nica -->
        <div id="tab-electronica" class="tab-content">
            <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-3 flex items-center gap-2">
                    <span class="material-icons-outlined text-blue-500">devices</span>
                    Componentes Electr√≥nicos
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NUC ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_nuc" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">UPS ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_ups" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sending Card ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_sending" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">M√≥dem WiFi ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_modem_wifi" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">M√≥dem SIM ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_modem_sim" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">C√°mara ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_camera" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Procesador ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_processor" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">HDMI ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_hdmi" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Teltonika ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="capex_teltonika" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: OPEX -->
        <div id="tab-opex" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-3 flex items-center gap-2">
                        <span class="material-icons-outlined text-red-500">paid</span>
                        Gastos Operativos
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Luz ($/mes)</label>
                            <input type="number" step="0.01" class="cost-input" id="opex_light" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Internet ($/mes)</label>
                            <input type="number" step="0.01" class="cost-input" id="opex_internet" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Renta ($/mes)</label>
                            <input type="number" step="0.01" class="cost-input" id="opex_rent" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Uso de Suelo ($/mes)</label>
                            <input type="number" step="0.01" class="cost-input" id="opex_soil_use" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Licencia Anual ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="opex_license_annual" placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Se divide autom√°ticamente entre 12 meses</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-emerald-700 mb-4 border-b pb-3 flex items-center gap-2">
                        <span class="material-icons-outlined text-emerald-500">trending_up</span>
                        Ingresos
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-emerald-700 mb-2">VENTAS MENSUALES ($)</label>
                            <input type="number" step="0.01" class="cost-input border-emerald-300 bg-emerald-50" id="revenue_monthly" placeholder="0.00">
                            <p class="text-xs text-emerald-600 mt-1">Ingresos estimados mensuales por publicidad</p>
                        </div>
                        
                        <div class="pt-4 border-t">
                            <h4 class="font-medium text-gray-700 mb-3">Otros Gastos</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contenido y Programaci√≥n ($/mes)</label>
                                    <input type="number" step="0.01" class="cost-input" id="opex_content_scheduling" placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">SRD ($/mes)</label>
                                    <input type="number" step="0.01" class="cost-input" id="opex_srd" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Mantenimiento -->
        <div id="tab-manto" class="tab-content">
            <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-3 flex items-center gap-2">
                    <span class="material-icons-outlined text-amber-500">build</span>
                    Mantenimiento y Vida √ötil
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Preventivo Bimestral ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="maint_prev_bimonthly" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Insumos Limpieza ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="maint_cleaning_supplies" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gasolina ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="maint_gas" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Partes Correctivas ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="maint_corr_parts" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Retiro / Vida √ötil ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="life_retirement" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Renovaci√≥n ($)</label>
                            <input type="number" step="0.01" class="cost-input" id="life_renewal" placeholder="0.00">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Debug -->
        <div id="tab-debug" class="tab-content">
            <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <span class="material-icons-outlined text-gray-500">terminal</span>
                    Debug & Logs del Sistema
                </h3>
                
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="testConnection()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm flex items-center gap-1">
                            <span class="material-icons-outlined text-sm">wifi</span>
                            Test Conexi√≥n
                        </button>
                        <button onclick="loadData()" class="px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-sm flex items-center gap-1">
                            <span class="material-icons-outlined text-sm">refresh</span>
                            Recargar Datos
                        </button>
                        <button onclick="clearLogs()" class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm flex items-center gap-1">
                            <span class="material-icons-outlined text-sm">delete</span>
                            Limpiar Logs
                        </button>
                        <button onclick="exportData()" class="px-3 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded text-sm flex items-center gap-1">
                            <span class="material-icons-outlined text-sm">download</span>
                            Exportar JSON
                        </button>
                    </div>
                    
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b">
                            <h4 class="font-medium text-sm">üìã Logs de Consola</h4>
                        </div>
                        <div id="console-logs" class="debug-panel max-h-60 overflow-y-auto p-3 bg-gray-900 text-gray-100">
                            <!-- Logs aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                    
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b">
                            <h4 class="font-medium text-sm">üì° √öltima Respuesta API</h4>
                        </div>
                        <pre id="api-response" class="debug-panel max-h-60 overflow-y-auto p-3 bg-gray-50">
// Esperando datos...
                        </pre>
                    </div>
                    
                    <div class="border rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b">
                            <h4 class="font-medium text-sm">‚öôÔ∏è Estado del Sistema</h4>
                        </div>
                        <div id="system-status" class="p-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <p class="text-sm text-gray-500">Service TechView</p>
                                    <p id="techview-status" class="font-medium">Comprobando...</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">√öltima actualizaci√≥n</p>
                                    <p id="last-update" class="font-medium">-</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Device ID</p>
                                    <p class="font-medium font-mono">{{ device_id }}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">URLs Disponibles</p>
                                    <p class="text-xs">
                                        <code>/techview/api/test</code><br>
                                        <code>/techview/api/device/...</code>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-md"></div>

    <script>
        // Variables globales
        const deviceId = "{{ device_id }}";
        let currentData = null;
        let charts = {};
        
        // Interceptar console.log para mostrar en pantalla
        (function() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                addToLog('üìò INFO', args, 'text-blue-600');
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                addToLog('‚ùå ERROR', args, 'text-red-600');
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                addToLog('‚ö†Ô∏è WARN', args, 'text-yellow-600');
            };
            
            function addToLog(level, args, colorClass) {
                const logsDiv = document.getElementById('console-logs');
                if (logsDiv) {
                    const message = args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                    ).join(' ');
                    
                    const logEntry = document.createElement('div');
                    logEntry.className = `mb-2 pb-2 border-b border-gray-800 ${colorClass}`;
                    logEntry.innerHTML = `<span class="font-mono text-xs">${level}:</span> <span class="text-gray-300">${message}</span>`;
                    
                    logsDiv.appendChild(logEntry);
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                }
            }
        })();
        
        // Funciones de UI
        function switchTab(tabId) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.nav-tab').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            const tabElement = document.getElementById(`tab-${tabId}`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Activar bot√≥n
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const config = {
                success: { bg: 'bg-emerald-500', icon: '‚úÖ' },
                error: { bg: 'bg-red-500', icon: '‚ùå' },
                warning: { bg: 'bg-yellow-500', icon: '‚ö†Ô∏è' },
                info: { bg: 'bg-blue-500', icon: '‚ÑπÔ∏è' }
            };
            
            const { bg, icon } = config[type] || config.info;
            
            toast.className = `${bg} text-white px-4 py-3 rounded-lg shadow-lg animate-fade-in`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">${icon}</span>
                    <span class="text-sm">${message}</span>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto-remover despu√©s de 4 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        function setLoading(loading) {
            const btn = document.getElementById('save-btn');
            if (!btn) return;
            
            if (loading) {
                btn.innerHTML = '<span class="loading-spinner"></span> Guardando...';
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.innerHTML = '<span class="material-icons-outlined text-sm">save</span> Guardar Todo';
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function updateSystemStatus(connected) {
            const statusElement = document.getElementById('techview-status');
            if (statusElement) {
                statusElement.innerHTML = connected ? 
                    '<span class="text-emerald-600">‚úÖ CONECTADO</span>' : 
                    '<span class="text-red-600">‚ùå DESCONECTADO</span>';
            }
            
            document.getElementById('last-update').textContent = 
                new Date().toLocaleTimeString();
        }
        
        // Funciones de API
        async function testConnection() {
            try {
                console.log('üîç Probando conexi√≥n con TechView API...');
                showToast('Probando conexi√≥n...', 'info');
                
                const response = await fetch('/techview/api/test');
                const data = await response.json();
                
                console.log('Test conexi√≥n:', data);
                
                // Mostrar respuesta en debug
                document.getElementById('api-response').textContent = 
                    JSON.stringify(data, null, 2);
                
                updateSystemStatus(response.ok);
                
                if (response.ok) {
                    showToast('‚úÖ Conexi√≥n exitosa con TechView', 'success');
                    return data;
                } else {
                    showToast('‚ùå Error de conexi√≥n', 'error');
                    return null;
                }
            } catch (error) {
                console.error('Error testConnection:', error);
                showToast('‚ùå Error de red: ' + error.message, 'error');
                
                document.getElementById('api-response').textContent = 
                    `Error: ${error.message}\n\n${error.stack || ''}`;
                
                updateSystemStatus(false);
                return null;
            }
        }
        
        async function loadData() {
            try {
                console.log(`üì• Cargando datos para dispositivo: ${deviceId}`);
                showToast('Cargando datos...', 'info');
                
                const response = await fetch(`/techview/api/device/${encodeURIComponent(deviceId)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
                currentData = await response.json();
                console.log('üìä Datos recibidos:', currentData);
                
                // Mostrar respuesta en debug
                document.getElementById('api-response').textContent = 
                    JSON.stringify(currentData, null, 2);
                
                // Actualizar informaci√≥n del dispositivo
                if (currentData.device) {
                    document.getElementById('device-info-status').textContent = 
                        currentData.device.status || 'Desconocido';
                    document.getElementById('device-info-location').textContent = 
                        currentData.device.location || 'Sin ubicaci√≥n';
                    document.getElementById('device-info-updated').textContent = 
                        currentData.device.updated_at ? 
                            new Date(currentData.device.updated_at).toLocaleString() : 'Nunca';
                    
                    // Actualizar badge de estado
                    const statusElement = document.getElementById('device-status');
                    if (statusElement) {
                        const status = currentData.device.status || 'unknown';
                        statusElement.textContent = status;
                        statusElement.className = `text-xs px-2 py-1 rounded-full ${
                            status === 'online' ? 'bg-green-100 text-green-800' :
                            status === 'offline' ? 'bg-red-100 text-red-800' :
                            'bg-gray-100 text-gray-800'
                        }`;
                    }
                }
                
                // Llenar inputs con datos financieros
                if (currentData.financials) {
                    Object.keys(currentData.financials).forEach(key => {
                        const input = document.getElementById(key);
                        if (input && currentData.financials[key] !== null && currentData.financials[key] !== undefined) {
                            input.value = currentData.financials[key];
                        }
                    });
                }
                
                // Actualizar KPIs
                if (currentData.totals) {
                    const formatCurrency = (value) => {
                        return new Intl.NumberFormat('es-MX', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }).format(value || 0);
                    };
                    
                    document.getElementById('kpi-capex').textContent = formatCurrency(currentData.totals.capex);
                    document.getElementById('kpi-opex').textContent = formatCurrency(currentData.totals.opex);
                    document.getElementById('kpi-sales').textContent = formatCurrency(currentData.totals.revenue);
                    document.getElementById('kpi-margin').textContent = formatCurrency(currentData.totals.margin);
                    document.getElementById('kpi-roi').textContent = 
                        currentData.totals.roi ? `${currentData.totals.roi.toFixed(1)} meses` : 'N/A';
                }
                
                // Actualizar impacto ecol√≥gico
                if (currentData.eco) {
                    document.getElementById('eco-kwh').textContent = 
                        `${currentData.eco.kwh_saved?.toLocaleString() || 0} kWh`;
                    document.getElementById('eco-co2').textContent = 
                        `${currentData.eco.co2_tons || 0} ton`;
                    document.getElementById('eco-trees').textContent = 
                        currentData.eco.trees || 0;
                }
                
                // Actualizar tickets
                if (currentData.history && currentData.history.tickets) {
                    document.getElementById('device-info-tickets').textContent = 
                        currentData.history.tickets.length;
                }
                
                // Renderizar gr√°fica
                renderChart();
                
                showToast('‚úÖ Datos cargados correctamente', 'success');
                updateSystemStatus(true);
                
                return currentData;
                
            } catch (error) {
                console.error('Error loadData:', error);
                showToast('‚ùå Error: ' + error.message, 'error');
                
                // Mostrar error en debug
                document.getElementById('api-response').textContent = 
                    `Error: ${error.message}\n\n${error.stack || ''}`;
                
                updateSystemStatus(false);
                return null;
            }
        }
        
        function renderChart() {
            const ctx = document.getElementById('performance-chart');
            if (!ctx) return;
            
            // Destruir gr√°fica anterior si existe
            if (charts.performance) {
                charts.performance.destroy();
            }
            
            // Datos para la gr√°fica
            const totals = currentData?.totals || {};
            const data = {
                labels: ['CAPEX', 'OPEX', 'Ingresos', 'Margen'],
                datasets: [{
                    label: 'Valores ($)',
                    data: [
                        totals.capex || 0,
                        totals.opex || 0,
                        totals.revenue || 0,
                        totals.margin || 0
                    ],
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(249, 115, 22, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(139, 92, 246, 0.7)'
                    ],
                    borderColor: [
                        'rgb(59, 130, 246)',
                        'rgb(249, 115, 22)',
                        'rgb(16, 185, 129)',
                        'rgb(139, 92, 246)'
                    ],
                    borderWidth: 1
                }]
            };
            
            charts.performance = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toLocaleString('es-MX', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return `$${value.toLocaleString('es-MX', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    })}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function saveAll() {
            setLoading(true);
            
            try {
                // Construir payload
                const payload = {
                    device_id: deviceId,
                    cost_type: 'techview_management',
                    category: 'comprehensive'
                };
                
                // Recolectar todos los inputs num√©ricos
                const inputs = document.querySelectorAll('.cost-input');
                let hasData = false;
                
                inputs.forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value) && input.id) {
                        payload[input.id] = value;
                        hasData = true;
                    }
                });
                
                if (!hasData) {
                    showToast('‚ö†Ô∏è No hay datos para guardar', 'warning');
                    setLoading(false);
                    return;
                }
                
                console.log('üì§ Enviando datos al servidor:', payload);
                showToast('Guardando datos...', 'info');
                
                const response = await fetch('/techview/api/save', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('üì• Respuesta del servidor:', result);
                
                // Mostrar respuesta en debug
                document.getElementById('api-response').textContent = 
                    JSON.stringify(result, null, 2);
                
                if (response.ok && result.success) {
                    showToast('‚úÖ Datos guardados correctamente', 'success');
                    // Recargar datos despu√©s de guardar
                    setTimeout(loadData, 1000);
                } else {
                    showToast('‚ùå Error: ' + (result.error || 'Error desconocido'), 'error');
                }
                
            } catch (error) {
                console.error('Error saveAll:', error);
                showToast('‚ùå Error de red: ' + error.message, 'error');
                
                document.getElementById('api-response').textContent = 
                    `Error: ${error.message}\n\n${error.stack || ''}`;
                
            } finally {
                setLoading(false);
            }
        }
        
        function clearLogs() {
            document.getElementById('console-logs').innerHTML = '';
            console.log('üóëÔ∏è Logs limpiados');
            showToast('Logs limpiados', 'info');
        }
        
        function exportData() {
            if (!currentData) {
                showToast('No hay datos para exportar', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(currentData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `techview_${deviceId.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('‚úÖ Datos exportados como JSON', 'success');
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ TechView Management inicializado');
            console.log(`üì± Dispositivo: ${deviceId}`);
            console.log(`üåê URL Base: ${window.location.origin}`);
            
            // Cargar datos iniciales
            loadData();
            
            // Test de conexi√≥n autom√°tico despu√©s de 1 segundo
            setTimeout(testConnection, 1000);
            
            // Mostrar notificaci√≥n de bienvenida
            setTimeout(() => {
                showToast('Sistema TechView listo. Datos cargados.', 'info');
            }, 1500);
            
            // Agregar estilos CSS para animaciones
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fade-in {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fade-in {
                    animation: fade-in 0.3s ease-out;
                }
            `;
            document.head.appendChild(style);
        });
        
        // Manejar tecla Enter en inputs
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.classList.contains('cost-input')) {
                e.preventDefault();
                saveAll();
            }
        });
    </script>
</body>
</html>
