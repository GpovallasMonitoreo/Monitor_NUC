<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Argos TechView - Gestión</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: "#F97316", secondary: "#3B82F6" } } }
        };
    </script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .nav-tab.active { border-bottom: 2px solid #F97316; color: #F97316; font-weight: 700; }
        .cost-input { width: 100%; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.875rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h2 class="text-lg font-bold text-slate-900">Gestión: <span class="text-primary">{{ device_id }}</span></h2>
        </div>
        <div class="flex gap-3">
            <a href="/techview/analysis?device_id={{ device_id }}" target="_blank" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-xs flex gap-2 items-center">
                <span class="material-icons-outlined text-sm">analytics</span> Reporte Visual
            </a>
            <button onclick="saveAll()" class="bg-primary hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-bold text-xs flex gap-2 items-center shadow-md">
                <span class="material-icons-outlined text-sm">save</span> Guardar Todo
            </button>
            <a href="/techview" class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-xs">Cerrar</a>
        </div>
    </header>

    <div class="bg-white border-b border-slate-100 px-6 overflow-x-auto">
        <div class="flex gap-6 min-w-max">
            <button onclick="switchTab('resumen')" class="nav-tab active py-3 text-sm">Resumen</button>
            <button onclick="switchTab('infra')" class="nav-tab py-3 text-sm">1. Infraestructura</button>
            <button onclick="switchTab('electro')" class="nav-tab py-3 text-sm">2. Electrónica</button>
            <button onclick="switchTab('legal')" class="nav-tab py-3 text-sm">3. Legal/MO</button>
            <button onclick="switchTab('opex')" class="nav-tab py-3 text-sm">4. OPEX</button>
            <button onclick="switchTab('manto')" class="nav-tab py-3 text-sm">5. Mantenimiento</button>
            <button onclick="switchTab('ciclo')" class="nav-tab py-3 text-sm">6. Ciclo de Vida</button>
        </div>
    </div>

    <main class="p-6 max-w-[1920px] mx-auto w-full">

        <div id="tab-resumen" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">CAPEX Total</p><h3 class="text-3xl font-black text-slate-900" id="kpi-capex">$0</h3></div>
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">OPEX Mensual</p><h3 class="text-3xl font-black text-orange-600" id="kpi-opex">$0</h3></div>
                <div class="bg-white p-6 rounded-xl border shadow-sm"><p class="text-xs text-slate-400 font-bold">Ventas Mensual</p><h3 class="text-3xl font-black text-emerald-600" id="kpi-sales">$0</h3></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl border shadow-sm h-64"><canvas id="barChart"></canvas></div>
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-xl border shadow-sm h-32 flex"><canvas id="pieCapex"></canvas></div>
                    <div class="bg-white p-4 rounded-xl border shadow-sm h-32 flex"><canvas id="pieOpex"></canvas></div>
                </div>
            </div>
        </div>

        <div id="tab-infra" class="tab-content space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-primary">Activos Fijos</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Pantalla LED ($)<input type="number" class="cost-input" id="capex_screen"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Obra Civil ($)<input type="number" class="cost-input" id="capex_civil"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Estructura ($)<input type="number" class="cost-input" id="capex_structure"></label>
                </div>
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-primary">Instalaciones</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Instalación Eléctrica ($)<input type="number" class="cost-input" id="capex_electrical"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Medidor CFE ($)<input type="number" class="cost-input" id="capex_meter"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Instalación Datos ($)<input type="number" class="cost-input" id="capex_data_install"></label>
                </div>
            </div>
        </div>

        <div id="tab-electro" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-xl border shadow-sm">
                <h4 class="font-bold border-b pb-2 mb-4 text-primary">Componentes Electrónicos</h4>
                <div class="grid grid-cols-3 gap-6">
                    <div>
                        <label class="block mb-2 text-xs font-bold text-slate-500">NUC (Player)<input type="number" class="cost-input" id="capex_nuc"></label>
                        <label class="block mb-2 text-xs font-bold text-slate-500">UPS<input type="number" class="cost-input" id="capex_ups"></label>
                        <label class="block mb-2 text-xs font-bold text-slate-500">Sending Card<input type="number" class="cost-input" id="capex_sending"></label>
                    </div>
                    <div>
                        <label class="block mb-2 text-xs font-bold text-slate-500">Procesador Video<input type="number" class="cost-input" id="capex_processor"></label>
                        <label class="block mb-2 text-xs font-bold text-slate-500">Módem WiFi<input type="number" class="cost-input" id="capex_modem_wifi"></label>
                        <label class="block mb-2 text-xs font-bold text-slate-500">Módem SIM<input type="number" class="cost-input" id="capex_modem_sim"></label>
                    </div>
                    <div>
                        <label class="block mb-2 text-xs font-bold text-slate-500">Teltonika<input type="number" class="cost-input" id="capex_teltonika"></label>
                        <label class="block mb-2 text-xs font-bold text-slate-500">HDMI / Cables<input type="number" class="cost-input" id="capex_hdmi"></label>
                        <label class="block mb-2 text-xs font-bold text-slate-500">Cámara<input type="number" class="cost-input" id="capex_camera"></label>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-legal" class="tab-content space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4">Mano de Obra</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Cuadrilla (6 técnicos)<input type="number" class="cost-input" id="capex_crew"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Logística/Gasolina<input type="number" class="cost-input" id="capex_logistics"></label>
                </div>
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4">Legal</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Gestoría / Permisos<input type="number" class="cost-input" id="capex_legal"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Primera Instalación<input type="number" class="cost-input" id="capex_first_install"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Alta QTM<input type="number" class="cost-input" id="capex_admin_qtm"></label>
                </div>
            </div>
        </div>

        <div id="tab-opex" class="tab-content space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-orange-600">Suministros (Mensual)</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Luz CFE<input type="number" class="cost-input" id="opex_light"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Internet<input type="number" class="cost-input" id="opex_internet"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Renta Sitio<input type="number" class="cost-input" id="opex_rent"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Uso Suelo<input type="number" class="cost-input" id="opex_soil_use"></label>
                </div>
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-orange-600">Software & Ingresos</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Licencias (Anual)<input type="number" class="cost-input" id="opex_license_annual"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Pauta (Mensual)<input type="number" class="cost-input" id="opex_content_scheduling"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">SRD<input type="number" class="cost-input" id="opex_srd"></label>
                    <div class="mt-4 p-4 bg-emerald-50 rounded border border-emerald-100">
                        <label class="block text-xs font-bold text-emerald-800">VENTA PUBLICIDAD (MES)<input type="number" class="cost-input font-bold" id="revenue_monthly"></label>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-manto" class="tab-content space-y-6">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4">Preventivo</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Costo Bimestral<input type="number" class="cost-input" id="maint_prev_bimonthly"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Insumos Limpieza<input type="number" class="cost-input" id="maint_cleaning_supplies"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Gasolina<input type="number" class="cost-input" id="maint_gas"></label>
                </div>
                <div class="bg-white p-6 rounded-xl border shadow-sm">
                    <h4 class="font-bold border-b pb-2 mb-4 text-red-600">Correctivo (Estimado)</h4>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Refacciones<input type="number" class="cost-input" id="maint_corr_parts"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Mano de Obra Extra<input type="number" class="cost-input" id="maint_corr_labor"></label>
                </div>
            </div>
        </div>

        <div id="tab-ciclo" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-xl border shadow-sm">
                <h4 class="font-bold border-b pb-2 mb-4">Costos Extraordinarios</h4>
                <div class="grid grid-cols-3 gap-6">
                    <label class="block mb-2 text-xs font-bold text-slate-500">Retiro / Reubicación<input type="number" class="cost-input" id="life_retirement"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Renovación Tecnológica<input type="number" class="cost-input" id="life_renewal"></label>
                    <label class="block mb-2 text-xs font-bold text-slate-500">Implementaciones Especiales<input type="number" class="cost-input" id="life_special"></label>
                </div>
            </div>
        </div>

    </main>

    <script>
        const deviceId = "{{ device_id }}";
        let charts = {};

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadData() {
            try {
                const res = await fetch(`/api/techview/device/${encodeURIComponent(deviceId)}`);
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();

                // Llenar inputs por ID (Mapeo directo a columnas DB)
                if(data.financials) {
                    Object.keys(data.financials).forEach(key => {
                        const input = document.getElementById(key);
                        if(input) input.value = data.financials[key];
                    });
                }

                // KPIs
                const fmt = n => `$${n.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                document.getElementById('kpi-capex').innerText = fmt(data.totals.capex);
                document.getElementById('kpi-opex').innerText = fmt(data.totals.opex);
                document.getElementById('kpi-sales').innerText = fmt(data.totals.revenue);
                
                // Charts
                renderCharts(data.totals);

            } catch(e) { console.error("Error loading data:", e); }
        }

        function renderCharts(totals) {
            if(charts.bar) charts.bar.destroy();
            
            charts.bar = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: ['Mensual'],
                    datasets: [
                        { label: 'Ingresos', data: [totals.revenue], backgroundColor: '#10B981' },
                        { label: 'Gastos', data: [totals.opex], backgroundColor: '#F97316' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
            // (Agregar lógica para los pasteles aquí si se requiere desglose porcentual)
        }

        async function saveAll() {
            // Construir payload con todos los inputs
            const payload = { device_id: deviceId };
            document.querySelectorAll('.cost-input').forEach(input => {
                payload[input.id] = parseFloat(input.value) || 0;
            });

            try {
                const res = await fetch('/api/techview/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if(res.ok) {
                    alert("Datos guardados y actualizados.");
                    loadData();
                } else {
                    alert("Error al guardar.");
                }
            } catch(e) { console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
