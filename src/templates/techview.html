<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechView - Gesti√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .nav-tab.active { border-bottom: 2px solid #F97316; color: #F97316; font-weight: 600; }
        .cost-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; }
        .cost-input:focus { outline: none; border-color: #F97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .debug-panel { font-family: monospace; font-size: 12px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-lg font-bold text-gray-800">üíº Gesti√≥n Financiera</h1>
                    <p class="text-sm text-gray-600 mt-1">
                        Dispositivo: <span id="device-id-display" class="font-mono">{{ device_id }}</span>
                        <span id="device-status" class="ml-2 text-xs px-2 py-1 bg-gray-100 rounded"></span>
                    </p>
                </div>
                <div class="flex gap-2">
                    <button onclick="testSave()" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded">
                        üß™ Test
                    </button>
                    <button onclick="saveAll()" id="save-btn" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg flex items-center gap-2">
                        <span>üíæ</span> Guardar Todo
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto">
                <button onclick="switchTab('resumen')" class="nav-tab active px-4 py-3 whitespace-nowrap">üìä Resumen</button>
                <button onclick="switchTab('capex')" class="nav-tab px-4 py-3 whitespace-nowrap">üèóÔ∏è CAPEX</button>
                <button onclick="switchTab('opex')" class="nav-tab px-4 py-3 whitespace-nowrap">üí° OPEX</button>
                <button onclick="switchTab('manto')" class="nav-tab px-4 py-3 whitespace-nowrap">üîß Mantenimiento</button>
                <button onclick="switchTab('debug')" class="nav-tab px-4 py-3 whitespace-nowrap">üêõ Debug</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Tab: Resumen -->
        <div id="tab-resumen" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-5 rounded-xl border shadow-sm">
                    <p class="text-sm text-gray-500 font-medium mb-1">CAPEX TOTAL</p>
                    <p class="text-3xl font-bold text-gray-800" id="kpi-capex">$0</p>
                    <p class="text-xs text-gray-400 mt-2">Inversi√≥n inicial</p>
                </div>
                <div class="bg-white p-5 rounded-xl border shadow-sm">
                    <p class="text-sm text-gray-500 font-medium mb-1">OPEX MENSUAL</p>
                    <p class="text-3xl font-bold text-orange-500" id="kpi-opex">$0</p>
                    <p class="text-xs text-gray-400 mt-2">Gastos operativos</p>
                </div>
                <div class="bg-white p-5 rounded-xl border shadow-sm">
                    <p class="text-sm text-gray-500 font-medium mb-1">VENTAS MENSUAL</p>
                    <p class="text-3xl font-bold text-emerald-500" id="kpi-sales">$0</p>
                    <p class="text-xs text-gray-400 mt-2">Ingresos</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-5 rounded-xl border shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4">üìà Rendimiento</h3>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm text-gray-500">Margen Mensual</p>
                            <p class="text-2xl font-bold text-blue-500" id="kpi-margin">$0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">ROI (Meses)</p>
                            <p class="text-2xl font-bold text-purple-500" id="kpi-roi">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-5 rounded-xl border shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4">üå± Impacto Ecol√≥gico</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Ahorro Energ√©tico</span>
                            <span class="font-medium" id="eco-kwh">0 kWh</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Reducci√≥n CO‚ÇÇ</span>
                            <span class="font-medium" id="eco-co2">0 ton</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Equivalente √Årboles</span>
                            <span class="font-medium" id="eco-trees">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: CAPEX -->
        <div id="tab-capex" class="tab-content">
            <div class="bg-white p-5 rounded-xl border shadow-sm mb-4">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">üèóÔ∏è Infraestructura</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pantalla LED ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_screen" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Obra Civil ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_civil" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estructura Metal ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_structure" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Inst. El√©ctrica ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_electrical" placeholder="0.00">
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl border shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">‚ö° Electr√≥nica</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">NUC ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_nuc" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">UPS ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_ups" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sending Card ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_sending" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M√≥dem WiFi ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_modem_wifi" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M√≥dem SIM ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_modem_sim" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">C√°mara ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="capex_camera" placeholder="0.00">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: OPEX -->
        <div id="tab-opex" class="tab-content">
            <div class="bg-white p-5 rounded-xl border shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">üí∞ Gastos Operativos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Luz ($/mes)</label>
                        <input type="number" step="0.01" class="cost-input" id="opex_light" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Internet ($/mes)</label>
                        <input type="number" step="0.01" class="cost-input" id="opex_internet" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Renta ($/mes)</label>
                        <input type="number" step="0.01" class="cost-input" id="opex_rent" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Uso Suelo ($/mes)</label>
                        <input type="number" step="0.01" class="cost-input" id="opex_soil_use" placeholder="0.00">
                    </div>
                </div>
                
                <div class="mt-6 pt-4 border-t">
                    <h4 class="font-bold text-emerald-600 mb-3">üíµ Ingresos</h4>
                    <div class="max-w-md">
                        <label class="block text-sm font-medium text-emerald-700 mb-1">VENTAS MENSUALES ($)</label>
                        <input type="number" step="0.01" class="cost-input border-emerald-300 bg-emerald-50" id="revenue_monthly" placeholder="0.00">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Mantenimiento -->
        <div id="tab-manto" class="tab-content">
            <div class="bg-white p-5 rounded-xl border shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">üîß Mantenimiento</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Preventivo Bimestral ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="maint_prev_bimonthly" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gasolina ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="maint_gas" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Partes Correctivas ($)</label>
                        <input type="number" step="0.01" class="cost-input" id="maint_corr_parts" placeholder="0.00">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Debug -->
        <div id="tab-debug" class="tab-content">
            <div class="bg-white p-5 rounded-xl border shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4">üêõ Debug & Logs</h3>
                
                <div class="space-y-4">
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="testConnection()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm">
                            üîó Test Conexi√≥n
                        </button>
                        <button onclick="loadData()" class="px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-sm">
                            üîÑ Recargar Datos
                        </button>
                        <button onclick="clearLogs()" class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded text-sm">
                            üóëÔ∏è Limpiar Logs
                        </button>
                    </div>
                    
                    <div class="border rounded p-3">
                        <h4 class="font-medium text-sm mb-2">Logs de Consola</h4>
                        <div id="console-logs" class="debug-panel max-h-60 overflow-y-auto p-2 bg-gray-50 rounded">
                            <!-- Logs aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                    
                    <div class="border rounded p-3">
                        <h4 class="font-medium text-sm mb-2">√öltima Respuesta API</h4>
                        <pre id="api-response" class="debug-panel max-h-60 overflow-y-auto p-2 bg-gray-900 text-gray-100 rounded">
                            {/* Respuesta aparecer√° aqu√≠ */}
                        </pre>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        const deviceId = "{{ device_id }}";
        let currentData = null;
        
        // Interceptar console.log para mostrar en pantalla
        (function() {
            const originalLog = console.log;
            const originalError = console.error;
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                addToLog('üìò', args);
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                addToLog('‚ùå', args);
            };
            
            function addToLog(icon, args) {
                const logsDiv = document.getElementById('console-logs');
                if (logsDiv) {
                    const message = args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                    ).join(' ');
                    
                    const logEntry = document.createElement('div');
                    logEntry.className = 'mb-1 pb-1 border-b border-gray-200';
                    logEntry.innerHTML = `<span class="mr-2">${icon}</span><span class="text-xs">${message}</span>`;
                    
                    logsDiv.appendChild(logEntry);
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                }
            }
        })();
        
        // Funciones de UI
        function switchTab(tabId) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.nav-tab').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(`tab-${tabId}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg animate-fade-in`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto-remover despu√©s de 3 segundos
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function setLoading(loading) {
            const btn = document.getElementById('save-btn');
            if (!btn) return;
            
            if (loading) {
                btn.innerHTML = '<span class="animate-spin">‚ü≥</span> Guardando...';
                btn.disabled = true;
                btn.classList.add('opacity-50');
            } else {
                btn.innerHTML = '<span>üíæ</span> Guardar Todo';
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }
        
        // Funciones de API
        async function testConnection() {
            try {
                console.log('üîç Probando conexi√≥n API...');
                const response = await fetch('/api/techview/test');
                const data = await response.json();
                
                document.getElementById('api-response').textContent = 
                    JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showToast('‚úÖ Conexi√≥n exitosa', 'success');
                } else {
                    showToast('‚ùå Error de conexi√≥n', 'error');
                }
                
                return data;
            } catch (error) {
                console.error('Error testConnection:', error);
                showToast('‚ùå Error de red: ' + error.message, 'error');
                return null;
            }
        }
        
        async function loadData() {
            try {
                console.log(`üì• Cargando datos para: ${deviceId}`);
                
                const response = await fetch(`/api/techview/device/${encodeURIComponent(deviceId)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                currentData = await response.json();
                console.log('üìä Datos recibidos:', currentData);
                
                // Mostrar respuesta en debug
                document.getElementById('api-response').textContent = 
                    JSON.stringify(currentData, null, 2);
                
                // Actualizar estado del dispositivo
                const statusEl = document.getElementById('device-status');
                if (statusEl && currentData.device) {
                    statusEl.textContent = currentData.device.status || 'unknown';
                    statusEl.className = `ml-2 text-xs px-2 py-1 rounded ${
                        currentData.device.status === 'online' ? 'bg-green-100 text-green-800' :
                        currentData.device.status === 'offline' ? 'bg-red-100 text-red-800' :
                        'bg-gray-100 text-gray-800'
                    }`;
                }
                
                // Llenar inputs
                if (currentData.financials) {
                    Object.keys(currentData.financials).forEach(key => {
                        const input = document.getElementById(key);
                        if (input && currentData.financials[key] !== null) {
                            input.value = currentData.financials[key];
                        }
                    });
                }
                
                // Actualizar KPIs
                if (currentData.totals) {
                    const fmt = (n) => `$${parseFloat(n || 0).toLocaleString('es-MX', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                    
                    document.getElementById('kpi-capex').textContent = fmt(currentData.totals.capex);
                    document.getElementById('kpi-opex').textContent = fmt(currentData.totals.opex);
                    document.getElementById('kpi-sales').textContent = fmt(currentData.totals.revenue);
                    document.getElementById('kpi-margin').textContent = fmt(currentData.totals.margin);
                    document.getElementById('kpi-roi').textContent = 
                        currentData.totals.roi ? `${currentData.totals.roi.toFixed(1)} meses` : 'N/A';
                }
                
                // Actualizar impacto ecol√≥gico
                if (currentData.eco) {
                    document.getElementById('eco-kwh').textContent = 
                        `${currentData.eco.kwh_saved.toLocaleString()} kWh`;
                    document.getElementById('eco-co2').textContent = 
                        `${currentData.eco.co2_tons} ton`;
                    document.getElementById('eco-trees').textContent = 
                        currentData.eco.trees;
                }
                
                showToast('‚úÖ Datos cargados', 'success');
                return currentData;
                
            } catch (error) {
                console.error('Error loadData:', error);
                showToast('‚ùå Error: ' + error.message, 'error');
                
                // Mostrar error en debug
                document.getElementById('api-response').textContent = 
                    `Error: ${error.message}\n\n${error.stack || ''}`;
                
                return null;
            }
        }
        
        async function saveAll() {
            setLoading(true);
            
            try {
                // Construir payload
                const payload = {
                    device_id: deviceId,
                    cost_type: 'techview',
                    category: 'management'
                };
                
                // Recolectar todos los inputs num√©ricos
                const inputs = document.querySelectorAll('.cost-input');
                inputs.forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value) && input.id) {
                        payload[input.id] = value;
                    }
                });
                
                console.log('üì§ Enviando datos:', payload);
                
                const response = await fetch('/api/techview/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log('üì• Respuesta:', result);
                
                // Mostrar respuesta
                document.getElementById('api-response').textContent = 
                    JSON.stringify(result, null, 2);
                
                if (response.ok && result.success) {
                    showToast('‚úÖ Datos guardados correctamente', 'success');
                    // Recargar datos despu√©s de guardar
                    setTimeout(loadData, 1000);
                } else {
                    showToast('‚ùå Error: ' + (result.error || 'Desconocido'), 'error');
                }
                
            } catch (error) {
                console.error('Error saveAll:', error);
                showToast('‚ùå Error de red: ' + error.message, 'error');
                
                document.getElementById('api-response').textContent = 
                    `Error: ${error.message}\n\n${error.stack || ''}`;
            } finally {
                setLoading(false);
            }
        }
        
        async function testSave() {
            // Guardado de prueba con datos m√≠nimos
            const testPayload = {
                device_id: deviceId,
                capex_screen: 15000,
                revenue_monthly: 3000,
                cost_type: 'test',
                category: 'test'
            };
            
            console.log('üß™ Test save:', testPayload);
            
            const response = await fetch('/api/techview/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testPayload)
            });
            
            const result = await response.json();
            console.log('üß™ Test result:', result);
            
            showToast(result.success ? '‚úÖ Test exitoso' : '‚ùå Test fall√≥', 
                     result.success ? 'success' : 'error');
            
            document.getElementById('api-response').textContent = 
                JSON.stringify(result, null, 2);
        }
        
        function clearLogs() {
            document.getElementById('console-logs').innerHTML = '';
            showToast('Logs limpiados', 'info');
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ TechView Management inicializado');
            console.log(`üì± Dispositivo: ${deviceId}`);
            
            // Cargar datos iniciales
            loadData();
            
            // Test de conexi√≥n autom√°tico
            setTimeout(testConnection, 500);
            
            // Mostrar notificaci√≥n de bienvenida
            setTimeout(() => {
                showToast('Sistema listo. Cargando datos...', 'info');
            }, 1000);
        });
        
        // Estilos para animaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fade-in {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fade-in {
                animation: fade-in 0.3s ease-out;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
