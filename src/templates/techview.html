<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechView - Gestión Financiera Completa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Estilos personalizados */
        .tab-content { 
            display: none; 
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }
        .tab-content.active { 
            display: block; 
            opacity: 1;
            transform: translateY(0);
            animation: fadeIn 0.4s ease-out;
        }
        .nav-tab.active { 
            border-bottom: 3px solid #f97316; 
            color: #f97316; 
            font-weight: 600;
            background: linear-gradient(to top, #fff7ed, white);
        }
        .cost-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }
        .cost-input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
            transform: translateY(-1px);
        }
        .cost-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .cost-input.success {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 400px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-panel {
            font-family: 'JetBrains Mono', 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-orange {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
        }
        
        .gradient-green {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        
        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }
        
        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }
        
        .stat-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            background: #e5e7eb;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .input-label {
            position: absolute;
            top: -10px;
            left: 12px;
            background: white;
            padding: 0 8px;
            font-size: 12px;
            font-weight: 600;
            color: #4b5563;
            z-index: 10;
        }
        
        .category-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .recommendation-card {
            border-left: 4px solid;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
            animation: fadeIn 0.5s ease;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 30px;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 3px solid;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 20px;
            width: 2px;
            height: calc(100% + 5px);
            background: #e5e7eb;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background: white !important;
                color: black !important;
                font-size: 12pt !important;
            }
            .card {
                break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
        
        /* Animaciones para gráficos */
        .chart-animation {
            animation: fadeIn 0.8s ease-out;
        }
        
        /* Tooltip personalizado */
        .custom-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .custom-tooltip .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #1f2937;
            color: white;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            line-height: 1.5;
        }
        
        .custom-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Estilos para tabs responsivas */
        @media (max-width: 768px) {
            .nav-tab {
                padding: 12px 16px;
                font-size: 13px;
            }
            .stat-card {
                padding: 20px 15px;
            }
            .toast {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .cost-input {
                background: #374151;
                border-color: #4b5563;
                color: white;
            }
            .cost-input:focus {
                background: #1f2937;
            }
            .input-label {
                background: #1f2937;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen">
    <!-- Header -->
    <header class="glass-effect shadow-lg border-b sticky top-0 z-40 no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3">
                        <div class="p-2 gradient-orange rounded-lg">
                            <span class="material-icons-outlined text-white text-2xl">analytics</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">TechView - Gestión Financiera Integral</h1>
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <code id="device-id-display" class="text-sm bg-gray-800 text-white px-3 py-1.5 rounded-lg font-mono">{{ device_id }}</code>
                                <div class="flex items-center gap-2">
                                    <span id="device-status" class="text-xs px-3 py-1 rounded-full font-medium"></span>
                                    <span id="device-health" class="text-xs px-3 py-1 rounded-full font-medium"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <button onclick="window.open('/techview/diagnostic', '_blank')" 
                            class="px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl flex items-center gap-2 transition-all hover:shadow-md">
                        <span class="material-icons-outlined text-sm">bug_report</span>
                        <span class="hidden sm:inline">Diagnóstico</span>
                    </button>
                    <button onclick="window.open('/techview/overview', '_blank')" 
                            class="px-4 py-2.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-xl flex items-center gap-2 transition-all hover:shadow-md">
                        <span class="material-icons-outlined text-sm">dashboard</span>
                        <span class="hidden sm:inline">Overview</span>
                    </button>
                    <button onclick="generateReport()" 
                            class="px-4 py-2.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-xl flex items-center gap-2 transition-all hover:shadow-md">
                        <span class="material-icons-outlined text-sm">description</span>
                        <span class="hidden sm:inline">Reporte</span>
                    </button>
                    <button onclick="saveAll()" id="save-btn" 
                            class="px-6 py-2.5 gradient-orange text-white font-semibold rounded-xl flex items-center gap-3 transition-all hover:shadow-lg hover:scale-105 active:scale-95">
                        <span id="save-icon" class="material-icons-outlined text-lg">save</span>
                        <span class="hidden sm:inline">Guardar Todo</span>
                        <span id="save-badge" class="bg-white/20 px-2 py-0.5 rounded text-xs hidden">0 cambios</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <div class="glass-effect border-b shadow-sm no-print">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto scrollbar-hide">
                <button onclick="switchTab('resumen')" class="nav-tab active px-5 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="material-icons-outlined text-lg">dashboard</span>
                    <span class="hidden md:inline">Resumen</span>
                </button>
                <button onclick="switchTab('capex')" class="nav-tab px-5 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="material-icons-outlined text-lg">business</span>
                    <span class="hidden md:inline">CAPEX</span>
                </button>
                <button onclick="switchTab('opex')" class="nav-tab px-5 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="material-icons-outlined text-lg">receipt_long</span>
                    <span class="hidden md:inline">OPEX</span>
                </button>
                <button onclick="switchTab('manto')" class="nav-tab px-5 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="material-icons-outlined text-lg">build</span>
                    <span class="hidden md:inline">Mantenimiento</span>
                </button>
                <button onclick="switchTab('analisis')" class="nav-tab px-5 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="material-icons-outlined text-lg">assessment</span>
                    <span class="hidden md:inline">Análisis</span>
                </button>
                <button onclick="switchTab('proyecciones')" class="nav-tab px-5 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="material-icons-outlined text-lg">trending_up</span>
                    <span class="hidden md:inline">Proyecciones</span>
                </button>
                <button onclick="switchTab('debug')" class="nav-tab px-5 py-4 whitespace-nowrap flex items-center gap-3">
                    <span class="material-icons-outlined text-lg">code</span>
                    <span class="hidden md:inline">Debug</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Tab: Resumen -->
        <div id="tab-resumen" class="tab-content active">
            <!-- KPIs Principales -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
                <div class="stat-card bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-2xl p-5">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-sm font-semibold text-blue-700 mb-1">CAPEX TOTAL</p>
                            <p class="text-3xl font-bold text-gray-800" id="kpi-capex">$0</p>
                        </div>
                        <div class="p-3 bg-blue-100 rounded-xl">
                            <span class="material-icons-outlined text-blue-600 text-xl">business</span>
                        </div>
                    </div>
                    <p class="text-xs text-blue-600">Inversión inicial en infraestructura</p>
                    <div class="mt-3 text-sm text-blue-700">
                        <span id="capex-breakdown" class="font-medium">Cargando...</span>
                    </div>
                </div>
                
                <div class="stat-card bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-2xl p-5">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-sm font-semibold text-orange-700 mb-1">OPEX MENSUAL</p>
                            <p class="text-3xl font-bold text-gray-800" id="kpi-opex">$0</p>
                        </div>
                        <div class="p-3 bg-orange-100 rounded-xl">
                            <span class="material-icons-outlined text-orange-600 text-xl">trending_up</span>
                        </div>
                    </div>
                    <p class="text-xs text-orange-600">Gastos operativos mensuales</p>
                    <div class="mt-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-orange-700">Anual:</span>
                            <span class="font-semibold text-orange-800" id="kpi-opex-annual">$0</span>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-2xl p-5">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-sm font-semibold text-emerald-700 mb-1">VENTAS MENSUALES</p>
                            <p class="text-3xl font-bold text-gray-800" id="kpi-sales">$0</p>
                        </div>
                        <div class="p-3 bg-emerald-100 rounded-xl">
                            <span class="material-icons-outlined text-emerald-600 text-xl">attach_money</span>
                        </div>
                    </div>
                    <p class="text-xs text-emerald-600">Ingresos mensuales estimados</p>
                    <div class="mt-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-emerald-700">Anual:</span>
                            <span class="font-semibold text-emerald-800" id="kpi-sales-annual">$0</span>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-2xl p-5">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-sm font-semibold text-purple-700 mb-1">MARGEN MENSUAL</p>
                            <p class="text-3xl font-bold text-gray-800" id="kpi-margin">$0</p>
                        </div>
                        <div class="p-3 bg-purple-100 rounded-xl">
                            <span class="material-icons-outlined text-purple-600 text-xl">show_chart</span>
                        </div>
                    </div>
                    <p class="text-xs text-purple-600">Ingresos - Gastos operativos</p>
                    <div class="mt-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-purple-700">ROI:</span>
                            <span class="font-semibold text-purple-800" id="kpi-roi">0 meses</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficas y Análisis -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 shadow-sm p-5">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-blue-500">bar_chart</span>
                            Rendimiento Financiero
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="updateChart('monthly')" class="px-3 py-1.5 text-xs bg-blue-100 text-blue-700 rounded-lg font-medium">Mensual</button>
                            <button onclick="updateChart('annual')" class="px-3 py-1.5 text-xs bg-gray-100 text-gray-700 rounded-lg font-medium">Anual</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
                
                <div class="space-y-5">
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-5">
                        <h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <span class="material-icons-outlined text-emerald-500">health_and_safety</span>
                            Estado Técnico
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-600">Score Técnico</span>
                                    <span class="text-sm font-bold" id="tech-score-text">0/100</span>
                                </div>
                                <div class="progress-bar">
                                    <div id="tech-score-bar" class="progress-fill bg-emerald-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Estado de Salud</p>
                                <div id="tech-status" class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-semibold">
                                    <span class="loading-spinner mr-2"></span> Cargando...
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Tasa de Reincidencia</p>
                                <p class="text-2xl font-bold text-amber-600" id="kpi-reincidence">0%</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-5">
                        <h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <span class="material-icons-outlined text-cyan-500">eco</span>
                            Impacto Ecológico
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Ahorro Energético</span>
                                <span class="font-semibold text-emerald-600" id="eco-kwh">0 kWh</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Reducción CO₂</span>
                                <span class="font-semibold text-emerald-600" id="eco-co2">0 ton</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Equivalente Árboles</span>
                                <span class="font-semibold text-emerald-600" id="eco-trees">0</span>
                            </div>
                            <div class="pt-3 border-t">
                                <p class="text-xs text-gray-500">Eficiencia: <span id="eco-efficiency" class="font-semibold">0%</span> vs pantalla tradicional</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen Ejecutivo -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-lg p-6 text-white">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <span class="material-icons-outlined">summarize</span>
                        Resumen Ejecutivo
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Salud Financiera</span>
                            <div id="financial-health" class="flex items-center gap-2">
                                <span class="loading-spinner"></span>
                                <span class="font-semibold">Cargando...</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Estado Operativo</span>
                            <span id="operational-status" class="font-semibold">Cargando...</span>
                        </div>
                        <div>
                            <p class="text-gray-300 mb-2">Fortaleza Principal</p>
                            <p id="key-strength" class="font-medium bg-white/10 px-3 py-2 rounded-lg">Cargando...</p>
                        </div>
                        <div>
                            <p class="text-gray-300 mb-2">Preocupación Clave</p>
                            <p id="key-concern" class="font-medium bg-white/10 px-3 py-2 rounded-lg">Cargando...</p>
                        </div>
                        <div class="pt-4 border-t border-white/20">
                            <p class="text-gray-300 mb-2">Rating General</p>
                            <div id="overall-rating" class="flex gap-1">
                                <!-- Estrellas se generarán dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="material-icons-outlined text-amber-500">lightbulb</span>
                        Recomendaciones
                    </h3>
                    <div id="kpi-recommendations" class="space-y-3">
                        <div class="recommendation-card bg-amber-50 border-amber-200">
                            <div class="flex items-start gap-3">
                                <span class="material-icons-outlined text-amber-600">info</span>
                                <div>
                                    <p class="font-medium text-amber-800">Cargando recomendaciones...</p>
                                    <p class="text-sm text-amber-700 mt-1">Analizando datos del dispositivo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del Dispositivo -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <span class="material-icons-outlined text-gray-500">info</span>
                    Información del Dispositivo
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-2">Estado Actual</p>
                        <div class="flex items-center gap-2">
                            <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                            <p class="font-semibold" id="device-info-status">Cargando...</p>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-2">Ubicación</p>
                        <p class="font-semibold" id="device-info-location">Cargando...</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-2">Última Actualización</p>
                        <p class="font-semibold" id="device-info-updated">Cargando...</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500 mb-2">Historial de Incidentes</p>
                        <div class="flex items-center gap-3">
                            <p class="font-semibold" id="device-info-incidents">0</p>
                            <button onclick="switchTab('analisis')" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                                Ver detalles →
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: CAPEX -->
        <div id="tab-capex" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Infraestructura -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-blue-600">apartment</span>
                            Infraestructura
                        </h3>
                        <span class="text-sm font-semibold text-blue-600" id="capex-infra-total">Total: $0</span>
                    </div>
                    
                    <div class="space-y-5">
                        <div class="input-group">
                            <span class="input-label">Pantalla LED</span>
                            <div class="flex items-center gap-3">
                                <input type="number" step="0.01" class="cost-input" id="capex_screen" placeholder="0.00">
                                <div class="custom-tooltip">
                                    <span class="material-icons-outlined text-gray-400 cursor-help">info</span>
                                    <div class="tooltip-text">
                                        <strong>Costo de pantalla LED:</strong> Incluye pantalla principal, estructura de montaje y controladores. Ejemplo típico: $10,000 - $50,000 USD dependiendo del tamaño y resolución.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <span class="input-label">Obra Civil</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_civil" placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Preparación del terreno y cimentación</p>
                        </div>
                        
                        <div class="input-group">
                            <span class="input-label">Estructura Metálica</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_structure" placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Estructura de soporte y montaje</p>
                        </div>
                        
                        <div class="input-group">
                            <span class="input-label">Instalación Eléctrica</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_electrical" placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Cableado, protecciones y conexiones eléctricas</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <span class="input-label">Medidor CFE</span>
                                <input type="number" step="0.01" class="cost-input" id="capex_meter" placeholder="0.00">
                            </div>
                            <div class="input-group">
                                <span class="input-label">Inst. Datos</span>
                                <input type="number" step="0.01" class="cost-input" id="capex_data_install" placeholder="0.00">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <span class="input-label">Transporte</span>
                                <input type="number" step="0.01" class="cost-input" id="capex_transportation" placeholder="0.00">
                            </div>
                            <div class="input-group">
                                <span class="input-label">Negociaciones</span>
                                <input type="number" step="0.01" class="cost-input" id="capex_negotiations" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Electrónica -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-purple-600">memory</span>
                            Electrónica y Hardware
                        </h3>
                        <span class="text-sm font-semibold text-purple-600" id="capex-electronica-total">Total: $0</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <span class="input-label">NUC</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_nuc" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <span class="input-label">UPS</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_ups" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <span class="input-label">Sending Card</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_sending" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <span class="input-label">Procesador</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_processor" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <span class="input-label">Módem WiFi</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_modem_wifi" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <span class="input-label">Módem SIM</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_modem_sim" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <span class="input-label">Teltonika</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_teltonika" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <span class="input-label">Cables HDMI</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_hdmi" placeholder="0.00">
                        </div>
                        <div class="input-group col-span-2">
                            <span class="input-label">Cámara</span>
                            <input type="number" step="0.01" class="cost-input" id="capex_camera" placeholder="0.00">
                        </div>
                    </div>
                </div>
                
                <!-- Mano de Obra y Legal -->
                <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-amber-600">engineering</span>
                            Mano de Obra y Legal
                        </h3>
                        <span class="text-sm font-semibold text-amber-600" id="capex-legal-total">Total: $0</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-5">
                            <div class="input-group">
                                <span class="input-label">Costo de Cuadrilla</span>
                                <input type="number" step="0.01" class="cost-input" id="capex_crew" placeholder="0.00">
                                <p class="text-xs text-gray-500 mt-1">Costo de 6 técnicos por 15 días</p>
                            </div>
                            <div class="input-group">
                                <span class="input-label">Logística y Transporte</span>
                                <input type="number" step="0.01" class="cost-input" id="capex_logistics" placeholder="0.00">
                                <p class="text-xs text-gray-500 mt-1">Gasolina y transporte de instalación</p>
                            </div>
                        </div>
                        
                        <div class="space-y-5">
                            <div class="input-group">
                                <span class="input-label">Costos Legales</span>
                                <input type="number" step="0.01" class="cost-input" id="capex_legal" placeholder="0.00">
                                <p class="text-xs text-gray-500 mt-1">Negociaciones con alcaldía y permisos</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <span class="input-label">Primera Instalación</span>
                                    <input type="number" step="0.01" class="cost-input" id="capex_first_install" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <span class="input-label">Administración QTM</span>
                                    <input type="number" step="0.01" class="cost-input" id="capex_admin_qtm" placeholder="0.00">
                                </div>
                            </div>
                            <div class="input-group">
                                <span class="input-label">Inventario</span>
                                <input type="number" step="0.01" class="cost-input" id="capex_inventory" placeholder="0.00">
                                <p class="text-xs text-gray-500 mt-1">Nombre en inventario y registro</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resumen CAPEX -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 mt-6">
                <h3 class="font-bold text-gray-700 mb-6 flex items-center gap-2">
                    <span class="material-icons-outlined text-blue-600">summarize</span>
                    Resumen CAPEX
                </h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="chart-container">
                            <canvas id="capex-chart"></canvas>
                        </div>
                    </div>
                    
                    <div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Infraestructura</span>
                                <span class="font-semibold text-blue-600" id="summary-infra">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Electrónica</span>
                                <span class="font-semibold text-purple-600" id="summary-electronica">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Mano de Obra</span>
                                <span class="font-semibold text-amber-600" id="summary-mano-obra">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Legal y Admin</span>
                                <span class="font-semibold text-gray-600" id="summary-legal">$0</span>
                            </div>
                            <div class="pt-4 border-t border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-bold text-gray-800">TOTAL CAPEX</span>
                                    <span class="text-2xl font-bold text-gray-900" id="summary-capex-total">$0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button onclick="calculateCapex()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all">
                                <span class="material-icons-outlined">calculate</span>
                                Calcular Totales
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: OPEX -->
        <div id="tab-opex" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Suministros y Rentas -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-green-600">bolt</span>
                            Suministros y Rentas
                        </h3>
                        <span class="text-sm font-semibold text-green-600" id="opex-suministros-total">Total: $0</span>
                    </div>
                    
                    <div class="space-y-5">
                        <div class="input-group">
                            <span class="input-label">Pago de Luz Mensual</span>
                            <input type="number" step="0.01" class="cost-input" id="opex_light" placeholder="0.00">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <span class="input-label">Internet SIM</span>
                                <input type="number" step="0.01" class="cost-input" id="opex_internet_sim" placeholder="0.00">
                            </div>
                            <div class="input-group">
                                <span class="input-label">Internet Cable</span>
                                <input type="number" step="0.01" class="cost-input" id="opex_internet_cable" placeholder="0.00">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <span class="input-label">Renta Mensual del Espacio</span>
                            <input type="number" step="0.01" class="cost-input" id="opex_rent" placeholder="0.00">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <span class="input-label">Uso de Suelo</span>
                                <input type="number" step="0.01" class="cost-input" id="opex_soil_use" placeholder="0.00">
                            </div>
                            <div class="input-group">
                                <span class="input-label">Impuestos</span>
                                <input type="number" step="0.01" class="cost-input" id="opex_taxes" placeholder="0.00">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <span class="input-label">Seguros</span>
                            <input type="number" step="0.01" class="cost-input" id="opex_insurance" placeholder="0.00">
                        </div>
                    </div>
                </div>
                
                <!-- Software y Licencias -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-indigo-600">code</span>
                            Software y Licencias
                        </h3>
                        <span class="text-sm font-semibold text-indigo-600" id="opex-software-total">Total: $0</span>
                    </div>
                    
                    <div class="space-y-5">
                        <div class="input-group">
                            <span class="input-label">Licencia Anual</span>
                            <input type="number" step="0.01" class="cost-input" id="opex_license_annual" placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Broadsign, TeamViewer, etc.</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <span class="input-label">Programación de Pauta</span>
                                <input type="number" step="0.01" class="cost-input" id="opex_content_scheduling" placeholder="0.00">
                            </div>
                            <div class="input-group">
                                <span class="input-label">Costo SRD</span>
                                <input type="number" step="0.01" class="cost-input" id="opex_srd" placeholder="0.00">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <span class="input-label">Internet Total</span>
                            <input type="number" step="0.01" class="cost-input" id="opex_internet" placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Total internet (SIM + Cable)</p>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen OPEX -->
                <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-green-600">trending_up</span>
                            Resumen OPEX Mensual
                        </h3>
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-semibold text-green-600" id="opex-monthly-total">Total Mensual: $0</span>
                            <span class="text-sm font-semibold text-green-700" id="opex-annual-total">Total Anual: $0</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div class="chart-container">
                                <canvas id="opex-chart"></canvas>
                            </div>
                        </div>
                        
                        <div>
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Suministros y Rentas</span>
                                        <span class="text-sm font-semibold" id="opex-summary-suministros">$0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="opex-progress-suministros" class="progress-fill bg-green-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Software y Licencias</span>
                                        <span class="text-sm font-semibold" id="opex-summary-software">$0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="opex-progress-software" class="progress-fill bg-indigo-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Mantenimiento</span>
                                        <span class="text-sm font-semibold" id="opex-summary-mantenimiento">$0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="opex-progress-mantenimiento" class="progress-fill bg-amber-500" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="pt-4 border-t border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <span class="text-lg font-bold text-gray-800">TOTAL MENSUAL</span>
                                        <span class="text-2xl font-bold text-green-600" id="opex-total-display">$0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <button onclick="calculateOpex()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all">
                                    <span class="material-icons-outlined">calculate</span>
                                    Calcular OPEX Mensual
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Mantenimiento -->
        <div id="tab-manto" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Mantenimiento Preventivo -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-blue-600">preventive</span>
                            Mantenimiento Preventivo (Programado)
                        </h3>
                        <span class="text-sm font-semibold text-blue-600" id="maint-preventivo-total">Total: $0</span>
                    </div>
                    
                    <div class="space-y-5">
                        <div class="input-group">
                            <span class="input-label">Costo Bimestral</span>
                            <input type="number" step="0.01" class="cost-input" id="maint_prev_bimonthly" placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Cuadrilla de 3 personas cada 2 meses</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <span class="input-label">Insumos de Limpieza</span>
                                <input type="number" step="0.01" class="cost-input" id="maint_cleaning_supplies" placeholder="0.00">
                            </div>
                            <div class="input-group">
                                <span class="input-label">Gasolina y Transporte</span>
                                <input type="number" step="0.01" class="cost-input" id="maint_gas" placeholder="0.00">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <span class="input-label">Tamaño Cuadrilla</span>
                                <input type="number" class="cost-input" id="maint_crew_size" placeholder="3" value="3">
                            </div>
                            <div class="input-group">
                                <span class="input-label">Conteo de Visitas</span>
                                <input type="number" class="cost-input" id="maint_visit_count" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mantenimiento Correctivo -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-red-600">handyman</span>
                            Mantenimiento Correctivo (No planeado)
                        </h3>
                        <span class="text-sm font-semibold text-red-600" id="maint-correctivo-total">Total: $0</span>
                    </div>
                    
                    <div class="space-y-5">
                        <div class="input-group">
                            <span class="input-label">Costo de Cuadrilla</span>
                            <input type="number" step="0.01" class="cost-input" id="maint_corr_labor" placeholder="0.00">
                            <p class="text-xs text-gray-500 mt-1">Costo de cuadrilla 3 personas</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <span class="input-label">Refacciones/Repuestos</span>
                                <input type="number" step="0.01" class="cost-input" id="maint_corr_parts" placeholder="0.00">
                            </div>
                            <div class="input-group">
                                <span class="input-label">Gasolina y Transporte</span>
                                <input type="number" step="0.01" class="cost-input" id="maint_corr_gas" placeholder="0.00">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <span class="input-label">Conteo de Visitas</span>
                            <input type="number" class="cost-input" id="maint_corr_visit_count" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <!-- Historial de Mantenimiento -->
                <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-gray-600">history</span>
                            Historial de Mantenimiento
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="addMaintenanceLog('preventive')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">
                                + Preventivo
                            </button>
                            <button onclick="addMaintenanceLog('corrective')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium">
                                + Correctivo
                            </button>
                        </div>
                    </div>
                    
                    <div id="maintenance-logs" class="space-y-4">
                        <!-- Los logs se cargarán dinámicamente -->
                        <div class="text-center py-8 text-gray-500">
                            <span class="material-icons-outlined text-4xl mb-2">history</span>
                            <p>No hay registros de mantenimiento</p>
                            <p class="text-sm">Agrega un nuevo registro usando los botones arriba</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Análisis -->
        <div id="tab-analisis" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- KPIs Avanzados -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <h3 class="font-bold text-gray-700 mb-6 flex items-center gap-2">
                        <span class="material-icons-outlined text-purple-600">assessment</span>
                        KPIs Avanzados de Rentabilidad
                    </h3>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium text-gray-600">Costo Total Acumulado</span>
                                <span class="text-sm font-semibold text-gray-800" id="kpi-total-cost">$0</span>
                            </div>
                            <div class="progress-bar">
                                <div id="cost-progress" class="progress-fill bg-purple-500" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">CAPEX + OPEX acumulado</p>
                        </div>
                        
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium text-gray-600">Rentabilidad Anual Proyectada</span>
                                <span class="text-sm font-semibold text-gray-800" id="kpi-annual-margin">$0</span>
                            </div>
                            <p class="text-xs text-gray-500">Margen anual proyectado</p>
                        </div>
                        
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium text-gray-600">Meses de Operación</span>
                                <span class="text-sm font-semibold text-gray-800" id="kpi-months-operation">0</span>
                            </div>
                            <p class="text-xs text-gray-500">Tiempo desde instalación</p>
                        </div>
                    </div>
                </div>
                
                <!-- Análisis por Categoría -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <h3 class="font-bold text-gray-700 mb-6 flex items-center gap-2">
                        <span class="material-icons-outlined text-blue-600">pie_chart</span>
                        Análisis por Categoría
                    </h3>
                    
                    <div class="chart-container">
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>
                
                <!-- Análisis de Rentabilidad -->
                <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                            <span class="material-icons-outlined text-emerald-600">trending_up</span>
                            Análisis de Rentabilidad Detallado
                        </h3>
                        <button onclick="calculateAdvancedKPIs()" class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-medium">
                            Recalcular KPIs
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-4">Distribución de Costos</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Infraestructura</span>
                                    <span class="text-sm font-semibold" id="analysis-infra">0%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Electrónica</span>
                                    <span class="text-sm font-semibold" id="analysis-electronica">0%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Mano de Obra</span>
                                    <span class="text-sm font-semibold" id="analysis-mano-obra">0%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Software/Licencias</span>
                                    <span class="text-sm font-semibold" id="analysis-software">0%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Mantenimiento</span>
                                    <span class="text-sm font-semibold" id="analysis-mantenimiento">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-4">Proyección de Vida Útil</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Vida Útil Estimada</span>
                                    <span class="text-sm font-semibold" id="life-estimated">0 años</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Meses Restantes</span>
                                    <span class="text-sm font-semibold" id="life-remaining">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Próximo Evento</span>
                                    <span class="text-sm font-semibold" id="life-next-event">N/A</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Fecha Evento</span>
                                    <span class="text-sm font-semibold" id="life-event-date">N/A</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-4">Análisis de ROI</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">ROI en Meses</span>
                                    <span class="text-sm font-semibold" id="roi-months">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">ROI en Años</span>
                                    <span class="text-sm font-semibold" id="roi-years">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Break-even Point</span>
                                    <span class="text-sm font-semibold" id="break-even">N/A</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Margen de Seguridad</span>
                                    <span class="text-sm font-semibold" id="safety-margin">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Proyecciones -->
        <div id="tab-proyecciones" class="tab-content">
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                        <span class="material-icons-outlined text-indigo-600">timeline</span>
                        Proyecciones Financieras
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="updateProjection('monthly')" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg text-sm font-medium">
                            Mensual
                        </button>
                        <button onclick="updateProjection('annual')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium">
                            Anual
                        </button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="projection-chart"></canvas>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Proyecciones Mensuales -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <h3 class="font-bold text-gray-700 mb-6 flex items-center gap-2">
                        <span class="material-icons-outlined text-blue-600">calendar_today</span>
                        Proyección Mensual (12 meses)
                    </h3>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Mes</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Ingresos</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">OPEX</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Margen</th>
                                </tr>
                            </thead>
                            <tbody id="projection-table" class="divide-y divide-gray-200">
                                <!-- Datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Resumen de Proyección -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                    <h3 class="font-bold text-gray-700 mb-6 flex items-center gap-2">
                        <span class="material-icons-outlined text-emerald-600">insights</span>
                        Resumen de Proyección
                    </h3>
                    
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Análisis de Sensibilidad</h4>
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Escenario Optimista (+10%)</span>
                                        <span class="text-sm font-semibold text-emerald-600" id="scenario-optimistic">$0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill bg-emerald-500" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Escenario Base</span>
                                        <span class="text-sm font-semibold text-blue-600" id="scenario-base">$0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill bg-blue-500" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm text-gray-600">Escenario Pesimista (-10%)</span>
                                        <span class="text-sm font-semibold text-red-600" id="scenario-pessimistic">$0</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill bg-red-500" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Recomendaciones Estratégicas</h4>
                            <div id="strategic-recommendations" class="space-y-2">
                                <p class="text-sm text-gray-600">Cargando recomendaciones...</p>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <button onclick="generateFinancialReport()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all">
                                <span class="material-icons-outlined">description</span>
                                Generar Reporte Financiero
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Debug -->
        <div id="tab-debug" class="tab-content">
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-700 text-lg flex items-center gap-2">
                        <span class="material-icons-outlined text-gray-600">bug_report</span>
                        Panel de Debug y Logs
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="clearLogs()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium">
                            Limpiar Logs
                        </button>
                        <button onclick="testConnection()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">
                            Test Conexión
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Información del Sistema</h4>
                        <div class="debug-panel bg-gray-900 text-gray-100 p-4 rounded-lg overflow-auto max-h-96">
                            <pre id="system-info">Cargando información del sistema...</pre>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Logs en Tiempo Real</h4>
                        <div class="debug-panel bg-gray-900 text-gray-100 p-4 rounded-lg overflow-auto max-h-96">
                            <div id="debug-logs">
                                <div class="text-gray-500 text-sm">Esperando logs...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Pruebas de Funcionalidad</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button onclick="runTest('load')" class="px-4 py-3 bg-blue-50 text-blue-700 rounded-lg font-medium hover:bg-blue-100">
                            Cargar Datos
                        </button>
                        <button onclick="runTest('save')" class="px-4 py-3 bg-green-50 text-green-700 rounded-lg font-medium hover:bg-green-100">
                            Guardar Test
                        </button>
                        <button onclick="runTest('calc')" class="px-4 py-3 bg-purple-50 text-purple-700 rounded-lg font-medium hover:bg-purple-100">
                            Calcular KPIs
                        </button>
                        <button onclick="runTest('all')" class="px-4 py-3 bg-orange-50 text-orange-700 rounded-lg font-medium hover:bg-orange-100">
                            Todas las Pruebas
                        </button>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Datos en Crudo</h4>
                    <div class="debug-panel bg-gray-900 text-gray-100 p-4 rounded-lg overflow-auto max-h-96">
                        <pre id="raw-data">Cargando datos...</pre>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Action Button -->
    <div class="floating-action no-print">
        <button onclick="saveAll()" class="p-4 gradient-orange rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-110 active:scale-95">
            <span class="material-icons-outlined text-white text-2xl">save</span>
        </button>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="loading-spinner border-t-orange-500 border-4 w-16 h-16 mb-4"></div>
            <p class="text-lg font-semibold text-gray-800" id="loading-message">Cargando datos...</p>
            <p class="text-sm text-gray-600 mt-2">Por favor espera</p>
        </div>
    </div>

    <script>
        // Variables globales
        let deviceData = null;
        let pendingChanges = new Set();
        let chartInstances = {};
        let autoSaveTimer = null;
        let deviceId = "{{ device_id }}";
        
        // Colores para gráficos
        const chartColors = {
            blue: '#3b82f6',
            green: '#10b981',
            orange: '#f97316',
            purple: '#8b5cf6',
            red: '#ef4444',
            yellow: '#eab308',
            indigo: '#6366f1',
            pink: '#ec4899',
            teal: '#14b8a6',
            cyan: '#06b6d4'
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 TechView cargando para dispositivo:', deviceId);
            loadDeviceData();
            setupEventListeners();
            setupAutoSave();
            updateBadge();
        });
        
        // Configurar event listeners para inputs
        function setupEventListeners() {
            // Escuchar cambios en todos los inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', function() {
                    const fieldId = this.id;
                    pendingChanges.add(fieldId);
                    updateBadge();
                    
                    // Validar automáticamente
                    validateInput(this);
                    
                    // Recalcular totales de la categoría
                    if (fieldId.startsWith('capex_')) {
                        calculateCategoryTotal('capex');
                    } else if (fieldId.startsWith('opex_')) {
                        calculateCategoryTotal('opex');
                    } else if (fieldId.startsWith('maint_')) {
                        calculateCategoryTotal('maint');
                    }
                });
                
                input.addEventListener('blur', function() {
                    formatCurrencyInput(this);
                });
                
                input.addEventListener('focus', function() {
                    this.select();
                });
            });
            
            // Escuchar teclas de atajo
            document.addEventListener('keydown', function(e) {
                // Ctrl + S para guardar
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveAll();
                }
                
                // Escape para cancelar
                if (e.key === 'Escape') {
                    clearSelection();
                }
            });
        }
        
        // Configurar auto-guardado
        function setupAutoSave() {
            // Guardar automáticamente cada 30 segundos si hay cambios
            autoSaveTimer = setInterval(() => {
                if (pendingChanges.size > 0) {
                    console.log('🔄 Auto-guardando cambios...');
                    saveAll();
                }
            }, 30000);
        }
        
        // Función para cargar datos del dispositivo
        async function loadDeviceData() {
            showLoading('Cargando datos del dispositivo...');
            
            try {
                const response = await fetch(`/techview/api/device/${encodeURIComponent(deviceId)}`);
                const data = await response.json();
                
                if (response.ok) {
                    deviceData = data;
                    console.log('📊 Datos cargados:', deviceData);
                    
                    // Actualizar todas las secciones
                    updateUI(data);
                    
                    // Inicializar gráficos
                    initializeCharts(data);
                    
                    showToast('✅ Datos cargados correctamente', 'success');
                } else {
                    throw new Error(data.error || 'Error al cargar datos');
                }
            } catch (error) {
                console.error('❌ Error cargando datos:', error);
                showToast(`❌ Error: ${error.message}`, 'error');
                
                // Cargar datos de ejemplo para desarrollo
                if (deviceId.includes('TEST')) {
                    loadSampleData();
                }
            } finally {
                hideLoading();
            }
        }
        
        // Actualizar la interfaz con los datos
        function updateUI(data) {
            // Actualizar KPIs principales
            updateMainKPIs(data.totals);
            
            // Actualizar formularios
            updateForms(data.financials);
            
            // Actualizar estado del dispositivo
            updateDeviceInfo(data.device);
            
            // Actualizar análisis avanzados
            updateAdvancedKPIs(data.advanced_kpis);
            
            // Actualizar proyecciones
            updateProjections(data.projections);
            
            // Actualizar mantenimiento
            updateMaintenanceLogs(data.maintenance_logs);
            
            // Actualizar impacto ecológico
            updateEcoImpact(data.eco);
            
            // Actualizar resumen ejecutivo
            updateExecutiveSummary(data.summary);
        }
        
        // Actualizar KPIs principales
        function updateMainKPIs(totals) {
            if (!totals) return;
            
            document.getElementById('kpi-capex').textContent = formatCurrency(totals.capex || 0);
            document.getElementById('kpi-opex').textContent = formatCurrency(totals.opex_monthly || 0);
            document.getElementById('kpi-opex-annual').textContent = formatCurrency(totals.opex_annual || 0);
            document.getElementById('kpi-sales').textContent = formatCurrency(totals.revenue_monthly || 0);
            document.getElementById('kpi-sales-annual').textContent = formatCurrency(totals.revenue_annual || 0);
            document.getElementById('kpi-margin').textContent = formatCurrency(totals.margin_monthly || 0);
            document.getElementById('kpi-roi').textContent = `${(totals.roi_months || 0).toFixed(1)} meses`;
            
            // Actualizar breakdown de CAPEX
            const capexBreakdown = calculateCapexBreakdown();
            document.getElementById('capex-breakdown').textContent = capexBreakdown;
        }
        
        // Actualizar formularios con datos
        function updateForms(financials) {
            if (!financials) return;
            
            // CAPEX
            updateFormSection(financials, 'capex_');
            
            // OPEX
            updateFormSection(financials, 'opex_');
            
            // Mantenimiento
            updateFormSection(financials, 'maint_');
            
            // Ciclo de vida
            updateFormSection(financials, 'life_');
            
            // Revenue
            if (financials.revenue_monthly !== undefined) {
                setInputValue('revenue_monthly', financials.revenue_monthly);
            }
            
            // Calcular totales
            calculateCategoryTotal('capex');
            calculateCategoryTotal('opex');
            calculateCategoryTotal('maint');
        }
        
        // Actualizar sección específica del formulario
        function updateFormSection(data, prefix) {
            Object.keys(data).forEach(key => {
                if (key.startsWith(prefix)) {
                    const input = document.getElementById(key);
                    if (input) {
                        setInputValue(key, data[key]);
                    }
                }
            });
        }
        
        // Establecer valor de input con formato
        function setInputValue(id, value) {
            const input = document.getElementById(id);
            if (input && value !== null && value !== undefined) {
                input.value = value;
                formatCurrencyInput(input);
            }
        }
        
        // Actualizar información del dispositivo
        function updateDeviceInfo(device) {
            if (!device) return;
            
            const status = device.status || 'unknown';
            const statusColors = {
                'online': {bg: 'bg-emerald-100', text: 'text-emerald-800', label: 'Online'},
                'active': {bg: 'bg-emerald-100', text: 'text-emerald-800', label: 'Activo'},
                'offline': {bg: 'bg-red-100', text: 'text-red-800', label: 'Offline'},
                'error': {bg: 'bg-red-100', text: 'text-red-800', label: 'Error'},
                'warning': {bg: 'bg-amber-100', text: 'text-amber-800', label: 'Advertencia'},
                'unknown': {bg: 'bg-gray-100', text: 'text-gray-800', label: 'Desconocido'}
            };
            
            const statusConfig = statusColors[status] || statusColors.unknown;
            
            document.getElementById('device-status').textContent = statusConfig.label;
            document.getElementById('device-status').className = `text-xs px-3 py-1 rounded-full font-medium ${statusConfig.bg} ${statusConfig.text}`;
            
            document.getElementById('status-indicator').className = `w-3 h-3 rounded-full ${
                status === 'online' || status === 'active' ? 'bg-emerald-500' :
                status === 'offline' || status === 'error' ? 'bg-red-500' :
                status === 'warning' ? 'bg-amber-500' : 'bg-gray-400'
            }`;
            
            document.getElementById('device-info-status').textContent = statusConfig.label;
            document.getElementById('device-info-location').textContent = device.location || deviceId;
            document.getElementById('device-info-updated').textContent = device.updated_at ? 
                new Date(device.updated_at).toLocaleString() : 'N/A';
        }
        
        // Actualizar KPIs avanzados
        function updateAdvancedKPIs(kpis) {
            if (!kpis) return;
            
            // Estado técnico
            const techScore = kpis.technical_score || 0;
            document.getElementById('tech-score-text').textContent = `${techScore}/100`;
            document.getElementById('tech-score-bar').style.width = `${techScore}%`;
            
            const healthStatus = kpis.health_status || {};
            document.getElementById('tech-status').innerHTML = `
                ${healthStatus.icon || '❓'} ${healthStatus.status || 'Desconocido'}
            `;
            document.getElementById('tech-status').className = 
                `inline-flex items-center px-3 py-1.5 rounded-full text-sm font-semibold bg-${healthStatus.color || 'gray'}-100 text-${healthStatus.color || 'gray'}-800`;
            
            // Tasa de reincidencia
            document.getElementById('kpi-reincidence').textContent = `${(kpis.reincidence_rate || 0).toFixed(1)}%`;
            
            // Costo total acumulado
            document.getElementById('kpi-total-cost').textContent = formatCurrency(kpis.total_current_cost || 0);
            document.getElementById('cost-progress').style.width = `${Math.min(100, (kpis.total_current_cost || 0) / 100000 * 100)}%`;
            
            // Rentabilidad anual
            document.getElementById('kpi-annual-margin').textContent = formatCurrency(kpis.annual_projected_margin || 0);
            
            // Meses de operación
            document.getElementById('kpi-months-operation').textContent = kpis.months_operation || 0;
            
            // Análisis por categoría
            updateCategoryAnalysis(kpis.category_analysis);
            
            // Proyección de vida útil
            updateLifeProjection(kpis.life_projection);
            
            // Recomendaciones
            updateRecommendations(kpis.recommendations);
        }
        
        // Actualizar análisis por categoría
        function updateCategoryAnalysis(analysis) {
            if (!analysis) return;
            
            document.getElementById('analysis-infra').textContent = `${analysis.infrastructure?.percentage_capex || 0}%`;
            document.getElementById('analysis-electronica').textContent = `${analysis.electronica?.percentage_capex || 0}%`;
            document.getElementById('analysis-mano-obra').textContent = `${analysis.mano_obra?.percentage_capex || 0}%`;
            document.getElementById('analysis-software').textContent = `${analysis.software?.percentage_opex || 0}%`;
            document.getElementById('analysis-mantenimiento').textContent = `${analysis.mantenimiento?.percentage_opex || 0}%`;
        }
        
        // Actualizar proyección de vida útil
        function updateLifeProjection(projection) {
            if (!projection) return;
            
            document.getElementById('life-estimated').textContent = `${projection.estimated_life_years || 0} años`;
            document.getElementById('life-remaining').textContent = projection.months_remaining || 0;
            document.getElementById('life-next-event').textContent = projection.next_major_event || 'N/A';
            document.getElementById('life-event-date').textContent = projection.event_date || 'N/A';
        }
        
        // Actualizar recomendaciones
        function updateRecommendations(recommendations) {
            const container = document.getElementById('kpi-recommendations');
            if (!recommendations || !Array.isArray(recommendations) || recommendations.length === 0) {
                container.innerHTML = `
                    <div class="recommendation-card bg-emerald-50 border-emerald-200">
                        <div class="flex items-start gap-3">
                            <span class="material-icons-outlined text-emerald-600">check_circle</span>
                            <div>
                                <p class="font-medium text-emerald-800">Todo en orden</p>
                                <p class="text-sm text-emerald-700 mt-1">No hay recomendaciones específicas en este momento</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            recommendations.forEach(rec => {
                const typeConfig = {
                    urgent: {bg: 'bg-red-50', border: 'border-red-200', icon: 'error', color: 'red'},
                    warning: {bg: 'bg-amber-50', border: 'border-amber-200', icon: 'warning', color: 'amber'},
                    info: {bg: 'bg-blue-50', border: 'border-blue-200', icon: 'info', color: 'blue'}
                };
                
                const config = typeConfig[rec.type] || typeConfig.info;
                
                const recElement = document.createElement('div');
                recElement.className = `recommendation-card ${config.bg} ${config.border}`;
                recElement.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="material-icons-outlined text-${config.color}-600">${config.icon}</span>
                        <div class="flex-1">
                            <p class="font-medium text-${config.color}-800">${rec.message || 'Sin mensaje'}</p>
                            <div class="mt-2 flex justify-between items-center">
                                <p class="text-sm text-${config.color}-700">Acción: ${rec.action || 'No especificada'}</p>
                                <button onclick="applyRecommendation('${rec.type}')" class="text-xs px-3 py-1 bg-${config.color}-100 text-${config.color}-700 rounded-lg font-medium">
                                    Aplicar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(recElement);
            });
        }
        
        // Actualizar proyecciones
        function updateProjections(projections) {
            if (!projections || !Array.isArray(projections)) return;
            
            // Actualizar tabla
            const tableBody = document.getElementById('projection-table');
            tableBody.innerHTML = '';
            
            projections.slice(0, 12).forEach((proj, index) => {
                const row = document.createElement('tr');
                const month = new Date(proj.projection_date || new Date());
                month.setMonth(month.getMonth() + index);
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-800">${month.toLocaleDateString('es-MX', { month: 'short', year: 'numeric' })}</td>
                    <td class="px-4 py-3 text-sm font-semibold text-emerald-600">${formatCurrency(proj.projected_revenue || 0)}</td>
                    <td class="px-4 py-3 text-sm font-semibold text-orange-600">${formatCurrency(proj.projected_opex || 0)}</td>
                    <td class="px-4 py-3 text-sm font-semibold ${(proj.projected_margin || 0) >= 0 ? 'text-blue-600' : 'text-red-600'}">
                        ${formatCurrency(proj.projected_margin || 0)}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Actualizar escenarios
            const baseRevenue = projections[0]?.projected_revenue || 0;
            document.getElementById('scenario-base').textContent = formatCurrency(baseRevenue);
            document.getElementById('scenario-optimistic').textContent = formatCurrency(baseRevenue * 1.1);
            document.getElementById('scenario-pessimistic').textContent = formatCurrency(baseRevenue * 0.9);
        }
        
        // Actualizar logs de mantenimiento
        function updateMaintenanceLogs(logs) {
            const container = document.getElementById('maintenance-logs');
            if (!logs || !Array.isArray(logs) || logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-icons-outlined text-4xl mb-2">history</span>
                        <p>No hay registros de mantenimiento</p>
                        <p class="text-sm">Agrega un nuevo registro usando los botones arriba</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            logs.forEach(log => {
                const logDate = new Date(log.log_date || log.created_at || new Date());
                const logType = log.log_type || 'unknown';
                const typeConfig = {
                    preventive: {bg: 'bg-blue-100', text: 'text-blue-800', icon: 'preventive', label: 'Preventivo'},
                    corrective: {bg: 'bg-red-100', text: 'text-red-800', icon: 'handyman', label: 'Correctivo'},
                    emergency: {bg: 'bg-amber-100', text: 'text-amber-800', icon: 'emergency', label: 'Emergencia'}
                };
                
                const config = typeConfig[logType] || {bg: 'bg-gray-100', text: 'text-gray-800', icon: 'help', label: 'Desconocido'};
                
                const logElement = document.createElement('div');
                logElement.className = 'bg-white border border-gray-200 rounded-xl p-4';
                logElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-start gap-3">
                            <div class="p-2 ${config.bg} rounded-lg">
                                <span class="material-icons-outlined ${config.text}">${config.icon}</span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${config.label} - ${log.description || 'Sin descripción'}</p>
                                <p class="text-sm text-gray-600 mt-1">${logDate.toLocaleDateString()} • ${log.crew_size || 3} personas • ${log.hours_spent || 0} horas</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-900">${formatCurrency(log.total_cost || 0)}</p>
                            <p class="text-xs ${log.solved ? 'text-emerald-600' : 'text-amber-600'}">
                                ${log.solved ? '✅ Resuelto' : '🔄 Pendiente'}
                            </p>
                        </div>
                    </div>
                `;
                
                container.appendChild(logElement);
            });
        }
        
        // Actualizar impacto ecológico
        function updateEcoImpact(eco) {
            if (!eco) return;
            
            document.getElementById('eco-kwh').textContent = `${(eco.kwh_saved || 0).toLocaleString()} kWh`;
            document.getElementById('eco-co2').textContent = `${(eco.co2_tons || 0).toFixed(2)} ton`;
            document.getElementById('eco-trees').textContent = (eco.trees || 0).toLocaleString();
            document.getElementById('eco-efficiency').textContent = eco.efficiency_gain || '0%';
        }
        
        // Actualizar resumen ejecutivo
        function updateExecutiveSummary(summary) {
            if (!summary) return;
            
            document.getElementById('financial-health').innerHTML = `
                <span class="font-semibold ${summary.financial_health === 'Excelente' ? 'text-emerald-600' : 
                                          summary.financial_health === 'Bueno' ? 'text-blue-600' : 
                                          summary.financial_health === 'Regular' ? 'text-amber-600' : 
                                          'text-red-600'}">
                    ${summary.financial_health || 'Desconocido'}
                </span>
            `;
            
            document.getElementById('operational-status').textContent = summary.operational_status || 'Desconocido';
            document.getElementById('key-strength').textContent = summary.key_strength || 'No identificada';
            document.getElementById('key-concern').textContent = summary.key_concern || 'No identificada';
            
            // Actualizar rating con estrellas
            const rating = summary.overall_rating || 0;
            const ratingContainer = document.getElementById('overall-rating');
            ratingContainer.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.className = `material-icons-outlined ${i <= rating ? 'text-yellow-500' : 'text-gray-400'}`;
                star.textContent = i <= rating ? 'star' : 'star_border';
                ratingContainer.appendChild(star);
            }
        }
        
        // Inicializar gráficos
        function initializeCharts(data) {
            // Gráfica de rendimiento financiero
            initPerformanceChart(data);
            
            // Gráfica de CAPEX
            initCapexChart(data);
            
            // Gráfica de OPEX
            initOpexChart(data);
            
            // Gráfica de categorías
            initCategoryChart(data);
            
            // Gráfica de proyecciones
            initProjectionChart(data);
        }
        
        // Inicializar gráfica de rendimiento
        function initPerformanceChart(data) {
            const ctx = document.getElementById('performance-chart');
            if (!ctx) return;
            
            const totals = data.totals || {};
            
            chartInstances.performance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'OPEX', 'Margen'],
                    datasets: [{
                        label: 'Mensual',
                        data: [
                            totals.revenue_monthly || 0,
                            totals.opex_monthly || 0,
                            totals.margin_monthly || 0
                        ],
                        backgroundColor: [
                            chartColors.green,
                            chartColors.orange,
                            chartColors.blue
                        ],
                        borderColor: [
                            chartColors.green,
                            chartColors.orange,
                            chartColors.blue
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Inicializar gráfica de CAPEX
        function initCapexChart(data) {
            const ctx = document.getElementById('capex-chart');
            if (!ctx) return;
            
            const financials = data.financials || {};
            const categories = {
                'Infraestructura': sumFields(financials, ['capex_screen', 'capex_civil', 'capex_structure', 'capex_electrical', 'capex_meter', 'capex_data_install']),
                'Electrónica': sumFields(financials, ['capex_nuc', 'capex_ups', 'capex_sending', 'capex_processor', 'capex_modem_wifi', 'capex_modem_sim', 'capex_teltonika', 'capex_hdmi', 'capex_camera']),
                'Mano de Obra': sumFields(financials, ['capex_crew', 'capex_logistics']),
                'Legal y Admin': sumFields(financials, ['capex_legal', 'capex_first_install', 'capex_admin_qtm', 'capex_inventory', 'capex_negotiations'])
            };
            
            chartInstances.capex = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            chartColors.blue,
                            chartColors.purple,
                            chartColors.orange,
                            chartColors.gray
                        ],
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = Object.values(categories).reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Inicializar gráfica de OPEX
        function initOpexChart(data) {
            const ctx = document.getElementById('opex-chart');
            if (!ctx) return;
            
            const financials = data.financials || {};
            const categories = {
                'Suministros': sumFields(financials, ['opex_light', 'opex_internet', 'opex_internet_sim', 'opex_internet_cable']),
                'Rentas': sumFields(financials, ['opex_rent', 'opex_soil_use']),
                'Software': sumFields(financials, ['opex_license_annual', 'opex_content_scheduling', 'opex_srd']),
                'Mantenimiento': sumFields(financials, ['maint_prev_bimonthly', 'maint_cleaning_supplies', 'maint_gas', 'maint_corr_parts', 'maint_corr_labor', 'maint_corr_gas']),
                'Otros': sumFields(financials, ['opex_taxes', 'opex_insurance'])
            };
            
            chartInstances.opex = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            chartColors.green,
                            chartColors.teal,
                            chartColors.indigo,
                            chartColors.orange,
                            chartColors.gray
                        ],
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = Object.values(categories).reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Inicializar gráfica de categorías
        function initCategoryChart(data) {
            const ctx = document.getElementById('category-chart');
            if (!ctx) return;
            
            const analysis = data.advanced_kpis?.category_analysis || {};
            
            chartInstances.category = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(analysis).map(key => key.charAt(0).toUpperCase() + key.slice(1)),
                    datasets: [{
                        label: 'Distribución %',
                        data: Object.values(analysis).map(item => item.percentage_capex || item.percentage_opex || 0),
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: chartColors.blue,
                        borderWidth: 2,
                        pointBackgroundColor: chartColors.blue,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: chartColors.blue
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Inicializar gráfica de proyecciones
        function initProjectionChart(data) {
            const ctx = document.getElementById('projection-chart');
            if (!ctx) return;
            
            const projections = data.projections || [];
            const labels = projections.slice(0, 12).map((_, i) => {
                const date = new Date();
                date.setMonth(date.getMonth() + i);
                return date.toLocaleDateString('es-MX', { month: 'short' });
            });
            
            chartInstances.projection = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ingresos Proyectados',
                            data: projections.slice(0, 12).map(p => p.projected_revenue || 0),
                            borderColor: chartColors.green,
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'OPEX Proyectado',
                            data: projections.slice(0, 12).map(p => p.projected_opex || 0),
                            borderColor: chartColors.orange,
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Actualizar gráfica de rendimiento
        function updateChart(type) {
            if (!chartInstances.performance) return;
            
            const totals = deviceData?.totals || {};
            
            if (type === 'annual') {
                chartInstances.performance.data.datasets[0].data = [
                    totals.revenue_annual || 0,
                    totals.opex_annual || 0,
                    totals.margin_annual || 0
                ];
                chartInstances.performance.data.datasets[0].label = 'Anual';
            } else {
                chartInstances.performance.data.datasets[0].data = [
                    totals.revenue_monthly || 0,
                    totals.opex_monthly || 0,
                    totals.margin_monthly || 0
                ];
                chartInstances.performance.data.datasets[0].label = 'Mensual';
            }
            
            chartInstances.performance.update();
        }
        
        // Actualizar proyección
        function updateProjection(type) {
            // Cambiar entre vista mensual y anual
            showToast(`Cambiando a vista ${type === 'annual' ? 'anual' : 'mensual'}`, 'info');
        }
        
        // Calcular totales por categoría
        function calculateCategoryTotal(category) {
            let total = 0;
            const inputs = document.querySelectorAll(`input[id^="${category}_"]`);
            
            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            // Actualizar display
            const displayId = `${category}-total-display`;
            const displayElement = document.getElementById(displayId);
            if (displayElement) {
                displayElement.textContent = formatCurrency(total);
            }
            
            return total;
        }
        
        // Calcular CAPEX
        function calculateCapex() {
            const total = calculateCategoryTotal('capex');
            
            // Actualizar resumen
            document.getElementById('summary-capex-total').textContent = formatCurrency(total);
            
            // Calcular subtotales
            const infra = sumInputs(['capex_screen', 'capex_civil', 'capex_structure', 'capex_electrical', 'capex_meter', 'capex_data_install', 'capex_transportation', 'capex_negotiations']);
            const electronica = sumInputs(['capex_nuc', 'capex_ups', 'capex_sending', 'capex_processor', 'capex_modem_wifi', 'capex_modem_sim', 'capex_teltonika', 'capex_hdmi', 'capex_camera']);
            const manoObra = sumInputs(['capex_crew', 'capex_logistics']);
            const legal = sumInputs(['capex_legal', 'capex_first_install', 'capex_admin_qtm', 'capex_inventory']);
            
            document.getElementById('summary-infra').textContent = formatCurrency(infra);
            document.getElementById('summary-electronica').textContent = formatCurrency(electronica);
            document.getElementById('summary-mano-obra').textContent = formatCurrency(manoObra);
            document.getElementById('summary-legal').textContent = formatCurrency(legal);
            
            showToast(`CAPEX total calculado: ${formatCurrency(total)}`, 'success');
        }
        
        // Calcular OPEX
        function calculateOpex() {
            const total = calculateCategoryTotal('opex') + (calculateCategoryTotal('maint') / 2); // Mantenimiento bimestral a mensual
            
            // Actualizar resumen
            document.getElementById('opex-total-display').textContent = formatCurrency(total);
            document.getElementById('opex-monthly-total').textContent = `Total Mensual: ${formatCurrency(total)}`;
            document.getElementById('opex-annual-total').textContent = `Total Anual: ${formatCurrency(total * 12)}`;
            
            // Calcular porcentajes
            const suministros = sumInputs(['opex_light', 'opex_internet', 'opex_internet_sim', 'opex_internet_cable', 'opex_rent', 'opex_soil_use', 'opex_taxes', 'opex_insurance']);
            const software = sumInputs(['opex_license_annual']) / 12 + sumInputs(['opex_content_scheduling', 'opex_srd']);
            const mantenimiento = sumInputs(['maint_prev_bimonthly', 'maint_cleaning_supplies', 'maint_gas', 'maint_corr_parts', 'maint_corr_labor', 'maint_corr_gas']) / 2;
            
            document.getElementById('opex-summary-suministros').textContent = formatCurrency(suministros);
            document.getElementById('opex-summary-software').textContent = formatCurrency(software);
            document.getElementById('opex-summary-mantenimiento').textContent = formatCurrency(mantenimiento);
            
            const pctSuministros = total > 0 ? (suministros / total * 100) : 0;
            const pctSoftware = total > 0 ? (software / total * 100) : 0;
            const pctMantenimiento = total > 0 ? (mantenimiento / total * 100) : 0;
            
            document.getElementById('opex-progress-suministros').style.width = `${pctSuministros}%`;
            document.getElementById('opex-progress-software').style.width = `${pctSoftware}%`;
            document.getElementById('opex-progress-mantenimiento').style.width = `${pctMantenimiento}%`;
            
            showToast(`OPEX mensual calculado: ${formatCurrency(total)}`, 'success');
        }
        
        // Calcular KPIs avanzados
        function calculateAdvancedKPIs() {
            showLoading('Calculando KPIs avanzados...');
            
            // Simular cálculo
            setTimeout(() => {
                // Actualizar datos locales
                if (deviceData && deviceData.advanced_kpis) {
                    updateAdvancedKPIs(deviceData.advanced_kpis);
                }
                
                hideLoading();
                showToast('✅ KPIs avanzados calculados', 'success');
            }, 1000);
        }
        
        // Guardar todos los cambios
        async function saveAll() {
            if (pendingChanges.size === 0) {
                showToast('⚠️ No hay cambios para guardar', 'warning');
                return;
            }
            
            showLoading('Guardando cambios...');
            
            try {
                // Recopilar datos del formulario
                const payload = {
                    device_id: deviceId,
                    cost_type: 'techview',
                    category: 'comprehensive'
                };
                
                // Agregar todos los campos de entrada
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    if (input.value && input.value !== '0') {
                        payload[input.id] = parseFloat(input.value);
                    }
                });
                
                console.log('📤 Enviando datos:', payload);
                
                const response = await fetch('/techview/api/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    pendingChanges.clear();
                    updateBadge();
                    
                    // Recargar datos
                    await loadDeviceData();
                    
                    showToast('✅ Cambios guardados exitosamente', 'success');
                } else {
                    throw new Error(result.error || 'Error al guardar');
                }
            } catch (error) {
                console.error('❌ Error guardando:', error);
                showToast(`❌ Error: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Generar reporte
        function generateReport() {
            showLoading('Generando reporte...');
            
            // Crear contenido del reporte
            const reportContent = `
                <html>
                <head>
                    <title>Reporte TechView - ${deviceId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #333; border-bottom: 2px solid #f97316; padding-bottom: 10px; }
                        .section { margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .kpi { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0; }
                        .positive { color: #10b981; }
                        .negative { color: #ef4444; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <h1>📊 Reporte TechView - ${deviceId}</h1>
                    <p>Generado: ${new Date().toLocaleString()}</p>
                    
                    <div class="section">
                        <h2>📈 KPIs Principales</h2>
                        <div class="kpi">
                            <p><strong>CAPEX Total:</strong> ${document.getElementById('kpi-capex').textContent}</p>
                            <p><strong>OPEX Mensual:</strong> ${document.getElementById('kpi-opex').textContent}</p>
                            <p><strong>Ventas Mensuales:</strong> ${document.getElementById('kpi-sales').textContent}</p>
                            <p><strong>Margen Mensual:</strong> ${document.getElementById('kpi-margin').textContent}</p>
                            <p><strong>ROI:</strong> ${document.getElementById('kpi-roi').textContent}</p>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>🔧 Estado Técnico</h2>
                        <div class="kpi">
                            <p><strong>Score Técnico:</strong> ${document.getElementById('tech-score-text').textContent}</p>
                            <p><strong>Estado:</strong> ${document.getElementById('tech-status').textContent}</p>
                            <p><strong>Tasa de Reincidencia:</strong> ${document.getElementById('kpi-reincidence').textContent}</p>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Reporte generado automáticamente por TechView System</p>
                        <p>© ${new Date().getFullYear()} TechView - Sistema de Gestión Financiera</p>
                    </div>
                </body>
                </html>
            `;
            
            // Crear ventana para el reporte
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportContent);
            reportWindow.document.close();
            
            hideLoading();
            showToast('✅ Reporte generado', 'success');
        }
        
        // Generar reporte financiero
        async function generateFinancialReport() {
            showLoading('Generando reporte financiero...');
            
            try {
                const response = await fetch(`/techview/api/device/${encodeURIComponent(deviceId)}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Crear contenido detallado del reporte
                    let reportHTML = `
                        <html>
                        <head>
                            <title>Reporte Financiero Detallado - ${deviceId}</title>
                            <style>
                                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; color: #333; }
                                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
                                h1 { margin: 0; font-size: 28px; }
                                h2 { color: #f97316; border-bottom: 2px solid #f97316; padding-bottom: 8px; margin-top: 30px; }
                                .section { background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
                                .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
                                .kpi-card { background: #f8f9fa; border-left: 4px solid #f97316; padding: 15px; border-radius: 5px; }
                                .table-responsive { overflow-x: auto; margin: 20px 0; }
                                table { width: 100%; border-collapse: collapse; }
                                th { background: #f5f5f5; font-weight: 600; }
                                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                                .positive { color: #10b981; font-weight: 600; }
                                .negative { color: #ef4444; font-weight: 600; }
                                .recommendation { background: #fff7ed; border-left: 4px solid #f97316; padding: 15px; margin: 15px 0; border-radius: 0 5px 5px 0; }
                                .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; text-align: center; }
                                @media print {
                                    body { margin: 20px; font-size: 12pt; }
                                    .no-print { display: none; }
                                    .section { break-inside: avoid; }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>📊 Reporte Financiero Detallado</h1>
                                <p><strong>Dispositivo:</strong> ${deviceId}</p>
                                <p><strong>Generado:</strong> ${new Date().toLocaleString()}</p>
                            </div>
                    `;
                    
                    // Resumen Ejecutivo
                    reportHTML += `
                        <div class="section">
                            <h2>📋 Resumen Ejecutivo</h2>
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <strong>Salud Financiera:</strong><br>
                                    <span class="${data.summary?.financial_health === 'Excelente' ? 'positive' : 
                                                  data.summary?.financial_health === 'Bueno' ? 'positive' : 
                                                  'negative'}">
                                        ${data.summary?.financial_health || 'N/A'}
                                    </span>
                                </div>
                                <div class="kpi-card">
                                    <strong>Estado Operativo:</strong><br>
                                    ${data.summary?.operational_status || 'N/A'}
                                </div>
                                <div class="kpi-card">
                                    <strong>Rating General:</strong><br>
                                    ${'★'.repeat(data.summary?.overall_rating || 0)}${'☆'.repeat(5 - (data.summary?.overall_rating || 0))}
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <p><strong>Fortaleza Principal:</strong> ${data.summary?.key_strength || 'No identificada'}</p>
                                <p><strong>Preocupación Clave:</strong> ${data.summary?.key_concern || 'No identificada'}</p>
                            </div>
                        </div>
                    `;
                    
                    // Análisis Financiero
                    const totals = data.totals || {};
                    reportHTML += `
                        <div class="section">
                            <h2>💰 Análisis Financiero</h2>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Concepto</th>
                                            <th>Mensual</th>
                                            <th>Anual</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Ingresos por Ventas</td>
                                            <td class="positive">${formatCurrency(totals.revenue_monthly || 0)}</td>
                                            <td class="positive">${formatCurrency(totals.revenue_annual || 0)}</td>
                                        </tr>
                                        <tr>
                                            <td>Gastos Operativos (OPEX)</td>
                                            <td class="negative">${formatCurrency(totals.opex_monthly || 0)}</td>
                                            <td class="negative">${formatCurrency(totals.opex_annual || 0)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Margen Operativo</strong></td>
                                            <td class="${(totals.margin_monthly || 0) >= 0 ? 'positive' : 'negative'}">
                                                <strong>${formatCurrency(totals.margin_monthly || 0)}</strong>
                                            </td>
                                            <td class="${(totals.margin_annual || 0) >= 0 ? 'positive' : 'negative'}">
                                                <strong>${formatCurrency(totals.margin_annual || 0)}</strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Inversión Inicial (CAPEX)</td>
                                            <td colspan="2">${formatCurrency(totals.capex || 0)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ROI (Retorno de Inversión)</strong></td>
                                            <td colspan="2"><strong>${(totals.roi_months || 0).toFixed(1)} meses (${(totals.roi_years || 0).toFixed(1)} años)</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    // KPIs Avanzados
                    const advanced = data.advanced_kpis || {};
                    reportHTML += `
                        <div class="section">
                            <h2>📈 KPIs Avanzados</h2>
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <strong>Costo Total Acumulado:</strong><br>
                                    ${formatCurrency(advanced.total_current_cost || 0)}
                                </div>
                                <div class="kpi-card">
                                    <strong>Meses de Operación:</strong><br>
                                    ${advanced.months_operation || 0}
                                </div>
                                <div class="kpi-card">
                                    <strong>Rentabilidad Anual Proyectada:</strong><br>
                                    <span class="${(advanced.annual_projected_margin || 0) >= 0 ? 'positive' : 'negative'}">
                                        ${formatCurrency(advanced.annual_projected_margin || 0)}
                                    </span>
                                </div>
                                <div class="kpi-card">
                                    <strong>Tasa de Reincidencia:</strong><br>
                                    ${(advanced.reincidence_rate || 0).toFixed(1)}%
                                </div>
                                <div class="kpi-card">
                                    <strong>Estado Técnico:</strong><br>
                                    ${advanced.technical_score || 0}/100
                                </div>
                                <div class="kpi-card">
                                    <strong>Estado de Salud:</strong><br>
                                    ${advanced.health_status?.status || 'N/A'}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Recomendaciones
                    const recommendations = advanced.recommendations || [];
                    if (recommendations.length > 0) {
                        reportHTML += `
                            <div class="section">
                                <h2>💡 Recomendaciones</h2>
                                ${recommendations.map(rec => `
                                    <div class="recommendation">
                                        <p><strong>${rec.type === 'urgent' ? '🚨 URGENTE' : rec.type === 'warning' ? '⚠️ ADVERTENCIA' : 'ℹ️ INFORMACIÓN'}:</strong> ${rec.message || ''}</p>
                                        <p><em>Acción recomendada:</em> ${rec.action || 'No especificada'}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    // Proyecciones
                    const projections = data.projections || [];
                    if (projections.length > 0) {
                        reportHTML += `
                            <div class="section">
                                <h2>📅 Proyecciones (Próximos 12 meses)</h2>
                                <div class="table-responsive">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Mes</th>
                                                <th>Ingresos Proyectados</th>
                                                <th>OPEX Proyectado</th>
                                                <th>Margen Proyectado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${projections.slice(0, 12).map((proj, i) => {
                                                const month = new Date();
                                                month.setMonth(month.getMonth() + i);
                                                return `
                                                    <tr>
                                                        <td>${month.toLocaleDateString('es-MX', { month: 'short', year: 'numeric' })}</td>
                                                        <td>${formatCurrency(proj.projected_revenue || 0)}</td>
                                                        <td>${formatCurrency(proj.projected_opex || 0)}</td>
                                                        <td class="${(proj.projected_margin || 0) >= 0 ? 'positive' : 'negative'}">
                                                            ${formatCurrency(proj.projected_margin || 0)}
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Impacto Ecológico
                    const eco = data.eco || {};
                    reportHTML += `
                        <div class="section">
                            <h2>🌱 Impacto Ecológico</h2>
                            <div class="kpi-grid">
                                <div class="kpi-card">
                                    <strong>Ahorro Energético:</strong><br>
                                    ${(eco.kwh_saved || 0).toLocaleString()} kWh
                                </div>
                                <div class="kpi-card">
                                    <strong>Reducción CO₂:</strong><br>
                                    ${(eco.co2_tons || 0).toFixed(2)} toneladas
                                </div>
                                <div class="kpi-card">
                                    <strong>Equivalente Árboles:</strong><br>
                                    ${(eco.trees || 0).toLocaleString()} árboles
                                </div>
                                <div class="kpi-card">
                                    <strong>Eficiencia vs Tradicional:</strong><br>
                                    ${eco.efficiency_gain || '0%'}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Footer
                    reportHTML += `
                        <div class="footer">
                            <p>📄 <strong>TechView - Sistema de Gestión Financiera Integral</strong></p>
                            <p>Este reporte fue generado automáticamente el ${new Date().toLocaleString()}</p>
                            <p>© ${new Date().getFullYear()} TechView System. Todos los derechos reservados.</p>
                            <p style="font-size: 10px; color: #999; margin-top: 10px;">
                                Información confidencial. Para uso interno únicamente.
                            </p>
                        </div>
                    `;
                    
                    reportHTML += `</body></html>`;
                    
                    // Abrir reporte en nueva ventana
                    const reportWindow = window.open('', '_blank');
                    reportWindow.document.write(reportHTML);
                    reportWindow.document.close();
                    
                    // Opción para imprimir
                    setTimeout(() => {
                        reportWindow.print();
                    }, 500);
                    
                    hideLoading();
                    showToast('✅ Reporte financiero generado', 'success');
                } else {
                    throw new Error(data.error || 'Error al generar reporte');
                }
            } catch (error) {
                console.error('❌ Error generando reporte:', error);
                showToast(`❌ Error: ${error.message}`, 'error');
                hideLoading();
            }
        }
        
        // Función para agregar registro de mantenimiento
        function addMaintenanceLog(type) {
            const logId = `log_${Date.now()}`;
            const logContainer = document.getElementById('maintenance-logs');
            
            const typeConfig = {
                preventive: {bg: 'bg-blue-100', text: 'text-blue-800', icon: 'preventive', label: 'Preventivo'},
                corrective: {bg: 'bg-red-100', text: 'text-red-800', icon: 'handyman', label: 'Correctivo'}
            };
            
            const config = typeConfig[type] || typeConfig.preventive;
            
            const logHTML = `
                <div id="${logId}" class="bg-white border border-gray-200 rounded-xl p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex items-start gap-3">
                            <div class="p-2 ${config.bg} rounded-lg">
                                <span class="material-icons-outlined ${config.text}">${config.icon}</span>
                            </div>
                            <div class="flex-1">
                                <input type="text" class="w-full p-2 border border-gray-300 rounded-lg mb-2" placeholder="Descripción del mantenimiento" value="Nuevo ${config.label} - ${new Date().toLocaleDateString()}">
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Costo</label>
                                        <input type="number" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="0.00" step="0.01">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">Horas</label>
                                        <input type="number" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="0" step="0.5">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="saveMaintenanceLog('${logId}')" class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-sm">
                                Guardar
                            </button>
                            <button onclick="removeMaintenanceLog('${logId}')" class="px-3 py-1 bg-red-100 text-red-700 rounded-lg text-sm">
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            if (logContainer.firstChild?.classList?.contains('text-center')) {
                logContainer.innerHTML = logHTML;
            } else {
                logContainer.insertAdjacentHTML('afterbegin', logHTML);
            }
            
            showToast(`📝 Nuevo registro de mantenimiento ${config.label} agregado`, 'info');
        }
        
        // Guardar registro de mantenimiento
        function saveMaintenanceLog(logId) {
            const logElement = document.getElementById(logId);
            if (!logElement) return;
            
            showToast('✅ Registro de mantenimiento guardado', 'success');
            
            // Aquí se implementaría la lógica para guardar en el servidor
            // Por ahora solo mostramos un mensaje
        }
        
        // Eliminar registro de mantenimiento
        function removeMaintenanceLog(logId) {
            const logElement = document.getElementById(logId);
            if (logElement) {
                logElement.remove();
                
                // Si no quedan logs, mostrar mensaje
                const logContainer = document.getElementById('maintenance-logs');
                if (logContainer.children.length === 0) {
                    logContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <span class="material-icons-outlined text-4xl mb-2">history</span>
                            <p>No hay registros de mantenimiento</p>
                            <p class="text-sm">Agrega un nuevo registro usando los botones arriba</p>
                        </div>
                    `;
                }
                
                showToast('🗑️ Registro eliminado', 'info');
            }
        }
        
        // Aplicar recomendación
        function applyRecommendation(type) {
            showToast(`Aplicando recomendación tipo: ${type}`, 'info');
            
            // Aquí se implementaría la lógica específica para cada tipo de recomendación
            // Por ejemplo, podría abrir el tab correspondiente o pre-llenar formularios
        }
        
        // Cambiar entre tabs
        function switchTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover clase active de todos los botones
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            const tabElement = document.getElementById(`tab-${tabName}`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Activar botón correspondiente
            const activeBtn = Array.from(document.querySelectorAll('.nav-tab')).find(btn => 
                btn.textContent.includes(tabName.charAt(0).toUpperCase() + tabName.slice(1)) || 
                btn.onclick.toString().includes(tabName)
            );
            
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Actualizar gráficos si es necesario
            if (tabName === 'resumen' && chartInstances.performance) {
                chartInstances.performance.update();
            } else if (tabName === 'capex' && chartInstances.capex) {
                chartInstances.capex.update();
            } else if (tabName === 'opex' && chartInstances.opex) {
                chartInstances.opex.update();
            } else if (tabName === 'analisis' && chartInstances.category) {
                chartInstances.category.update();
            } else if (tabName === 'proyecciones' && chartInstances.projection) {
                chartInstances.projection.update();
            }
            
            // Scroll suave al inicio del tab
            setTimeout(() => {
                tabElement?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        // Mostrar toast
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            
            const typeConfig = {
                success: {bg: 'bg-emerald-500', icon: '✅'},
                error: {bg: 'bg-red-500', icon: '❌'},
                warning: {bg: 'bg-amber-500', icon: '⚠️'},
                info: {bg: 'bg-blue-500', icon: 'ℹ️'}
            };
            
            const config = typeConfig[type] || typeConfig.info;
            
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast ${config.bg}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-lg">${config.icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remover toast después de 5 segundos
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => {
                        toastElement.remove();
                    }, 300);
                }
            }, 5000);
        }
        
        // Mostrar loading
        function showLoading(message = 'Cargando...') {
            const overlay = document.getElementById('loading-overlay');
            const messageElement = document.getElementById('loading-message');
            
            if (messageElement) {
                messageElement.textContent = message;
            }
            
            if (overlay) {
                overlay.classList.remove('hidden');
            }
        }
        
        // Ocultar loading
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }
        
        // Actualizar badge de cambios pendientes
        function updateBadge() {
            const badge = document.getElementById('save-badge');
            const saveBtn = document.getElementById('save-btn');
            
            if (pendingChanges.size > 0) {
                badge.textContent = `${pendingChanges.size} cambios`;
                badge.classList.remove('hidden');
                
                // Efecto de parpadeo en el botón
                saveBtn.classList.add('animate-pulse');
            } else {
                badge.classList.add('hidden');
                saveBtn.classList.remove('animate-pulse');
            }
        }
        
        // Validar input
        function validateInput(input) {
            const value = parseFloat(input.value);
            
            if (isNaN(value) || value < 0) {
                input.classList.add('error');
                input.classList.remove('success');
                return false;
            } else {
                input.classList.remove('error');
                input.classList.add('success');
                return true;
            }
        }
        
        // Formatear input de moneda
        function formatCurrencyInput(input) {
            const value = parseFloat(input.value);
            
            if (!isNaN(value) && input.value !== '') {
                input.value = value.toFixed(2);
            }
        }
        
        // Formatear moneda
        function formatCurrency(amount) {
            if (isNaN(amount)) return '$0.00';
            
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }
        
        // Calcular breakdown de CAPEX
        function calculateCapexBreakdown() {
            const screen = parseFloat(document.getElementById('capex_screen')?.value || 0);
            const infra = sumInputs(['capex_civil', 'capex_structure', 'capex_electrical']);
            const electronica = sumInputs(['capex_nuc', 'capex_ups', 'capex_sending', 'capex_processor']);
            
            const total = screen + infra + electronica;
            if (total === 0) return 'No hay datos';
            
            const pctScreen = total > 0 ? (screen / total * 100).toFixed(0) : 0;
            const pctInfra = total > 0 ? (infra / total * 100).toFixed(0) : 0;
            const pctElectronica = total > 0 ? (electronica / total * 100).toFixed(0) : 0;
            
            return `Pantalla: ${pctScreen}% | Infra: ${pctInfra}% | Electrón: ${pctElectronica}%`;
        }
        
        // Sumar valores de inputs
        function sumInputs(inputIds) {
            return inputIds.reduce((total, id) => {
                const input = document.getElementById(id);
                const value = parseFloat(input?.value || 0);
                return total + (isNaN(value) ? 0 : value);
            }, 0);
        }
        
        // Sumar campos específicos de un objeto
        function sumFields(obj, fields) {
            return fields.reduce((total, field) => {
                const value = parseFloat(obj[field] || 0);
                return total + (isNaN(value) ? 0 : value);
            }, 0);
        }
        
        // Limpiar selección
        function clearSelection() {
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            } else if (document.selection) {
                document.selection.empty();
            }
        }
        
        // Test de conexión
        async function testConnection() {
            showLoading('Probando conexión...');
            
            try {
                const response = await fetch('/techview/api/test');
                const data = await response.json();
                
                if (response.ok) {
                    showToast('✅ Conexión exitosa con el servidor', 'success');
                    logDebug('System', `Test conexión: ${JSON.stringify(data)}`);
                } else {
                    throw new Error(data.error || 'Error en la conexión');
                }
            } catch (error) {
                showToast(`❌ Error de conexión: ${error.message}`, 'error');
                logDebug('System', `Error conexión: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // Ejecutar pruebas
        async function runTest(testType) {
            showLoading(`Ejecutando prueba: ${testType}`);
            
            try {
                switch (testType) {
                    case 'load':
                        await loadDeviceData();
                        break;
                        
                    case 'save':
                        // Crear datos de prueba
                        const testData = {
                            device_id: deviceId,
                            capex_screen: 15000,
                            revenue_monthly: 3000,
                            cost_type: "test",
                            category: "test"
                        };
                        
                        const saveResponse = await fetch('/techview/api/save', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(testData)
                        });
                        
                        const saveResult = await saveResponse.json();
                        
                        if (saveResponse.ok) {
                            showToast('✅ Prueba de guardado exitosa', 'success');
                            logDebug('Test', `Save test: ${JSON.stringify(saveResult)}`);
                        } else {
                            throw new Error(saveResult.error || 'Error en guardado');
                        }
                        break;
                        
                    case 'calc':
                        calculateAdvancedKPIs();
                        break;
                        
                    case 'all':
                        await testConnection();
                        await loadDeviceData();
                        calculateAdvancedKPIs();
                        break;
                }
            } catch (error) {
                showToast(`❌ Error en prueba: ${error.message}`, 'error');
                logDebug('Test', `Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // Limpiar logs
        function clearLogs() {
            const logsContainer = document.getElementById('debug-logs');
            if (logsContainer) {
                logsContainer.innerHTML = '<div class="text-gray-500 text-sm">Logs limpiados</div>';
            }
        }
        
        // Log para debug
        function logDebug(source, message) {
            const logsContainer = document.getElementById('debug-logs');
            if (!logsContainer) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1';
            logEntry.innerHTML = `
                <span class="text-emerald-400">[${timestamp}]</span>
                <span class="text-blue-400">${source}:</span>
                <span class="text-gray-300">${message}</span>
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // También actualizar datos en crudo
            if (deviceData && source === 'System') {
                updateRawData();
            }
        }
        
        // Actualizar datos en crudo
        function updateRawData() {
            const rawDataElement = document.getElementById('raw-data');
            if (rawDataElement && deviceData) {
                rawDataElement.textContent = JSON.stringify(deviceData, null, 2);
            }
        }
        
        // Cargar datos de ejemplo para desarrollo
        function loadSampleData() {
            console.log('📝 Cargando datos de ejemplo...');
            
            deviceData = {
                device: {
                    device_id: deviceId,
                    status: 'active',
                    location: deviceId,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                },
                financials: {
                    capex_screen: 25000,
                    capex_civil: 5000,
                    capex_structure: 8000,
                    capex_electrical: 3000,
                    capex_nuc: 1200,
                    capex_ups: 800,
                    opex_light: 450,
                    opex_internet: 120,
                    opex_rent: 800,
                    revenue_monthly: 3200
                },
                totals: {
                    capex: 35300,
                    opex_monthly: 1370,
                    opex_annual: 16440,
                    revenue_monthly: 3200,
                    revenue_annual: 38400,
                    margin_monthly: 1830,
                    margin_annual: 21960,
                    roi_months: 19.3,
                    roi_years: 1.6
                },
                advanced_kpis: {
                    total_current_cost: 55640,
                    months_operation: 12,
                    annual_projected_margin: 21960,
                    reincidence_rate: 8.5,
                    technical_score: 85,
                    health_status: {
                        status: 'Excelente',
                        color: 'emerald',
                        icon: '✅'
                    },
                    recommendations: [
                        {
                            type: 'info',
                            message: 'Equipo en excelente estado técnico',
                            action: 'Mantener programa de mantenimiento actual'
                        }
                    ]
                },
                eco: {
                    kwh_saved: 9850,
                    co2_tons: 4.43,
                    trees: 222,
                    efficiency_gain: '66%'
                },
                summary: {
                    financial_health: 'Bueno',
                    operational_status: 'Excelente',
                    key_strength: 'Alta rentabilidad mensual',
                    key_concern: 'ROI de 19 meses ligeramente alto',
                    overall_rating: 4
                },
                projections: Array.from({length: 12}, (_, i) => ({
                    projection_date: new Date(new Date().setMonth(new Date().getMonth() + i)).toISOString().split('T')[0],
                    projected_revenue: 3200 * (1 + (i * 0.02)),
                    projected_opex: 1370 * (1 + (i * 0.01)),
                    projected_margin: 1830 * (1 + (i * 0.03)),
                    notes: `Proyección mes ${i + 1}`
                }))
            };
            
            updateUI(deviceData);
            initializeCharts(deviceData);
            showToast('📊 Datos de ejemplo cargados', 'info');
        }
        
        // Inicializar logs
        logDebug('System', 'Aplicación TechView cargada');
        logDebug('System', `Dispositivo: ${deviceId}`);
        
        // Actualizar información del sistema
        document.getElementById('system-info').textContent = `
TechView System v1.0
====================
Dispositivo: ${deviceId}
Tiempo: ${new Date().toLocaleString()}
User Agent: ${navigator.userAgent}
Pantalla: ${window.screen.width}x${window.screen.height}
Online: ${navigator.onLine ? '✅' : '❌'}
        `.trim();
        
        // Actualizar datos en crudo
        updateRawData();
    </script>
</body>
</html>
