<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Financiero DOOH</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#00e070",
                        "primary-dark": "#00c462",
                        "background-light": "#f8fcfa",
                        "surface-light": "#ffffff",
                        "text-main": "#0c1d14",
                        "text-muted": "#45a173",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Space Grotesk', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .icon-filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; }
        .nav-tab.active { color: #00e070; border-bottom: 2px solid #00e070; background-color: rgba(0, 224, 112, 0.05); }
        .cost-input { width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; background-color: #fff; }
        .cost-input:focus { outline: none; border-color: #00e070; box-shadow: 0 0 0 3px rgba(0, 224, 112, 0.1); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #00e070; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; z-index: 2000; box-shadow: 0 10px 25px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .profit-indicator { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .report-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .report-btn:hover { background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); }
    </style>
</head>
<body class="bg-background-light text-text-main font-display min-h-screen flex flex-col">

    <header class="flex items-center justify-between border-b border-[#e6f4ed] px-6 py-3 bg-surface-light sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="size-10 bg-primary/10 rounded-lg flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined icon-filled">analytics</span>
                </div>
                <div>
                    <h2 class="text-lg font-bold leading-none">Análisis Financiero DOOH</h2>
                    <p class="text-xs text-text-muted mt-1 font-mono truncate max-w-[200px]" id="device-display">{{ device_id }}</p>
                </div>
            </div>
            
            <nav class="hidden md:flex bg-gray-100/50 p-1 rounded-lg overflow-x-auto max-w-2xl">
                <button onclick="switchTab('resumen')" class="nav-tab active px-4 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap">Dashboard</button>
                <button onclick="switchTab('instalacion')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main whitespace-nowrap">Instalación</button>
                <button onclick="switchTab('gastos')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main whitespace-nowrap">Gastos Mensuales</button>
                <button onclick="switchTab('mantenimientos')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main whitespace-nowrap">Mantenimientos</button>
                <button onclick="switchTab('refacciones')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main whitespace-nowrap">Refacciones</button>
                <button onclick="switchTab('retiros')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main whitespace-nowrap">Retiros</button>
                <button onclick="switchTab('reubicaciones')" class="nav-tab px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-text-main whitespace-nowrap">Reubicaciones</button>
            </nav>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="generateReport()" class="flex items-center gap-2 px-4 py-2 report-btn text-white rounded-lg font-bold text-sm transition-all shadow-lg hover:shadow-xl active:scale-95">
                <span class="material-symbols-outlined text-lg">description</span> <span class="hidden sm:inline">Generar Reporte PDF</span>
            </button>
            <div id="unsaved-badge" class="hidden px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-full border border-yellow-200 animate-pulse">Cambios sin guardar</div>
            <button onclick="saveAll()" class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg font-bold text-sm transition-colors shadow-lg shadow-primary/20 active:scale-95">
                <span class="material-symbols-outlined text-lg">save</span> <span class="hidden sm:inline">Guardar</span>
            </button>
            <button onclick="checkExit()" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 rounded-lg font-bold text-sm transition-colors" title="Salir">
                <span class="material-symbols-outlined text-lg">logout</span>
            </button>
        </div>
    </header>

    <main class="flex-1 w-full max-w-[1800px] mx-auto px-4 md:px-8 py-6">
        
        <!-- TAB: DASHBOARD -->
        <div id="tab-resumen" class="tab-content active">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6">
                <div>
                    <div class="flex items-center gap-2 text-sm text-text-muted mb-1">
                        <span>Estado Financiero</span> <span class="material-symbols-outlined text-xs">chevron_right</span> <span class="text-primary font-bold" id="financial-status-text">Analizando...</span>
                    </div>
                    <h1 class="text-3xl font-black tracking-tight text-text-main">Dashboard Financiero</h1>
                </div>
                <div class="bg-surface-light border border-[#e6f4ed] rounded-xl p-3 flex items-center gap-4 shadow-sm">
                    <div class="size-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                        <span class="material-symbols-outlined">smart_toy</span>
                    </div>
                    <div>
                        <p class="text-xs text-text-muted font-bold uppercase">Recomendación IA</p>
                        <p class="text-sm font-bold text-text-main" id="ai-recommendation">Cargando...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 flex flex-col gap-6">
                    <div class="bg-surface-light rounded-2xl border border-[#cdeadb] shadow-sm p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><span class="material-symbols-outlined text-primary">verified</span> Salud del Activo</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm mb-1"><span class="text-text-muted">Score Técnico</span><span class="font-bold" id="tech-score-val">0/100</span></div>
                                <div class="w-full bg-gray-100 rounded-full h-2"><div id="tech-score-bar" class="bg-primary h-2 rounded-full" style="width: 0%"></div></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><span class="text-xs text-text-muted block">ROI Actual</span><span class="text-lg font-black text-text-main" id="dash-roi">0m</span></div>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100"><span class="text-xs text-text-muted block">Incidencias</span><span class="text-lg font-black text-text-main" id="dash-reincidence">0%</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-surface-light rounded-2xl border border-[#cdeadb] shadow-sm p-6 flex-1">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg flex items-center gap-2"><span class="material-symbols-outlined text-orange-500">payments</span> Flujo Operativo</h3><span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold">MENSUAL</span></div>
                        <p class="text-sm text-text-muted mb-4">Suma de OPEX + Mantenimiento</p>
                        <div class="flex items-baseline gap-2 mb-4 w-full">
                            <span class="text-2xl font-black text-text-main truncate" id="dash-monthly-cost">$0</span>
                            <span class="text-sm text-text-muted shrink-0">/ mes</span>
                        </div>
                        <div class="h-32 w-full"><canvas id="monthlyCostChart"></canvas></div>
                    </div>
                </div>

                <div class="lg:col-span-8 flex flex-col gap-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div class="bg-surface-light p-4 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
                            <p class="text-text-muted text-[10px] font-bold uppercase mb-1">Ingreso Mensual</p>
                            <p class="text-xl font-black text-text-main" id="dash-revenue">$0</p>
                        </div>
                        <div class="bg-surface-light p-4 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden group">
                            <p class="text-text-muted text-[10px] font-bold uppercase mb-1">Inversión Total</p>
                            <p class="text-xl font-black text-blue-600" id="dash-capex">$0</p>
                        </div>
                        <div class="bg-surface-light p-4 rounded-xl border border-orange-100 bg-orange-50/30 shadow-sm relative overflow-hidden group">
                            <p class="text-orange-600 text-[10px] font-bold uppercase mb-1">Gasto Mensual</p>
                            <p class="text-xl font-black text-orange-700" id="dash-opex-monthly">$0</p>
                        </div>
                        <div class="bg-surface-light p-4 rounded-xl border border-purple-100 bg-purple-50/30 shadow-sm relative overflow-hidden group">
                            <p class="text-purple-600 text-[10px] font-bold uppercase mb-1">Margen Mensual</p>
                            <p class="text-xl font-black text-purple-700" id="dash-margin">$0</p>
                        </div>
                        <div class="bg-surface-light p-4 rounded-xl border border-green-100 bg-green-50/30 shadow-sm relative overflow-hidden group">
                            <p class="text-green-600 text-[10px] font-bold uppercase mb-1">Rentabilidad</p>
                            <p class="text-xl font-black text-green-700" id="dash-profitability">0%</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                        <div class="bg-surface-light p-6 rounded-2xl border border-[#cdeadb] shadow-sm">
                            <h4 class="text-xs uppercase tracking-wider text-text-muted font-bold mb-4 border-b pb-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-green-600">trending_up</span>
                                Proyección de Rentabilidad
                            </h4>
                            <div class="h-32 w-full mb-4">
                                <canvas id="profitabilityChart"></canvas>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Punto de Equilibrio</span>
                                    <span class="font-bold text-green-600" id="break-even">Cargando...</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Margen Operativo</span>
                                    <span class="font-bold" id="operating-margin">0%</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">ROI Anual</span>
                                    <span class="font-bold" id="annual-roi">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-surface-light p-6 rounded-2xl border border-[#cdeadb] shadow-sm relative overflow-hidden">
                            <h4 class="text-xs uppercase tracking-wider text-text-muted font-bold mb-4 border-b pb-2 flex items-center gap-2">
                                <span class="material-symbols-outlined text-blue-600">account_balance</span>
                                TCO (5 años)
                            </h4>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-2xl font-black text-text-main" id="tco-5year">$0</p>
                                        <p class="text-xs text-text-muted">Costo Total de Propiedad</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-black" id="tco-monthly">$0</p>
                                        <p class="text-xs text-text-muted">/ mes equivalente</p>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-500">CAPEX</span>
                                        <span class="font-bold" id="tco-capex">$0</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-500">OPEX (5 años)</span>
                                        <span class="font-bold" id="tco-opex">$0</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-500">Mantenimiento</span>
                                        <span class="font-bold" id="tco-maintenance">$0</span>
                                    </div>
                                </div>
                                <div class="pt-2 border-t">
                                    <div class="flex justify-between text-sm font-bold">
                                        <span>Rentabilidad Neta (5 años)</span>
                                        <span class="text-green-600" id="tco-net-profit">$0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: INSTALACIÓN -->
        <div id="tab-instalacion" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-gray-800">Instalación - Costos Iniciales</h3>
                    <div class="text-sm text-gray-500">ID: <span class="font-bold text-primary">{{ device_id }}</span></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-blue-600 border-b pb-2">Pantalla y Estructura</h4>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Pantalla</label><input type="number" class="cost-input" id="cost_pantalla" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Costo Obra Civil</label><input type="number" class="cost-input" id="cost_obra_civil" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Costo Estructura</label><input type="number" class="cost-input" id="cost_estructura" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Medidor CFE</label><input type="number" class="cost-input" id="cost_medidor_cfe" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Instalación Eléctrica</label><input type="number" class="cost-input" id="cost_inst_electrica" placeholder="0.00"></div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-purple-600 border-b pb-2">Electrónica Principal</h4>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Novastar MCTRL300</label><input type="number" class="cost-input" id="cost_novastar" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">UPS CyberPower 1000VA</label><input type="number" class="cost-input" id="cost_ups" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">NUC ASUS Intel Core i5</label><input type="number" class="cost-input" id="cost_nuc" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Pastilla 3X100A QO</label><input type="number" class="cost-input" id="cost_pastilla_100a" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Pastilla 2X20A QO</label><input type="number" class="cost-input" id="cost_pastilla_20a" placeholder="0.00"></div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-amber-600 border-b pb-2">Comunicación y Seguridad</h4>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Cámara HIKVISION</label><input type="number" class="cost-input" id="cost_camara" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Teltonika RUT 955</label><input type="number" class="cost-input" id="cost_teltonika" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Poe Utepo</label><input type="number" class="cost-input" id="cost_poe" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Cable HDMI a DVI 2m</label><input type="number" class="cost-input" id="cost_cable_hdmi" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">ONT Fibra</label><input type="number" class="cost-input" id="cost_ont_fibra" placeholder="0.00"></div>
                    </div>
                </div>
                
                <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm font-bold text-blue-700">Total Inversión Inicial</p>
                            <p class="text-xs text-blue-600">Suma de todos los conceptos</p>
                        </div>
                        <p class="text-2xl font-black text-blue-700" id="total-instalacion">$0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: GASTOS MENSUALES -->
        <div id="tab-gastos" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-gray-800">Gastos Operativos Mensuales</h3>
                    <div class="text-sm text-gray-500">ID: <span class="font-bold text-primary">{{ device_id }}</span></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-green-600 border-b pb-2">Rentas y Servicios</h4>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Renta del Predio</label><input type="number" class="cost-input" id="renta_predio" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">CFE (Luz)</label><input type="number" class="cost-input" id="costo_cfe" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Internet Fibra</label><input type="number" class="cost-input" id="internet_fibra" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Internet Redundancia</label><input type="number" class="cost-input" id="internet_redundancia" placeholder="0.00"></div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-indigo-600 border-b pb-2">Licencias y Software</h4>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Licencia Teltonika</label><input type="number" class="cost-input" id="licencia_teltonika" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Licencia TeamViewer</label><input type="number" class="cost-input" id="licencia_teamviewer" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Licencia CMS</label><input type="number" class="cost-input" id="licencia_cms" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Licencia Hikvision</label><input type="number" class="cost-input" id="licencia_hikvision" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Licencia Portal UPS</label><input type="number" class="cost-input" id="licencia_ups_portal" placeholder="0.00"></div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Licencia QTM</label><input type="number" class="cost-input" id="licencia_qtm" placeholder="0.00"></div>
                    </div>
                </div>
                
                <div class="mt-8 p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm font-bold text-green-700">Total Gastos Mensuales</p>
                            <p class="text-xs text-green-600">Suma de todos los conceptos</p>
                        </div>
                        <p class="text-2xl font-black text-green-700" id="total-gastos-mensuales">$0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: MANTENIMIENTOS -->
        <div id="tab-mantenimientos" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-gray-800">Mantenimientos - Costos por Hora</h3>
                    <div class="text-sm text-gray-500">Costos base por flotilla</div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-blue-600 border-b pb-2">Preventivo</h4>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <label class="text-xs font-bold text-gray-500 mb-1 block">Costo por Hora</label>
                            <div class="flex items-center">
                                <span class="text-lg font-bold text-blue-700">$423.07</span>
                                <span class="text-xs text-gray-500 ml-2">/ hora</span>
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Horas Aplicadas</label><input type="number" step="0.1" class="cost-input" id="maint_preventivo_horas" placeholder="0.0" value="1"></div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs font-bold text-gray-500 mb-1">Total Preventivo</p>
                            <p class="text-lg font-bold text-gray-800" id="total-preventivo">$423.07</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-orange-600 border-b pb-2">Correctivo</h4>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <label class="text-xs font-bold text-gray-500 mb-1 block">Costo por Hora</label>
                            <div class="flex items-center">
                                <span class="text-lg font-bold text-orange-700">$423.07</span>
                                <span class="text-xs text-gray-500 ml-2">/ hora</span>
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Horas Aplicadas</label><input type="number" step="0.1" class="cost-input" id="maint_correctivo_horas" placeholder="0.0" value="1"></div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs font-bold text-gray-500 mb-1">Total Correctivo</p>
                            <p class="text-lg font-bold text-gray-800" id="total-correctivo">$423.07</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-green-600 border-b pb-2">Materiales</h4>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <label class="text-xs font-bold text-gray-500 mb-1 block">Dióxido de Titanio</label>
                            <div class="flex items-center">
                                <span class="text-lg font-bold text-green-700">$540.00</span>
                                <span class="text-xs text-gray-500 ml-2">/ unidad</span>
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Cantidad</label><input type="number" step="1" class="cost-input" id="cantidad_titanio" placeholder="0" value="1"></div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs font-bold text-gray-500 mb-1">Total Materiales</p>
                            <p class="text-lg font-bold text-gray-800" id="total-materiales">$540.00</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 p-4 bg-amber-50 rounded-lg border border-amber-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm font-bold text-amber-700">Total Mantenimiento</p>
                            <p class="text-xs text-amber-600">Preventivo + Correctivo + Materiales</p>
                        </div>
                        <p class="text-2xl font-black text-amber-700" id="total-mantenimiento">$1,386.14</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: REFACCIONES -->
        <div id="tab-refacciones" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-gray-800">Refacciones - Costos Unitarios</h3>
                    <div class="text-sm text-gray-500">Precios de reposición</div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-purple-600 border-b pb-2">Componentes Pantalla</h4>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Módulo</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_modulo_costo" value="1500" readonly>
                                <input type="number" class="cost-input" id="refaccion_modulo_cantidad" placeholder="Cantidad" value="0">
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Fuente de Poder</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_fuente_costo" value="800" readonly>
                                <input type="number" class="cost-input" id="refaccion_fuente_cantidad" placeholder="Cantidad" value="0">
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Tarjeta Receptora</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_tarjeta_costo" value="600" readonly>
                                <input type="number" class="cost-input" id="refaccion_tarjeta_cantidad" placeholder="Cantidad" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-blue-600 border-b pb-2">Cables y Conectores</h4>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Cable FAT (metro)</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_cable_fat_costo" value="40" readonly>
                                <input type="number" class="cost-input" id="refaccion_cable_fat_metros" placeholder="Metros" value="0">
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Cable Corriente Módulo</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_cable_modulo_costo" value="100" readonly>
                                <input type="number" class="cost-input" id="refaccion_cable_modulo_cantidad" placeholder="Cantidad" value="0">
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Cable Alimentación Fuente</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_cable_fuente_costo" value="200" readonly>
                                <input type="number" class="cost-input" id="refaccion_cable_fuente_cantidad" placeholder="Cantidad" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-bold text-sm text-green-600 border-b pb-2">Electrónica Principal</h4>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">Novastar MCTRL300</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_novastar_costo" value="3000" readonly>
                                <input type="number" class="cost-input" id="refaccion_novastar_cantidad" placeholder="Cantidad" value="0">
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">UPS CyberPower</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_ups_costo" value="5200" readonly>
                                <input type="number" class="cost-input" id="refaccion_ups_cantidad" placeholder="Cantidad" value="0">
                            </div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500 mb-1 block">NUC ASUS</label>
                            <div class="flex gap-2">
                                <input type="number" class="cost-input" id="refaccion_nuc_costo" value="12000" readonly>
                                <input type="number" class="cost-input" id="refaccion_nuc_cantidad" placeholder="Cantidad" value="0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm font-bold text-purple-700">Total Refacciones</p>
                            <p class="text-xs text-purple-600">Suma de todos los componentes</p>
                        </div>
                        <p class="text-2xl font-black text-purple-700" id="total-refacciones">$0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: RETIROS -->
        <div id="tab-retiros" class="tab-content">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 max-w-4xl mx-auto">
                <div class="text-center">
                    <div class="size-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-4xl text-gray-400">engineering</span>
                    </div>
                    <h3 class="font-bold text-xl text-gray-800 mb-2">Módulo de Retiros</h3>
                    <p class="text-gray-500 mb-6">Esta funcionalidad se encuentra en desarrollo</p>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 inline-block">
                        <p class="text-sm text-yellow-700 font-bold">Próximamente disponibles:</p>
                        <ul class="text-xs text-yellow-600 mt-2 text-left">
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">schedule</span>Programación de retiros</li>
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">calculate</span>Cálculo de costos de desmontaje</li>
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">inventory_2</span>Gestión de inventario post-retiro</li>
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">description</span>Reportes de baja de activos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: REUBICACIONES -->
        <div id="tab-reubicaciones" class="tab-content">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 max-w-4xl mx-auto">
                <div class="text-center">
                    <div class="size-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="material-symbols-outlined text-4xl text-gray-400">move_up</span>
                    </div>
                    <h3 class="font-bold text-xl text-gray-800 mb-2">Módulo de Reubicaciones</h3>
                    <p class="text-gray-500 mb-6">Esta funcionalidad se encuentra en desarrollo</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 inline-block">
                        <p class="text-sm text-blue-700 font-bold">Próximamente disponibles:</p>
                        <ul class="text-xs text-blue-600 mt-2 text-left">
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">map</span>Planificación de nuevas ubicaciones</li>
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">local_shipping</span>Logística de transporte</li>
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">architecture</span>Análisis de rentabilidad por ubicación</li>
                            <li class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">compare_arrows</span>Comparativa de costos de reubicación</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loading-overlay" class="loading-overlay hidden"><div class="bg-white p-6 rounded-xl flex flex-col items-center"><div class="spinner mb-4"></div><p class="font-bold">Procesando...</p></div></div>
    <div id="toast-container"></div>

    <script>
        const deviceId = "{{ device_id }}";
        let pendingChanges = new Set();
        let chartInstance = null;
        let profitabilityChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadDeviceData();
            setupEventListeners();
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') checkExit();
                if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveAll(); }
            });
        });

        function setupEventListeners() {
            // Listeners para todas las entradas
            document.querySelectorAll('input').forEach(i => i.addEventListener('input', (e) => {
                pendingChanges.add(e.target.id);
                document.getElementById('unsaved-badge').classList.remove('hidden');
                
                // Calcular totales en tiempo real
                if (e.target.id.includes('maint_') || e.target.id.includes('refaccion_')) {
                    calculateTotals();
                }
            }));

            // Listeners específicos para mantenimientos
            document.getElementById('maint_preventivo_horas')?.addEventListener('input', updateMaintenanceTotals);
            document.getElementById('maint_correctivo_horas')?.addEventListener('input', updateMaintenanceTotals);
            document.getElementById('cantidad_titanio')?.addEventListener('input', updateMaintenanceTotals);

            // Listeners para refacciones
            document.querySelectorAll('[id*="refaccion_"][id*="_cantidad"], [id*="refaccion_"][id*="_metros"]').forEach(input => {
                input.addEventListener('input', updateRefaccionesTotal);
            });
        }

        function calculateTotals() {
            // Total Instalación
            let totalInstalacion = 0;
            const instalacionIds = ['cost_pantalla', 'cost_obra_civil', 'cost_estructura', 'cost_medidor_cfe', 
                                   'cost_inst_electrica', 'cost_novastar', 'cost_ups', 'cost_nuc', 
                                   'cost_pastilla_100a', 'cost_pastilla_20a', 'cost_camara', 
                                   'cost_teltonika', 'cost_poe', 'cost_cable_hdmi', 'cost_ont_fibra'];
            
            instalacionIds.forEach(id => {
                const val = parseFloat(document.getElementById(id)?.value) || 0;
                totalInstalacion += val;
            });
            safeSetCurrency('total-instalacion', totalInstalacion);

            // Total Gastos Mensuales
            let totalGastos = 0;
            const gastosIds = ['renta_predio', 'costo_cfe', 'internet_fibra', 'internet_redundancia',
                             'licencia_teltonika', 'licencia_teamviewer', 'licencia_cms',
                             'licencia_hikvision', 'licencia_ups_portal', 'licencia_qtm'];
            
            gastosIds.forEach(id => {
                const val = parseFloat(document.getElementById(id)?.value) || 0;
                totalGastos += val;
            });
            safeSetCurrency('total-gastos-mensuales', totalGastos);

            updateMaintenanceTotals();
            updateRefaccionesTotal();
        }

        function updateMaintenanceTotals() {
            const horasPreventivo = parseFloat(document.getElementById('maint_preventivo_horas')?.value) || 0;
            const horasCorrectivo = parseFloat(document.getElementById('maint_correctivo_horas')?.value) || 0;
            const cantidadTitanio = parseFloat(document.getElementById('cantidad_titanio')?.value) || 0;
            
            const costoPreventivo = horasPreventivo * 423.07;
            const costoCorrectivo = horasCorrectivo * 423.07;
            const costoTitanio = cantidadTitanio * 540.00;
            
            const totalMantenimiento = costoPreventivo + costoCorrectivo + costoTitanio;
            
            safeSetCurrency('total-preventivo', costoPreventivo);
            safeSetCurrency('total-correctivo', costoCorrectivo);
            safeSetCurrency('total-materiales', costoTitanio);
            safeSetCurrency('total-mantenimiento', totalMantenimiento);
        }

        function updateRefaccionesTotal() {
            let totalRefacciones = 0;
            
            // Componentes con cantidad
            const componentes = [
                {id: 'modulo', costo: 1500},
                {id: 'fuente', costo: 800},
                {id: 'tarjeta', costo: 600},
                {id: 'cable_modulo', costo: 100},
                {id: 'cable_fuente', costo: 200},
                {id: 'novastar', costo: 3000},
                {id: 'ups', costo: 5200},
                {id: 'nuc', costo: 12000}
            ];
            
            componentes.forEach(comp => {
                const cantidad = parseFloat(document.getElementById(`refaccion_${comp.id}_cantidad`)?.value) || 0;
                totalRefacciones += cantidad * comp.costo;
            });
            
            // Cables por metro
            const metrosFat = parseFloat(document.getElementById('refaccion_cable_fat_metros')?.value) || 0;
            totalRefacciones += metrosFat * 40;
            
            safeSetCurrency('total-refacciones', totalRefacciones);
        }

        function checkExit() {
            if (pendingChanges.size > 0 && confirm("Tienes cambios sin guardar. ¿Deseas salir?")) goBack();
            else if(pendingChanges.size === 0) goBack();
        }
        
        function goBack() { 
            window.location.href = '/techview'; 
        }
        
        const safeSet = (id, val) => { 
            const el = document.getElementById(id); 
            if(el) el.innerText = val; 
        };
        
        const safeSetCurrency = (id, val) => { 
            safeSet(id, formatCurrency(val)); 
        };

        async function loadDeviceData() {
            showLoading();
            try {
                const res = await fetch(`/techview/api/device/${encodeURIComponent(deviceId)}`);
                const data = await res.json();
                
                if (data.financials) {
                    Object.keys(data.financials).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = data.financials[key];
                    });
                }

                if (data.totals) {
                    safeSetCurrency('dash-revenue', data.totals.revenue_monthly);
                    safeSetCurrency('dash-capex', data.totals.capex);
                    safeSetCurrency('dash-margin', data.totals.margin_monthly);
                    safeSetCurrency('dash-opex-monthly', data.totals.opex_monthly);
                    safeSet('dash-roi', `${data.totals.roi_months} meses`);
                    safeSetCurrency('dash-monthly-cost', data.totals.opex_monthly);
                    
                    // Calcular porcentaje de rentabilidad
                    const revenue = data.totals.revenue_monthly || 0;
                    const margin = data.totals.margin_monthly || 0;
                    const profitability = revenue > 0 ? (margin / revenue * 100) : 0;
                    safeSet('dash-profitability', `${profitability.toFixed(1)}%`);
                    
                    // Calcular ROI anual
                    const capex = data.totals.capex || 0;
                    const annualMargin = margin * 12;
                    const annualROI = capex > 0 ? (annualMargin / capex * 100) : 0;
                    safeSet('annual-roi', `${annualROI.toFixed(1)}%`);
                    
                    // Calcular margen operativo
                    const opex = data.totals.opex_monthly || 0;
                    const operatingMargin = revenue > 0 ? ((revenue - opex) / revenue * 100) : 0;
                    safeSet('operating-margin', `${operatingMargin.toFixed(1)}%`);
                }

                if (data.advanced_kpis) {
                    safeSet('tech-score-val', `${data.advanced_kpis.technical_score}/100`);
                    if(document.getElementById('tech-score-bar')) document.getElementById('tech-score-bar').style.width = `${data.advanced_kpis.technical_score}%`;
                    safeSet('dash-reincidence', `${data.advanced_kpis.reincidence_rate}%`);
                    
                    calculateTCO(data.totals, data.advanced_kpis);
                    calculateBreakEven(data.totals);
                    updateAIRecommendation(data.totals, data.advanced_kpis);
                }
                
                calculateTotals();
                initMonthlyChart(data.financials);
                initProfitabilityChart(data.totals);

            } catch (e) { 
                console.error(e);
                showToast('Error cargando datos', 'error');
            } 
            finally { hideLoading(); }
        }

        function calculateTCO(totals, advanced) {
            const capex = totals.capex || 0;
            const monthlyOpex = totals.opex_monthly || 0;
            const annualOpex = monthlyOpex * 12;
            const fiveYearOpex = annualOpex * 5;
            
            const monthlyMaintenance = (advanced.real_maintenance_total || 0) / (advanced.months_operation || 1);
            const fiveYearMaintenance = monthlyMaintenance * 12 * 5;
            
            const tco5Year = capex + fiveYearOpex + fiveYearMaintenance;
            const tcoMonthlyEquivalent = tco5Year / (5 * 12);
            
            const annualRevenue = (totals.revenue_monthly || 0) * 12;
            const fiveYearRevenue = annualRevenue * 5;
            const netProfit = fiveYearRevenue - tco5Year;
            
            safeSetCurrency('tco-5year', tco5Year);
            safeSetCurrency('tco-monthly', tcoMonthlyEquivalent);
            safeSetCurrency('tco-capex', capex);
            safeSetCurrency('tco-opex', fiveYearOpex);
            safeSetCurrency('tco-maintenance', fiveYearMaintenance);
            safeSetCurrency('tco-net-profit', netProfit);
            
            const netProfitEl = document.getElementById('tco-net-profit');
            if (netProfitEl) {
                netProfitEl.className = netProfit >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
            }
        }

        function calculateBreakEven(totals) {
            const capex = totals.capex || 0;
            const monthlyMargin = totals.margin_monthly || 0;
            
            if (monthlyMargin > 0) {
                const breakEvenMonths = Math.ceil(capex / monthlyMargin);
                const breakEvenDate = new Date();
                breakEvenDate.setMonth(breakEvenDate.getMonth() + breakEvenMonths);
                
                const options = { year: 'numeric', month: 'short' };
                const breakEvenText = `${breakEvenMonths} meses (${breakEvenDate.toLocaleDateString('es-MX', options)})`;
                safeSet('break-even', breakEvenText);
            } else {
                safeSet('break-even', 'No alcanzable');
                document.getElementById('break-even').className = 'font-bold text-red-600';
            }
        }

        function updateAIRecommendation(totals, advanced) {
            const margin = totals.margin_monthly || 0;
            const revenue = totals.revenue_monthly || 0;
            
            let recommendation = '';
            let status = '';
            let statusColor = '';
            
            if (margin < 0) {
                recommendation = "⚠️ Revisar costos operativos urgentemente";
                status = "Déficit";
                statusColor = "text-red-500";
            } else if (margin < revenue * 0.1) {
                recommendation = "Margen bajo. Optimizar costos operativos";
                status = "Precaución";
                statusColor = "text-orange-500";
            } else if (margin < revenue * 0.25) {
                recommendation = "Rentabilidad aceptable con margen de mejora";
                status = "Estable";
                statusColor = "text-blue-500";
            } else {
                recommendation = "✅ Inversión altamente rentable";
                status = "Excelente";
                statusColor = "text-primary";
            }
            
            safeSet('ai-recommendation', recommendation);
            safeSet('financial-status-text', status);
            document.getElementById('financial-status-text').className = `font-bold ${statusColor}`;
        }

        function initMonthlyChart(financials) {
            const ctx = document.getElementById('monthlyCostChart');
            if (!ctx) return;
            let opex = 0;
            if(financials) Object.keys(financials).forEach(k => { 
                if(k.startsWith('opex_') || k.includes('renta') || k.includes('costo_cfe') || k.includes('internet')) 
                    opex += parseFloat(financials[k]||0); 
            });
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
                    datasets: [{
                        data: Array(12).fill(opex).map(v => v * (1 + (Math.random()*0.1 - 0.05))),
                        borderColor: '#f97316', 
                        backgroundColor: 'rgba(249,115,22,0.1)', 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 0
                    }]
                },
                options: { 
                    plugins: {legend: {display: false}}, 
                    scales: {x:{display:true}, y:{display:false}} 
                }
            });
        }

        function initProfitabilityChart(totals) {
            const ctx = document.getElementById('profitabilityChart');
            if (!ctx) return;
            if (profitabilityChart) profitabilityChart.destroy();
            
            const revenue = totals.revenue_monthly || 0;
            const opex = totals.opex_monthly || 0;
            const capex = totals.capex || 0;
            
            const months = Array.from({length: 24}, (_, i) => `M${i+1}`);
            const cumulativeRevenue = months.map((_, i) => revenue * (i + 1));
            const cumulativeCost = months.map((_, i) => capex + (opex * (i + 1)));
            
            profitabilityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Ingreso Acumulado',
                            data: cumulativeRevenue,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Costo Acumulado',
                            data: cumulativeCost,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'top',
                            labels: { usePointStyle: true, padding: 15 }
                        } 
                    },
                    scales: {
                        x: { 
                            display: true,
                            grid: { display: false },
                            ticks: { maxTicksLimit: 8 }
                        },
                        y: { 
                            display: true,
                            beginAtZero: true,
                            ticks: { 
                                callback: function(value) {
                                    return formatCurrency(value, true);
                                }
                            }
                        }
                    }
                }
            });
        }

        async function saveAll() {
            showLoading();
            try {
                const payload = { device_id: deviceId, cost_type: 'techview', category: 'comprehensive' };
                
                // Recoger todos los valores de los inputs
                const allInputs = document.querySelectorAll('input');
                allInputs.forEach(input => {
                    if(input.value !== '') {
                        if(input.type === 'number') {
                            payload[input.id] = parseFloat(input.value) || 0;
                        } else {
                            payload[input.id] = input.value;
                        }
                    }
                });
                
                const res = await fetch('/techview/api/save', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload) 
                });
                if (res.ok) { 
                    showToast('Datos financieros guardados', 'success'); 
                    pendingChanges.clear(); 
                    document.getElementById('unsaved-badge').classList.add('hidden'); 
                    loadDeviceData(); 
                } else {
                    throw new Error('Error al guardar');
                }
            } catch (e) { 
                showToast('Error: ' + e.message, 'error'); 
            } 
            finally { hideLoading(); }
        }

        function generateReport() {
            showLoading();
            
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configuración inicial
                doc.setFont("helvetica", "bold");
                doc.setFontSize(20);
                doc.setTextColor(0, 224, 112);
                doc.text("REPORTE FINANCIERO DOOH", 105, 20, null, null, "center");
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Pantalla: ${deviceId}`, 105, 30, null, null, "center");
                doc.text(`Generado: ${new Date().toLocaleDateString()}`, 105, 36, null, null, "center");
                
                // Resumen ejecutivo
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text("RESUMEN EJECUTIVO", 20, 50);
                
                doc.setFont("helvetica", "normal");
                doc.setFontSize(11);
                const summaryData = [
                    [`Ingreso Mensual:`, document.getElementById('dash-revenue')?.innerText || '$0'],
                    [`Inversión Total:`, document.getElementById('dash-capex')?.innerText || '$0'],
                    [`Gasto Mensual:`, document.getElementById('dash-opex-monthly')?.innerText || '$0'],
                    [`Margen Mensual:`, document.getElementById('dash-margin')?.innerText || '$0'],
                    [`ROI Actual:`, document.getElementById('dash-roi')?.innerText || '0 meses'],
                    [`Rentabilidad:`, document.getElementById('dash-profitability')?.innerText || '0%'],
                    [`Punto de Equilibrio:`, document.getElementById('break-even')?.innerText || 'N/A'],
                    [`TCO (5 años):`, document.getElementById('tco-5year')?.innerText || '$0']
                ];
                
                let y = 60;
                summaryData.forEach(([label, value]) => {
                    doc.text(label, 20, y);
                    doc.text(value, 120, y);
                    y += 7;
                });
                
                // Recomendación IA
                y += 5;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text("RECOMENDACIÓN IA:", 20, y);
                y += 7;
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                const recommendation = document.getElementById('ai-recommendation')?.innerText || 'Sin recomendación';
                doc.text(recommendation, 20, y, {maxWidth: 170});
                
                // Instalación
                y += 20;
                doc.addPage();
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("DETALLE DE INSTALACIÓN", 20, 20);
                
                const installationData = [];
                const instalacionIds = ['cost_pantalla', 'cost_obra_civil', 'cost_estructura', 'cost_medidor_cfe', 
                                      'cost_inst_electrica', 'cost_novastar', 'cost_ups', 'cost_nuc'];
                
                instalacionIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.value) {
                        const label = el.previousElementSibling?.innerText || id;
                        installationData.push([label, formatCurrency(parseFloat(el.value) || 0)]);
                    }
                });
                
                y = 30;
                doc.setFontSize(10);
                installationData.forEach(([label, value]) => {
                    doc.text(label, 20, y);
                    doc.text(value, 150, y);
                    y += 6;
                });
                
                // Gastos Mensuales
                y += 10;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("GASTOS MENSUALES", 20, y);
                
                const monthlyData = [];
                const gastosIds = ['renta_predio', 'costo_cfe', 'internet_fibra', 'internet_redundancia',
                                 'licencia_teltonika', 'licencia_teamviewer', 'licencia_qtm'];
                
                y += 10;
                doc.setFontSize(10);
                gastosIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.value) {
                        const label = el.previousElementSibling?.innerText || id;
                        doc.text(label, 20, y);
                        doc.text(formatCurrency(parseFloat(el.value) || 0), 150, y);
                        y += 6;
                    }
                });
                
                // Totales
                y += 10;
                doc.setFont("helvetica", "bold");
                doc.text("TOTAL INSTALACIÓN:", 20, y);
                doc.text(document.getElementById('total-instalacion')?.innerText || '$0', 150, y);
                y += 7;
                doc.text("TOTAL MENSUAL:", 20, y);
                doc.text(document.getElementById('total-gastos-mensuales')?.innerText || '$0', 150, y);
                
                // Guardar PDF
                doc.save(`Reporte_${deviceId}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                hideLoading();
                showToast('Reporte generado exitosamente', 'success');
            }, 1000);
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
        
        function formatCurrency(val, short = false) {
            if (short && val >= 1000000) {
                return '$' + (val / 1000000).toFixed(1) + 'M';
            } else if (short && val >= 1000) {
                return '$' + (val / 1000).toFixed(1) + 'K';
            }
            return new Intl.NumberFormat('es-MX', { 
                style: 'currency', 
                currency: 'MXN',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(val || 0);
        }
        
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function showToast(msg, type) {
            const t = document.createElement('div'); 
            t.className = `toast ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`; 
            t.innerText = msg;
            document.getElementById('toast-container').appendChild(t); 
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
